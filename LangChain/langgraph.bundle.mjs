/*! For license information please see langgraph.bundle.mjs.LICENSE.txt */
var e={4083:(e,t,r)=>{e=r.nmd(e);const n=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,r,n)=>`[${38+e};2;${t};${r};${n}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[r,n]of Object.entries(t)){for(const[r,a]of Object.entries(n))t[r]={open:`[${a[0]}m`,close:`[${a[1]}m`},n[r]=t[r],e.set(a[0],a[1]);Object.defineProperty(t,r,{value:n,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=n(),t.color.ansi16m=a(),t.bgColor.ansi256=n(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map((e=>e+e)).join(""));const n=Number.parseInt(r,16);return[n>>16&255,n>>8&255,255&n]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},7526:(e,t)=>{t.byteLength=function(e){var t=o(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,i=o(e),s=i[0],c=i[1],l=new a(function(e,t,r){return 3*(t+r)/4-r}(0,s,c)),u=0,d=c>0?s-4:s;for(r=0;r<d;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===c&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,l[u++]=255&t),1===c&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,n=e.length,a=n%3,i=[],s=16383,o=0,l=n-a;o<l;o+=s)i.push(c(e,o,o+s>l?l:o+s));return 1===a?(t=e[n-1],i.push(r[t>>2]+r[t<<4&63]+"==")):2===a&&(t=(e[n-2]<<8)+e[n-1],i.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),i.join("")};for(var r=[],n=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)r[s]=i[s],n[i.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function c(e,t,n){for(var a,i,s=[],o=t;o<n;o+=3)a=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(r[(i=a)>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i]);return s.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},2729:e=>{const t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,s=new RegExp("^"+i.source),o=new RegExp(i.source+a.source,"gu"),c=new RegExp("\\d+"+a.source,"gu"),l=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const i=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),l=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?l(e):i(e):(e!==i(e)&&(e=((e,n,a)=>{let i=!1,s=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];i&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),i=!1,o=s,s=!0,c++):s&&o&&r.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=s,s=!1,i=!0):(i=n(l)===l&&a(l)!==l,o=s,s=a(l)===l&&n(l)!==l)}return e})(e,i,l)),e=e.replace(s,""),e=a.preserveConsecutiveUppercase?((e,t)=>(n.lastIndex=0,e.replace(n,(e=>t(e)))))(e,i):i(e),a.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,r)=>t(r))).replace(c,(e=>t(e)))))(e,l))};e.exports=l,e.exports.default=l},9478:e=>{e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},228:e=>{var t=Object.prototype.hasOwnProperty,r="~";function n(){}function a(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new a(n,i||e,s),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,n,a=[];if(0===this._eventsCount)return a;for(n in e=this._events)t.call(e,n)&&a.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,i=n.length,s=new Array(i);a<i;a++)s[a]=n[a].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,a,i,s){var o=r?r+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,a),!0;case 5:return u.fn.call(u.context,t,n,a,i),!0;case 6:return u.fn.call(u.context,t,n,a,i,s),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,n);break;case 4:u[l].fn.call(u[l].context,t,n,a);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,n,a){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||a&&!o.once||n&&o.context!==n||s(this,i);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||a&&!o[c].once||n&&o[c].context!==n)&&l.push(o[c]);l.length?this._events[i]=1===l.length?l[0]:l:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},4617:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},3290:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=r(228),a=r(6641),i=r(4774),s=()=>{},o=new a.TimeoutError;t.default=class extends n{constructor(e){var t,r,n,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(r=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==r?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(n=e.interval)||void 0===n?void 0:n.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((r,n)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&n(o)}));r(await i)}catch(e){n(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},9998:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let n=0,a=e.length;for(;a>0;){const i=a/2|0;let s=n+i;r(e[s],t)<=0?(n=++s,a-=i+1):a=i}return n}},4774:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=r(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);const a=n.default(this._queue,r,((e,t)=>t.priority-e.priority));this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},4116:(e,t,r)=>{const n=r(5617),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t)=>new Promise(((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=n.operation(t);o.attempt((async n=>{try{r(await e(n))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),s(e.originalError);else if(e instanceof TypeError&&(c=e.message,!a.includes(c)))o.stop(),s(e);else{((e,t,r)=>{const n=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=n})(e,n,t);try{await t.onFailedAttempt(e)}catch(e){return void s(e)}o.retry(e)||s(o.mainError())}}var c}))}));e.exports=s,e.exports.default=s,e.exports.AbortError=i},6641:(e,t,r)=>{const n=r(4617);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,r)=>new Promise(((i,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout((()=>{if("function"==typeof r){try{i(r())}catch(e){s(e)}return}const n=r instanceof Error?r:new a("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(n)}),t);n(e.then(i,s),(()=>{clearTimeout(o)}))}));e.exports=i,e.exports.default=i,e.exports.TimeoutError=a},5617:(e,t,r)=>{e.exports=r(8303)},8303:(e,t,r)=>{var n=r(3961);t.operation=function(e){var r=t.timeouts(e);return new n(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],a=0;a<t.retries;a++)n.push(this.createTimeout(a,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(a,t)),n.sort((function(e,t){return e-t})),n},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(n,t.maxTimeout)},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var a in n=[],e)"function"==typeof e[a]&&n.push(a);for(var i=0;i<n.length;i++){var s=n[i],o=e[s];e[s]=function(n){var a=t.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),s.apply(this,arguments))})),a.attempt((function(){n.apply(e,i)}))}.bind(e,o),e[s].options=r}}},3961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((function(){n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var a=this._errors[n],i=a.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=a,r=s)}return t}},3904:(e,t,r)=>{const n=Symbol("SemVer ANY");class a{static get ANY(){return n}constructor(e,t){if(t=i(t),e instanceof a){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===n?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?s[o.COMPARATORLOOSE]:s[o.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new u(r[2],this.options.loose):this.semver=n}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===n||e===n)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=i(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(c(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(c(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=a;const i=r(8587),{safeRe:s,t:o}=r(9718),c=r(2111),l=r(7272),u=r(3908),d=r(8311)},8311:(e,t,r)=>{const n=/\s+/g;class a{constructor(e,t){if(t=s(t),e instanceof a)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new a(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(n," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!b(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&y(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,r=i.get(t);if(r)return r;const n=this.options.loose,a=n?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(a,C(this.options.includePrerelease)),c("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],h),c("comparator trim",e),e=e.replace(u[d.TILDETRIM],p),c("tilde trim",e),e=e.replace(u[d.CARETTRIM],f),c("caret trim",e);let s=e.split(" ").map((e=>_(e,this.options))).join(" ").split(/\s+/).map((e=>j(e,this.options)));n&&(s=s.filter((e=>(c("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE]))))),c("range list",s);const l=new Map,y=s.map((e=>new o(e,this.options)));for(const e of y){if(b(e))return[e];l.set(e.value,e)}l.size>1&&l.has("")&&l.delete("");const v=[...l.values()];return i.set(t,v),v}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Range is required");return this.set.some((r=>v(r,t)&&e.set.some((e=>v(e,t)&&r.every((r=>e.every((e=>r.intersects(e,t)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new l(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(I(this.set[t],e,this.options))return!0;return!1}}e.exports=a;const i=new(r(8794)),s=r(8587),o=r(3904),c=r(7272),l=r(3908),{safeRe:u,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=r(9718),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=r(6874),b=e=>"<0.0.0-0"===e.value,y=e=>""===e.value,v=(e,t)=>{let r=!0;const n=e.slice();let a=n.pop();for(;r&&n.length;)r=n.every((e=>a.intersects(e,t))),a=n.pop();return r},_=(e,t)=>(c("comp",e,t),e=E(e,t),c("caret",e),e=O(e,t),c("tildes",e),e=T(e,t),c("xrange",e),e=x(e,t),c("stars",e),e),w=e=>!e||"x"===e.toLowerCase()||"*"===e,O=(e,t)=>e.trim().split(/\s+/).map((e=>k(e,t))).join(" "),k=(e,t)=>{const r=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(r,((t,r,n,a,i)=>{let s;return c("tilde",e,t,r,n,a,i),w(r)?s="":w(n)?s=`>=${r}.0.0 <${+r+1}.0.0-0`:w(a)?s=`>=${r}.${n}.0 <${r}.${+n+1}.0-0`:i?(c("replaceTilde pr",i),s=`>=${r}.${n}.${a}-${i} <${r}.${+n+1}.0-0`):s=`>=${r}.${n}.${a} <${r}.${+n+1}.0-0`,c("tilde return",s),s}))},E=(e,t)=>e.trim().split(/\s+/).map((e=>S(e,t))).join(" "),S=(e,t)=>{c("caret",e,t);const r=t.loose?u[d.CARETLOOSE]:u[d.CARET],n=t.includePrerelease?"-0":"";return e.replace(r,((t,r,a,i,s)=>{let o;return c("caret",e,t,r,a,i,s),w(r)?o="":w(a)?o=`>=${r}.0.0${n} <${+r+1}.0.0-0`:w(i)?o="0"===r?`>=${r}.${a}.0${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.0${n} <${+r+1}.0.0-0`:s?(c("replaceCaret pr",s),o="0"===r?"0"===a?`>=${r}.${a}.${i}-${s} <${r}.${a}.${+i+1}-0`:`>=${r}.${a}.${i}-${s} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${i}-${s} <${+r+1}.0.0-0`):(c("no pr"),o="0"===r?"0"===a?`>=${r}.${a}.${i}${n} <${r}.${a}.${+i+1}-0`:`>=${r}.${a}.${i}${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${i} <${+r+1}.0.0-0`),c("caret return",o),o}))},T=(e,t)=>(c("replaceXRanges",e,t),e.split(/\s+/).map((e=>P(e,t))).join(" ")),P=(e,t)=>{e=e.trim();const r=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(r,((r,n,a,i,s,o)=>{c("xRange",e,r,n,a,i,s,o);const l=w(a),u=l||w(i),d=u||w(s),h=d;return"="===n&&h&&(n=""),o=t.includePrerelease?"-0":"",l?r=">"===n||"<"===n?"<0.0.0-0":"*":n&&h?(u&&(i=0),s=0,">"===n?(n=">=",u?(a=+a+1,i=0,s=0):(i=+i+1,s=0)):"<="===n&&(n="<",u?a=+a+1:i=+i+1),"<"===n&&(o="-0"),r=`${n+a}.${i}.${s}${o}`):u?r=`>=${a}.0.0${o} <${+a+1}.0.0-0`:d&&(r=`>=${a}.${i}.0${o} <${a}.${+i+1}.0-0`),c("xRange return",r),r}))},x=(e,t)=>(c("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),j=(e,t)=>(c("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),C=e=>(t,r,n,a,i,s,o,c,l,u,d,h)=>`${r=w(n)?"":w(a)?`>=${n}.0.0${e?"-0":""}`:w(i)?`>=${n}.${a}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`} ${c=w(l)?"":w(u)?`<${+l+1}.0.0-0`:w(d)?`<${l}.${+u+1}.0-0`:h?`<=${l}.${u}.${d}-${h}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),I=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(c(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){const n=e[r].semver;if(n.major===t.major&&n.minor===t.minor&&n.patch===t.patch)return!0}return!1}return!0}},3908:(e,t,r)=>{const n=r(7272),{MAX_LENGTH:a,MAX_SAFE_INTEGER:i}=r(6874),{safeRe:s,t:o}=r(9718),c=r(8587),{compareIdentifiers:l}=r(1123);class u{constructor(e,t){if(t=c(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>a)throw new TypeError(`version is longer than ${a} characters`);n("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?s[o.LOOSE]:s[o.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<i)return t}return e})):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(n("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),l(this.major,e.major)||l(this.minor,e.minor)||l(this.patch,e.patch)}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(n("prerelease compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return l(r,a)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(n("build compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return l(r,a)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let n=this.prerelease.length;for(;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);if(-1===n){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let n=[t,e];!1===r&&(n=[t]),0===l(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=n):this.prerelease=n}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},7414:(e,t,r)=>{const n=r(144);e.exports=(e,t)=>{const r=n(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},2111:(e,t,r)=>{const n=r(4641),a=r(3999),i=r(5580),s=r(4089),o=r(7059),c=r(5200);e.exports=(e,t,r,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return n(e,r,l);case"!=":return a(e,r,l);case">":return i(e,r,l);case">=":return s(e,r,l);case"<":return o(e,r,l);case"<=":return c(e,r,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},6170:(e,t,r)=>{const n=r(3908),a=r(144),{safeRe:i,t:s}=r(9718);e.exports=(e,t)=>{if(e instanceof n)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){const n=t.includePrerelease?i[s.COERCERTLFULL]:i[s.COERCERTL];let a;for(;(a=n.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&a.index+a[0].length===r.index+r[0].length||(r=a),n.lastIndex=a.index+a[1].length+a[2].length;n.lastIndex=-1}else r=e.match(t.includePrerelease?i[s.COERCEFULL]:i[s.COERCE]);if(null===r)return null;const o=r[2],c=r[3]||"0",l=r[4]||"0",u=t.includePrerelease&&r[5]?`-${r[5]}`:"",d=t.includePrerelease&&r[6]?`+${r[6]}`:"";return a(`${o}.${c}.${l}${u}${d}`,t)}},909:(e,t,r)=>{const n=r(3908);e.exports=(e,t,r)=>{const a=new n(e,r),i=new n(t,r);return a.compare(i)||a.compareBuild(i)}},1763:(e,t,r)=>{const n=r(560);e.exports=(e,t)=>n(e,t,!0)},560:(e,t,r)=>{const n=r(3908);e.exports=(e,t,r)=>new n(e,r).compare(new n(t,r))},1832:(e,t,r)=>{const n=r(144);e.exports=(e,t)=>{const r=n(e,null,!0),a=n(t,null,!0),i=r.compare(a);if(0===i)return null;const s=i>0,o=s?r:a,c=s?a:r,l=!!o.prerelease.length;if(c.prerelease.length&&!l)return c.patch||c.minor?o.patch?"patch":o.minor?"minor":"major":"major";const u=l?"pre":"";return r.major!==a.major?u+"major":r.minor!==a.minor?u+"minor":r.patch!==a.patch?u+"patch":"prerelease"}},4641:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>0===n(e,t,r)},5580:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>n(e,t,r)>0},4089:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>n(e,t,r)>=0},3007:(e,t,r)=>{const n=r(3908);e.exports=(e,t,r,a,i)=>{"string"==typeof r&&(i=a,a=r,r=void 0);try{return new n(e instanceof n?e.version:e,r).inc(t,a,i).version}catch(e){return null}}},7059:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>n(e,t,r)<0},5200:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>n(e,t,r)<=0},2938:(e,t,r)=>{const n=r(3908);e.exports=(e,t)=>new n(e,t).major},6254:(e,t,r)=>{const n=r(3908);e.exports=(e,t)=>new n(e,t).minor},3999:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>0!==n(e,t,r)},144:(e,t,r)=>{const n=r(3908);e.exports=(e,t,r=!1)=>{if(e instanceof n)return e;try{return new n(e,t)}catch(e){if(!r)return null;throw e}}},4493:(e,t,r)=>{const n=r(3908);e.exports=(e,t)=>new n(e,t).patch},1729:(e,t,r)=>{const n=r(144);e.exports=(e,t)=>{const r=n(e,t);return r&&r.prerelease.length?r.prerelease:null}},9970:(e,t,r)=>{const n=r(560);e.exports=(e,t,r)=>n(t,e,r)},4277:(e,t,r)=>{const n=r(909);e.exports=(e,t)=>e.sort(((e,r)=>n(r,e,t)))},7638:(e,t,r)=>{const n=r(8311);e.exports=(e,t,r)=>{try{t=new n(t,r)}catch(e){return!1}return t.test(e)}},3927:(e,t,r)=>{const n=r(909);e.exports=(e,t)=>e.sort(((e,r)=>n(e,r,t)))},6953:(e,t,r)=>{const n=r(144);e.exports=(e,t)=>{const r=n(e,t);return r?r.version:null}},9589:(e,t,r)=>{const n=r(9718),a=r(6874),i=r(3908),s=r(1123),o=r(144),c=r(6953),l=r(7414),u=r(3007),d=r(1832),h=r(2938),p=r(6254),f=r(4493),m=r(1729),g=r(560),b=r(9970),y=r(1763),v=r(909),_=r(3927),w=r(4277),O=r(5580),k=r(7059),E=r(4641),S=r(3999),T=r(4089),P=r(5200),x=r(2111),j=r(6170),C=r(3904),I=r(8311),A=r(7638),R=r(7631),N=r(9628),$=r(270),L=r(1261),M=r(3874),D=r(7075),F=r(5571),U=r(5342),B=r(6780),z=r(2525),V=r(5032);e.exports={parse:o,valid:c,clean:l,inc:u,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:b,compareLoose:y,compareBuild:v,sort:_,rsort:w,gt:O,lt:k,eq:E,neq:S,gte:T,lte:P,cmp:x,coerce:j,Comparator:C,Range:I,satisfies:A,toComparators:R,maxSatisfying:N,minSatisfying:$,minVersion:L,validRange:M,outside:D,gtr:F,ltr:U,intersects:B,simplifyRange:z,subset:V,SemVer:i,re:n.re,src:n.src,tokens:n.t,SEMVER_SPEC_VERSION:a.SEMVER_SPEC_VERSION,RELEASE_TYPES:a.RELEASE_TYPES,compareIdentifiers:s.compareIdentifiers,rcompareIdentifiers:s.rcompareIdentifiers}},6874:e=>{const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},7272:e=>{const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},1123:e=>{const t=/^[0-9]+$/,r=(e,r)=>{const n=t.test(e),a=t.test(r);return n&&a&&(e=+e,r=+r),e===r?0:n&&!a?-1:a&&!n?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},8794:e=>{e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},8587:e=>{const t=Object.freeze({loose:!0}),r=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:r},9718:(e,t,r)=>{const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:i}=r(6874),s=r(7272),o=(t=e.exports={}).re=[],c=t.safeRe=[],l=t.src=[],u=t.t={};let d=0;const h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",i],[h,a]],f=(e,t,r)=>{const n=(e=>{for(const[t,r]of p)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),a=d++;s(e,a,t),u[e]=a,l[a]=t,o[a]=new RegExp(t,r?"g":void 0),c[a]=new RegExp(n,r?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),f("MAINVERSION",`(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})\\.(${l[u.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})\\.(${l[u.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${l[u.NUMERICIDENTIFIER]}|${l[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${l[u.NUMERICIDENTIFIERLOOSE]}|${l[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${l[u.PRERELEASEIDENTIFIER]}(?:\\.${l[u.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${l[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[u.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${h}+`),f("BUILD",`(?:\\+(${l[u.BUILDIDENTIFIER]}(?:\\.${l[u.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${l[u.MAINVERSION]}${l[u.PRERELEASE]}?${l[u.BUILD]}?`),f("FULL",`^${l[u.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${l[u.MAINVERSIONLOOSE]}${l[u.PRERELEASELOOSE]}?${l[u.BUILD]}?`),f("LOOSE",`^${l[u.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${l[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${l[u.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:\\.(${l[u.XRANGEIDENTIFIER]})(?:${l[u.PRERELEASE]})?${l[u.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[u.XRANGEIDENTIFIERLOOSE]})(?:${l[u.PRERELEASELOOSE]})?${l[u.BUILD]}?)?)?`),f("XRANGE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${l[u.GTLT]}\\s*${l[u.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),f("COERCE",`${l[u.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",l[u.COERCEPLAIN]+`(?:${l[u.PRERELEASE]})?`+`(?:${l[u.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",l[u.COERCE],!0),f("COERCERTLFULL",l[u.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${l[u.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${l[u.LONETILDE]}${l[u.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${l[u.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${l[u.LONECARET]}${l[u.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${l[u.LONECARET]}${l[u.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${l[u.GTLT]}\\s*(${l[u.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${l[u.GTLT]}\\s*(${l[u.LOOSEPLAIN]}|${l[u.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${l[u.XRANGEPLAIN]})\\s+-\\s+(${l[u.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${l[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[u.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},5571:(e,t,r)=>{const n=r(7075);e.exports=(e,t,r)=>n(e,t,">",r)},6780:(e,t,r)=>{const n=r(8311);e.exports=(e,t,r)=>(e=new n(e,r),t=new n(t,r),e.intersects(t,r))},5342:(e,t,r)=>{const n=r(7075);e.exports=(e,t,r)=>n(e,t,"<",r)},9628:(e,t,r)=>{const n=r(3908),a=r(8311);e.exports=(e,t,r)=>{let i=null,s=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(i&&-1!==s.compare(e)||(i=e,s=new n(i,r)))})),i}},270:(e,t,r)=>{const n=r(3908),a=r(8311);e.exports=(e,t,r)=>{let i=null,s=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(i&&1!==s.compare(e)||(i=e,s=new n(i,r)))})),i}},1261:(e,t,r)=>{const n=r(3908),a=r(8311),i=r(5580);e.exports=(e,t)=>{e=new a(e,t);let r=new n("0.0.0");if(e.test(r))return r;if(r=new n("0.0.0-0"),e.test(r))return r;r=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let s=null;a.forEach((e=>{const t=new n(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":s&&!i(t,s)||(s=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!s||r&&!i(r,s)||(r=s)}return r&&e.test(r)?r:null}},7075:(e,t,r)=>{const n=r(3908),a=r(3904),{ANY:i}=a,s=r(8311),o=r(7638),c=r(5580),l=r(7059),u=r(5200),d=r(4089);e.exports=(e,t,r,h)=>{let p,f,m,g,b;switch(e=new n(e,h),t=new s(t,h),r){case">":p=c,f=u,m=l,g=">",b=">=";break;case"<":p=l,f=d,m=c,g="<",b="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let r=0;r<t.set.length;++r){const n=t.set[r];let s=null,o=null;if(n.forEach((e=>{e.semver===i&&(e=new a(">=0.0.0")),s=s||e,o=o||e,p(e.semver,s.semver,h)?s=e:m(e.semver,o.semver,h)&&(o=e)})),s.operator===g||s.operator===b)return!1;if((!o.operator||o.operator===g)&&f(e,o.semver))return!1;if(o.operator===b&&m(e,o.semver))return!1}return!0}},2525:(e,t,r)=>{const n=r(7638),a=r(560);e.exports=(e,t,r)=>{const i=[];let s=null,o=null;const c=e.sort(((e,t)=>a(e,t,r)));for(const e of c)n(e,t,r)?(o=e,s||(s=e)):(o&&i.push([s,o]),o=null,s=null);s&&i.push([s,null]);const l=[];for(const[e,t]of i)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const u=l.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},5032:(e,t,r)=>{const n=r(8311),a=r(3904),{ANY:i}=a,s=r(7638),o=r(560),c=[new a(">=0.0.0-0")],l=[new a(">=0.0.0")],u=(e,t,r)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===i){if(1===t.length&&t[0].semver===i)return!0;e=r.includePrerelease?c:l}if(1===t.length&&t[0].semver===i){if(r.includePrerelease)return!0;t=l}const n=new Set;let a,u,p,f,m,g,b;for(const t of e)">"===t.operator||">="===t.operator?a=d(a,t,r):"<"===t.operator||"<="===t.operator?u=h(u,t,r):n.add(t.semver);if(n.size>1)return null;if(a&&u){if(p=o(a.semver,u.semver,r),p>0)return null;if(0===p&&(">="!==a.operator||"<="!==u.operator))return null}for(const e of n){if(a&&!s(e,String(a),r))return null;if(u&&!s(e,String(u),r))return null;for(const n of t)if(!s(e,String(n),r))return!1;return!0}let y=!(!u||r.includePrerelease||!u.semver.prerelease.length)&&u.semver,v=!(!a||r.includePrerelease||!a.semver.prerelease.length)&&a.semver;y&&1===y.prerelease.length&&"<"===u.operator&&0===y.prerelease[0]&&(y=!1);for(const e of t){if(b=b||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,a)if(v&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===v.major&&e.semver.minor===v.minor&&e.semver.patch===v.patch&&(v=!1),">"===e.operator||">="===e.operator){if(f=d(a,e,r),f===e&&f!==a)return!1}else if(">="===a.operator&&!s(a.semver,String(e),r))return!1;if(u)if(y&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===y.major&&e.semver.minor===y.minor&&e.semver.patch===y.patch&&(y=!1),"<"===e.operator||"<="===e.operator){if(m=h(u,e,r),m===e&&m!==u)return!1}else if("<="===u.operator&&!s(u.semver,String(e),r))return!1;if(!e.operator&&(u||a)&&0!==p)return!1}return!(a&&g&&!u&&0!==p||u&&b&&!a&&0!==p||v||y)},d=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n>0?e:n<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n<0?e:n>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new n(e,r),t=new n(t,r);let a=!1;e:for(const n of e.set){for(const e of t.set){const t=u(n,e,r);if(a=a||null!==t,t)continue e}if(a)return!1}return!0}},7631:(e,t,r)=>{const n=r(8311);e.exports=(e,t)=>new n(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")))},3874:(e,t,r)=>{const n=r(8311);e.exports=(e,t)=>{try{return new n(e,t).range||"*"}catch(e){return null}}},3407:(e,t,r)=>{var n;r.d(t,{A:()=>i});var a=new Uint8Array(16);function i(){if(!n&&!(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(a)}},8823:(e,t,r)=>{r.d(t,{k:()=>i});for(var n=[],a=0;a<256;++a)n.push((a+256).toString(16).slice(1));function i(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}},477:(e,t,r)=>{r.d(t,{A:()=>s});const n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var a=r(3407),i=r(8823);const s=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();var s=(e=e||{}).random||(e.rng||a.A)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){r=r||0;for(var o=0;o<16;++o)t[r+o]=s[o];return t}return(0,i.k)(s)}},8227:(e,t,r)=>{r.d(t,{A:()=>a});const n=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,a=function(e){return"string"==typeof e&&n.test(e)}},5960:(e,t,r)=>{r.r(t),r.d(t,{BaseCallbackHandler:()=>o});var n=r(477),a=r(7380),i=r(9583);class s{}class o extends s{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,a.get_lc_unique_name)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,i.getEnvironmentVariable)("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return a.Serializable.prototype.toJSON.call(this)}toJSONNotImplemented(){return a.Serializable.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends o{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:n.A()}),Object.assign(this,e)}}}}},7715:(e,t,r)=>{r.r(t),r.d(t,{BaseCallbackManager:()=>h,BaseRunManager:()=>p,CallbackManager:()=>y,CallbackManagerForChainRun:()=>g,CallbackManagerForLLMRun:()=>m,CallbackManagerForRetrieverRun:()=>f,CallbackManagerForToolRun:()=>b,TraceGroup:()=>_,ensureHandler:()=>v,parseCallbackConfigArg:()=>d,traceAsGroup:()=>w});var n=r(477),a=r(5960),i=r(6906),s=r(6362),o=r(9583),c=r(1201),l=r(7243),u=r(1590);function d(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class h{setHandler(e){return this.setHandlers([e])}}class p{constructor(e,t,r,n,a,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map((r=>(0,l.consumeCallback)((async()=>{try{await(r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}}class f extends p{getChild(e){const t=new y(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class m extends p{async handleLLMNewToken(e,t,r,n,a,i){await Promise.all(this.handlers.map((r=>(0,l.consumeCallback)((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class g extends p{getChild(e){const t=new y(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,a){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,r,n,a){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class b extends p{getChild(e){const t=new y(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>(0,l.consumeCallback)((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class y extends h{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(t.map((async(t,a)=>{const s=0===a&&r?r:(0,n.A)();return await Promise.all(this.handlers.map((r=>{if(!r.ignoreLLM)return(0,u.isBaseTracer)(r)&&r._createRunForLLMStart(e,[t],s,this._parentRunId,i,this.tags,this.metadata,c),(0,l.consumeCallback)((async()=>{try{await(r.handleLLMStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,c))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new m(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,r=void 0,a=void 0,i=void 0,o=void 0,c=void 0,d=void 0){return Promise.all(t.map((async(t,a)=>{const o=0===a&&r?r:(0,n.A)();return await Promise.all(this.handlers.map((r=>{if(!r.ignoreLLM)return(0,u.isBaseTracer)(r)&&r._createRunForChatModelStart(e,[t],o,this._parentRunId,i,this.tags,this.metadata,d),(0,l.consumeCallback)((async()=>{try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],o,this._parentRunId,i,this.tags,this.metadata,d));else if(r.handleLLMStart){const n=(0,s.Sw)(t);await(r.handleLLMStart?.(e,[n],o,this._parentRunId,i,this.tags,this.metadata,d))}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new m(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreChain)return(0,u.isBaseTracer)(n)&&n._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),(0,l.consumeCallback)((async()=>{try{await(n.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleChainStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new g(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreAgent)return(0,u.isBaseTracer)(n)&&n._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),(0,l.consumeCallback)((async()=>{try{await(n.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new b(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreRetriever)return(0,u.isBaseTracer)(n)&&n._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),(0,l.consumeCallback)((async()=>{try{await(n.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new f(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map((n=>(0,l.consumeCallback)((async()=>{if(!n.ignoreCustomEvent)try{await(n.handleCustomEvent?.(e,t,r,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new y(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const n of e)r.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===n.name))||r.addHandler(n,t);return r}static fromHandlers(e){class t extends a.BaseCallbackHandler{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,n.A)()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static configure(e,t,r,n,a,i,s){return this._configureSync(e,t,r,n,a,i,s)}static _configureSync(e,t,r,n,a,s,l){let u;(e||t)&&(Array.isArray(e)||!e?(u=new y,u.setHandlers(e?.map(v)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(v):t?.handlers,!1));const d="true"===(0,o.getEnvironmentVariable)("LANGCHAIN_VERBOSE")||l?.verbose,h=c.LangChainTracer.getTraceableRunTree()?.tracingEnabled||!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===(0,o.getEnvironmentVariable)(e))),p=h||((0,o.getEnvironmentVariable)("LANGCHAIN_TRACING")??!1);if(d||p){if(u||(u=new y),d&&!u.handlers.some((e=>e.name===i.ConsoleCallbackHandler.prototype.name))){const e=new i.ConsoleCallbackHandler;u.addHandler(e,!0)}if(p&&!u.handlers.some((e=>"langchain_tracer"===e.name))&&h){const e=new c.LangChainTracer;u.addHandler(e,!0),u._parentRunId=c.LangChainTracer.getTraceableRunTree()?.id??u._parentRunId}}return(r||n)&&u&&(u.addTags(r??[]),u.addTags(n??[],!1)),(a||s)&&u&&(u.addMetadata(a??{}),u.addMetadata(s??{},!1)),u}}function v(e){return"name"in e?e:a.BaseCallbackHandler.fromMethods(e)}class _{constructor(e,t){Object.defineProperty(this,"groupName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"runManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async getTraceGroupCallbackManager(e,t,r){const n=new c.LangChainTracer(r),a=await y.configure([n]),i=await(a?.handleChainStart({lc:1,type:"not_implemented",id:["langchain","callbacks","groups",e]},t??{}));if(!i)throw new Error("Failed to create run group callback manager.");return i}async start(e){return this.runManager||(this.runManager=await this.getTraceGroupCallbackManager(this.groupName,e,this.options)),this.runManager.getChild()}async error(e){this.runManager&&(await this.runManager.handleChainError(e),this.runManager=void 0)}async end(e){this.runManager&&(await this.runManager.handleChainEnd(e??{}),this.runManager=void 0)}}async function w(e,t,...r){const n=new _(e.name,e),a=await n.start({...r});try{const e=await t(a,...r);return await n.end((i=e,s="output",i&&!Array.isArray(i)&&"object"==typeof i?i:{[s]:i})),e}catch(e){throw await n.error(e),e}var i,s}},7243:(e,t,r)=>{r.r(t),r.d(t,{awaitAllCallbacks:()=>s,consumeCallback:()=>i});var n=r(3290);let a;async function i(e,t){!0===t?await e():(void 0===a&&(a=new(0,n.default)({autoStart:!0,concurrency:1})),a.add(e))}function s(){return void 0!==a?a.onIdle():Promise.resolve()}},1368:(e,t,r)=>{function n(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}r.d(t,{Y:()=>n})},7492:(e,t,r)=>{r.d(t,{$o:()=>i,O3:()=>s,d4:()=>o});var n=r(9478),a=r(2729);function i(e,t){return t?.[e]||n(e)}function s(e,t){return t?.[e]||a(e)}function o(e,t,r){const n={};for(const a in e)Object.hasOwn(e,a)&&(n[t(a,r)]=e[a]);return n}},7380:(e,t,r)=>{r.r(t),r.d(t,{Serializable:()=>o,get_lc_unique_name:()=>s});var n=r(7492);function a(e){return Array.isArray(e)?[...e]:{...e}}function i(e,t){const r=a(e);for(const[e,n]of Object.entries(t)){const[t,...i]=e.split(".").reverse();let s=r;for(const e of i.reverse()){if(void 0===s[e])break;s[e]=a(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[n]})}return r}function s(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}class o{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,s(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof o||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,n=r;const[a,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}a in t&&void 0!==t[a]&&(n[a]=n[a]||t[a])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:(0,n.d4)(Object.keys(t).length?i(r,t):r,n.$o,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},7765:(e,t,r)=>{r.d(t,{H:()=>l,KX:()=>o,Od:()=>s,jm:()=>c});var n=r(780),a=r(3490),i=r(8009);class s extends a.XQ{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if("string"==typeof e)r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const t=r.additional_kwargs?.tool_calls,n=r.tool_calls;null!=t&&t.length>0&&(void 0===n||0===n.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===n){const[e,n]=(0,i.p1)(t);r.tool_calls=e??[],r.invalid_tool_calls=n??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch(e){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof r&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function o(e){return"ai"===e._getType()}function c(e){return"ai"===e._getType()}class l extends a.gj{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const r=[],a=[];for(const t of e.tool_call_chunks){let e={};try{if(e=(0,n.d)(t.args||"{}"),null===e||"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");r.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){a.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:(0,a._I)(this.content,e.content),additional_kwargs:(0,a.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.ns)(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const r=(0,a.Vt)(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const r={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},n={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},a=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:a.input_tokens+i.input_tokens,output_tokens:a.output_tokens+i.output_tokens,total_tokens:a.total_tokens+i.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(n).length>0&&{output_token_details:n}};t.usage_metadata=s}return new l(t)}}},3490:(e,t,r)=>{r.d(t,{AJ:()=>f,Ao:()=>o,F7:()=>u,Iv:()=>i,Vt:()=>l,XQ:()=>s,_I:()=>a,dp:()=>h,gj:()=>d,ns:()=>c,ny:()=>p});var n=r(7380);function a(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?l(e,t)??[...e,...t]:[...e,{type:"text",text:t}]}function i(e,t){return"error"===e||"error"===t?"error":"success"}class s extends n.Serializable{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(r=this._printableFields,n=Math.max(4,e),JSON.stringify(function e(t,r){if("object"!=typeof t||null==t)return t;if(r>=n)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map((t=>e(t,r+1)));const a={};for(const n of Object.keys(t))a[n]=e(t[n],r+1);return a}(r,0),null,2));var r,n;return`${this.constructor.lc_name()} ${t}`}}function o(e){return Array.isArray(e)&&e.every((e=>"number"==typeof e.index))}function c(e,t){const r={...e};for(const[e,n]of Object.entries(t))if(null==r[e])r[e]=n;else{if(null==n)continue;if(typeof r[e]!=typeof n||Array.isArray(r[e])!==Array.isArray(n))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e]){if("type"===e)continue;r[e]+=n}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=l(r[e],n);else{if(r[e]===n)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=c(r[e],n)}return r}function l(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const r=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=r.findIndex((t=>t.index===e.index));-1!==t?r[t]=c(r[t],e):r.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}}function u(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return l(e,t);if("object"==typeof e&&"object"==typeof t)return c(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class d extends s{}function h(e){return"string"==typeof e.role}function p(e){return"function"==typeof e?._getType}function f(e){return p(e)&&"function"==typeof e.concat}},4301:(e,t,r)=>{r.d(t,{XU:()=>i,bU:()=>o,cM:()=>a,kY:()=>s});var n=r(3490);class a extends n.XQ{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return a}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class i extends n.gj{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}function s(e){return"generic"===e._getType()}function o(e){return"generic"===e._getType()}},8675:(e,t,r)=>{r.d(t,{AP:()=>s,FK:()=>i,mg:()=>a,vl:()=>o});var n=r(3490);class a extends n.XQ{static lc_name(){return"FunctionMessage"}constructor(e,t){"string"==typeof e&&(e={content:e,name:t}),super(e)}_getType(){return"function"}}class i extends n.gj{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}function s(e){return"function"===e._getType()}function o(e){return"function"===e._getType()}},5454:(e,t,r)=>{r.d(t,{GZ:()=>o,a7:()=>i,di:()=>s,xc:()=>a});var n=r(3490);class a extends n.XQ{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class i extends n.gj{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function s(e){return"human"===e.getType()}function o(e){return"human"===e.getType()}},1673:(e,t,r)=>{r.r(t),r.d(t,{AIMessage:()=>n.Od,AIMessageChunk:()=>n.H,BaseMessage:()=>a.XQ,BaseMessageChunk:()=>a.gj,ChatMessage:()=>i.cM,ChatMessageChunk:()=>i.XU,FunctionMessage:()=>s.mg,FunctionMessageChunk:()=>s.FK,HumanMessage:()=>o.xc,HumanMessageChunk:()=>o.a7,RemoveMessage:()=>d,SystemMessage:()=>c.tn,SystemMessageChunk:()=>c.uU,ToolMessage:()=>h.uf,ToolMessageChunk:()=>h.dr,_isMessageFieldWithRole:()=>a.dp,_mergeDicts:()=>a.ns,_mergeLists:()=>a.Vt,_mergeObj:()=>a.F7,_mergeStatus:()=>a.Iv,coerceMessageLikeToMessage:()=>l.K0,convertToChunk:()=>l.ih,defaultTextSplitter:()=>E,filterMessages:()=>f,getBufferString:()=>l.Sw,isAIMessage:()=>n.KX,isAIMessageChunk:()=>n.jm,isBaseMessage:()=>a.ny,isBaseMessageChunk:()=>a.AJ,isChatMessage:()=>i.kY,isChatMessageChunk:()=>i.bU,isFunctionMessage:()=>s.AP,isFunctionMessageChunk:()=>s.vl,isHumanMessage:()=>o.di,isHumanMessageChunk:()=>o.GZ,isOpenAIToolCallArray:()=>a.Ao,isSystemMessage:()=>c.X4,isSystemMessageChunk:()=>c.UF,isToolMessage:()=>h.wk,isToolMessageChunk:()=>h.P,mapChatMessagesToStoredMessages:()=>l.Js,mapStoredMessageToChatMessage:()=>l.Pz,mapStoredMessagesToChatMessages:()=>l.rf,mergeContent:()=>a._I,mergeMessageRuns:()=>g,trimMessages:()=>y});var n=r(7765),a=r(3490),i=r(4301),s=r(8675),o=r(5454),c=r(7974),l=r(6362),u=r(7896);class d extends a.XQ{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}var h=r(8009);const p=(e,t)=>{const r=[...new Set(t?.map((e=>{if("string"==typeof e)return e;const t=new e({});if(!("_getType"in t)||"function"!=typeof t._getType)throw new Error("Invalid type provided.");return t._getType()})))],n=e._getType();return r.some((e=>e===n))};function f(e,t){return Array.isArray(e)?m(e,t):u.jY.from((t=>m(t,e)))}function m(e,t={}){const{includeNames:r,excludeNames:n,includeTypes:a,excludeTypes:i,includeIds:s,excludeIds:o}=t,c=[];for(const t of e)n&&t.name&&n.includes(t.name)||i&&p(t,i)||o&&t.id&&o.includes(t.id)||(a||s||r?(r&&t.name&&r.some((e=>e===t.name))||a&&p(t,a)||s&&t.id&&s.some((e=>e===t.id)))&&c.push(t):c.push(t));return c}function g(e){return Array.isArray(e)?b(e):u.jY.from(b)}function b(e){if(!e.length)return[];const t=[];for(const r of e){const e=r,n=t.pop();if(n)if("tool"===e._getType()||e._getType()!==n._getType())t.push(n,e);else{const r=(0,l.ih)(n),a=(0,l.ih)(e),i=r.concat(a);"string"==typeof r.content&&"string"==typeof a.content&&(i.content=`${r.content}\n${a.content}`),t.push(k(i))}else t.push(e)}return t}function y(e,t){if(Array.isArray(e)){const r=e;if(!t)throw new Error("Options parameter is required when providing messages.");return v(r,t)}{const t=e;return u.jY.from((e=>v(e,t)))}}async function v(e,t){const{maxTokens:r,tokenCounter:n,strategy:a="last",allowPartial:i=!1,endOn:s,startOn:o,includeSystem:c=!1,textSplitter:l}=t;if(o&&"first"===a)throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&"first"===a)throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;u="getNumTokens"in n?async e=>(await Promise.all(e.map((e=>n.getNumTokens(e.content))))).reduce(((e,t)=>e+t),0):async e=>n(e);let d=E;if(l&&(d="splitText"in l?l.splitText:async e=>l(e)),"first"===a)return _(e,{maxTokens:r,tokenCounter:u,textSplitter:d,partialStrategy:i?"first":void 0,endOn:s});if("last"===a)return async function(e,t){const{allowPartial:r=!1,includeSystem:n=!1,endOn:a,startOn:i,...s}=t;if(a){const t=Array.isArray(a)?a:[a];for(;e&&!p(e[e.length-1],t);)e.pop()}const o=n&&"system"===e[0]._getType();let c=o?e.slice(0,1).concat(e.slice(1).reverse()):e.reverse();return c=await _(c,{...s,partialStrategy:r?"last":void 0,endOn:i}),o?[c[0],...c.slice(1).reverse()]:c.reverse()}(e,{maxTokens:r,tokenCounter:u,textSplitter:d,allowPartial:i,includeSystem:c,startOn:o,endOn:s});throw new Error(`Unrecognized strategy: '${a}'. Must be one of 'first' or 'last'.`)}async function _(e,t){const{maxTokens:r,tokenCounter:n,textSplitter:a,partialStrategy:i,endOn:s}=t;let o=[...e],c=0;for(let e=0;e<o.length;e+=1){const t=e>0?o.slice(0,-e):o;if(await n(t)<=r){c=o.length-e;break}}if(c<o.length-1&&i){let e=!1;if(Array.isArray(o[c].content)){const t=o[c];if("string"==typeof t.content)throw new Error("Expected content to be an array.");const a=t.content.length,s="last"===i?[...t.content].reverse():t.content;for(let l=1;l<=a;l+=1){const a="first"===i?s.slice(0,l):s.slice(-l),u=Object.fromEntries(Object.entries(t).filter((([e])=>"type"!==e&&!e.startsWith("lc_")))),d=O(t._getType(),{...u,content:a}),h=[...o.slice(0,c),d];if(!(await n(h)<=r))break;o=h,c+=1,e=!0}e&&"last"===i&&(t.content=[...s].reverse())}if(!e){const e=o[c];let t;if(Array.isArray(e.content)&&e.content.some((e=>"string"==typeof e||"text"===e.type))){const r=e.content.find((e=>"text"===e.type&&e.text));t=r?.text}else"string"==typeof e.content&&(t=e.content);if(t){const s=await a(t),l=s.length;"last"===i&&s.reverse();for(let t=0;t<l-1;t+=1)if(s.pop(),e.content=s.join(""),await n([...o.slice(0,c),e])<=r){"last"===i&&(e.content=[...s].reverse().join("")),o=[...o.slice(0,c),e],c+=1;break}}}}if(s){const e=Array.isArray(s)?s:[s];for(;c>0&&!p(o[c-1],e);)c-=1}return o.slice(0,c)}const w={human:{message:o.xc,messageChunk:o.a7},ai:{message:n.Od,messageChunk:n.H},system:{message:c.tn,messageChunk:c.uU},tool:{message:h.uf,messageChunk:h.dr},function:{message:s.mg,messageChunk:s.FK},generic:{message:i.cM,messageChunk:i.XU},remove:{message:d,messageChunk:d}};function O(e,t,r){let a,l;switch(e){case"human":r?a=new o.a7(t):l=new o.xc(t);break;case"ai":if(r){let e={...t};"tool_calls"in e&&(e={...e,tool_call_chunks:e.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),a=new n.H(e)}else l=new n.Od(t);break;case"system":r?a=new c.uU(t):l=new c.tn(t);break;case"tool":if(!("tool_call_id"in t))throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");r?a=new h.dr(t):l=new h.uf(t);break;case"function":if(r)a=new s.FK(t);else{if(!t.name)throw new Error("FunctionMessage must have a 'name' field");l=new s.mg(t)}break;case"generic":if(!("role"in t))throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");r?a=new i.XU(t):l=new i.cM(t);break;default:throw new Error(`Unrecognized message type ${e}`)}if(r&&a)return a;if(l)return l;throw new Error(`Unrecognized message type ${e}`)}function k(e){const t=e._getType();let r;const n=Object.fromEntries(Object.entries(e).filter((([e])=>!["type","tool_call_chunks"].includes(e)&&!e.startsWith("lc_"))));if(t in w&&(r=O(t,n)),!r)throw new Error(`Unrecognized message chunk class ${t}. Supported classes are ${Object.keys(w)}`);return r}function E(e){const t=e.split("\n");return Promise.resolve([...t.slice(0,-1).map((e=>`${e}\n`)),t[t.length-1]])}},7974:(e,t,r)=>{r.d(t,{UF:()=>o,X4:()=>s,tn:()=>a,uU:()=>i});var n=r(3490);class a extends n.XQ{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class i extends n.gj{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function s(e){return"system"===e._getType()}function o(e){return"system"===e._getType()}},8009:(e,t,r)=>{r.d(t,{P:()=>c,dr:()=>i,p1:()=>s,uf:()=>a,wk:()=>o});var n=r(3490);class a extends n.XQ{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){"string"==typeof e&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class i extends n.gj{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),artifact:(0,n.F7)(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(0,n.Iv)(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function s(e){const t=[],r=[];for(const n of e)if(n.function){const e=n.function.name;try{const r={name:e||"",args:JSON.parse(n.function.arguments)||{},id:n.id};t.push(r)}catch(t){r.push({name:e,args:n.function.arguments,id:n.id,error:"Malformed args."})}}return[t,r]}function o(e){return"tool"===e._getType()}function c(e){return"tool"===e._getType()}},6362:(e,t,r)=>{r.d(t,{Js:()=>y,K0:()=>f,Pz:()=>g,Sw:()=>m,ih:()=>v,rf:()=>b});var n=r(1368),a=r(199),i=r(7765),s=r(3490),o=r(4301),c=r(8675),l=r(5454),u=r(7974),d=r(8009);function h(e){return(0,a.K)(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function p(e){let t,r;if("object"==typeof(a=e)&&null!=a&&1===a.lc&&Array.isArray(a.id)&&null!=a.kwargs&&"object"==typeof a.kwargs){const n=e.id.at(-1);t="HumanMessage"===n||"HumanMessageChunk"===n?"user":"AIMessage"===n||"AIMessageChunk"===n?"assistant":"SystemMessage"===n||"SystemMessageChunk"===n?"system":"unknown",r=e.kwargs}else{const{type:n,...a}=e;t=n,r=a}var a;if("human"===t||"user"===t)return new l.xc(r);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=r;if(!Array.isArray(e))return new i.Od(r);const n=e.map(h);return new i.Od({...t,tool_calls:n})}if("system"===t)return new u.tn(r);if("tool"===t&&"tool_call_id"in r)return new d.uf({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});throw(0,n.Y)(new Error(`Unable to coerce message from array: only human, AI, system, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function f(e){if("string"==typeof e)return new l.xc(e);if((0,s.ny)(e))return e;if(Array.isArray(e)){const[t,r]=e;return p({type:t,content:r})}if((0,s.dp)(e)){const{role:t,...r}=e;return p({...r,type:t})}return p(e)}function m(e,t="Human",r="AI"){const n=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=r;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const i=a.name?`${a.name}, `:"",s="string"==typeof a.content?a.content:JSON.stringify(a.content,null,2);n.push(`${e}: ${i}${s}`)}return n.join("\n")}function g(e){const t=function(e){if(void 0!==e.data)return e;{const t=e;return{type:t.type,data:{content:t.text,role:t.role,name:void 0,tool_call_id:void 0}}}}(e);switch(t.type){case"human":return new l.xc(t.data);case"ai":return new i.Od(t.data);case"system":return new u.tn(t.data);case"function":if(void 0===t.data.name)throw new Error("Name must be defined for function messages");return new c.mg(t.data);case"tool":if(void 0===t.data.tool_call_id)throw new Error("Tool call ID must be defined for tool messages");return new d.uf(t.data);case"generic":if(void 0===t.data.role)throw new Error("Role must be defined for chat messages");return new o.cM(t.data);default:throw new Error(`Got unexpected type: ${t.type}`)}}function b(e){return e.map(g)}function y(e){return e.map((e=>e.toDict()))}function v(e){const t=e._getType();if("human"===t)return new l.a7({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),new i.H({...t})}if("system"===t)return new u.uU({...e});if("function"===t)return new c.FK({...e});if(o.cM.isInstance(e))return new o.XU({...e});throw new Error("Unknown message type.")}},8028:(e,t,r)=>{r.r(t),r.d(t,{ChatGenerationChunk:()=>i,GenerationChunk:()=>a,RUN_KEY:()=>n});const n="__run";class a{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new a({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class i extends a{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new i({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},5311:(e,t,r)=>{r.r(t),r.d(t,{BasePromptValue:()=>s,ChatPromptValue:()=>c,ImagePromptValue:()=>l,StringPromptValue:()=>o});var n=r(7380),a=r(5454),i=r(6362);class s extends n.Serializable{}class o extends s{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new a.xc(this.value)]}}class c extends s{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,i.Sw)(this.messages)}toChatMessages(){return this.messages}}class l extends s{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new a.xc({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}},6993:(e,t,r)=>{r.d(t,{m:()=>a});var n=r(7896);class a extends n.YN{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[e,n]of Object.entries(t))r[e]="string"==typeof n?n:await n();return{...r,...e}}async invoke(e,t){return this._callWithConfig((e=>this.formatPromptValue(e)),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,3650));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,3650));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then(r.bind(r,2771));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}},3766:(e,t,r)=>{r.d(t,{BJ:()=>_,FS:()=>y,GL:()=>p,OT:()=>f,RZ:()=>O,Wn:()=>g,pl:()=>h,qF:()=>m,sS:()=>v});var n=r(1673),a=r(5311),i=r(7896),s=r(329),o=r(6993),c=r(3650),l=r(6279),u=r(9849),d=r(1368);class h extends i.YN{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig((e=>this.formatMessages(e)),e,{...t,runType:"prompt"})}}class p extends h{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const e=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let r;try{r=Array.isArray(t)?t.map(n.coerceMessageLikeToMessage):[(0,n.coerceMessageLikeToMessage)(t)]}catch(e){const r="string"==typeof t?t:JSON.stringify(t,null,2),n=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${r}`,`Additional message: ${e.message}`].join("\n\n"));throw n.name="InputFormatError",n.lc_error_code=e.lc_error_code,n}return r}}class f extends h{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class m extends o.m{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new a.ChatPromptValue(t)}}class g extends f{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new n.ChatMessage(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(c.PromptTemplate.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}}class b extends h{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach((t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))})),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass())return new(t._messageClass())({content:e});if(t.chatMessageClass){const r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(c.PromptTemplate.fromTemplate(e,t));const r=[];for(const n of e)if("string"==typeof n||"object"==typeof n&&"text"in n){let e="";"string"==typeof n?e=n:"string"==typeof n.text&&(e=n.text??"");const a={...t,..."string"!=typeof n?{additionalContentFields:n}:{}};r.push(c.PromptTemplate.fromTemplate(e,a))}else if("object"==typeof n&&"image_url"in n){let e,a=n.image_url??"",i=[];if("string"==typeof a){let r;r="mustache"===t?.templateFormat?(0,u.g2)(a):(0,u.D4)(a);const s=r.flatMap((e=>"variable"===e.type?[e.name]:[]));if((s?.length??0)>0){if(s.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${s}\nFrom: ${a}`);i=[s[0]]}else i=[];a={url:a},e=new l.C({template:a,inputVariables:i,templateFormat:t?.templateFormat,additionalContentFields:n})}else{if("object"!=typeof a)throw new Error("Invalid image template");if("url"in a){let e;e="mustache"===t?.templateFormat?(0,u.g2)(a.url):(0,u.D4)(a.url),i=e.flatMap((e=>"variable"===e.type?[e.name]:[]))}else i=[];e=new l.C({template:a,inputVariables:i,templateFormat:t?.templateFormat,additionalContentFields:n})}r.push(e)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof s.L){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const r of this.prompt){let n={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const t of r.inputVariables)n||(n={[t]:e[t]}),n={...n,[t]:e[t]};if(r instanceof s.L){const e=await r.format(n);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),t.push({...a,type:"text",text:e})}else if(r instanceof l.C){const e=await r.format(n);let a;"additionalContentFields"in r&&(a=r.additionalContentFields),t.push({...a,type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class y extends b{static _messageClass(){return n.HumanMessage}static lc_name(){return"HumanMessagePromptTemplate"}}class v extends b{static _messageClass(){return n.AIMessage}static lc_name(){return"AIMessagePromptTemplate"}}class _ extends b{static _messageClass(){return n.SystemMessage}static lc_name(){return"SystemMessagePromptTemplate"}}function w(e,t){if("function"==typeof e.formatMessages||(0,n.isBaseMessage)(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const t=e[1];if("string"!=typeof t||"{"!==t[0]||"}"!==t[t.length-1])throw new Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);const r=t.slice(1,-1);return new p({variableName:r,optional:!0})}const r=(0,n.coerceMessageLikeToMessage)(e);let a;if(a="string"==typeof r.content?r.content:r.content.map((e=>"text"in e?{...e,text:e.text}:"image_url"in e?{...e,image_url:e.image_url}:e)),"human"===r._getType())return y.fromTemplate(a,t);if("ai"===r._getType())return v.fromTemplate(a,t);if("system"===r._getType())return _.fromTemplate(a,t);if(n.ChatMessage.isInstance(r))return g.fromTemplate(r.content,r.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${r._getType()}".`)}class O extends m{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof n.BaseMessage))for(const r of t.inputVariables)e.add(r);const t=this.inputVariables,r=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),a=new Set([...r].filter((t=>!e.has(t))));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const i=new Set([...e].filter((e=>!r.has(e))));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const r=await Promise.all(e.content.map((async e=>{if("image_url"!==e.type)return e;let r="";r="string"==typeof e.image_url?e.image_url:e.image_url.url;const n=c.PromptTemplate.fromTemplate(r,{templateFormat:this.templateFormat}),a=await n.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=a:e.image_url=a,e})));return e.content=r,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const e of this.promptMessages)if(e instanceof n.BaseMessage)r.push(await this._parseImagePrompts(e,t));else{const n=e.inputVariables.reduce(((r,n)=>{if(!(n in t||"MessagesPlaceholder"===e.constructor.lc_name()&&e.optional))throw(0,d.Y)(new Error(`Missing value for input variable \`${n.toString()}\``),"INVALID_PROMPT_INPUT");return r[n]=t[n],r}),{}),a=await e.formatMessages(n);r=r.concat(a)}return r}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new O(n)}static fromTemplate(e,t){const r=c.PromptTemplate.fromTemplate(e,t),n=new y({prompt:r});return this.fromMessages([n])}static fromMessages(e,t){const r=e.reduce(((e,r)=>e.concat(r instanceof O?r.promptMessages:[w(r,t)])),[]),a=e.reduce(((e,t)=>t instanceof O?Object.assign(e,t.partialVariables):e),Object.create(null)),i=new Set;for(const e of r)if(!(e instanceof n.BaseMessage))for(const t of e.inputVariables)t in a||i.add(t);return new this({...t,inputVariables:[...i],promptMessages:r,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}},2771:(e,t,r)=>{r.d(t,{FewShotPromptTemplate:()=>o,s:()=>c});var n=r(329),a=r(9849),i=r(3650),s=r(3766);class o extends n.L{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new o(n)}async format(e){const t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=await Promise.all(r.map((e=>this.examplePrompt.format(e)))),i=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return(0,a.Xm)(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const r=await i.PromptTemplate.deserialize(t);let n;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return n=e.examples,new o({inputVariables:e.input_variables,examplePrompt:r,examples:n,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}class c extends s.qF{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??"\n\n",this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.prefix+this.suffix,this.templateFormat,e)}}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=await this.getExamples(t);r=r.map((e=>{const t={};return this.examplePrompt.inputVariables.forEach((r=>{t[r]=e[r]})),t}));const n=[];for(const e of r){const t=await this.examplePrompt.formatMessages(e);n.push(...t)}return n}async format(e){const t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=(await Promise.all(r.map((e=>this.examplePrompt.formatMessages(e))))).flat().map((e=>e.content)),i=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return(0,a.Xm)(i,this.templateFormat,t)}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new c(n)}}},6279:(e,t,r)=>{r.d(t,{C:()=>s});var n=r(5311),a=r(6993),i=r(9849);class s extends a.m{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,i.Ns)([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new s(n)}async format(e){const t={};for(const[r,n]of Object.entries(this.template))t[r]="string"==typeof n?(0,i.Xm)(n,this.templateFormat,e):n;const r=e.url||t.url,n=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if("string"!=typeof r)throw new Error("url must be a string.");const a={url:r};return n&&(a.detail=n),a}async formatPromptValue(e){const t=await this.format(e);return new n.ImagePromptValue(t)}}},3650:(e,t,r)=>{r.d(t,{PromptTemplate:()=>i});var n=r(329),a=r(9849);class i extends n.L{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return(0,a.Xm)(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n="\n\n",a=""){const s=[a,...e,t].join(n);return new i({inputVariables:r,template:s})}static fromTemplate(e,t){const{templateFormat:r="f-string",...n}=t??{},s=new Set;return(0,a.QC)(e,r).forEach((e=>{"variable"===e.type&&s.add(e.name)})),new i({inputVariables:[...s],templateFormat:r,template:e,...n})}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new i(n)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new i({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}},329:(e,t,r)=>{r.d(t,{L:()=>i});var n=r(5311),a=r(6993);class i extends a.m{async formatPromptValue(e){const t=await this.format(e);return new n.StringPromptValue(t)}}},9849:(e,t,r)=>{r.d(t,{ez:()=>x,RG:()=>j,Ns:()=>A,Vt:()=>T,Qs:()=>P,D4:()=>E,g2:()=>S,QC:()=>I,Xm:()=>C});var n=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===n.call(e)};function i(e){return"function"==typeof e}function s(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(e,t){return null!=e&&"object"==typeof e&&t in e}var c=RegExp.prototype.test,l=/\S/;var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},d=/\s*/,h=/\s+/,p=/\s*=/,f=/\s*\}/,m=/#|\^|\/|>|\{|&|=|!/;function g(e){this.string=e,this.tail=e,this.pos=0}function b(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function y(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}g.prototype.eos=function(){return""===this.tail},g.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r},g.prototype.scanUntil=function(e){var t,r=this.tail.search(e);switch(r){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=t.length,t},b.prototype.push=function(e){return new b(e,this)},b.prototype.lookup=function(e){var t,r,n,a=this.cache;if(a.hasOwnProperty(e))t=a[e];else{for(var s,c,l,u=this,d=!1;u;){if(e.indexOf(".")>0)for(s=u.view,c=e.split("."),l=0;null!=s&&l<c.length;)l===c.length-1&&(d=o(s,c[l])||(r=s,n=c[l],null!=r&&"object"!=typeof r&&r.hasOwnProperty&&r.hasOwnProperty(n))),s=s[c[l++]];else s=u.view[e],d=o(u.view,e);if(d){t=s;break}u=u.parent}a[e]=t}return i(t)&&(t=t.call(this.view)),t},y.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},y.prototype.parse=function(e,t){var r=this.templateCache,n=e+":"+(t||v.tags).join(":"),i=void 0!==r,o=i?r.get(n):void 0;return null==o&&(o=function(e,t){if(!e)return[];var r,n,i,o,u=!1,b=[],y=[],_=[],w=!1,O=!1,k="",E=0;function S(){if(w&&!O)for(;_.length;)delete y[_.pop()];else _=[];w=!1,O=!1}function T(e){if("string"==typeof e&&(e=e.split(h,2)),!a(e)||2!==e.length)throw new Error("Invalid tags: "+e);r=new RegExp(s(e[0])+"\\s*"),n=new RegExp("\\s*"+s(e[1])),i=new RegExp("\\s*"+s("}"+e[1]))}T(t||v.tags);for(var P,x,j,C,I,A,R=new g(e);!R.eos();){if(P=R.pos,j=R.scanUntil(r))for(var N=0,$=j.length;N<$;++N)o=C=j.charAt(N),function(e,t){return c.call(e,t)}(l,o)?(O=!0,u=!0,k+=" "):(_.push(y.length),k+=C),y.push(["text",C,P,P+1]),P+=1,"\n"===C&&(S(),k="",E=0,u=!1);if(!R.scan(r))break;if(w=!0,x=R.scan(m)||"name",R.scan(d),"="===x?(j=R.scanUntil(p),R.scan(p),R.scanUntil(n)):"{"===x?(j=R.scanUntil(i),R.scan(f),R.scanUntil(n),x="&"):j=R.scanUntil(n),!R.scan(n))throw new Error("Unclosed tag at "+R.pos);if(I=">"==x?[x,j,P,R.pos,k,E,u]:[x,j,P,R.pos],E++,y.push(I),"#"===x||"^"===x)b.push(I);else if("/"===x){if(!(A=b.pop()))throw new Error('Unopened section "'+j+'" at '+P);if(A[1]!==j)throw new Error('Unclosed section "'+A[1]+'" at '+P)}else"name"===x||"{"===x||"&"===x?O=!0:"="===x&&T(j)}if(S(),A=b.pop())throw new Error('Unclosed section "'+A[1]+'" at '+R.pos);return function(e){for(var t,r=[],n=r,a=[],i=0,s=e.length;i<s;++i)switch((t=e[i])[0]){case"#":case"^":n.push(t),a.push(t),n=t[4]=[];break;case"/":a.pop()[5]=t[2],n=a.length>0?a[a.length-1][4]:r;break;default:n.push(t)}return r}(function(e){for(var t,r,n=[],a=0,i=e.length;a<i;++a)(t=e[a])&&("text"===t[0]&&r&&"text"===r[0]?(r[1]+=t[1],r[3]=t[3]):(n.push(t),r=t));return n}(y))}(e,t),i&&r.set(n,o)),o},y.prototype.render=function(e,t,r,n){var a=this.getConfigTags(n),i=this.parse(e,a),s=t instanceof b?t:new b(t,void 0);return this.renderTokens(i,s,r,e,n)},y.prototype.renderTokens=function(e,t,r,n,a){for(var i,s,o,c="",l=0,u=e.length;l<u;++l)o=void 0,"#"===(s=(i=e[l])[0])?o=this.renderSection(i,t,r,n,a):"^"===s?o=this.renderInverted(i,t,r,n,a):">"===s?o=this.renderPartial(i,t,r,a):"&"===s?o=this.unescapedValue(i,t):"name"===s?o=this.escapedValue(i,t,a):"text"===s&&(o=this.rawValue(i)),void 0!==o&&(c+=o);return c},y.prototype.renderSection=function(e,t,r,n,s){var o=this,c="",l=t.lookup(e[1]);if(l){if(a(l))for(var u=0,d=l.length;u<d;++u)c+=this.renderTokens(e[4],t.push(l[u]),r,n,s);else if("object"==typeof l||"string"==typeof l||"number"==typeof l)c+=this.renderTokens(e[4],t.push(l),r,n,s);else if(i(l)){if("string"!=typeof n)throw new Error("Cannot use higher-order sections without the original template");null!=(l=l.call(t.view,n.slice(e[3],e[5]),(function(e){return o.render(e,t,r,s)})))&&(c+=l)}else c+=this.renderTokens(e[4],t,r,n,s);return c}},y.prototype.renderInverted=function(e,t,r,n,i){var s=t.lookup(e[1]);if(!s||a(s)&&0===s.length)return this.renderTokens(e[4],t,r,n,i)},y.prototype.indentPartial=function(e,t,r){for(var n=t.replace(/[^ \t]/g,""),a=e.split("\n"),i=0;i<a.length;i++)a[i].length&&(i>0||!r)&&(a[i]=n+a[i]);return a.join("\n")},y.prototype.renderPartial=function(e,t,r,n){if(r){var a=this.getConfigTags(n),s=i(r)?r(e[1]):r[e[1]];if(null!=s){var o=e[6],c=e[5],l=e[4],u=s;0==c&&l&&(u=this.indentPartial(s,l,o));var d=this.parse(u,a);return this.renderTokens(d,t,r,u,n)}}},y.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(null!=r)return r},y.prototype.escapedValue=function(e,t,r){var n=this.getConfigEscape(r)||v.escape,a=t.lookup(e[1]);if(null!=a)return"number"==typeof a&&n===v.escape?String(a):n(a)},y.prototype.rawValue=function(e){return e[1]},y.prototype.getConfigTags=function(e){return a(e)?e:e&&"object"==typeof e?e.tags:void 0},y.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!a(e)?e.escape:void 0};var v={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){_.templateCache=e},get templateCache(){return _.templateCache}},_=new y;v.clearCache=function(){return _.clearCache()},v.parse=function(e,t){return _.parse(e,t)},v.render=function(e,t,r,n){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+(a(i=e)?"array":typeof i)+'" was given as the first argument for mustache#render(template, view, partials)');var i;return _.render(e,t,r,n)},v.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return u[e]}))},v.Scanner=g,v.Context=b,v.Writer=y;const w=v;var O=r(1368);function k(){w.escape=e=>e}const E=e=>{const t=e.split(""),r=[],n=(e,r)=>{for(let n=r;n<t.length;n+=1)if(e.includes(t[n]))return n;return-1};let a=0;for(;a<t.length;)if("{"===t[a]&&a+1<t.length&&"{"===t[a+1])r.push({type:"literal",text:"{"}),a+=2;else if("}"===t[a]&&a+1<t.length&&"}"===t[a+1])r.push({type:"literal",text:"}"}),a+=2;else if("{"===t[a]){const e=n("}",a);if(e<0)throw new Error("Unclosed '{' in template.");r.push({type:"variable",name:t.slice(a+1,e).join("")}),a=e+1}else{if("}"===t[a])throw new Error("Single '}' in template.");{const e=n("{}",a),i=(e<0?t.slice(a):t.slice(a,e)).join("");r.push({type:"literal",text:i}),a=e<0?t.length:e}}return r},S=e=>(k(),(e=>e.map((e=>"name"===e[0]?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]})))(w.parse(e))),T=(e,t)=>E(e).reduce(((e,r)=>{if("variable"===r.type){if(r.name in t)return e+("string"==typeof t[r.name]?t[r.name]:JSON.stringify(t[r.name]));throw new Error(`(f-string) Missing value for input ${r.name}`)}return e+r.text}),""),P=(e,t)=>(k(),w.render(e,t)),x={"f-string":T,mustache:P},j={"f-string":E,mustache:S},C=(e,t,r)=>{try{return x[t](e,r)}catch(e){throw(0,O.Y)(e,"INVALID_PROMPT_INPUT")}},I=(e,t)=>j[t](e),A=(e,t,r)=>{if(!(t in x)){const e=Object.keys(x);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const n=r.reduce(((e,t)=>(e[t]="foo",e)),{});Array.isArray(e)?e.forEach((e=>{if("text"===e.type)C(e.text,t,n);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)C(e.image_url,t,n);else{const r=e.image_url.url;C(r,t,n)}}})):C(e,t,n)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}}},7896:(e,t,r)=>{r.d(t,{YN:()=>T,B2:()=>M,fJ:()=>P,Vi:()=>x,jY:()=>R,ck:()=>I,Pq:()=>N,Fm:()=>D,AO:()=>j,zZ:()=>C,pG:()=>F,lH:()=>$,GH:()=>S,Bp:()=>L});var n=r(4476),a=r(4116),i=r(477),s=r(3389),o=r(1060),c=r(4102),l=r(7380),u=r(58),d=r(9830),h=r(765),p=r(9624),f=r(1590);class m extends f.BaseTracer{constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}var g=r(4850),b=r(8521),y=r(9475),v=r(7481).ZY;function _(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function w(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*O(e,t){for(;;){const{value:r,done:n}=b.Nx.runWithConfig(e,t.next.bind(t),!0);if(n)break;yield r}}async function*k(e,t){const r=t[Symbol.asyncIterator]();for(;;){const{value:n,done:a}=await b.Nx.runWithConfig(e,r.next.bind(t),!0);if(a)break;yield n}}var E=r(199);function S(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class T extends l.Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new P({bound:this,kwargs:e,config:{}})}map(){return new x({bound:this})}withRetry(e){return new j({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new P({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new $({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(h.ZI);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,n)=>(0,h.ZI)(0===n?e:r)))}return Array.from({length:t},(()=>(0,h.ZI)(e)))}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=n[0]?.maxConcurrency??r?.maxConcurrency,i=new p.AsyncCaller({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,n[t])}catch(e){if(r?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=(0,h.ZI)(t),n=new u.AsyncGeneratorWithSetup({generator:this._streamIterator(e,r),config:r});return await n.setup,u.IterableReadableStream.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?(0,h.ZI)(e):(0,h.ZI)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const n=(0,h.ZI)(r),a=await(0,h.kJ)(n),i=await(a?.handleChainStart(this.toJSON(),S(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName()));let s;delete n.runId;try{const a=e.call(this,t,n,i);s=await(0,d.o)(a,r?.signal)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(S(s,"output"))),s}async _batchWithConfig(e,t,r,n){const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(h.kJ)),s=await Promise.all(i.map((async(e,r)=>{const n=await(e?.handleChainStart(this.toJSON(),S(t[r],"input"),a[r].runId,a[r].runType,void 0,void 0,a[r].runName??this.getName()));return delete a[r].runId,n})));let o;try{const r=e.call(this,t,a,s,n);o=await(0,d.o)(r,a?.[0]?.signal)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(S(o,"output"))))),o}async*_transformStreamWithConfig(e,t,r){let n,a,i=!0,s=!0;const l=(0,h.ZI)(r),d=await(0,h.kJ)(l);let p;try{const h=await(0,u.pipeGeneratorWithSetup)(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===n)n=t;else try{n=(0,u.concat)(n,t)}catch{n=void 0,i=!1}yield t}}(),(async()=>d?.handleChainStart(this.toJSON(),{input:""},l.runId,l.runType,void 0,void 0,l.runName??this.getName())),r?.signal,l);delete l.runId,p=h.setup;const f=p?.handlers.find(c.K);let m=h.output;void 0!==f&&void 0!==p&&(m=f.tapOutputIterable(p.runId,m));const g=p?.handlers.find(o.isLogStreamHandler);void 0!==g&&void 0!==p&&(m=g.tapOutputIterable(p.runId,m));for await(const e of m)if(yield e,s)if(void 0===a)a=e;else try{a=(0,u.concat)(a,e)}catch{a=void 0,s=!1}}catch(e){throw await(p?.handleChainError(e,void 0,void 0,void 0,{inputs:S(n,"input")})),e}await(p?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:S(n,"input")}))}getGraph(e){const t=new y.T,r=t.addNode({name:`${this.getName()}Input`,schema:n.z.any()}),a=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:n.z.any()});return t.addEdge(r,a),t.addEdge(a,i),t}pipe(e){return new C({first:this,last:L(e)})}pick(e){return this.pipe(new D(e))}assign(e){return this.pipe(new M(new I({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:(0,u.concat)(r,t);yield*this._streamIterator(r,(0,h.ZI)(t))}async*streamLog(e,t,r){const n=new o.LogStreamCallbackHandler({...r,autoClose:!1,_schemaFormat:"original"}),a=(0,h.ZI)(t);yield*this._streamLog(e,n,a)}async*_streamLog(e,t,r){const{callbacks:n}=r;if(void 0===n)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{const e=n.copy();e.addHandler(t,!0),r.callbacks=e}const a=this.stream(e,r),i=async function(){try{const e=await a;for await(const r of e){const e=new o.RunLogPatch({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}streamEvents(e,t,r){let n;if("v1"===t.version)n=this._streamEventsV1(e,t,r);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');n=this._streamEventsV2(e,t,r)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,r=new v({async start(r){for await(const n of e)r.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(n)}\n\n`));r.enqueue(t.encode("event: end\n\n")),r.close()}});return u.IterableReadableStream.fromReadableStream(r)}(n):u.IterableReadableStream.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,r){const n=new c.s({...r,autoClose:!1}),a=(0,h.ZI)(t),s=a.runId??(0,i.A)();a.runId=s;const o=a.callbacks;if(void 0===o)a.callbacks=[n];else if(Array.isArray(o))a.callbacks=o.concat(n);else{const e=o.copy();e.addHandler(n,!0),a.callbacks=e}const l=this,u=async function(){try{const t=await l.stream(e,a),r=n.tapOutputIterable(s,t);for await(const e of r);}finally{await n.finish()}}();let d,p=!1;try{for await(const t of n)p?(t.run_id===d&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,p=!0,d=t.run_id,yield t)}finally{await u}}async*_streamEventsV1(e,t,r){let n,a=!1;const i=(0,h.ZI)(t),s=i.tags??[],c=i.metadata??{},l=i.runName??this.getName(),u=new o.LogStreamCallbackHandler({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new g.G({...r}),p=this._streamLog(e,u,i);for await(const t of p){if(n=n?n.concat(t):o.RunLog.fromRunLogPatch(t),void 0===n.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...n.state},r={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:s,metadata:c,data:{input:e}};d.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(r)];for(const e of i){let t,r={};const a=n.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(r.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(r.input=a.inputs),r.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);r={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:r}}const{state:u}=n;if(u.streamed_output.length>0){const e=u.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${u.name}"`);const t={chunk:u.streamed_output[0]};u.streamed_output=[];const r={event:`on_${u.type}_stream`,run_id:u.id,tags:s,metadata:c,name:l,data:t};d.includeEvent(r,u.type)&&(yield r)}}const f=n?.state;if(void 0!==f){const e={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:s,metadata:c,data:{output:f.final_output}};d.includeEvent(e,f.type)&&(yield e)}}static isRunnable(e){return(0,g.T)(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new P({bound:this,config:{},configFactories:[n=>({callbacks:[new m({config:n,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return function(e,t){const r=t.name??e.getName(),a=t.description??t.schema?.description;return t.schema.constructor===n.z.ZodString?new F({name:r,description:a,schema:n.z.object({input:n.z.string()}).transform((e=>e.input)),bound:e}):new F({name:r,description:a,schema:t.schema,bound:e})}(this,e)}}class P extends T{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=(0,h.SV)(this.config,...e);return(0,h.SV)(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig((0,h.ZI)(t),this.kwargs))}async batch(e,t,r){const n=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig((0,h.ZI)(e),this.kwargs)))):await this._mergeConfig((0,h.ZI)(t),this.kwargs);return this.bound.batch(e,n,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig((0,h.ZI)(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig((0,h.ZI)(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig((0,h.ZI)(t),this.kwargs))}streamEvents(e,t,r){const n=this;return u.IterableReadableStream.fromAsyncGenerator(async function*(){yield*n.bound.streamEvents(e,{...await n._mergeConfig((0,h.ZI)(t),n.kwargs),version:t.version},r)}())}static isRunnableBinding(e){return e.bound&&T.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new P({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new m({config:n,onStart:e,onEnd:t,onError:r})]})]})}}class x extends T{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new x({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,(0,h.tn)(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new x({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class j extends P{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const n=e>1?`retry:attempt:${e}`:void 0;return(0,h.tn)(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return a((n=>super.invoke(e,this._patchConfigForRetry(n,t,r))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,n){const i={};try{await a((async a=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),o=s.map((t=>e[t])),c=s.map((e=>this._patchConfigForRetry(a,t?.[e],r?.[e]))),l=await super.batch(o,c,{...n,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],r=s[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),i[r.toString()]=t}if(u)throw u;return l}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==n?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class C extends T{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=(0,h.ZI)(t),n=await(0,h.kJ)(r),a=await(n?.handleChainStart(this.toJSON(),S(e,"input"),r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;let i,s=e;try{const e=[this.first,...this.middle];for(let n=0;n<e.length;n+=1){const i=e[n].invoke(s,(0,h.tn)(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${n+1}`)}));s=await(0,d.o)(i,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");i=await this.last.invoke(s,(0,h.tn)(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(S(i,"output"))),i}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(h.kJ)),i=await Promise.all(a.map((async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),S(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a})));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(s,i.map(((t,r)=>{const a=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return(0,h.tn)(n[r],{callbacks:a})})),r);s=await(0,d.o)(t,n[0]?.signal)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(S(s,"output"))))),s}async*_streamIterator(e,t){const r=await(0,h.kJ)(t),{runId:n,...a}=t??{},i=await(r?.handleChainStart(this.toJSON(),S(e,"input"),n,void 0,void 0,void 0,a?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let r=s[0].transform(async function*(){yield e}(),(0,h.tn)(a,{callbacks:i?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<s.length;e+=1){const t=s[e];r=await t.transform(r,(0,h.tn)(a,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of r)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=(0,u.concat)(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(S(o,"output")))}getGraph(e){const t=new y.T;let r=null;return this.steps.forEach(((n,a)=>{const i=n.getGraph(e);0!==a&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${n} has no first node`);r&&t.addEdge(r,s),r=i.lastNode()})),t}pipe(e){return C.isRunnableSequence(e)?new C({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new C({first:this.first,middle:[...this.middle,this.last],last:L(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&T.isRunnable(e)}static from([e,...t],r){let n={};return"string"==typeof r?n.name=r:void 0!==r&&(n=r),new C({...n,first:L(e),middle:t.slice(0,-1).map(L),last:L(t[t.length-1])})}}class I extends T{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=L(r)}static from(e){return new I({steps:e})}async invoke(e,t){const r=(0,h.ZI)(t),n=await(0,h.kJ)(r),a=await(n?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;const i={};try{const n=Object.entries(this.steps).map((async([t,n])=>{i[t]=await n.invoke(e,(0,h.tn)(r,{callbacks:a?.getChild(`map:key:${t}`)}))}));await(0,d.o)(Promise.all(n),t?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(i)),i}async*_transform(e,t,r){const n={...this.steps},a=(0,u.atee)(e,Object.keys(n).length),i=new Map(Object.entries(n).map((([e,n],i)=>{const s=n.transform(a[i],(0,h.tn)(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const e=Promise.race(i.values()),{key:t,result:n,gen:a}=await(0,d.o)(e,r?.signal);i.delete(t),n.done||(yield{[t]:n.value},i.set(t,a.next().then((e=>({key:t,gen:a,result:e})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=(0,h.ZI)(t),n=new u.AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,u.IterableReadableStream.fromAsyncGenerator(n)}}class A extends T{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!(0,s.GZ)(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),n=await(0,h.kJ)(r),a=this.func((0,h.tn)(r,{callbacks:n}),e);return(0,d.o)(a,r?.signal)}async*_streamIterator(e,t){const[r]=this._getOptionsList(t??{},1),n=await this.invoke(e,t);var a;if(w(n))for await(const e of n)r?.signal?.throwIfAborted(),yield e;else if(null!=(a=n)&&"object"==typeof a&&"next"in a&&"function"==typeof a.next)for(;;){r?.signal?.throwIfAborted();const e=n.next();if(e.done)break;yield e.value}else yield n}static from(e){return new A({func:e})}}class R extends T{static lc_name(){return"RunnableLambda"}constructor(e){if((0,s.GZ)(e.func))return A.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if((0,s.GZ)(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new R({func:e})}async _invoke(e,t,r){return new Promise(((n,a)=>{const i=(0,h.tn)(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??h.p_)-1});b.Nx.runWithConfig(i,(async()=>{try{let r=await this.func(e,{...i});if(r&&T.isRunnable(r)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");r=await r.invoke(e,{...i,recursionLimit:(i.recursionLimit??h.p_)-1})}else if(w(r)){let e;for await(const n of k(i,r))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=(0,u.concat)(e,n)}catch(t){e=n}r=e}else if(_(r)){let e;for(const n of O(i,r))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=(0,u.concat)(e,n)}catch(t){e=n}r=e}n(r)}catch(e){a(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){let n;for await(const t of e)if(void 0===n)n=t;else try{n=(0,u.concat)(n,t)}catch(e){n=t}const a=(0,h.tn)(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??h.p_)-1}),i=await new Promise(((e,t)=>{b.Nx.runWithConfig(a,(async()=>{try{const t=await this.func(n,{...a,config:a});e(t)}catch(e){t(e)}}))}));if(i&&T.isRunnable(i)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(n,a);for await(const t of e)yield t}else if(w(i))for await(const e of k(a,i))r?.signal?.throwIfAborted(),yield e;else if(_(i))for(const e of O(a,i))r?.signal?.throwIfAborted(),yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=(0,h.ZI)(t),n=new u.AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,u.IterableReadableStream.fromAsyncGenerator(n)}}class N extends I{}class $ extends T{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=(0,h.ZI)(t),n=await(0,h.kJ)(t),{runId:a,...i}=r,s=await(n?.handleChainStart(this.toJSON(),S(e,"input"),a,void 0,void 0,void 0,i?.runName));let o;for(const t of this.runnables()){r?.signal?.throwIfAborted();try{const r=await t.invoke(e,(0,h.tn)(i,{callbacks:s?.getChild()}));return await(s?.handleChainEnd(S(r,"output"))),r}catch(e){void 0===o&&(o=e)}}if(void 0===o)throw new Error("No error stored at end of fallback.");throw await(s?.handleChainError(o)),o}async*_streamIterator(e,t){const r=(0,h.ZI)(t),n=await(0,h.kJ)(t),{runId:a,...i}=r,s=await(n?.handleChainStart(this.toJSON(),S(e,"input"),a,void 0,void 0,void 0,i?.runName));let o,c,l;for(const t of this.runnables()){r?.signal?.throwIfAborted();const n=(0,h.tn)(i,{callbacks:s?.getChild()});try{c=await t.stream(e,n);break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(s?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:(0,u.concat)(l,e)}catch(e){l=void 0}}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(S(l,"output")))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map((e=>(0,h.kJ)(e)))),i=await Promise.all(a.map((async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),S(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a})));let s;for(const t of this.runnables()){n[0].signal?.throwIfAborted();try{const a=await t.batch(e,i.map(((e,t)=>(0,h.tn)(n[t],{callbacks:e?.getChild()}))),r);return await Promise.all(i.map(((e,t)=>e?.handleChainEnd(S(a[t],"output"))))),a}catch(e){void 0===s&&(s=e)}}if(!s)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(i.map((e=>e?.handleChainError(s)))),s}}function L(e){if("function"==typeof e)return new R({func:e});if(T.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,n]of Object.entries(e))t[r]=L(n);return new I({steps:t})}}class M extends T{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof I&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const n=this.mapper.getStepsKeys(),[a,i]=(0,u.atee)(e),s=this.mapper.transform(i,(0,h.tn)(r,{callbacks:t?.getChild()})),o=s.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!n.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=(0,h.ZI)(t),n=new u.AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,u.IterableReadableStream.fromAsyncGenerator(n)}}class D extends T{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=(0,h.ZI)(t),n=new u.AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,u.IterableReadableStream.fromAsyncGenerator(n)}}class F extends P{constructor(e){super({bound:C.from([R.from((async e=>{let t;if((0,E.K)(e))try{t=await this.schema.parseAsync(e.args)}catch(t){throw new E.q("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t})).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}},765:(e,t,r)=>{r.d(t,{SV:()=>o,ZI:()=>l,kJ:()=>s,p_:()=>i,tn:()=>u});var n=r(7715),a=r(8521);const i=25;async function s(e){return n.CallbackManager._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function o(...e){const t={};for(const r of e.filter((e=>!!e)))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){const n=t[e]??[];t[e]=[...new Set(n.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=r.timeout:void 0!==r.timeout&&(t.timeout=Math.min(t.timeout,r.timeout));else if("signal"===e)void 0===t.signal?t.signal=r.signal:void 0!==r.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if("callbacks"===e){const e=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{const r=e.copy();for(const e of a)r.addHandler((0,n.ensureHandler)(e),!0);t.callbacks=r}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){const r=a.copy();for(const t of e)r.addHandler((0,n.ensureHandler)(t),!0);t.callbacks=r}else t.callbacks=new n.CallbackManager(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else{const n=e;t[n]=r[n]??t[n]}return t}const c=new Set(["string","number","boolean"]);function l(e){const t=a.Nx.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:n,...a}=t;r=Object.entries(a).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)}if(e&&(r=Object.entries(e).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)),r?.configurable)for(const e of Object.keys(r.configurable))c.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);if(void 0!==r.timeout){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(r.timeout);void 0!==r.signal?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,e])):r.signal=e,delete r.timeout}return r}function u(e={},{callbacks:t,maxConcurrency:r,recursionLimit:n,runName:a,configurable:i,runId:s}={}){const o=l(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==n&&(o.recursionLimit=n),void 0!==r&&(o.maxConcurrency=r),void 0!==a&&(o.runName=a),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}},9475:(e,t,r)=>{r.d(t,{T:()=>d});var n=r(2522),a=r(8227),i=r(477),s=r(4850);function o(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const c=["*","_","`"];function l(e,t){if(void 0!==e&&!(0,a.A)(e))return e;if(!(0,s.T)(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function u(e){return(0,s.T)(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...(0,n.Ik)(e.data.schema),title:e.data.name}}}class d{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,r)=>{e[t.id]=(0,a.A)(t.id)?r:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...u(t)}))),edges:this.edges.map((t=>{const r={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(r.data=t.data),void 0!==t.conditional&&(r.conditional=t.conditional),r}))}}addNode(e,t,r){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t??(0,i.A)(),a={id:n,data:e,name:l(t,e),metadata:r};return this.nodes[n]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,r,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:r,conditional:n};return this.edges.push(a),a}firstNode(){return h(this)}lastNode(){return p(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map((e=>e.id)).every(a.A)&&(r="");const n=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[n(e)]={...t,id:n(e)}}));const i=e.edges.map((e=>({...e,source:n(e.source),target:n(e.target)})));this.edges=[...this.edges,...i];const s=e.firstNode(),o=e.lastNode();return[s?{id:n(s.id),data:s.data}:void 0,o?{id:n(o.id),data:o.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&h(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&p(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map((e=>[e.id,e.name]))),t=new Map;Object.values(e).forEach((e=>{t.set(e,(t.get(e)||0)+1)}));const r=r=>{const n=e[r];return(0,a.A)(r)&&1===t.get(n)?n:r};return new d({nodes:Object.fromEntries(Object.entries(this.nodes).map((([e,t])=>[r(e),{...t,id:r(e)}]))),edges:this.edges.map((e=>({...e,source:r(e.source),target:r(e.target)})))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:n={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},i=this.reid(),s=i.firstNode(),l=i.lastNode();return function(e,t,r){const{firstNode:n,lastNode:a,nodeColors:i,withStyles:s=!0,curveStyle:l="linear",wrapLabelNWords:u=9}=r??{};let d=s?`%%{init: {'flowchart': {'curve': '${l}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(s){const t="default",r={[t]:"{0}({1})"};void 0!==n&&(r[n]="{0}([{1}]):::first"),void 0!==a&&(r[a]="{0}([{1}]):::last");for(const[n,a]of Object.entries(e)){const e=a.name.split(":").pop()??"";let i=c.some((t=>e.startsWith(t)&&e.endsWith(t)))?`<p>${e}</p>`:e;Object.keys(a.metadata??{}).length&&(i+=`<hr/><small><em>${Object.entries(a.metadata??{}).map((([e,t])=>`${e} = ${t}`)).join("\n")}</em></small>`);const s=(r[n]??r[t]).replace("{0}",o(n)).replace("{1}",i);d+=`\t${s}\n`}}const h={};for(const e of t){const t=e.source.split(":"),r=e.target.split(":"),n=t.filter(((e,t)=>e===r[t])).join(":");h[n]||(h[n]=[]),h[n].push(e)}const p=new Set;function f(e,t){const r=1===e.length&&e[0].source===e[0].target;if(t&&!r){const e=t.split(":").pop();if(p.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);p.add(e),d+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:r,data:n,conditional:a}=t;let i="";if(void 0!==n){let e=n;const t=e.split(" ");t.length>u&&(e=Array.from({length:Math.ceil(t.length/u)},((e,r)=>t.slice(r*u,(r+1)*u).join(" "))).join("&nbsp;<br>&nbsp;")),i=a?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else i=a?" -.-> ":" --\x3e ";d+=`\t${o(e)}${i}${o(r)};\n`}for(const e in h)e.startsWith(`${t}:`)&&e!==t&&f(h[e],e);t&&!r&&(d+="\tend\n")}f(h[""]??[],"");for(const e in h)e.includes(":")||""===e||f(h[e],e);return s&&(d+=function(e){let t="";for(const[r,n]of Object.entries(e))t+=`\tclassDef ${r} ${n};\n`;return t}(i??{})),d}(i.nodes,i.edges,{firstNode:s?.id,lastNode:l?.id,withStyles:t,curveStyle:r,nodeColors:n,wrapLabelNWords:a})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:r="white"}=t??{};const n=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const a=`https://mermaid.ink/img/${n}?bgColor=${r}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function h(e,t=[]){const r=new Set(e.edges.filter((e=>!t.includes(e.source))).map((e=>e.target))),n=[];for(const a of Object.values(e.nodes))t.includes(a.id)||r.has(a.id)||n.push(a);return 1===n.length?n[0]:void 0}function p(e,t=[]){const r=new Set(e.edges.filter((e=>!t.includes(e.target))).map((e=>e.source))),n=[];for(const a of Object.values(e.nodes))t.includes(a.id)||r.has(a.id)||n.push(a);return 1===n.length?n[0]:void 0}},4850:(e,t,r)=>{function n(e){return!!e&&e.lc_runnable}r.d(t,{G:()=>a,T:()=>n});class a{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const n=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||n.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&n.every((e=>!this.excludeTags?.includes(e)))),r}}},8521:(e,t,r)=>{r.d(t,{Nx:()=>l});var n=r(1259),a=r(7715);const i=new class{getStore(){}run(e,t){return t()}enterWith(e){}},s=Symbol.for("ls:tracing_async_local_storage"),o=Symbol.for("lc:child_config"),c=Symbol.for("lc:context_variables"),l=new class{getInstance(){return globalThis[s]??i}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[o]}runWithConfig(e,t,r){const i=a.CallbackManager._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),s=this.getInstance(),l=s.getStore(),u=i?.getParentRunId(),d=i?.handlers?.find((e=>"langchain_tracer"===e?.name));let h;return d&&u?h=d.convertToRunTree(u):r||(h=new n.gk({name:"<runnable_lambda>",tracingEnabled:!1})),h&&(h.extra={...h.extra,[o]:e}),void 0!==l&&void 0!==l[c]&&(h[c]=l[c]),s.run(h,t)}initializeGlobalInstance(e){void 0===globalThis[s]&&(globalThis[s]=e)}}},199:(e,t,r)=>{function n(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}r.d(t,{K:()=>n,q:()=>a});class a extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}},1590:(e,t,r)=>{r.r(t),r.d(t,{BaseTracer:()=>s,isBaseTracer:()=>i});var n=r(5960);function a(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function i(e){return"function"==typeof e._addRunToRunMap}class s extends n.BaseCallbackHandler{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=function(e,t,r){const n=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),r={...e};if(void 0!==r.parent_run_id){const e=this.runMap.get(r.parent_run_id);e&&(this._addChildRun(e,r),e.child_execution_order=Math.max(e.child_execution_order,r.child_execution_order),r.trace_id=e.trace_id,void 0!==e.dotted_order&&(r.dotted_order=[e.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),l=Date.now(),u=s?{...a,metadata:s}:a,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,n,a,i,s,o){const c=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),l=Date.now(),u=s?{...a,metadata:s}:a,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,n,a,i,s,o){const c=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}_createRunForChainStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,r,n,a,i,s,o){const c=this.runMap.get(r)??this._createRunForChainStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,r,n,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=a(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=a(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,r,n,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=a(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}_createRunForToolStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,n,a,i,s){const o=this.runMap.get(r)??this._createRunForToolStart(e,t,r,n,a,i,s);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}_createRunForRetrieverStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,n,a,i,s){const o=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,n,a,i,s);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,n,a,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}},6906:(e,t,r)=>{r.r(t),r.d(t,{ConsoleCallbackHandler:()=>u});var n=r(4083),a=r(1590);function i(e,t){return`${e.open}${t}${e.close}`}function s(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function o(e){return"string"==typeof e?e.trim():null==e?e:s(e,e.toString())}function c(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:l}=n;class u extends a.BaseTracer{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,r)=>{const a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?i(n.bold,a):a})).join(" > ");return i(l.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[chain/start]")} [${t}] Entering Chain run with input: ${s(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[chain/end]")} [${t}] [${c(e)}] Exiting Chain run with output: ${s(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[chain/error]")} [${t}] [${c(e)}] Chain run errored with error: ${s(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${i(l.green,"[llm/start]")} [${t}] Entering LLM run with input: ${s(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[llm/end]")} [${t}] [${c(e)}] Exiting LLM run with output: ${s(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[llm/error]")} [${t}] [${c(e)}] LLM run errored with error: ${s(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[tool/start]")} [${t}] Entering Tool run with input: "${o(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[tool/end]")} [${t}] [${c(e)}] Exiting Tool run with output: "${o(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[tool/error]")} [${t}] [${c(e)}] Tool run errored with error: ${s(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${s(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.cyan,"[retriever/end]")} [${t}] [${c(e)}] Exiting Retriever run with output: ${s(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${i(l.red,"[retriever/error]")} [${t}] [${c(e)}] Retriever run errored with error: ${s(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${i(l.blue,"[agent/action]")} [${r}] Agent selected action: ${s(t.actions[t.actions.length-1],"[action]")}`)}}},4102:(e,t,r)=>{r.d(t,{K:()=>l,s:()=>u});var n=r(1590),a=r(58),i=r(7765),s=r(8028),o=r(7481).Rv;function c({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const l=e=>"event_stream_tracer"===e.name;class u extends n.BaseTracer{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new o,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=a.IterableReadableStream.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const n=this.runInfoMap.get(e);if(void 0===n)return void(yield r.value);function a(e,t){return"llm"===e&&"string"==typeof t?new s.GenerationChunk({text:t}):t}let i=this.tappedPromises.get(e);if(void 0===i){let s;i=new Promise((e=>{s=e})),this.tappedPromises.set(e,i);try{const i={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...i,data:{chunk:a(n.runType,r.value)}},n),yield r.value;for await(const e of t)"tool"!==n.runType&&"retriever"!==n.runType&&await this.send({...i,data:{chunk:a(n.runType,e)}},n),yield e}finally{s()}}else{yield r.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);void 0!==r?r.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=c(e),r=void 0!==e.inputs.messages?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,n);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,r){const n=this.runInfoMap.get(e.id);let a,o;if(void 0===n)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===n.runType)o="on_chat_model_stream",a=void 0===r?.chunk?new i.H({content:t,id:`run-${e.id}`}):r.chunk.message;else{if("llm"!==n.runType)throw new Error(`Unexpected run type ${n.runType}`);o="on_llm_stream",a=void 0===r?.chunk?new s.GenerationChunk({text:t}):r.chunk}await this.send({event:o,data:{chunk:a},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let r;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const n=e.outputs?.generations;let a;if("chat_model"===t.runType){for(const e of n??[]){if(void 0!==a)break;a=e[0]?.message}r="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);a={generations:n?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end"}await this.sendEndEvent({event:r,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=c(e),r=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let a={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(a={},n.inputs={}):void 0!==e.inputs.input?(a.input=e.inputs.input,n.inputs=e.inputs.input):(a.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${r}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:n};n.input&&1===Object.keys(n).length&&(a.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:r,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=c(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=c(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const n=this.runInfoMap.get(r);if(void 0===n)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}},1060:(e,t,r)=>{r.r(t),r.d(t,{LogStreamCallbackHandler:()=>p,RunLog:()=>l,RunLogPatch:()=>c,isLogStreamHandler:()=>u});var n=r(6150),a=r(1590),i=r(58),s=r(7765),o=r(7481).Rv;class c{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=(0,n.X6)({},t);return new l({ops:t,state:r[r.length-1].newDocument})}}class l extends c{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=(0,n.X6)(this.state,e.ops);return new l({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=(0,n.X6)({},e.ops);return new l({ops:e.ops,state:t[t.length-1].newDocument})}}const u=e=>"log_stream_tracer"===e.name;async function d(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function h(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}class p extends a.BaseTracer{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new o,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=i.IterableReadableStream.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new c({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new c({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await d(e,this._schemaFormat)),await this.writer.write(new c({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await d(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await h(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new c({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new c({ops:[{op:"replace",path:"/final_output",value:await h(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const n=this.keyMapByRunId[e.id];if(void 0===n)return;let a;var i;void 0!==e.inputs.messages?(i=r?.chunk,a=void 0!==i&&void 0!==i.message?r?.chunk:new s.H({id:`run-${e.id}`,content:t})):a=t;const o=new c({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:a}]});await this.writer.write(o)}}},1201:(e,t,r)=>{r.r(t),r.d(t,{LangChainTracer:()=>c});var n=r(1259),a=r(3246),i=r(3389),s=r(9583),o=r(1590);class c extends o.BaseTracer{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??(0,s.getEnvironmentVariable)("LANGCHAIN_PROJECT")??(0,s.getEnvironmentVariable)("LANGCHAIN_SESSION"),this.exampleId=t;const i="false"===(0,s.getEnvironmentVariable)("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};this.client=a??new n.Kj(i);const o=c.getTraceableRunTree();o&&this.updateFromRunTree(o)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await(0,s.getRuntimeEnvironment)()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);)t=t.parent_run;r.clear();const n=[t];for(;n.length>0;){const e=n.shift();e&&!r.has(e.id)&&(r.add(e.id),this.runMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[e,n]of this.runMap){const i=new a.gk({...n,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[e]=i,r.push([e,n.dotted_order])}r.sort(((e,t)=>e[1]&&t[1]?e[1].localeCompare(t[1]):0));for(const[e]of r){const r=this.runMap.get(e),n=t[e];if(r&&n&&r.parent_run_id){const e=t[r.parent_run_id];e&&(e.child_runs.push(n),n.parent_run=e)}}return t[e]}static getTraceableRunTree(){try{return(0,i.vR)()}catch{return}}}},9624:(e,t,r)=>{r.r(t),r.d(t,{AsyncCaller:()=>o});var n=r(4116),a=r(3290);const i=[400,401,402,403,404,405,406,407,409],s=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&i.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s;const t=a.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>n((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}},9583:(e,t,r)=>{r.r(t),r.d(t,{getEnv:()=>c,getEnvironmentVariable:()=>d,getRuntimeEnvironment:()=>u,isBrowser:()=>n,isDeno:()=>s,isJsDom:()=>i,isNode:()=>o,isWebWorker:()=>a});const n=()=>"undefined"!=typeof window&&void 0!==window.document,a=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,i=()=>"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),s=()=>"undefined"!=typeof Deno,o=()=>"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node&&!s(),c=()=>{let e;return e=n()?"browser":o()?"node":a()?"webworker":i()?"jsdom":s()?"deno":"other",e};let l;async function u(){if(void 0===l){const e=c();l={library:"langchain-js",runtime:e}}return l}function d(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}},6150:(e,t,r)=>{r.d(t,{X6:()=>v,UD:()=>S});var n={};r.r(n),r.d(n,{JsonPatchError:()=>p,_areEquals:()=>k,applyOperation:()=>y,applyPatch:()=>v,applyReducer:()=>_,deepClone:()=>f,getValueByPointer:()=>b,validate:()=>O,validator:()=>w});const a=Object.prototype.hasOwnProperty;function i(e,t){return a.call(e,t)}function s(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)i(e,r)&&t.push(r);return t}function o(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function c(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),!(n>=48&&n<=57))return!1;t++}return!0}function l(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function u(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(u(e[t]))return!0}else if("object"==typeof e){const r=s(e),n=r.length;for(var t=0;t<n;t++)if(u(e[r[t]]))return!0}return!1}function d(e,t){const r=[e];for(const e in t){const n="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==n&&r.push(`${e}: ${n}`)}return r.join("\n")}class h extends Error{constructor(e,t,r,n,a){super(d(e,{name:t,index:r,operation:n,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=d(e,{name:t,index:r,operation:n,tree:a})}}const p=h,f=o,m={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=b(r,this.path);n&&(n=o(n));const a=y(r,{op:"remove",path:this.from}).removed;return y(r,{op:"add",path:this.path,value:a}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=b(r,this.from);return y(r,{op:"add",path:this.path,value:o(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:k(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var g={add:function(e,t,r){return c(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:m.move,copy:m.copy,test:m.test,_get:m._get};function b(e,t){if(""==t)return e;var r={op:"_get",path:t};return y(e,r),r.value}function y(e,t,r=!1,n=!0,a=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):w(t,0)),""===t.path){let n={newDocument:e};if("add"===t.op)return n.newDocument=t.value,n;if("replace"===t.op)return n.newDocument=t.value,n.removed=e,n;if("move"===t.op||"copy"===t.op)return n.newDocument=b(e,t.from),"move"===t.op&&(n.removed=e),n;if("test"===t.op){if(n.test=k(e,t.value),!1===n.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n.newDocument=e,n}if("remove"===t.op)return n.removed=e,n.newDocument=null,n;if("_get"===t.op)return t.value=e,n;if(r)throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return n}{n||(e=o(e));const s=(t.path||"").split("/");let l,u,d,h=e,f=1,b=s.length;for(d="function"==typeof r?r:w;;){if(u=s[f],u&&-1!=u.indexOf("~")&&(u=u.replace(/~1/g,"/").replace(/~0/g,"~")),a&&("__proto__"==u||"prototype"==u&&f>0&&"constructor"==s[f-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===l&&(void 0===h[u]?l=s.slice(0,f).join("/"):f==b-1&&(l=t.path),void 0!==l&&d(t,0,e,l)),f++,Array.isArray(h)){if("-"===u)u=h.length;else{if(r&&!c(u))throw new p("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);c(u)&&(u=~~u)}if(f>=b){if(r&&"add"===t.op&&u>h.length)throw new p("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const n=g[t.op].call(t,h,u,e);if(!1===n.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n}}else if(f>=b){const r=m[t.op].call(t,h,u,e);if(!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(h=h[u],r&&f<b&&(!h||"object"!=typeof h))throw new p("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function v(e,t,r,n=!0,a=!0){if(r&&!Array.isArray(t))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=o(e));const i=new Array(t.length);for(let n=0,s=t.length;n<s;n++)i[n]=y(e,t[n],r,!0,a,n),e=i[n].newDocument;return i.newDocument=e,i}function _(e,t,r){const n=y(e,t);if(!1===n.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function w(e,t,r,n){if("object"!=typeof e||null===e||Array.isArray(e))throw new p("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!m[e.op])throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new p("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new p('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new p("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&u(e.value))throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var a=e.path.split("/").length,i=n.split("/").length;if(a!==i+1&&a!==i)throw new p("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==n)throw new p("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=O([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new p("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function O(e,t,r){try{if(!Array.isArray(e))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)v(o(t),o(e),r||!0);else{r=r||w;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(e){if(e instanceof p)return e;throw e}}function k(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,n,a,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((n=e.length)!=t.length)return!1;for(r=n;0!=r--;)if(!k(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((n=o.length)!==Object.keys(t).length)return!1;for(r=n;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=n;0!=r--;)if(!k(e[a=o[r]],t[a]))return!1;return!0}return e!=e&&t!=t}function E(e,t,r,n,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var c=s(t),u=s(e),d=!1,h=u.length-1;h>=0;h--){var p=e[m=u[h]];if(!i(t,m)||void 0===t[m]&&void 0!==p&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&r.push({op:"test",path:n+"/"+l(m),value:o(p)}),r.push({op:"remove",path:n+"/"+l(m)}),d=!0):(a&&r.push({op:"test",path:n,value:e}),r.push({op:"replace",path:n,value:t}));else{var f=t[m];"object"==typeof p&&null!=p&&"object"==typeof f&&null!=f&&Array.isArray(p)===Array.isArray(f)?E(p,f,r,n+"/"+l(m),a):p!==f&&(a&&r.push({op:"test",path:n+"/"+l(m),value:o(p)}),r.push({op:"replace",path:n+"/"+l(m),value:o(f)}))}}if(d||c.length!=u.length)for(h=0;h<c.length;h++){var m;i(e,m=c[h])||void 0===t[m]||r.push({op:"add",path:n+"/"+l(m),value:o(t[m])})}}}function S(e,t,r=!1){var n=[];return E(e,t,n,"",r),n}new WeakMap},780:(e,t,r)=>{function n(e,t=a){e=e.trim();const r=/```(json)?(.*)```/s.exec(e);return t(r?r[2]:e)}function a(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const r=[];let n=!1,a=!1;for(let i of e){if(n)'"'!==i||a?"\n"!==i||a?a="\\"===i&&!a:i="\\n":n=!1;else if('"'===i)n=!0,a=!1;else if("{"===i)r.push("}");else if("["===i)r.push("]");else if("}"===i||"]"===i){if(!r||r[r.length-1]!==i)return null;r.pop()}t+=i}n&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}r.d(t,{D:()=>n,d:()=>a})},9830:(e,t,r)=>{async function n(e,t){if(void 0===t)return e;let r;return Promise.race([e.catch((e=>{if(!t?.aborted)throw e})),new Promise(((e,n)=>{r=()=>{n(new Error("Aborted"))},t.addEventListener("abort",r),t.aborted&&n(new Error("Aborted"))}))]).finally((()=>t.removeEventListener("abort",r)))}r.d(t,{o:()=>n})},58:(e,t,r)=>{r.r(t),r.d(t,{AsyncGeneratorWithSetup:()=>l,IterableReadableStream:()=>s,atee:()=>o,concat:()=>c,pipeGeneratorWithSetup:()=>u});var n=r(8521),a=r(9830),i=r(7481).ZY;class s extends i{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new s({start:e=>function r(){return t.read().then((({done:t,value:n})=>{if(!t)return e.enqueue(n),r();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new s({async pull(t){const{value:r,done:n}=await e.next();n&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function o(e,t=2){const r=Array.from({length:t},(()=>[]));return r.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function c(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,n]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=c(r[e],n):r[e]=n;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class l{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise(((t,r)=>{n.Nx.runWithConfig(e.config,(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then((e=>t(void 0)),r)}),!0)}))}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?n.Nx.runWithConfig(this.config,this.signal?async()=>(0,a.o)(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function u(e,t,r,n,...a){const i=new l({generator:t,startSetup:r,signal:n}),s=await i.setup;return{output:e(i,s,...a),setup:s}}},2738:(e,t,r)=>{r.d(t,{Kj:()=>A});var n=r(477),a=r(4116),i=r(3290),s=r(747);const o=[400,401,403,404,405,406,407,408],c=[409];class l{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new i.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add((()=>a((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,n=t?.status;if(n){if(o.includes(+n))throw e;if(c.includes(+n))return;r&&await r(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>(0,s.Y)()(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function u(e){return"function"==typeof e?._getType}function d(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var h=r(4785),p=r(6928),f=r(8227);function m(e,t){if(!f.A(e))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}var g=r(6232),b=r(9589);function y(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),n=r||"latest";if(t.includes("/")){const[r,a]=t.split("/",2);if(!r||!a)throw new Error(`Invalid identifier format: ${e}`);return[r,a,n]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}class v extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function _(e,t,r){let n;if(e.ok)return void(r&&(n=await e.text()));n=await e.text();const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${n}`;if(409===e.status)throw new v(a);throw new Error(a)}var w="[...]",O={result:"[Circular]"},k=[],E=[];function S(e,t,r,n){try{return JSON.stringify(e,t,r)}catch(s){if(!s.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";var a;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===n&&(n={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),P(e,"",0,[],void 0,0,n);try{a=0===E.length?JSON.stringify(e,t,r):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,r){if(E.length>0)for(var n=0;n<E.length;n++){var a=E[n];if(a[1]===t&&a[0]===r){r=a[2],E.splice(n,1);break}}return e.call(this,t,r)}}(t),r)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==k.length;){var i=k.pop();4===i.length?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return a}}function T(e,t,r,n){var a=Object.getOwnPropertyDescriptor(n,r);void 0!==a.get?a.configurable?(Object.defineProperty(n,r,{value:e}),k.push([n,r,t,a])):E.push([t,r,e]):(n[r]=e,k.push([n,r,t]))}function P(e,t,r,n,a,i,s){var o;if(i+=1,"object"==typeof e&&null!==e){for(o=0;o<n.length;o++)if(n[o]===e)return void T(O,e,t,a);if(void 0!==s.depthLimit&&i>s.depthLimit)return void T(w,e,t,a);if(void 0!==s.edgesLimit&&r+1>s.edgesLimit)return void T(w,e,t,a);if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)P(e[o],o,o,n,e,i,s);else{var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];P(e[l],l,o,n,e,i,s)}}n.pop()}}function x(e){const t=(0,h.Ec)(),r=(0,h.yk)(),n=e.extra??{},a=n.metadata;return e.extra={...n,runtime:{...t,...n?.runtime},metadata:{...r,...r.revision_id||e.revision_id?{revision_id:e.revision_id??r.revision_id}:{},...a}},e}function j(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const C=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class I{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise((e=>{t=e})),n=S(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:n}),this.sizeBytes+=n,r}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),r+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}class A{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new I}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,h.Az)("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=A.getDefaultClientConfig();if(this.tracingSampleRate=(()=>{const e=(0,h.Jz)("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=j(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=j(e.apiKey??t.apiKey),this.webUrl=j(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new l(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new l({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:C}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=(0,h.Jz)("API_KEY");return{apiUrl:(0,h.Jz)("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===(0,h.Jz)("HIDE_INPUTS"),hideOutputs:"true"===(0,h.Jz)("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(()=>{const e=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===e||"127.0.0.1"===e||"::1"===e})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${p.Ls}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",n=`${this.apiUrl}${e}?${r}`,a=await this.caller.call((0,s.Y)(),n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let n=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(a));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call((0,s.Y)(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,`Failed to fetch ${e}`);const c=r?r(await o.json()):await o.json();if(0===c.length)break;if(yield c,c.length<a)break;n+=c.length}}async*_getCursorPaginatedList(e,t=null,r="POST",n="runs"){const a=t?{...t}:{};for(;;){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)}),i=await t.json();if(!i)break;if(!i[n])break;yield i[n];const o=i.cursors;if(!o)break;if(!o.next)break;a.cursor=o.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.filteredPostUuids.has(r.id)?this.filteredPostUuids.delete(r.id):t.push(r);return t}{const t=[];for(const r of e)r.id!==r.trace_id&&!this.filteredPostUuids.has(r.trace_id)||Math.random()<this.tracingSampleRate?t.push(r):this.filteredPostUuids.add(r.id);return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}drainAutoBatchQueue(e){for(;this.autoBatchQueue.items.length>0;){const[t,r]=this.autoBatchQueue.pop(e);if(!t.length){r();break}this._processBatch(t,r).catch(console.error)}}async _processBatch(e,t){if(e.length)try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},r=await this._ensureServerInfo();r?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}else t()}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=x(e.item));const t=this.autoBatchQueue.push(e),r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)}),this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await(0,s.Y)()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e3),...this.fetchOptions});return await _(e,"get server info"),e.json()}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const n=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void this.processRunOperation({action:"create",item:n}).catch(console.error);const a=x(n),i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:S(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],n=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(r.length>0&&n.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const r of n)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);r=Object.values(e),n=t}const a={post:this._filterForSampling(r),patch:this._filterForSampling(n,!0)};if(!a.post.length&&!a.patch.length)return;if(void 0===(await this._ensureServerInfo()).version){this.autoBatchTracing=!1;for(const e of a.post)await this.createRun(e);for(const e of a.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i={post:[],patch:[]};for(const e of["post","patch"]){const t=e,r=a[t].reverse();let n=r.pop();for(;void 0!==n;)i[t].push(n),n=r.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(S(i))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call((0,s.Y)(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const r={};let n=[];for(const t of e??[]){const e=this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(r[e.id]=e.attachments),delete e.attachments,n.push(e)}let a=[];for(const e of t??[])a.push(this.prepareRunCreateOrUpdateInputs(e));if(void 0!==n.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==a.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(n.length>0&&a.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);n=Object.values(e),a=t}if(0===n.length&&0===a.length)return;const i=[],s=[];for(const[e,t]of[["post",n],["patch",a]])for(const n of t){const{inputs:t,outputs:a,events:o,attachments:c,...l}=n,u={inputs:t,outputs:a,events:o},d=S(l);s.push({name:`${e}.${l.id}`,payload:new Blob([d],{type:`application/json; length=${d.length}`})});for(const[t,r]of Object.entries(u)){if(void 0===r)continue;const n=S(r);s.push({name:`${e}.${l.id}.${t}`,payload:new Blob([n],{type:`application/json; length=${n.length}`})})}if(void 0!==l.id){const e=r[l.id];if(e){delete r[l.id];for(const[t,[r,n]]of Object.entries(e))t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${l.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):s.push({name:`attachment.${l.id}.${t}`,payload:new Blob([n],{type:`${r}; length=${n.byteLength}`})})}}i.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(s,i.join("; "))}async _sendMultipartRequest(e,t){try{const t=new FormData;for(const r of e)t.append(r.name,r.payload);await this.batchIngestCaller.call((0,s.Y)(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:t,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(e){let r="Failed to multipart ingest runs";e instanceof Error?r+=`: ${e.stack||e.message}`:r+=`: ${String(e)}`,console.warn(`${r.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){m(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization?void await this.processRunOperation({action:"update",item:r}).catch(console.error):void this.processRunOperation({action:"update",item:r}).catch(console.error);const n={...this.headers,"Content-Type":"application/json"},a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:n,body:S(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){m(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:(0,h.Jz)("PROJECT")||"default"})).id;const n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({id:e.child_run_ids})),r={},n={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in r||(r[e.parent_run_id]=[]),r[e.parent_run_id].push(e),n[e.id]=e}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(n[t].child_runs=r[t]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:n,traceId:a,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:b}=e;let y=[];if(t&&(y=Array.isArray(t)?t:[t]),r){const e=Array.isArray(r)?r:[r],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));y.push(...t)}const v={session:y.length?y:null,run_type:l,reference_example:i,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:n,start_time:s?s.toISOString():null,error:u,id:d,limit:g,trace:a,select:b||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let _=0;for await(const e of this._getCursorPaginatedList("/runs/query",v))if(g){if(_>=g)break;if(e.length+_>g){const t=e.slice(0,g-_);yield*t;break}_+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:r,runType:n,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:c,endTime:l,error:u,query:d,filter:h,traceFilter:p,treeFilter:f,isRoot:m,dataSourceType:g}){let b=i||[];a&&(b=[...i||[],...await Promise.all(a.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y={id:e,trace:t,parent_run:r,run_type:n,session:b,reference_example:o,start_time:c,end_time:l,error:u,query:d,filter:h,trace_filter:p,tree_filter:f,is_root:m,data_source_type:g},v=Object.fromEntries(Object.entries(y).filter((([e,t])=>void 0!==t))),_=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(v),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _.json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||n.A()};m(e);const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){m(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare run",!0)}async readRunSharedLink(e){m(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);m(e);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await n.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),m(e);const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await r.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};m(e);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await n.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){m(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare dataset",!0)}async readSharedDataset(e){m(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const n=new URLSearchParams;Object.entries(r).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>n.append(e,t))):n.append(e,t)}));const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/examples?${n.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(!a.ok){if("detail"in i)throw new Error(`Failed to list shared examples.\nStatus: ${a.status}\nMessage: ${i.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`)}return i.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:n=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=n?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=a||{};r&&(l.metadata=r);const u={name:e,extra:l,description:t};null!==i&&(u.reference_dataset_id=i);const d=await this.caller.call((0,s.Y)(),c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:n=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=a;n&&(c={...c||{},metadata:n});const l={name:t,extra:c,description:r,end_time:i?new Date(i).toISOString():null},u=await this.caller.call((0,s.Y)(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"update project"),await u.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}${r}?${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let n="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==r&&a.append("include_stats",r.toString());const i=await this._get(n,a);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:n,referenceDatasetName:a,referenceFree:i,metadata:s}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==r&&o.append("name_contains",r),void 0!==n)o.append("reference_dataset",n);else if(void 0!==a){const e=await this.readDataset({datasetName:a});o.append("reference_dataset",e.id)}void 0!==i&&o.append("reference_free",i.toString()),void 0!==s&&o.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,m(r);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:n,description:a,dataType:i,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach((e=>{l.append("input_keys",e)})),n.forEach((e=>{l.append("output_keys",e)})),a&&l.append("description",a),i&&l.append("data_type",i),o&&l.append("name",o);const u=await this.caller.call((0,s.Y)(),c,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"upload CSV"),await u.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:n,outputsSchema:a,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),n&&(o.inputs_schema_definition=n),a&&(o.outputs_schema_definition=a);const c=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(c,"create dataset"),await c.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const n=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)m(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");n.append("name",t)}const a=await this._get(r,n);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:n}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof n?n:n.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:n,datasetNameContains:a,metadata:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)s.append("id",e);void 0!==n&&s.append("name",n),void 0!==a&&s.append("name_contains",a),void 0!==i&&s.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/datasets",s))yield*e}async updateDataset(e){const{datasetId:t,datasetName:r,...n}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:r})).id;m(a);const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",n=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(n=(await this.readDataset({datasetName:t})).id),void 0===n)throw new Error("Must provide datasetName or datasetId");m(n),r+=`/${n}`;const a=await this.caller.call((0,s.Y)(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,`delete ${r}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let n=e;if(!n&&!t)throw new Error("Must provide either datasetName or datasetId");if(n&&t)throw new Error("Must provide either datasetName or datasetId, not both");n||(n=(await this.readDataset({datasetName:t})).id),m(n);const a={tag:r},i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${n}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:n}={}){const a={limit:r,inputs:e};void 0!==n&&(a.filter=n),m(t);const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:n,createdAt:a,exampleId:i,metadata:o,split:c,sourceRunId:l}){let u=r;if(void 0===u&&void 0===n)throw new Error("Must provide either datasetName or datasetId");if(void 0!==u&&void 0!==n)throw new Error("Must provide either datasetName or datasetId, not both");void 0===u&&(u=(await this.readDataset({datasetName:n})).id);const d=a||new Date,h={dataset_id:u,inputs:e,outputs:t,created_at:d?.toISOString(),id:i,metadata:o,split:c,source_run_id:l},p=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(p,"create example"),await p.json()}async createExamples(e){const{inputs:t,outputs:r,metadata:n,sourceRunIds:a,exampleIds:i,datasetId:o,datasetName:c}=e;let l=o;if(void 0===l&&void 0===c)throw new Error("Must provide either datasetName or datasetId");if(void 0!==l&&void 0!==c)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===l){const e=await this.readDataset({datasetName:c});l=e.id}const u=t.map(((t,s)=>({dataset_id:l,inputs:t,outputs:r?r[s]:void 0,metadata:n?n[s]:void 0,split:e.splits?e.splits[s]:void 0,id:i?i[s]:void 0,source_run_id:a?a[s]:void 0}))),d=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(d,"create examples"),await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const n=e.map((e=>u(e)?d(e):e)),a=u(t)?d(t):t;return this.createExample({input:n},{output:a},r)}async readExample(e){m(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:n,splits:a,inlineS3Urls:i,metadata:s,limit:o,offset:c,filter:l}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const d=new URLSearchParams({dataset:u}),h=n?"string"==typeof n?n:n?.toISOString():void 0;h&&d.append("as_of",h);const p=i??!0;if(d.append("inline_s3_urls",p.toString()),void 0!==r)for(const e of r)d.append("id",e);if(void 0!==a)for(const e of a)d.append("splits",e);if(void 0!==s){const e=JSON.stringify(s);d.append("metadata",e)}void 0!==o&&d.append("limit",o.toString()),void 0!==c&&d.append("offset",c.toString()),void 0!==l&&d.append("filter",l);let f=0;for await(const e of this._getPaginated("/examples",d)){for(const t of e)yield t,f++;if(void 0!==o&&f>=o)break}}async deleteExample(e){m(e);const t=`/examples/${e}`,r=await this.caller.call((0,s.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async updateExample(e,t){m(e);const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(r,"update example"),await r.json()}async updateExamples(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");n=void 0===e?(await this.readDataset({datasetName:t})).id:e,m(n);const a=new URLSearchParams,i=r?"string"==typeof r?r:r?.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${n}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:n,remove:a=!1}){let i;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");i=void 0===e?(await this.readDataset({datasetName:t})).id:e,m(i);const o={split_name:r,examples:n.map((e=>(m(e),e))),remove:a},c=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(c,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:n,referenceExample:a}={loadChildRuns:!1}){let i;if((0,g.m)("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:n});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(a=await this.readExample(i.reference_example_id));const s=await t.evaluateRun(i,a),[o,c]=await this._logEvaluationFeedback(s,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:i,comment:o,sourceInfo:c,feedbackSourceType:l="api",sourceRunId:u,feedbackId:d,feedbackConfig:h,projectId:p,comparativeExperimentId:f}){if(!e&&!p)throw new Error("One of runId or projectId must be provided");if(e&&p)throw new Error("Only one of runId or projectId can be provided");const g={type:l??"api",metadata:c??{}};void 0===u||void 0===g?.metadata||g.metadata.__run||(g.metadata.__run={run_id:u}),void 0!==g?.metadata&&void 0!==g.metadata.__run?.run_id&&m(g.metadata.__run.run_id);const b={id:d??n.A(),run_id:e,key:t,score:r,value:a,correction:i,comment:o,feedback_source:g,comparative_experiment_id:f,feedbackConfig:h,session_id:p},y=`${this.apiUrl}/feedback`,v=await this.caller.call((0,s.Y)(),y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(v,"create feedback",!0),b}async updateFeedback(e,{score:t,value:r,correction:n,comment:a}){const i={};null!=t&&(i.score=t),null!=r&&(i.value=r),null!=n&&(i.correction=n),null!=a&&(i.comment=a),m(e);const o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"update feedback",!0)}async readFeedback(e){m(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){m(e);const t=`/feedback/${e}`,r=await this.caller.call((0,s.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const n=new URLSearchParams;if(e&&n.append("run",e.join(",")),t)for(const e of t)n.append("key",e);if(r)for(const e of r)n.append("source",e);for await(const e of this._getPaginated("/feedback",n))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:n}={}){const a={run_id:e,feedback_key:t,feedback_config:n};r?"string"==typeof r?a.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(a.expires_in=r):a.expires_in={hours:3};const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:n,description:a,metadata:i,id:o}){if(0===t.length)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw new Error("A reference dataset is required");const c={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:a,created_at:(n??new Date)?.toISOString(),extra:{}};i&&(c.extra.metadata=i);const l=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await l.json()}async*listPresignedFeedbackTokens(e){m(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,r){const n=this._selectEvalResults(e),a=[];for(const e of n){let n=r||{};e.evaluatorInfo&&(n={...e.evaluatorInfo,...n});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),a.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:n,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[n,a]}async logEvaluationFeedback(e,t,r){const[n]=await this._logEvaluationFeedback(e,t,r);return n}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:n,limit:a}=e,i=new URLSearchParams;t&&t.forEach(((e,t)=>{m(e,`queueIds[${t}]`),i.append("ids",e)})),r&&i.append("name",r),n&&i.append("name_contains",n),i.append("limit",(void 0!==a?Math.min(a,100):100).toString());let s=0;for await(const e of this._getPaginated("/annotation-queues",i))if(yield*e,s++,void 0!==a&&s>=a)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,i={name:t,description:r,id:a||n.A()},o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(i).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(o,"create annotation queue"),await o.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:n}=t,a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:n}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>m(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${m(e,"queueId")}/run`,n=await this.caller.call((0,s.Y)(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"get run from annotation queue"),await n.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${r.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const e="string"==typeof r.detail?r.detail:JSON.stringify(r.detail),n=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw n.statusCode=t.status,n}if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,n,a]=y(e),i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/likes/${r}/${n}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,(t?"like":"unlike")+" prompt"),await i.json()}async _getPromptUrl(e){const[t,r,n]=y(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==n?`${this.getHostUrl()}/prompts/${r}/${n.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==n?`${this.getHostUrl()}/hub/${t}/${r}/${n.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,r,n]=y(e),a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===a.status)return null;await _(a,"get prompt");const i=await a.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[n,a,i]=y(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("create a prompt",n);const o={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},c=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(c,"create prompt");const{repo:l}=await c.json();return l}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,a,i]=y(e),o="latest"!==r?.parentCommitHash&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${n}/${a}`),c={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},l=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${n}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"create commit");const u=await l.json();return this._getPromptUrl(`${n}/${a}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n]=y(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if(void 0!==t?.description&&(a.description=t.description),void 0!==t?.readme&&(a.readme=t.readme),void 0!==t?.tags&&(a.tags=t.tags),void 0!==t?.isPublic&&(a.is_public=t.isPublic),void 0!==t?.isArchived&&(a.is_archived=t.isArchived),0===Object.keys(a).length)throw new Error("No valid update options provided");const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${r}/${n}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,n]=y(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async pullPromptCommit(e,t){const[r,n,a]=y(e);let i=a;if(!function(e){const t=(0,b.parse)(e),r=(0,b.parse)("0.5.23");if(!t||!r)throw new Error("Invalid version format.");return t.compare(r)>=0}((await this._getServerInfo()).version)&&"latest"===a){const e=await this._getLatestCommitHash(`${r}/${n}`);if(!e)throw new Error("No commits found");i=e}const o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${r}/${n}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"pull prompt commit");const c=await o.json();return{owner:r,repo:n,commit_hash:c.commit_hash,manifest:c.manifest,examples:c.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:n}=t,[a,i]=this.parseTokenOrUrl(e,r),s=new A({apiUrl:a,apiKey:"placeholder"}),o=await s.readSharedDataset(i),c=n||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await s.listSharedExamples(i),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map((e=>e.inputs)),outputs:l.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,n="dataset"){try{return m(e),[t,e]}catch(e){}try{const a=new URL(e).pathname.split("/").filter((e=>""!==e));if(a.length>=r)return[t,a[a.length-r]];throw new Error(`Invalid public ${n} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${n} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all([...this.autoBatchQueue.items.map((({itemPromise:e})=>e)),this.batchIngestCaller.queue.onIdle()])}}},6928:(e,t,r)=>{r.d(t,{Kj:()=>n.Kj,Ls:()=>i,gk:()=>a.gk});var n=r(2738),a=r(3246);r(747);const i="0.2.4"},3246:(e,t,r)=>{r.d(t,{gk:()=>l,m5:()=>u});var n=r(477),a=r(4785),i=r(2738),s=r(6232);const o=Symbol.for("lc:context_variables");class c{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let r={},n=[];for(const e of t){const[t,a]=e.split("="),i=decodeURIComponent(a);"langsmith-metadata"===t?r=JSON.parse(i):"langsmith-tags"===t&&(n=i.split(","))}return new c(r,n)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class l{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),u(e))return void Object.assign(this,{...e});const t=l.getDefaultConfig(),{metadata:r,...n}=e,a=n.client??l.getSharedClient(),i={...r,...n?.extra?.metadata};if(n.extra={...n.extra,metadata:i},Object.assign(this,{...t,...n,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const e=function(e,t,r=1){const n=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`.replace(/[-:.]/g,"")+t}(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}static getDefaultConfig(){return{id:n.A(),run_type:"chain",project_name:(0,a.Az)("LANGCHAIN_PROJECT")??(0,a.Az)("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:(0,a.Az)("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:(0,a.Az)("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return l.sharedClient||(l.sharedClient=new i.Kj),l.sharedClient}createChild(e){const t=this.child_execution_order+1,r=new l({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});o in this&&(r[o]=this[o]);const n=Symbol.for("lc:child_config"),a=e.extra?.[n]??this.extra[n];if(void 0!==(i=a)&&"object"==typeof i.callbacks&&(h(i.callbacks?.handlers)||h(i.callbacks))){const e={...a},t=function(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:r.id}),t.handlers?.find(d)?.updateFromRunTree?.(r),e.callbacks=t),r.extra[n]=e}var i;const s=new Set;let c=this;for(;null!=c&&!s.has(c.id);)s.add(c.id),c.child_execution_order=Math.max(c.child_execution_order,t),c=c.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),n){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,n&&Object.keys(n).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...n}}:{metadata:n})}_convertToCreate(e,t,r=!0){const n=e.extra??{};if(n.runtime||(n.runtime={}),t)for(const[e,r]of Object.entries(t))n.runtime[e]||(n.runtime[e]=r);let a,i;return r?(i=e.parent_run?.id,a=[]):(a=e.child_runs.map((e=>this._convertToCreate(e,t,r))),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=(0,a.Ec)(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){(0,s.m)("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){const r=e?.callbacks;let n,i,s,o=!!["TRACING_V2","TRACING"].find((e=>"true"===(0,a.Jz)(e)));if(r){const e=r?.getParentRunId?.()??"",t=r?.handlers?.find((e=>"langchain_tracer"==e?.name));n=t?.getRun?.(e),i=t?.projectName,s=t?.client,o=o||!!t}return n?new l({name:n.name,id:n.id,trace_id:n.trace_id,dotted_order:n.dotted_order,client:s,tracingEnabled:o,project_name:i,tags:[...new Set((n?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...n?.extra?.metadata,...e?.metadata}}}).createChild(t):new l({...t,client:s,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,n=r["langsmith-trace"];if(!n||"string"!=typeof n)return;const a=n.trim(),i=a.split(".").map((e=>{const[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}})),s=i[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:i.at(-1)?.uuid,trace_id:s,dotted_order:a};if(r.baggage&&"string"==typeof r.baggage){const e=c.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags}return new l(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new c(this.extra?.metadata,this.tags).toHeader()};if(e)for(const[r,n]of Object.entries(t))e.set(r,n);return t}}function u(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function d(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function h(e){return Array.isArray(e)&&e.some((e=>d(e)))}Object.defineProperty(l,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})},747:(e,t,r)=>{r.d(t,{Y:()=>i});const n=(...e)=>fetch(...e),a=Symbol.for("ls:fetch_implementation"),i=()=>globalThis[a]??n},4785:(e,t,r)=>{r.d(t,{Az:()=>d,Ec:()=>l,Jz:()=>h,yk:()=>u});var n=r(6928);let a;const i=()=>"undefined"!=typeof Deno,s=()=>a||(a="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||i()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":i()?"deno":"other":"node",a);let o,c;function l(){if(void 0===o){const e=s(),t=function(){if(void 0!==c)return c;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=d(r);void 0!==e&&(t[r]=e)}return c=t,t}();o={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:n.Ls,...t}}return o}function u(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,r])=>(e[t]=String(r),e)),{}):void 0}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[n,a]of Object.entries(e))!n.startsWith("LANGCHAIN_")||"string"!=typeof a||r.includes(n)||n.toLowerCase().includes("key")||n.toLowerCase().includes("secret")||n.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===n?t.revision_id=a:t[n]=a);return t}function d(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function h(e){return d(`LANGSMITH_${e}`)||d(`LANGCHAIN_${e}`)}},6232:(e,t,r)=>{r.d(t,{m:()=>a});const n={};function a(e){n[e]||(console.warn(e),n[e]=!0)}},1259:(e,t,r)=>{r.d(t,{Kj:()=>n.Kj,gk:()=>n.gk});var n=r(6928)},3389:(e,t,r)=>{r.d(t,{vR:()=>o,GZ:()=>c});var n=r(3246);const a=Symbol.for("ls:tracing_async_local_storage"),i=new class{getStore(){}run(e,t){return t()}},s=new class{getInstance(){return globalThis[a]??i}initializeGlobalInstance(e){void 0===globalThis[a]&&(globalThis[a]=e)}},o=()=>{const e=s.getInstance().getStore();if(!(0,n.m5)(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e};function c(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root")},7481:(e,t,r)=>{function n(){}function a(e){return"object"==typeof e&&null!==e||"function"==typeof e}r.d(t,{Rv:()=>rn,ZY:()=>Rr,ho:()=>Et,i0:()=>Zr,ty:()=>Yr});const i=n;function s(e,t){try{Object.defineProperty(e,"name",{value:t,configurable:!0})}catch(e){}}const o=Promise,c=Promise.resolve.bind(o),l=Promise.prototype.then,u=Promise.reject.bind(o),d=c;function h(e){return new o(e)}function p(e){return h((t=>t(e)))}function f(e){return u(e)}function m(e,t,r){return l.call(e,t,r)}function g(e,t,r){m(m(e,t,r),void 0,i)}function b(e,t){g(e,t)}function y(e,t){g(e,void 0,t)}function v(e,t,r){return m(e,t,r)}function _(e){m(e,void 0,i)}let w=e=>{if("function"==typeof queueMicrotask)w=queueMicrotask;else{const e=p(void 0);w=t=>m(e,t)}return w(e)};function O(e,t,r){if("function"!=typeof e)throw new TypeError("Argument is not a function");return Function.prototype.apply.call(e,t,r)}function k(e,t,r){try{return p(O(e,t,r))}catch(e){return f(e)}}class E{constructor(){this._cursor=0,this._size=0,this._front={_elements:[],_next:void 0},this._back=this._front,this._cursor=0,this._size=0}get length(){return this._size}push(e){const t=this._back;let r=t;16383===t._elements.length&&(r={_elements:[],_next:void 0}),t._elements.push(e),r!==t&&(this._back=r,t._next=r),++this._size}shift(){const e=this._front;let t=e;const r=this._cursor;let n=r+1;const a=e._elements,i=a[r];return 16384===n&&(t=e._next,n=0),--this._size,this._cursor=n,e!==t&&(this._front=t),a[r]=void 0,i}forEach(e){let t=this._cursor,r=this._front,n=r._elements;for(;!(t===n.length&&void 0===r._next||t===n.length&&(r=r._next,n=r._elements,t=0,0===n.length));)e(n[t]),++t}peek(){const e=this._front,t=this._cursor;return e._elements[t]}}const S=Symbol("[[AbortSteps]]"),T=Symbol("[[ErrorSteps]]"),P=Symbol("[[CancelSteps]]"),x=Symbol("[[PullSteps]]"),j=Symbol("[[ReleaseSteps]]");function C(e,t){e._ownerReadableStream=t,t._reader=e,"readable"===t._state?N(e):"closed"===t._state?function(e){N(e),M(e)}(e):$(e,t._storedError)}function I(e,t){return Fr(e._ownerReadableStream,t)}function A(e){const t=e._ownerReadableStream;"readable"===t._state?L(e,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness")):function(e){$(e,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness"))}(e),t._readableStreamController[j](),t._reader=void 0,e._ownerReadableStream=void 0}function R(e){return new TypeError("Cannot "+e+" a stream using a released reader")}function N(e){e._closedPromise=h(((t,r)=>{e._closedPromise_resolve=t,e._closedPromise_reject=r}))}function $(e,t){N(e),L(e,t)}function L(e,t){void 0!==e._closedPromise_reject&&(_(e._closedPromise),e._closedPromise_reject(t),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0)}function M(e){void 0!==e._closedPromise_resolve&&(e._closedPromise_resolve(void 0),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0)}const D=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},F=Math.trunc||function(e){return e<0?Math.ceil(e):Math.floor(e)};function U(e,t){if(void 0!==e&&"object"!=typeof(r=e)&&"function"!=typeof r)throw new TypeError(`${t} is not an object.`);var r}function B(e,t){if("function"!=typeof e)throw new TypeError(`${t} is not a function.`)}function z(e,t){if(!function(e){return"object"==typeof e&&null!==e||"function"==typeof e}(e))throw new TypeError(`${t} is not an object.`)}function V(e,t,r){if(void 0===e)throw new TypeError(`Parameter ${t} is required in '${r}'.`)}function q(e,t,r){if(void 0===e)throw new TypeError(`${t} is required in '${r}'.`)}function Z(e){return Number(e)}function G(e){return 0===e?0:e}function H(e,t){const r=Number.MAX_SAFE_INTEGER;let n=Number(e);if(n=G(n),!D(n))throw new TypeError(`${t} is not a finite number`);if(n=function(e){return G(F(e))}(n),n<0||n>r)throw new TypeError(`${t} is outside the accepted range of 0 to ${r}, inclusive`);return D(n)&&0!==n?n:0}function W(e,t){if(!Mr(e))throw new TypeError(`${t} is not a ReadableStream.`)}function Y(e){return new ee(e)}function J(e,t){e._reader._readRequests.push(t)}function K(e,t,r){const n=e._reader._readRequests.shift();r?n._closeSteps():n._chunkSteps(t)}function X(e){return e._reader._readRequests.length}function Q(e){const t=e._reader;return void 0!==t&&!!te(t)}class ee{constructor(e){if(V(e,1,"ReadableStreamDefaultReader"),W(e,"First parameter"),Dr(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");C(this,e),this._readRequests=new E}get closed(){return te(this)?this._closedPromise:f(ae("closed"))}cancel(e=void 0){return te(this)?void 0===this._ownerReadableStream?f(R("cancel")):I(this,e):f(ae("cancel"))}read(){if(!te(this))return f(ae("read"));if(void 0===this._ownerReadableStream)return f(R("read from"));let e,t;const r=h(((r,n)=>{e=r,t=n}));return re(this,{_chunkSteps:t=>e({value:t,done:!1}),_closeSteps:()=>e({value:void 0,done:!0}),_errorSteps:e=>t(e)}),r}releaseLock(){if(!te(this))throw ae("releaseLock");void 0!==this._ownerReadableStream&&function(e){A(e),ne(e,new TypeError("Reader was released"))}(this)}}function te(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readRequests")&&e instanceof ee}function re(e,t){const r=e._ownerReadableStream;r._disturbed=!0,"closed"===r._state?t._closeSteps():"errored"===r._state?t._errorSteps(r._storedError):r._readableStreamController[x](t)}function ne(e,t){const r=e._readRequests;e._readRequests=new E,r.forEach((e=>{e._errorSteps(t)}))}function ae(e){return new TypeError(`ReadableStreamDefaultReader.prototype.${e} can only be used on a ReadableStreamDefaultReader`)}var ie,se,oe;function ce(e){return e.slice()}function le(e,t,r,n,a){new Uint8Array(e).set(new Uint8Array(r,n,a),t)}Object.defineProperties(ee.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),s(ee.prototype.cancel,"cancel"),s(ee.prototype.read,"read"),s(ee.prototype.releaseLock,"releaseLock"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(ee.prototype,Symbol.toStringTag,{value:"ReadableStreamDefaultReader",configurable:!0});let ue=e=>(ue="function"==typeof e.transfer?e=>e.transfer():"function"==typeof structuredClone?e=>structuredClone(e,{transfer:[e]}):e=>e,ue(e)),de=e=>(de="boolean"==typeof e.detached?e=>e.detached:e=>0===e.byteLength,de(e));function he(e,t,r){if(e.slice)return e.slice(t,r);const n=r-t,a=new ArrayBuffer(n);return le(a,0,e,t,n),a}function pe(e,t){const r=e[t];if(null!=r){if("function"!=typeof r)throw new TypeError(`${String(t)} is not a function`);return r}}function fe(e){try{const t=e.done,r=e.value;return m(d(r),(e=>({done:t,value:e})))}catch(e){return f(e)}}const me=null!==(oe=null!==(ie=Symbol.asyncIterator)&&void 0!==ie?ie:null===(se=Symbol.for)||void 0===se?void 0:se.call(Symbol,"Symbol.asyncIterator"))&&void 0!==oe?oe:"@@asyncIterator";function ge(e,t="sync",r){if(void 0===r)if("async"===t){if(void 0===(r=pe(e,me)))return function(e){const t={next(){let t;try{t=be(e)}catch(e){return f(e)}return fe(t)},return(t){let r;try{const n=pe(e.iterator,"return");if(void 0===n)return p({done:!0,value:t});r=O(n,e.iterator,[t])}catch(e){return f(e)}return a(r)?fe(r):f(new TypeError("The iterator.return() method must return an object"))}};return{iterator:t,nextMethod:t.next,done:!1}}(ge(e,"sync",pe(e,Symbol.iterator)))}else r=pe(e,Symbol.iterator);if(void 0===r)throw new TypeError("The object is not iterable");const n=O(r,e,[]);if(!a(n))throw new TypeError("The iterator method must return an object");return{iterator:n,nextMethod:n.next,done:!1}}function be(e){const t=O(e.nextMethod,e.iterator,[]);if(!a(t))throw new TypeError("The iterator.next() method must return an object");return t}class ye{constructor(e,t){this._ongoingPromise=void 0,this._isFinished=!1,this._reader=e,this._preventCancel=t}next(){const e=()=>this._nextSteps();return this._ongoingPromise=this._ongoingPromise?v(this._ongoingPromise,e,e):e(),this._ongoingPromise}return(e){const t=()=>this._returnSteps(e);return this._ongoingPromise?v(this._ongoingPromise,t,t):t()}_nextSteps(){if(this._isFinished)return Promise.resolve({value:void 0,done:!0});const e=this._reader;let t,r;const n=h(((e,n)=>{t=e,r=n}));return re(e,{_chunkSteps:e=>{this._ongoingPromise=void 0,w((()=>t({value:e,done:!1})))},_closeSteps:()=>{this._ongoingPromise=void 0,this._isFinished=!0,A(e),t({value:void 0,done:!0})},_errorSteps:t=>{this._ongoingPromise=void 0,this._isFinished=!0,A(e),r(t)}}),n}_returnSteps(e){if(this._isFinished)return Promise.resolve({value:e,done:!0});this._isFinished=!0;const t=this._reader;if(!this._preventCancel){const r=I(t,e);return A(t),v(r,(()=>({value:e,done:!0})))}return A(t),p({value:e,done:!0})}}const ve={next(){return _e(this)?this._asyncIteratorImpl.next():f(we("next"))},return(e){return _e(this)?this._asyncIteratorImpl.return(e):f(we("return"))},[me](){return this}};function _e(e){if(!a(e))return!1;if(!Object.prototype.hasOwnProperty.call(e,"_asyncIteratorImpl"))return!1;try{return e._asyncIteratorImpl instanceof ye}catch(e){return!1}}function we(e){return new TypeError(`ReadableStreamAsyncIterator.${e} can only be used on a ReadableSteamAsyncIterator`)}Object.defineProperty(ve,me,{enumerable:!1});const Oe=Number.isNaN||function(e){return e!=e};function ke(e){const t=he(e.buffer,e.byteOffset,e.byteOffset+e.byteLength);return new Uint8Array(t)}function Ee(e){const t=e._queue.shift();return e._queueTotalSize-=t.size,e._queueTotalSize<0&&(e._queueTotalSize=0),t.value}function Se(e,t,r){if("number"!=typeof(n=r)||Oe(n)||n<0||r===1/0)throw new RangeError("Size must be a finite, non-NaN, non-negative number.");var n;e._queue.push({value:t,size:r}),e._queueTotalSize+=r}function Te(e){e._queue=new E,e._queueTotalSize=0}function Pe(e){return e===DataView}class xe{constructor(){throw new TypeError("Illegal constructor")}get view(){if(!Ie(this))throw rt("view");return this._view}respond(e){if(!Ie(this))throw rt("respond");if(V(e,1,"respond"),e=H(e,"First parameter"),void 0===this._associatedReadableByteStreamController)throw new TypeError("This BYOB request has been invalidated");if(de(this._view.buffer))throw new TypeError("The BYOB request's buffer has been detached and so cannot be used as a response");Qe(this._associatedReadableByteStreamController,e)}respondWithNewView(e){if(!Ie(this))throw rt("respondWithNewView");if(V(e,1,"respondWithNewView"),!ArrayBuffer.isView(e))throw new TypeError("You can only respond with array buffer views");if(void 0===this._associatedReadableByteStreamController)throw new TypeError("This BYOB request has been invalidated");if(de(e.buffer))throw new TypeError("The given view's buffer has been detached and so cannot be used as a response");et(this._associatedReadableByteStreamController,e)}}Object.defineProperties(xe.prototype,{respond:{enumerable:!0},respondWithNewView:{enumerable:!0},view:{enumerable:!0}}),s(xe.prototype.respond,"respond"),s(xe.prototype.respondWithNewView,"respondWithNewView"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(xe.prototype,Symbol.toStringTag,{value:"ReadableStreamBYOBRequest",configurable:!0});class je{constructor(){throw new TypeError("Illegal constructor")}get byobRequest(){if(!Ce(this))throw nt("byobRequest");return Ke(this)}get desiredSize(){if(!Ce(this))throw nt("desiredSize");return Xe(this)}close(){if(!Ce(this))throw nt("close");if(this._closeRequested)throw new TypeError("The stream has already been closed; do not close it again!");const e=this._controlledReadableByteStream._state;if("readable"!==e)throw new TypeError(`The stream (in ${e} state) is not in the readable state and cannot be closed`);He(this)}enqueue(e){if(!Ce(this))throw nt("enqueue");if(V(e,1,"enqueue"),!ArrayBuffer.isView(e))throw new TypeError("chunk must be an array buffer view");if(0===e.byteLength)throw new TypeError("chunk must have non-zero byteLength");if(0===e.buffer.byteLength)throw new TypeError("chunk's buffer must have non-zero byteLength");if(this._closeRequested)throw new TypeError("stream is closed or draining");const t=this._controlledReadableByteStream._state;if("readable"!==t)throw new TypeError(`The stream (in ${t} state) is not in the readable state and cannot be enqueued to`);We(this,e)}error(e=void 0){if(!Ce(this))throw nt("error");Ye(this,e)}[P](e){Re(this),Te(this);const t=this._cancelAlgorithm(e);return Ge(this),t}[x](e){const t=this._controlledReadableByteStream;if(this._queueTotalSize>0)return void Je(this,e);const r=this._autoAllocateChunkSize;if(void 0!==r){let n;try{n=new ArrayBuffer(r)}catch(t){return void e._errorSteps(t)}const a={buffer:n,bufferByteLength:r,byteOffset:0,byteLength:r,bytesFilled:0,minimumFill:1,elementSize:1,viewConstructor:Uint8Array,readerType:"default"};this._pendingPullIntos.push(a)}J(t,e),Ae(this)}[j](){if(this._pendingPullIntos.length>0){const e=this._pendingPullIntos.peek();e.readerType="none",this._pendingPullIntos=new E,this._pendingPullIntos.push(e)}}}function Ce(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledReadableByteStream")&&e instanceof je}function Ie(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_associatedReadableByteStreamController")&&e instanceof xe}function Ae(e){const t=function(e){const t=e._controlledReadableByteStream;return"readable"===t._state&&(!e._closeRequested&&(!!e._started&&(!!(Q(t)&&X(t)>0)||(!!(ct(t)&&ot(t)>0)||Xe(e)>0))))}(e);t&&(e._pulling?e._pullAgain=!0:(e._pulling=!0,g(e._pullAlgorithm(),(()=>(e._pulling=!1,e._pullAgain&&(e._pullAgain=!1,Ae(e)),null)),(t=>(Ye(e,t),null)))))}function Re(e){ze(e),e._pendingPullIntos=new E}function Ne(e,t){let r=!1;"closed"===e._state&&(r=!0);const n=$e(t);"default"===t.readerType?K(e,n,r):function(e,t,r){const n=e._reader._readIntoRequests.shift();r?n._closeSteps(t):n._chunkSteps(t)}(e,n,r)}function $e(e){const t=e.bytesFilled,r=e.elementSize;return new e.viewConstructor(e.buffer,e.byteOffset,t/r)}function Le(e,t,r,n){e._queue.push({buffer:t,byteOffset:r,byteLength:n}),e._queueTotalSize+=n}function Me(e,t,r,n){let a;try{a=he(t,r,r+n)}catch(t){throw Ye(e,t),t}Le(e,a,0,n)}function De(e,t){t.bytesFilled>0&&Me(e,t.buffer,t.byteOffset,t.bytesFilled),Ze(e)}function Fe(e,t){const r=Math.min(e._queueTotalSize,t.byteLength-t.bytesFilled),n=t.bytesFilled+r;let a=r,i=!1;const s=n-n%t.elementSize;s>=t.minimumFill&&(a=s-t.bytesFilled,i=!0);const o=e._queue;for(;a>0;){const r=o.peek(),n=Math.min(a,r.byteLength),i=t.byteOffset+t.bytesFilled;le(t.buffer,i,r.buffer,r.byteOffset,n),r.byteLength===n?o.shift():(r.byteOffset+=n,r.byteLength-=n),e._queueTotalSize-=n,Ue(0,n,t),a-=n}return i}function Ue(e,t,r){r.bytesFilled+=t}function Be(e){0===e._queueTotalSize&&e._closeRequested?(Ge(e),Ur(e._controlledReadableByteStream)):Ae(e)}function ze(e){null!==e._byobRequest&&(e._byobRequest._associatedReadableByteStreamController=void 0,e._byobRequest._view=null,e._byobRequest=null)}function Ve(e){for(;e._pendingPullIntos.length>0;){if(0===e._queueTotalSize)return;const t=e._pendingPullIntos.peek();Fe(e,t)&&(Ze(e),Ne(e._controlledReadableByteStream,t))}}function qe(e,t){const r=e._pendingPullIntos.peek();ze(e),"closed"===e._controlledReadableByteStream._state?function(e,t){"none"===t.readerType&&Ze(e);const r=e._controlledReadableByteStream;if(ct(r))for(;ot(r)>0;)Ne(r,Ze(e))}(e,r):function(e,t,r){if(Ue(0,t,r),"none"===r.readerType)return De(e,r),void Ve(e);if(r.bytesFilled<r.minimumFill)return;Ze(e);const n=r.bytesFilled%r.elementSize;if(n>0){const t=r.byteOffset+r.bytesFilled;Me(e,r.buffer,t-n,n)}r.bytesFilled-=n,Ne(e._controlledReadableByteStream,r),Ve(e)}(e,t,r),Ae(e)}function Ze(e){return e._pendingPullIntos.shift()}function Ge(e){e._pullAlgorithm=void 0,e._cancelAlgorithm=void 0}function He(e){const t=e._controlledReadableByteStream;if(!e._closeRequested&&"readable"===t._state)if(e._queueTotalSize>0)e._closeRequested=!0;else{if(e._pendingPullIntos.length>0){const t=e._pendingPullIntos.peek();if(t.bytesFilled%t.elementSize!=0){const t=new TypeError("Insufficient bytes to fill elements in the given buffer");throw Ye(e,t),t}}Ge(e),Ur(t)}}function We(e,t){const r=e._controlledReadableByteStream;if(e._closeRequested||"readable"!==r._state)return;const{buffer:n,byteOffset:a,byteLength:i}=t;if(de(n))throw new TypeError("chunk's buffer is detached and so cannot be enqueued");const s=ue(n);if(e._pendingPullIntos.length>0){const t=e._pendingPullIntos.peek();if(de(t.buffer))throw new TypeError("The BYOB request's buffer has been detached and so cannot be filled with an enqueued chunk");ze(e),t.buffer=ue(t.buffer),"none"===t.readerType&&De(e,t)}Q(r)?(function(e){const t=e._controlledReadableByteStream._reader;for(;t._readRequests.length>0;){if(0===e._queueTotalSize)return;Je(e,t._readRequests.shift())}}(e),0===X(r)?Le(e,s,a,i):(e._pendingPullIntos.length>0&&Ze(e),K(r,new Uint8Array(s,a,i),!1))):ct(r)?(Le(e,s,a,i),Ve(e)):Le(e,s,a,i),Ae(e)}function Ye(e,t){const r=e._controlledReadableByteStream;"readable"===r._state&&(Re(e),Te(e),Ge(e),Br(r,t))}function Je(e,t){const r=e._queue.shift();e._queueTotalSize-=r.byteLength,Be(e);const n=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);t._chunkSteps(n)}function Ke(e){if(null===e._byobRequest&&e._pendingPullIntos.length>0){const t=e._pendingPullIntos.peek(),r=new Uint8Array(t.buffer,t.byteOffset+t.bytesFilled,t.byteLength-t.bytesFilled),n=Object.create(xe.prototype);!function(e,t,r){e._associatedReadableByteStreamController=t,e._view=r}(n,e,r),e._byobRequest=n}return e._byobRequest}function Xe(e){const t=e._controlledReadableByteStream._state;return"errored"===t?null:"closed"===t?0:e._strategyHWM-e._queueTotalSize}function Qe(e,t){const r=e._pendingPullIntos.peek();if("closed"===e._controlledReadableByteStream._state){if(0!==t)throw new TypeError("bytesWritten must be 0 when calling respond() on a closed stream")}else{if(0===t)throw new TypeError("bytesWritten must be greater than 0 when calling respond() on a readable stream");if(r.bytesFilled+t>r.byteLength)throw new RangeError("bytesWritten out of range")}r.buffer=ue(r.buffer),qe(e,t)}function et(e,t){const r=e._pendingPullIntos.peek();if("closed"===e._controlledReadableByteStream._state){if(0!==t.byteLength)throw new TypeError("The view's length must be 0 when calling respondWithNewView() on a closed stream")}else if(0===t.byteLength)throw new TypeError("The view's length must be greater than 0 when calling respondWithNewView() on a readable stream");if(r.byteOffset+r.bytesFilled!==t.byteOffset)throw new RangeError("The region specified by view does not match byobRequest");if(r.bufferByteLength!==t.buffer.byteLength)throw new RangeError("The buffer of view has different capacity than byobRequest");if(r.bytesFilled+t.byteLength>r.byteLength)throw new RangeError("The region specified by view is larger than byobRequest");const n=t.byteLength;r.buffer=ue(t.buffer),qe(e,n)}function tt(e,t,r,n,a,i,s){t._controlledReadableByteStream=e,t._pullAgain=!1,t._pulling=!1,t._byobRequest=null,t._queue=t._queueTotalSize=void 0,Te(t),t._closeRequested=!1,t._started=!1,t._strategyHWM=i,t._pullAlgorithm=n,t._cancelAlgorithm=a,t._autoAllocateChunkSize=s,t._pendingPullIntos=new E,e._readableStreamController=t,g(p(r()),(()=>(t._started=!0,Ae(t),null)),(e=>(Ye(t,e),null)))}function rt(e){return new TypeError(`ReadableStreamBYOBRequest.prototype.${e} can only be used on a ReadableStreamBYOBRequest`)}function nt(e){return new TypeError(`ReadableByteStreamController.prototype.${e} can only be used on a ReadableByteStreamController`)}function at(e,t){if("byob"!=(e=`${e}`))throw new TypeError(`${t} '${e}' is not a valid enumeration value for ReadableStreamReaderMode`);return e}function it(e){return new lt(e)}function st(e,t){e._reader._readIntoRequests.push(t)}function ot(e){return e._reader._readIntoRequests.length}function ct(e){const t=e._reader;return void 0!==t&&!!ut(t)}Object.defineProperties(je.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},byobRequest:{enumerable:!0},desiredSize:{enumerable:!0}}),s(je.prototype.close,"close"),s(je.prototype.enqueue,"enqueue"),s(je.prototype.error,"error"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(je.prototype,Symbol.toStringTag,{value:"ReadableByteStreamController",configurable:!0});class lt{constructor(e){if(V(e,1,"ReadableStreamBYOBReader"),W(e,"First parameter"),Dr(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");if(!Ce(e._readableStreamController))throw new TypeError("Cannot construct a ReadableStreamBYOBReader for a stream not constructed with a byte source");C(this,e),this._readIntoRequests=new E}get closed(){return ut(this)?this._closedPromise:f(pt("closed"))}cancel(e=void 0){return ut(this)?void 0===this._ownerReadableStream?f(R("cancel")):I(this,e):f(pt("cancel"))}read(e,t={}){if(!ut(this))return f(pt("read"));if(!ArrayBuffer.isView(e))return f(new TypeError("view must be an array buffer view"));if(0===e.byteLength)return f(new TypeError("view must have non-zero byteLength"));if(0===e.buffer.byteLength)return f(new TypeError("view's buffer must have non-zero byteLength"));if(de(e.buffer))return f(new TypeError("view's buffer has been detached"));let r;try{r=function(e,t){var r;return U(e,t),{min:H(null!==(r=null==e?void 0:e.min)&&void 0!==r?r:1,`${t} has member 'min' that`)}}(t,"options")}catch(e){return f(e)}const n=r.min;if(0===n)return f(new TypeError("options.min must be greater than 0"));if(function(e){return Pe(e.constructor)}(e)){if(n>e.byteLength)return f(new RangeError("options.min must be less than or equal to view's byteLength"))}else if(n>e.length)return f(new RangeError("options.min must be less than or equal to view's length"));if(void 0===this._ownerReadableStream)return f(R("read from"));let a,i;const s=h(((e,t)=>{a=e,i=t}));return dt(this,e,n,{_chunkSteps:e=>a({value:e,done:!1}),_closeSteps:e=>a({value:e,done:!0}),_errorSteps:e=>i(e)}),s}releaseLock(){if(!ut(this))throw pt("releaseLock");void 0!==this._ownerReadableStream&&function(e){A(e),ht(e,new TypeError("Reader was released"))}(this)}}function ut(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readIntoRequests")&&e instanceof lt}function dt(e,t,r,n){const a=e._ownerReadableStream;a._disturbed=!0,"errored"===a._state?n._errorSteps(a._storedError):function(e,t,r,n){const a=e._controlledReadableByteStream,i=t.constructor,s=function(e){return Pe(e)?1:e.BYTES_PER_ELEMENT}(i),{byteOffset:o,byteLength:c}=t,l=r*s;let u;try{u=ue(t.buffer)}catch(e){return void n._errorSteps(e)}const d={buffer:u,bufferByteLength:u.byteLength,byteOffset:o,byteLength:c,bytesFilled:0,minimumFill:l,elementSize:s,viewConstructor:i,readerType:"byob"};if(e._pendingPullIntos.length>0)return e._pendingPullIntos.push(d),void st(a,n);if("closed"!==a._state){if(e._queueTotalSize>0){if(Fe(e,d)){const t=$e(d);return Be(e),void n._chunkSteps(t)}if(e._closeRequested){const t=new TypeError("Insufficient bytes to fill elements in the given buffer");return Ye(e,t),void n._errorSteps(t)}}e._pendingPullIntos.push(d),st(a,n),Ae(e)}else{const e=new i(d.buffer,d.byteOffset,0);n._closeSteps(e)}}(a._readableStreamController,t,r,n)}function ht(e,t){const r=e._readIntoRequests;e._readIntoRequests=new E,r.forEach((e=>{e._errorSteps(t)}))}function pt(e){return new TypeError(`ReadableStreamBYOBReader.prototype.${e} can only be used on a ReadableStreamBYOBReader`)}function ft(e,t){const{highWaterMark:r}=e;if(void 0===r)return t;if(Oe(r)||r<0)throw new RangeError("Invalid highWaterMark");return r}function mt(e){const{size:t}=e;return t||(()=>1)}function gt(e,t){U(e,t);const r=null==e?void 0:e.highWaterMark,n=null==e?void 0:e.size;return{highWaterMark:void 0===r?void 0:Z(r),size:void 0===n?void 0:bt(n,`${t} has member 'size' that`)}}function bt(e,t){return B(e,t),t=>Z(e(t))}function yt(e,t,r){return B(e,r),r=>k(e,t,[r])}function vt(e,t,r){return B(e,r),()=>k(e,t,[])}function _t(e,t,r){return B(e,r),r=>O(e,t,[r])}function wt(e,t,r){return B(e,r),(r,n)=>k(e,t,[r,n])}function Ot(e,t){if(!Pt(e))throw new TypeError(`${t} is not a WritableStream.`)}Object.defineProperties(lt.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),s(lt.prototype.cancel,"cancel"),s(lt.prototype.read,"read"),s(lt.prototype.releaseLock,"releaseLock"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(lt.prototype,Symbol.toStringTag,{value:"ReadableStreamBYOBReader",configurable:!0});const kt="function"==typeof AbortController;class Et{constructor(e={},t={}){void 0===e?e=null:z(e,"First parameter");const r=gt(t,"Second parameter"),n=function(e,t){U(e,t);const r=null==e?void 0:e.abort,n=null==e?void 0:e.close,a=null==e?void 0:e.start,i=null==e?void 0:e.type,s=null==e?void 0:e.write;return{abort:void 0===r?void 0:yt(r,e,`${t} has member 'abort' that`),close:void 0===n?void 0:vt(n,e,`${t} has member 'close' that`),start:void 0===a?void 0:_t(a,e,`${t} has member 'start' that`),write:void 0===s?void 0:wt(s,e,`${t} has member 'write' that`),type:i}}(e,"First parameter");if(Tt(this),void 0!==n.type)throw new RangeError("Invalid type is specified");const a=mt(r);!function(e,t,r,n){const a=Object.create(qt.prototype);let i,s,o,c;i=void 0!==t.start?()=>t.start(a):()=>{},s=void 0!==t.write?e=>t.write(e,a):()=>p(void 0),o=void 0!==t.close?()=>t.close():()=>p(void 0),c=void 0!==t.abort?e=>t.abort(e):()=>p(void 0),Gt(e,a,i,s,o,c,r,n)}(this,n,ft(r,1),a)}get locked(){if(!Pt(this))throw Qt("locked");return xt(this)}abort(e=void 0){return Pt(this)?xt(this)?f(new TypeError("Cannot abort a stream that already has a writer")):jt(this,e):f(Qt("abort"))}close(){return Pt(this)?xt(this)?f(new TypeError("Cannot close a stream that already has a writer")):Nt(this)?f(new TypeError("Cannot close an already-closing stream")):Ct(this):f(Qt("close"))}getWriter(){if(!Pt(this))throw Qt("getWriter");return St(this)}}function St(e){return new Mt(e)}function Tt(e){e._state="writable",e._storedError=void 0,e._writer=void 0,e._writableStreamController=void 0,e._writeRequests=new E,e._inFlightWriteRequest=void 0,e._closeRequest=void 0,e._inFlightCloseRequest=void 0,e._pendingAbortRequest=void 0,e._backpressure=!1}function Pt(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_writableStreamController")&&e instanceof Et}function xt(e){return void 0!==e._writer}function jt(e,t){var r;if("closed"===e._state||"errored"===e._state)return p(void 0);e._writableStreamController._abortReason=t,null===(r=e._writableStreamController._abortController)||void 0===r||r.abort(t);const n=e._state;if("closed"===n||"errored"===n)return p(void 0);if(void 0!==e._pendingAbortRequest)return e._pendingAbortRequest._promise;let a=!1;"erroring"===n&&(a=!0,t=void 0);const i=h(((r,n)=>{e._pendingAbortRequest={_promise:void 0,_resolve:r,_reject:n,_reason:t,_wasAlreadyErroring:a}}));return e._pendingAbortRequest._promise=i,a||At(e,t),i}function Ct(e){const t=e._state;if("closed"===t||"errored"===t)return f(new TypeError(`The stream (in ${t} state) is not in the writable state and cannot be closed`));const r=h(((t,r)=>{const n={_resolve:t,_reject:r};e._closeRequest=n})),n=e._writer;var a;return void 0!==n&&e._backpressure&&"writable"===t&&dr(n),Se(a=e._writableStreamController,Vt,0),Yt(a),r}function It(e,t){"writable"!==e._state?Rt(e):At(e,t)}function At(e,t){const r=e._writableStreamController;e._state="erroring",e._storedError=t;const n=e._writer;void 0!==n&&Ut(n,t),!function(e){return void 0!==e._inFlightWriteRequest||void 0!==e._inFlightCloseRequest}(e)&&r._started&&Rt(e)}function Rt(e){e._state="errored",e._writableStreamController[T]();const t=e._storedError;if(e._writeRequests.forEach((e=>{e._reject(t)})),e._writeRequests=new E,void 0===e._pendingAbortRequest)return void $t(e);const r=e._pendingAbortRequest;if(e._pendingAbortRequest=void 0,r._wasAlreadyErroring)return r._reject(t),void $t(e);g(e._writableStreamController[S](r._reason),(()=>(r._resolve(),$t(e),null)),(t=>(r._reject(t),$t(e),null)))}function Nt(e){return void 0!==e._closeRequest||void 0!==e._inFlightCloseRequest}function $t(e){void 0!==e._closeRequest&&(e._closeRequest._reject(e._storedError),e._closeRequest=void 0);const t=e._writer;void 0!==t&&ir(t,e._storedError)}function Lt(e,t){const r=e._writer;void 0!==r&&t!==e._backpressure&&(t?function(e){or(e)}(r):dr(r)),e._backpressure=t}Object.defineProperties(Et.prototype,{abort:{enumerable:!0},close:{enumerable:!0},getWriter:{enumerable:!0},locked:{enumerable:!0}}),s(Et.prototype.abort,"abort"),s(Et.prototype.close,"close"),s(Et.prototype.getWriter,"getWriter"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(Et.prototype,Symbol.toStringTag,{value:"WritableStream",configurable:!0});class Mt{constructor(e){if(V(e,1,"WritableStreamDefaultWriter"),Ot(e,"First parameter"),xt(e))throw new TypeError("This stream has already been locked for exclusive writing by another writer");this._ownerWritableStream=e,e._writer=this;const t=e._state;if("writable"===t)!Nt(e)&&e._backpressure?or(this):lr(this),nr(this);else if("erroring"===t)cr(this,e._storedError),nr(this);else if("closed"===t)lr(this),nr(this),sr(this);else{const t=e._storedError;cr(this,t),ar(this,t)}}get closed(){return Dt(this)?this._closedPromise:f(tr("closed"))}get desiredSize(){if(!Dt(this))throw tr("desiredSize");if(void 0===this._ownerWritableStream)throw rr("desiredSize");return function(e){const t=e._ownerWritableStream,r=t._state;return"errored"===r||"erroring"===r?null:"closed"===r?0:Wt(t._writableStreamController)}(this)}get ready(){return Dt(this)?this._readyPromise:f(tr("ready"))}abort(e=void 0){return Dt(this)?void 0===this._ownerWritableStream?f(rr("abort")):function(e,t){return jt(e._ownerWritableStream,t)}(this,e):f(tr("abort"))}close(){if(!Dt(this))return f(tr("close"));const e=this._ownerWritableStream;return void 0===e?f(rr("close")):Nt(e)?f(new TypeError("Cannot close an already-closing stream")):Ft(this)}releaseLock(){if(!Dt(this))throw tr("releaseLock");void 0!==this._ownerWritableStream&&Bt(this)}write(e=void 0){return Dt(this)?void 0===this._ownerWritableStream?f(rr("write to")):zt(this,e):f(tr("write"))}}function Dt(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_ownerWritableStream")&&e instanceof Mt}function Ft(e){return Ct(e._ownerWritableStream)}function Ut(e,t){"pending"===e._readyPromiseState?ur(e,t):function(e,t){cr(e,t)}(e,t)}function Bt(e){const t=e._ownerWritableStream,r=new TypeError("Writer was released and can no longer be used to monitor the stream's closedness");Ut(e,r),function(e,t){"pending"===e._closedPromiseState?ir(e,t):function(e,t){ar(e,t)}(e,t)}(e,r),t._writer=void 0,e._ownerWritableStream=void 0}function zt(e,t){const r=e._ownerWritableStream,n=r._writableStreamController,a=function(e,t){try{return e._strategySizeAlgorithm(t)}catch(t){return Jt(e,t),1}}(n,t);if(r!==e._ownerWritableStream)return f(rr("write to"));const i=r._state;if("errored"===i)return f(r._storedError);if(Nt(r)||"closed"===i)return f(new TypeError("The stream is closing or closed and cannot be written to"));if("erroring"===i)return f(r._storedError);const s=function(e){return h(((t,r)=>{const n={_resolve:t,_reject:r};e._writeRequests.push(n)}))}(r);return function(e,t,r){try{Se(e,t,r)}catch(t){return void Jt(e,t)}const n=e._controlledWritableStream;Nt(n)||"writable"!==n._state||Lt(n,Kt(e)),Yt(e)}(n,t,a),s}Object.defineProperties(Mt.prototype,{abort:{enumerable:!0},close:{enumerable:!0},releaseLock:{enumerable:!0},write:{enumerable:!0},closed:{enumerable:!0},desiredSize:{enumerable:!0},ready:{enumerable:!0}}),s(Mt.prototype.abort,"abort"),s(Mt.prototype.close,"close"),s(Mt.prototype.releaseLock,"releaseLock"),s(Mt.prototype.write,"write"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(Mt.prototype,Symbol.toStringTag,{value:"WritableStreamDefaultWriter",configurable:!0});const Vt={};class qt{constructor(){throw new TypeError("Illegal constructor")}get abortReason(){if(!Zt(this))throw er("abortReason");return this._abortReason}get signal(){if(!Zt(this))throw er("signal");if(void 0===this._abortController)throw new TypeError("WritableStreamDefaultController.prototype.signal is not supported");return this._abortController.signal}error(e=void 0){if(!Zt(this))throw er("error");"writable"===this._controlledWritableStream._state&&Xt(this,e)}[S](e){const t=this._abortAlgorithm(e);return Ht(this),t}[T](){Te(this)}}function Zt(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledWritableStream")&&e instanceof qt}function Gt(e,t,r,n,a,i,s,o){t._controlledWritableStream=e,e._writableStreamController=t,t._queue=void 0,t._queueTotalSize=void 0,Te(t),t._abortReason=void 0,t._abortController=function(){if(kt)return new AbortController}(),t._started=!1,t._strategySizeAlgorithm=o,t._strategyHWM=s,t._writeAlgorithm=n,t._closeAlgorithm=a,t._abortAlgorithm=i;const c=Kt(t);Lt(e,c),g(p(r()),(()=>(t._started=!0,Yt(t),null)),(r=>(t._started=!0,It(e,r),null)))}function Ht(e){e._writeAlgorithm=void 0,e._closeAlgorithm=void 0,e._abortAlgorithm=void 0,e._strategySizeAlgorithm=void 0}function Wt(e){return e._strategyHWM-e._queueTotalSize}function Yt(e){const t=e._controlledWritableStream;if(!e._started)return;if(void 0!==t._inFlightWriteRequest)return;if("erroring"===t._state)return void Rt(t);if(0===e._queue.length)return;const r=e._queue.peek().value;r===Vt?function(e){const t=e._controlledWritableStream;(function(e){e._inFlightCloseRequest=e._closeRequest,e._closeRequest=void 0})(t),Ee(e);const r=e._closeAlgorithm();Ht(e),g(r,(()=>(function(e){e._inFlightCloseRequest._resolve(void 0),e._inFlightCloseRequest=void 0,"erroring"===e._state&&(e._storedError=void 0,void 0!==e._pendingAbortRequest&&(e._pendingAbortRequest._resolve(),e._pendingAbortRequest=void 0)),e._state="closed";const t=e._writer;void 0!==t&&sr(t)}(t),null)),(e=>(function(e,t){e._inFlightCloseRequest._reject(t),e._inFlightCloseRequest=void 0,void 0!==e._pendingAbortRequest&&(e._pendingAbortRequest._reject(t),e._pendingAbortRequest=void 0),It(e,t)}(t,e),null)))}(e):function(e,t){const r=e._controlledWritableStream;!function(e){e._inFlightWriteRequest=e._writeRequests.shift()}(r),g(e._writeAlgorithm(t),(()=>{!function(e){e._inFlightWriteRequest._resolve(void 0),e._inFlightWriteRequest=void 0}(r);const t=r._state;if(Ee(e),!Nt(r)&&"writable"===t){const t=Kt(e);Lt(r,t)}return Yt(e),null}),(t=>("writable"===r._state&&Ht(e),function(e,t){e._inFlightWriteRequest._reject(t),e._inFlightWriteRequest=void 0,It(e,t)}(r,t),null)))}(e,r)}function Jt(e,t){"writable"===e._controlledWritableStream._state&&Xt(e,t)}function Kt(e){return Wt(e)<=0}function Xt(e,t){const r=e._controlledWritableStream;Ht(e),At(r,t)}function Qt(e){return new TypeError(`WritableStream.prototype.${e} can only be used on a WritableStream`)}function er(e){return new TypeError(`WritableStreamDefaultController.prototype.${e} can only be used on a WritableStreamDefaultController`)}function tr(e){return new TypeError(`WritableStreamDefaultWriter.prototype.${e} can only be used on a WritableStreamDefaultWriter`)}function rr(e){return new TypeError("Cannot "+e+" a stream using a released writer")}function nr(e){e._closedPromise=h(((t,r)=>{e._closedPromise_resolve=t,e._closedPromise_reject=r,e._closedPromiseState="pending"}))}function ar(e,t){nr(e),ir(e,t)}function ir(e,t){void 0!==e._closedPromise_reject&&(_(e._closedPromise),e._closedPromise_reject(t),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0,e._closedPromiseState="rejected")}function sr(e){void 0!==e._closedPromise_resolve&&(e._closedPromise_resolve(void 0),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0,e._closedPromiseState="resolved")}function or(e){e._readyPromise=h(((t,r)=>{e._readyPromise_resolve=t,e._readyPromise_reject=r})),e._readyPromiseState="pending"}function cr(e,t){or(e),ur(e,t)}function lr(e){or(e),dr(e)}function ur(e,t){void 0!==e._readyPromise_reject&&(_(e._readyPromise),e._readyPromise_reject(t),e._readyPromise_resolve=void 0,e._readyPromise_reject=void 0,e._readyPromiseState="rejected")}function dr(e){void 0!==e._readyPromise_resolve&&(e._readyPromise_resolve(void 0),e._readyPromise_resolve=void 0,e._readyPromise_reject=void 0,e._readyPromiseState="fulfilled")}Object.defineProperties(qt.prototype,{abortReason:{enumerable:!0},signal:{enumerable:!0},error:{enumerable:!0}}),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(qt.prototype,Symbol.toStringTag,{value:"WritableStreamDefaultController",configurable:!0});const hr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof global?global:void 0,pr=function(){const e=null==hr?void 0:hr.DOMException;return function(e){if("function"!=typeof e&&"object"!=typeof e)return!1;if("DOMException"!==e.name)return!1;try{return new e,!0}catch(e){return!1}}(e)?e:void 0}()||function(){const e=function(e,t){this.message=e||"",this.name=t||"Error",Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)};return s(e,"DOMException"),e.prototype=Object.create(Error.prototype),Object.defineProperty(e.prototype,"constructor",{value:e,writable:!0,configurable:!0}),e}();function fr(e,t,r,a,i,s){const o=Y(e),c=St(t);e._disturbed=!0;let l=!1,u=p(void 0);return h(((d,v)=>{let w;if(void 0!==s){if(w=()=>{const r=void 0!==s.reason?s.reason:new pr("Aborted","AbortError"),n=[];a||n.push((()=>"writable"===t._state?jt(t,r):p(void 0))),i||n.push((()=>"readable"===e._state?Fr(e,r):p(void 0))),P((()=>Promise.all(n.map((e=>e())))),!0,r)},s.aborted)return void w();s.addEventListener("abort",w)}var O,k,E;if(T(e,o._closedPromise,(e=>(a?x(!0,e):P((()=>jt(t,e)),!0,e),null))),T(t,c._closedPromise,(t=>(i?x(!0,t):P((()=>Fr(e,t)),!0,t),null))),O=e,k=o._closedPromise,E=()=>(r?x():P((()=>function(e){const t=e._ownerWritableStream,r=t._state;return Nt(t)||"closed"===r?p(void 0):"errored"===r?f(t._storedError):Ft(e)}(c))),null),"closed"===O._state?E():b(k,E),Nt(t)||"closed"===t._state){const t=new TypeError("the destination writable stream closed before all data could be piped to it");i?x(!0,t):P((()=>Fr(e,t)),!0,t)}function S(){const e=u;return m(u,(()=>e!==u?S():void 0))}function T(e,t,r){"errored"===e._state?r(e._storedError):y(t,r)}function P(e,r,n){function a(){return g(e(),(()=>j(r,n)),(e=>j(!0,e))),null}l||(l=!0,"writable"!==t._state||Nt(t)?a():b(S(),a))}function x(e,r){l||(l=!0,"writable"!==t._state||Nt(t)?j(e,r):b(S(),(()=>j(e,r))))}function j(e,t){return Bt(c),A(o),void 0!==s&&s.removeEventListener("abort",w),e?v(t):d(void 0),null}_(h(((e,t)=>{!function r(a){a?e():m(l?p(!0):m(c._readyPromise,(()=>h(((e,t)=>{re(o,{_chunkSteps:t=>{u=m(zt(c,t),void 0,n),e(!1)},_closeSteps:()=>e(!0),_errorSteps:t})})))),r,t)}(!1)})))}))}class mr{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!gr(this))throw Tr("desiredSize");return kr(this)}close(){if(!gr(this))throw Tr("close");if(!Er(this))throw new TypeError("The stream is not in a state that permits close");_r(this)}enqueue(e=void 0){if(!gr(this))throw Tr("enqueue");if(!Er(this))throw new TypeError("The stream is not in a state that permits enqueue");return wr(this,e)}error(e=void 0){if(!gr(this))throw Tr("error");Or(this,e)}[P](e){Te(this);const t=this._cancelAlgorithm(e);return vr(this),t}[x](e){const t=this._controlledReadableStream;if(this._queue.length>0){const r=Ee(this);this._closeRequested&&0===this._queue.length?(vr(this),Ur(t)):br(this),e._chunkSteps(r)}else J(t,e),br(this)}[j](){}}function gr(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledReadableStream")&&e instanceof mr}function br(e){yr(e)&&(e._pulling?e._pullAgain=!0:(e._pulling=!0,g(e._pullAlgorithm(),(()=>(e._pulling=!1,e._pullAgain&&(e._pullAgain=!1,br(e)),null)),(t=>(Or(e,t),null)))))}function yr(e){const t=e._controlledReadableStream;return!!Er(e)&&!!e._started&&(!!(Dr(t)&&X(t)>0)||kr(e)>0)}function vr(e){e._pullAlgorithm=void 0,e._cancelAlgorithm=void 0,e._strategySizeAlgorithm=void 0}function _r(e){if(!Er(e))return;const t=e._controlledReadableStream;e._closeRequested=!0,0===e._queue.length&&(vr(e),Ur(t))}function wr(e,t){if(!Er(e))return;const r=e._controlledReadableStream;if(Dr(r)&&X(r)>0)K(r,t,!1);else{let r;try{r=e._strategySizeAlgorithm(t)}catch(t){throw Or(e,t),t}try{Se(e,t,r)}catch(t){throw Or(e,t),t}}br(e)}function Or(e,t){const r=e._controlledReadableStream;"readable"===r._state&&(Te(e),vr(e),Br(r,t))}function kr(e){const t=e._controlledReadableStream._state;return"errored"===t?null:"closed"===t?0:e._strategyHWM-e._queueTotalSize}function Er(e){const t=e._controlledReadableStream._state;return!e._closeRequested&&"readable"===t}function Sr(e,t,r,n,a,i,s){t._controlledReadableStream=e,t._queue=void 0,t._queueTotalSize=void 0,Te(t),t._started=!1,t._closeRequested=!1,t._pullAgain=!1,t._pulling=!1,t._strategySizeAlgorithm=s,t._strategyHWM=i,t._pullAlgorithm=n,t._cancelAlgorithm=a,e._readableStreamController=t,g(p(r()),(()=>(t._started=!0,br(t),null)),(e=>(Or(t,e),null)))}function Tr(e){return new TypeError(`ReadableStreamDefaultController.prototype.${e} can only be used on a ReadableStreamDefaultController`)}function Pr(e){return a(t=e)&&void 0!==t.getReader?function(e){let t;return t=Nr(n,(function(){let r;try{r=e.read()}catch(r){return f(r)}return v(r,(e=>{if(!a(e))throw new TypeError("The promise returned by the reader.read() method must fulfill with an object");if(e.done)_r(t._readableStreamController);else{const r=e.value;wr(t._readableStreamController,r)}}))}),(function(t){try{return p(e.cancel(t))}catch(t){return f(t)}}),0),t}(e.getReader()):function(e){let t;const r=ge(e,"async");return t=Nr(n,(function(){let e;try{e=be(r)}catch(e){return f(e)}return v(p(e),(e=>{if(!a(e))throw new TypeError("The promise returned by the iterator.next() method must fulfill with an object");if(e.done)_r(t._readableStreamController);else{const r=e.value;wr(t._readableStreamController,r)}}))}),(function(e){const t=r.iterator;let n;try{n=pe(t,"return")}catch(e){return f(e)}return void 0===n?p(void 0):v(k(n,t,[e]),(e=>{if(!a(e))throw new TypeError("The promise returned by the iterator.return() method must fulfill with an object")}))}),0),t}(e);var t}function xr(e,t,r){return B(e,r),r=>k(e,t,[r])}function jr(e,t,r){return B(e,r),r=>k(e,t,[r])}function Cr(e,t,r){return B(e,r),r=>O(e,t,[r])}function Ir(e,t){if("bytes"!=(e=`${e}`))throw new TypeError(`${t} '${e}' is not a valid enumeration value for ReadableStreamType`);return e}function Ar(e,t){U(e,t);const r=null==e?void 0:e.preventAbort,n=null==e?void 0:e.preventCancel,a=null==e?void 0:e.preventClose,i=null==e?void 0:e.signal;return void 0!==i&&function(e,t){if(!function(e){if("object"!=typeof e||null===e)return!1;try{return"boolean"==typeof e.aborted}catch(e){return!1}}(e))throw new TypeError(`${t} is not an AbortSignal.`)}(i,`${t} has member 'signal' that`),{preventAbort:Boolean(r),preventCancel:Boolean(n),preventClose:Boolean(a),signal:i}}Object.defineProperties(mr.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},desiredSize:{enumerable:!0}}),s(mr.prototype.close,"close"),s(mr.prototype.enqueue,"enqueue"),s(mr.prototype.error,"error"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(mr.prototype,Symbol.toStringTag,{value:"ReadableStreamDefaultController",configurable:!0});class Rr{constructor(e={},t={}){void 0===e?e=null:z(e,"First parameter");const r=gt(t,"Second parameter"),n=function(e,t){U(e,t);const r=e,n=null==r?void 0:r.autoAllocateChunkSize,a=null==r?void 0:r.cancel,i=null==r?void 0:r.pull,s=null==r?void 0:r.start,o=null==r?void 0:r.type;return{autoAllocateChunkSize:void 0===n?void 0:H(n,`${t} has member 'autoAllocateChunkSize' that`),cancel:void 0===a?void 0:xr(a,r,`${t} has member 'cancel' that`),pull:void 0===i?void 0:jr(i,r,`${t} has member 'pull' that`),start:void 0===s?void 0:Cr(s,r,`${t} has member 'start' that`),type:void 0===o?void 0:Ir(o,`${t} has member 'type' that`)}}(e,"First parameter");if(Lr(this),"bytes"===n.type){if(void 0!==r.size)throw new RangeError("The strategy for a byte stream cannot have a size function");!function(e,t,r){const n=Object.create(je.prototype);let a,i,s;a=void 0!==t.start?()=>t.start(n):()=>{},i=void 0!==t.pull?()=>t.pull(n):()=>p(void 0),s=void 0!==t.cancel?e=>t.cancel(e):()=>p(void 0);const o=t.autoAllocateChunkSize;if(0===o)throw new TypeError("autoAllocateChunkSize must be greater than 0");tt(e,n,a,i,s,r,o)}(this,n,ft(r,0))}else{const e=mt(r);!function(e,t,r,n){const a=Object.create(mr.prototype);let i,s,o;i=void 0!==t.start?()=>t.start(a):()=>{},s=void 0!==t.pull?()=>t.pull(a):()=>p(void 0),o=void 0!==t.cancel?e=>t.cancel(e):()=>p(void 0),Sr(e,a,i,s,o,r,n)}(this,n,ft(r,1),e)}}get locked(){if(!Mr(this))throw zr("locked");return Dr(this)}cancel(e=void 0){return Mr(this)?Dr(this)?f(new TypeError("Cannot cancel a stream that already has a reader")):Fr(this,e):f(zr("cancel"))}getReader(e=void 0){if(!Mr(this))throw zr("getReader");return void 0===function(e,t){U(e,t);const r=null==e?void 0:e.mode;return{mode:void 0===r?void 0:at(r,`${t} has member 'mode' that`)}}(e,"First parameter").mode?Y(this):it(this)}pipeThrough(e,t={}){if(!Mr(this))throw zr("pipeThrough");V(e,1,"pipeThrough");const r=function(e,t){U(e,t);const r=null==e?void 0:e.readable;q(r,"readable","ReadableWritablePair"),W(r,`${t} has member 'readable' that`);const n=null==e?void 0:e.writable;return q(n,"writable","ReadableWritablePair"),Ot(n,`${t} has member 'writable' that`),{readable:r,writable:n}}(e,"First parameter"),n=Ar(t,"Second parameter");if(Dr(this))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked ReadableStream");if(xt(r.writable))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked WritableStream");return _(fr(this,r.writable,n.preventClose,n.preventAbort,n.preventCancel,n.signal)),r.readable}pipeTo(e,t={}){if(!Mr(this))return f(zr("pipeTo"));if(void 0===e)return f("Parameter 1 is required in 'pipeTo'.");if(!Pt(e))return f(new TypeError("ReadableStream.prototype.pipeTo's first argument must be a WritableStream"));let r;try{r=Ar(t,"Second parameter")}catch(e){return f(e)}return Dr(this)?f(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked ReadableStream")):xt(e)?f(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked WritableStream")):fr(this,e,r.preventClose,r.preventAbort,r.preventCancel,r.signal)}tee(){if(!Mr(this))throw zr("tee");return ce(function(e){return Ce(e._readableStreamController)?function(e){let t,r,n,a,i,s=Y(e),o=!1,c=!1,l=!1,u=!1,d=!1;const f=h((e=>{i=e}));function m(e){y(e._closedPromise,(t=>(e!==s||(Ye(n._readableStreamController,t),Ye(a._readableStreamController,t),u&&d||i(void 0)),null)))}function g(){ut(s)&&(A(s),s=Y(e),m(s)),re(s,{_chunkSteps:t=>{w((()=>{c=!1,l=!1;const r=t;let s=t;if(!u&&!d)try{s=ke(t)}catch(t){return Ye(n._readableStreamController,t),Ye(a._readableStreamController,t),void i(Fr(e,t))}u||We(n._readableStreamController,r),d||We(a._readableStreamController,s),o=!1,c?v():l&&_()}))},_closeSteps:()=>{o=!1,u||He(n._readableStreamController),d||He(a._readableStreamController),n._readableStreamController._pendingPullIntos.length>0&&Qe(n._readableStreamController,0),a._readableStreamController._pendingPullIntos.length>0&&Qe(a._readableStreamController,0),u&&d||i(void 0)},_errorSteps:()=>{o=!1}})}function b(t,r){te(s)&&(A(s),s=it(e),m(s));const h=r?a:n,p=r?n:a;dt(s,t,1,{_chunkSteps:t=>{w((()=>{c=!1,l=!1;const n=r?d:u;if(r?u:d)n||et(h._readableStreamController,t);else{let r;try{r=ke(t)}catch(t){return Ye(h._readableStreamController,t),Ye(p._readableStreamController,t),void i(Fr(e,t))}n||et(h._readableStreamController,t),We(p._readableStreamController,r)}o=!1,c?v():l&&_()}))},_closeSteps:e=>{o=!1;const t=r?d:u,n=r?u:d;t||He(h._readableStreamController),n||He(p._readableStreamController),void 0!==e&&(t||et(h._readableStreamController,e),!n&&p._readableStreamController._pendingPullIntos.length>0&&Qe(p._readableStreamController,0)),t&&n||i(void 0)},_errorSteps:()=>{o=!1}})}function v(){if(o)return c=!0,p(void 0);o=!0;const e=Ke(n._readableStreamController);return null===e?g():b(e._view,!1),p(void 0)}function _(){if(o)return l=!0,p(void 0);o=!0;const e=Ke(a._readableStreamController);return null===e?g():b(e._view,!0),p(void 0)}function O(){}return n=$r(O,v,(function(n){if(u=!0,t=n,d){const n=ce([t,r]),a=Fr(e,n);i(a)}return f})),a=$r(O,_,(function(n){if(d=!0,r=n,u){const n=ce([t,r]),a=Fr(e,n);i(a)}return f})),m(s),[n,a]}(e):function(e){const t=Y(e);let r,n,a,i,s,o=!1,c=!1,l=!1,u=!1;const d=h((e=>{s=e}));function f(){return o?(c=!0,p(void 0)):(o=!0,re(t,{_chunkSteps:e=>{w((()=>{c=!1;const t=e,r=e;l||wr(a._readableStreamController,t),u||wr(i._readableStreamController,r),o=!1,c&&f()}))},_closeSteps:()=>{o=!1,l||_r(a._readableStreamController),u||_r(i._readableStreamController),l&&u||s(void 0)},_errorSteps:()=>{o=!1}}),p(void 0))}function m(){}return a=Nr(m,f,(function(t){if(l=!0,r=t,u){const t=ce([r,n]),a=Fr(e,t);s(a)}return d})),i=Nr(m,f,(function(t){if(u=!0,n=t,l){const t=ce([r,n]),a=Fr(e,t);s(a)}return d})),y(t._closedPromise,(e=>(Or(a._readableStreamController,e),Or(i._readableStreamController,e),l&&u||s(void 0),null))),[a,i]}(e)}(this))}values(e=void 0){if(!Mr(this))throw zr("values");return function(e,t){const r=Y(e),n=new ye(r,t),a=Object.create(ve);return a._asyncIteratorImpl=n,a}(this,function(e){U(e,"First parameter");const t=null==e?void 0:e.preventCancel;return{preventCancel:Boolean(t)}}(e).preventCancel)}[me](e){return this.values(e)}static from(e){return Pr(e)}}function Nr(e,t,r,n=1,a=()=>1){const i=Object.create(Rr.prototype);return Lr(i),Sr(i,Object.create(mr.prototype),e,t,r,n,a),i}function $r(e,t,r){const n=Object.create(Rr.prototype);return Lr(n),tt(n,Object.create(je.prototype),e,t,r,0,void 0),n}function Lr(e){e._state="readable",e._reader=void 0,e._storedError=void 0,e._disturbed=!1}function Mr(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readableStreamController")&&e instanceof Rr}function Dr(e){return void 0!==e._reader}function Fr(e,t){if(e._disturbed=!0,"closed"===e._state)return p(void 0);if("errored"===e._state)return f(e._storedError);Ur(e);const r=e._reader;if(void 0!==r&&ut(r)){const e=r._readIntoRequests;r._readIntoRequests=new E,e.forEach((e=>{e._closeSteps(void 0)}))}return v(e._readableStreamController[P](t),n)}function Ur(e){e._state="closed";const t=e._reader;if(void 0!==t&&(M(t),te(t))){const e=t._readRequests;t._readRequests=new E,e.forEach((e=>{e._closeSteps()}))}}function Br(e,t){e._state="errored",e._storedError=t;const r=e._reader;void 0!==r&&(L(r,t),te(r)?ne(r,t):ht(r,t))}function zr(e){return new TypeError(`ReadableStream.prototype.${e} can only be used on a ReadableStream`)}function Vr(e,t){U(e,t);const r=null==e?void 0:e.highWaterMark;return q(r,"highWaterMark","QueuingStrategyInit"),{highWaterMark:Z(r)}}Object.defineProperties(Rr,{from:{enumerable:!0}}),Object.defineProperties(Rr.prototype,{cancel:{enumerable:!0},getReader:{enumerable:!0},pipeThrough:{enumerable:!0},pipeTo:{enumerable:!0},tee:{enumerable:!0},values:{enumerable:!0},locked:{enumerable:!0}}),s(Rr.from,"from"),s(Rr.prototype.cancel,"cancel"),s(Rr.prototype.getReader,"getReader"),s(Rr.prototype.pipeThrough,"pipeThrough"),s(Rr.prototype.pipeTo,"pipeTo"),s(Rr.prototype.tee,"tee"),s(Rr.prototype.values,"values"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(Rr.prototype,Symbol.toStringTag,{value:"ReadableStream",configurable:!0}),Object.defineProperty(Rr.prototype,me,{value:Rr.prototype.values,writable:!0,configurable:!0});const qr=e=>e.byteLength;s(qr,"size");class Zr{constructor(e){V(e,1,"ByteLengthQueuingStrategy"),e=Vr(e,"First parameter"),this._byteLengthQueuingStrategyHighWaterMark=e.highWaterMark}get highWaterMark(){if(!Hr(this))throw Gr("highWaterMark");return this._byteLengthQueuingStrategyHighWaterMark}get size(){if(!Hr(this))throw Gr("size");return qr}}function Gr(e){return new TypeError(`ByteLengthQueuingStrategy.prototype.${e} can only be used on a ByteLengthQueuingStrategy`)}function Hr(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_byteLengthQueuingStrategyHighWaterMark")&&e instanceof Zr}Object.defineProperties(Zr.prototype,{highWaterMark:{enumerable:!0},size:{enumerable:!0}}),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(Zr.prototype,Symbol.toStringTag,{value:"ByteLengthQueuingStrategy",configurable:!0});const Wr=()=>1;s(Wr,"size");class Yr{constructor(e){V(e,1,"CountQueuingStrategy"),e=Vr(e,"First parameter"),this._countQueuingStrategyHighWaterMark=e.highWaterMark}get highWaterMark(){if(!Kr(this))throw Jr("highWaterMark");return this._countQueuingStrategyHighWaterMark}get size(){if(!Kr(this))throw Jr("size");return Wr}}function Jr(e){return new TypeError(`CountQueuingStrategy.prototype.${e} can only be used on a CountQueuingStrategy`)}function Kr(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_countQueuingStrategyHighWaterMark")&&e instanceof Yr}function Xr(e,t,r){return B(e,r),r=>k(e,t,[r])}function Qr(e,t,r){return B(e,r),r=>O(e,t,[r])}function en(e,t,r){return B(e,r),(r,n)=>k(e,t,[r,n])}function tn(e,t,r){return B(e,r),r=>k(e,t,[r])}Object.defineProperties(Yr.prototype,{highWaterMark:{enumerable:!0},size:{enumerable:!0}}),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(Yr.prototype,Symbol.toStringTag,{value:"CountQueuingStrategy",configurable:!0});class rn{constructor(e={},t={},r={}){void 0===e&&(e=null);const n=gt(t,"Second parameter"),a=gt(r,"Third parameter"),i=function(e,t){U(e,t);const r=null==e?void 0:e.cancel,n=null==e?void 0:e.flush,a=null==e?void 0:e.readableType,i=null==e?void 0:e.start,s=null==e?void 0:e.transform,o=null==e?void 0:e.writableType;return{cancel:void 0===r?void 0:tn(r,e,`${t} has member 'cancel' that`),flush:void 0===n?void 0:Xr(n,e,`${t} has member 'flush' that`),readableType:a,start:void 0===i?void 0:Qr(i,e,`${t} has member 'start' that`),transform:void 0===s?void 0:en(s,e,`${t} has member 'transform' that`),writableType:o}}(e,"First parameter");if(void 0!==i.readableType)throw new RangeError("Invalid readableType specified");if(void 0!==i.writableType)throw new RangeError("Invalid writableType specified");const s=ft(a,0),o=mt(a),c=ft(n,1),l=mt(n);let u;!function(e,t,r,n,a,i){function s(){return t}e._writable=function(e,t,r,n,a=1,i=()=>1){const s=Object.create(Et.prototype);return Tt(s),Gt(s,Object.create(qt.prototype),e,t,r,n,a,i),s}(s,(function(t){return function(e,t){const r=e._transformStreamController;return e._backpressure?v(e._backpressureChangePromise,(()=>{const n=e._writable;if("erroring"===n._state)throw n._storedError;return pn(r,t)})):pn(r,t)}(e,t)}),(function(){return function(e){const t=e._transformStreamController;if(void 0!==t._finishPromise)return t._finishPromise;const r=e._readable;t._finishPromise=h(((e,r)=>{t._finishPromise_resolve=e,t._finishPromise_reject=r}));const n=t._flushAlgorithm();return dn(t),g(n,(()=>("errored"===r._state?gn(t,r._storedError):(_r(r._readableStreamController),mn(t)),null)),(e=>(Or(r._readableStreamController,e),gn(t,e),null))),t._finishPromise}(e)}),(function(t){return function(e,t){const r=e._transformStreamController;if(void 0!==r._finishPromise)return r._finishPromise;const n=e._readable;r._finishPromise=h(((e,t)=>{r._finishPromise_resolve=e,r._finishPromise_reject=t}));const a=r._cancelAlgorithm(t);return dn(r),g(a,(()=>("errored"===n._state?gn(r,n._storedError):(Or(n._readableStreamController,t),mn(r)),null)),(e=>(Or(n._readableStreamController,e),gn(r,e),null))),r._finishPromise}(e,t)}),r,n),e._readable=Nr(s,(function(){return function(e){return cn(e,!1),e._backpressureChangePromise}(e)}),(function(t){return function(e,t){const r=e._transformStreamController;if(void 0!==r._finishPromise)return r._finishPromise;const n=e._writable;r._finishPromise=h(((e,t)=>{r._finishPromise_resolve=e,r._finishPromise_reject=t}));const a=r._cancelAlgorithm(t);return dn(r),g(a,(()=>("errored"===n._state?gn(r,n._storedError):(Jt(n._writableStreamController,t),on(e),mn(r)),null)),(t=>(Jt(n._writableStreamController,t),on(e),gn(r,t),null))),r._finishPromise}(e,t)}),a,i),e._backpressure=void 0,e._backpressureChangePromise=void 0,e._backpressureChangePromise_resolve=void 0,cn(e,!0),e._transformStreamController=void 0}(this,h((e=>{u=e})),c,l,s,o),function(e,t){const r=Object.create(ln.prototype);let n,a,i;n=void 0!==t.transform?e=>t.transform(e,r):e=>{try{return hn(r,e),p(void 0)}catch(e){return f(e)}},a=void 0!==t.flush?()=>t.flush(r):()=>p(void 0),i=void 0!==t.cancel?e=>t.cancel(e):()=>p(void 0),function(e,t,r,n,a){t._controlledTransformStream=e,e._transformStreamController=t,t._transformAlgorithm=r,t._flushAlgorithm=n,t._cancelAlgorithm=a,t._finishPromise=void 0,t._finishPromise_resolve=void 0,t._finishPromise_reject=void 0}(e,r,n,a,i)}(this,i),void 0!==i.start?u(i.start(this._transformStreamController)):u(void 0)}get readable(){if(!nn(this))throw bn("readable");return this._readable}get writable(){if(!nn(this))throw bn("writable");return this._writable}}function nn(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_transformStreamController")&&e instanceof rn}function an(e,t){Or(e._readable._readableStreamController,t),sn(e,t)}function sn(e,t){dn(e._transformStreamController),Jt(e._writable._writableStreamController,t),on(e)}function on(e){e._backpressure&&cn(e,!1)}function cn(e,t){void 0!==e._backpressureChangePromise&&e._backpressureChangePromise_resolve(),e._backpressureChangePromise=h((t=>{e._backpressureChangePromise_resolve=t})),e._backpressure=t}Object.defineProperties(rn.prototype,{readable:{enumerable:!0},writable:{enumerable:!0}}),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(rn.prototype,Symbol.toStringTag,{value:"TransformStream",configurable:!0});class ln{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!un(this))throw fn("desiredSize");return kr(this._controlledTransformStream._readable._readableStreamController)}enqueue(e=void 0){if(!un(this))throw fn("enqueue");hn(this,e)}error(e=void 0){if(!un(this))throw fn("error");var t;t=e,an(this._controlledTransformStream,t)}terminate(){if(!un(this))throw fn("terminate");!function(e){const t=e._controlledTransformStream;_r(t._readable._readableStreamController),sn(t,new TypeError("TransformStream terminated"))}(this)}}function un(e){return!!a(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledTransformStream")&&e instanceof ln}function dn(e){e._transformAlgorithm=void 0,e._flushAlgorithm=void 0,e._cancelAlgorithm=void 0}function hn(e,t){const r=e._controlledTransformStream,n=r._readable._readableStreamController;if(!Er(n))throw new TypeError("Readable side is not in a state that permits enqueue");try{wr(n,t)}catch(e){throw sn(r,e),r._readable._storedError}const a=function(e){return!yr(e)}(n);a!==r._backpressure&&cn(r,!0)}function pn(e,t){return v(e._transformAlgorithm(t),void 0,(t=>{throw an(e._controlledTransformStream,t),t}))}function fn(e){return new TypeError(`TransformStreamDefaultController.prototype.${e} can only be used on a TransformStreamDefaultController`)}function mn(e){void 0!==e._finishPromise_resolve&&(e._finishPromise_resolve(),e._finishPromise_resolve=void 0,e._finishPromise_reject=void 0)}function gn(e,t){void 0!==e._finishPromise_reject&&(_(e._finishPromise),e._finishPromise_reject(t),e._finishPromise_resolve=void 0,e._finishPromise_reject=void 0)}function bn(e){return new TypeError(`TransformStream.prototype.${e} can only be used on a TransformStream`)}Object.defineProperties(ln.prototype,{enqueue:{enumerable:!0},error:{enumerable:!0},terminate:{enumerable:!0},desiredSize:{enumerable:!0}}),s(ln.prototype.enqueue,"enqueue"),s(ln.prototype.error,"error"),s(ln.prototype.terminate,"terminate"),"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(ln.prototype,Symbol.toStringTag,{value:"TransformStreamDefaultController",configurable:!0})},2522:(e,t,r)=>{r.d(t,{Ik:()=>R});const n=Symbol("Let zodToJsonSchema decide on which parser to use"),a={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};var i=r(4476);function s(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function o(e,t,r,n,a){e[t]=r,s(e,t,n,a)}function c(e,t){return x(e.type._def,t)}function l(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(((r,n)=>l(e,t,r)))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return u(e,t)}}const u=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const n of e.checks)switch(n.kind){case"min":o(r,"minimum",n.value,n.message,t);break;case"max":o(r,"maximum",n.value,n.message,t)}return r};let d;const h=/^[cC][^\s-]{8,}$/,p=/^[0-9a-z]+$/,f=/^[0-9A-HJKMNP-TV-Z]{26}$/,m=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,g=()=>(void 0===d&&(d=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),d),b=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,y=/^[a-zA-Z0-9_-]{21}$/;function v(e,t){const r={type:"string"};function n(e){return"escape"===t.patternStrategy?_(e):e}if(e.checks)for(const a of e.checks)switch(a.kind){case"min":o(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":o(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":w(r,"email",a.message,t);break;case"format:idn-email":w(r,"idn-email",a.message,t);break;case"pattern:zod":O(r,m,a.message,t)}break;case"url":w(r,"uri",a.message,t);break;case"uuid":w(r,"uuid",a.message,t);break;case"regex":O(r,a.regex,a.message,t);break;case"cuid":O(r,h,a.message,t);break;case"cuid2":O(r,p,a.message,t);break;case"startsWith":O(r,RegExp(`^${n(a.value)}`),a.message,t);break;case"endsWith":O(r,RegExp(`${n(a.value)}$`),a.message,t);break;case"datetime":w(r,"date-time",a.message,t);break;case"date":w(r,"date",a.message,t);break;case"time":w(r,"time",a.message,t);break;case"duration":w(r,"duration",a.message,t);break;case"length":o(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),o(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":O(r,RegExp(n(a.value)),a.message,t);break;case"ip":"v6"!==a.version&&w(r,"ipv4",a.message,t),"v4"!==a.version&&w(r,"ipv6",a.message,t);break;case"emoji":O(r,g,a.message,t);break;case"ulid":O(r,f,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":w(r,"binary",a.message,t);break;case"contentEncoding:base64":o(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":O(r,b,a.message,t)}break;case"nanoid":O(r,y,a.message,t)}return r}const _=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),w=(e,t,r,n)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):o(e,"format",t,r,n)},O=(e,t,r,n)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:k(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):o(e,"pattern",k(t,n),r,n)},k=(e,t)=>{const r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;const n=r.flags.includes("i"),a=r.flags.includes("m"),i=r.flags.includes("s"),s=n?r.source.toLowerCase():r.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<s.length;e++)if(c)o+=s[e],c=!1;else{if(n)if(l){if(s[e].match(/[a-z]/)){u?(o+=s[e],o+=`${s[e-2]}-${s[e]}`.toUpperCase(),u=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(o+=s[e],u=!0):o+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){o+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(a){if("^"===s[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){o+="($|(?=[\r\n]))";continue}}i&&"."===s[e]?o+=l?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(o+=s[e],"\\"===s[e]?c=!0:l&&"]"===s[e]?l=!1:l||"["!==s[e]||(l=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return o};function E(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===i.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((r,n)=>({...r,[n]:x(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??{}})),{}),additionalProperties:!1};const r={type:"object",additionalProperties:x(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===i.kY.ZodString&&e.keyType._def.checks?.length){const{type:n,...a}=v(e.keyType._def,t);return{...r,propertyNames:a}}if(e.keyType?._def.typeName===i.kY.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===i.kY.ZodBranded&&e.keyType._def.type._def.typeName===i.kY.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...a}=c(e.keyType._def,t);return{...r,propertyNames:a}}return r}const S={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},T=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,r)=>x(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return r.length?{anyOf:r}:void 0};function P(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:x(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:x(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function x(e,t,r=!1){const a=t.seen.get(e);if(t.override){const i=t.override?.(e,t,a,r);if(i!==n)return i}if(a&&!r){const e=j(a,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=I(e,e.typeName,t);return s&&A(e,t,s),i.jsonSchema=s,s}const j=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:C(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,r)=>t.currentPath[r]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},C=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},I=(e,t,r)=>{switch(t){case i.kY.ZodString:return v(e,r);case i.kY.ZodNumber:return function(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",s(r,"type",n.message,t);break;case"min":"jsonSchema7"===t.target?n.inclusive?o(r,"minimum",n.value,n.message,t):o(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),o(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?o(r,"maximum",n.value,n.message,t):o(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),o(r,"maximum",n.value,n.message,t));break;case"multipleOf":o(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case i.kY.ZodObject:return function(e,t){const r={type:"object",...Object.entries(e.shape()).reduce(((e,[r,n])=>{if(void 0===n||void 0===n._def)return e;const a=x(n._def,{...t,currentPath:[...t.currentPath,"properties",r],propertyPath:[...t.currentPath,"properties",r]});return void 0===a?e:{properties:{...e.properties,[r]:a},required:n.isOptional()?e.required:[...e.required,r]}}),{properties:{},required:[]}),additionalProperties:P(e,t)};return r.required.length||delete r.required,r}(e,r);case i.kY.ZodBigInt:return function(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":"jsonSchema7"===t.target?n.inclusive?o(r,"minimum",n.value,n.message,t):o(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),o(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?o(r,"maximum",n.value,n.message,t):o(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),o(r,"maximum",n.value,n.message,t));break;case"multipleOf":o(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case i.kY.ZodBoolean:return{type:"boolean"};case i.kY.ZodDate:return l(e,r);case i.kY.ZodUndefined:return{not:{}};case i.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(r);case i.kY.ZodArray:return function(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==i.kY.ZodAny&&(r.items=x(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&o(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&o(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(o(r,"minItems",e.exactLength.value,e.exactLength.message,t),o(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case i.kY.ZodUnion:case i.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return T(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every((e=>e._def.typeName in S&&(!e._def.checks||!e._def.checks.length)))){const e=r.reduce(((e,t)=>{const r=S[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e}),[]);return{type:e.length>1?e:e[0]}}if(r.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=r.reduce(((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===r.length){const t=e.filter(((e,t,r)=>r.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:r.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(r.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:r.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return T(e,t)}(e,r);case i.kY.ZodIntersection:return function(e,t){const r=[x(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),x(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let n="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...n}=e;t=n}else n=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(n=void 0);var t})),a.length?{allOf:a,...n}:void 0}(e,r);case i.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,r)=>x(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:x(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,r)=>x(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,r);case i.kY.ZodRecord:return E(e,r);case i.kY.ZodLiteral:return function(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case i.kY.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case i.kY.ZodNativeEnum:return function(e){const t=e.values,r=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),n=Array.from(new Set(r.map((e=>typeof e))));return{type:1===n.length?"string"===n[0]?"string":"number":["string","number"],enum:r}}(e);case i.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:S[e.innerType._def.typeName],nullable:!0}:{type:[S[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=x(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=x(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case i.kY.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return x(e.innerType._def,t);const r=x(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:{}},r]}:{}})(e,r);case i.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?E(e,t):{type:"array",maxItems:125,items:{type:"array",items:[x(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},x(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,r);case i.kY.ZodSet:return function(e,t){const r={type:"array",uniqueItems:!0,items:x(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&o(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&o(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case i.kY.ZodLazy:return x(e.getter()._def,r);case i.kY.ZodPromise:return function(e,t){return x(e.type._def,t)}(e,r);case i.kY.ZodNaN:case i.kY.ZodNever:return{not:{}};case i.kY.ZodEffects:return function(e,t){return"input"===t.effectStrategy?x(e.schema._def,t):{}}(e,r);case i.kY.ZodAny:case i.kY.ZodUnknown:return{};case i.kY.ZodDefault:return function(e,t){return{...x(e.innerType._def,t),default:e.defaultValue()}}(e,r);case i.kY.ZodBranded:return c(e,r);case i.kY.ZodReadonly:case i.kY.ZodCatch:return((e,t)=>x(e.innerType._def,t))(e,r);case i.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return x(e.in._def,t);if("output"===t.pipeStrategy)return x(e.out._def,t);const r=x(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,x(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter((e=>void 0!==e))}})(e,r);case i.kY.ZodFunction:case i.kY.ZodVoid:case i.kY.ZodSymbol:default:return}},A=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),R=(e,t)=>{const r=(e=>{const t=(e=>"string"==typeof e?{...a,name:e}:{...a,...e})(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,n])=>({...e,[t]:x(n._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??{}})),{}):void 0,i="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=x(e._def,void 0===i?r:{...r,currentPath:[...r.basePath,r.definitionPath,i]},!1)??{},o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(s.title=o);const c=void 0===i?n?{...s,[r.definitionPath]:n}:s:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...n,[i]:s}};return"jsonSchema7"===r.target?c.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(c.$schema="https://json-schema.org/draft/2019-09/schema#"),c}},4476:(e,t,r)=>{var n,a;r.d(t,{kY:()=>Le,z:()=>vt}),function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},e.getValidEnumValues=t=>{const r=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),n={};for(const e of r)n[e]=t[e];return e.objectValues(n)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},e.find=(e,t)=>{for(const r of e)if(t(r))return r},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(n||(n={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(a||(a={}));const i=n.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),s=e=>{switch(typeof e){case"undefined":return i.undefined;case"string":return i.string;case"number":return isNaN(e)?i.nan:i.number;case"boolean":return i.boolean;case"function":return i.function;case"bigint":return i.bigint;case"symbol":return i.symbol;case"object":return Array.isArray(e)?i.array:null===e?i.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?i.promise:"undefined"!=typeof Map&&e instanceof Map?i.map:"undefined"!=typeof Set&&e instanceof Set?i.set:"undefined"!=typeof Date&&e instanceof Date?i.date:i.object;default:return i.unknown}},o=n.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class c extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},r={_errors:[]},n=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(n);else if("invalid_return_type"===a.code)n(a.returnTypeError);else if("invalid_arguments"===a.code)n(a.argumentsError);else if(0===a.path.length)r._errors.push(t(a));else{let e=r,n=0;for(;n<a.path.length;){const r=a.path[n];n===a.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(a))):e[r]=e[r]||{_errors:[]},e=e[r],n++}}};return n(this),r}static assert(e){if(!(e instanceof c))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,n.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const n of this.issues)n.path.length>0?(t[n.path[0]]=t[n.path[0]]||[],t[n.path[0]].push(e(n))):r.push(e(n));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}c.create=e=>new c(e);const l=(e,t)=>{let r;switch(e.code){case o.invalid_type:r=e.received===i.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case o.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,n.jsonStringifyReplacer)}`;break;case o.unrecognized_keys:r=`Unrecognized key(s) in object: ${n.joinValues(e.keys,", ")}`;break;case o.invalid_union:r="Invalid input";break;case o.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${n.joinValues(e.options)}`;break;case o.invalid_enum_value:r=`Invalid enum value. Expected ${n.joinValues(e.options)}, received '${e.received}'`;break;case o.invalid_arguments:r="Invalid function arguments";break;case o.invalid_return_type:r="Invalid function return type";break;case o.invalid_date:r="Invalid date";break;case o.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:n.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case o.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case o.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case o.custom:r="Invalid input";break;case o.invalid_intersection_types:r="Intersection results could not be merged";break;case o.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case o.not_finite:r="Number must be finite";break;default:r=t.defaultError,n.assertNever(e)}return{message:r}};let u=l;function d(){return u}const h=e=>{const{data:t,path:r,errorMaps:n,issueData:a}=e,i=[...r,...a.path||[]],s={...a,path:i};if(void 0!==a.message)return{...a,path:i,message:a.message};let o="";const c=n.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(s,{data:t,defaultError:o}).message;return{...a,path:i,message:o}};function p(e,t){const r=d(),n=h({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===l?void 0:l].filter((e=>!!e))});e.common.issues.push(n)}class f{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const n of t){if("aborted"===n.status)return m;"dirty"===n.status&&e.dirty(),r.push(n.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,n=await e.value;r.push({key:t,value:n})}return f.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const n of t){const{key:t,value:a}=n;if("aborted"===t.status)return m;if("aborted"===a.status)return m;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!n.alwaysSet||(r[t.value]=a.value)}return{status:e.value,value:r}}}const m=Object.freeze({status:"aborted"}),g=e=>({status:"dirty",value:e}),b=e=>({status:"valid",value:e}),y=e=>"aborted"===e.status,v=e=>"dirty"===e.status,_=e=>"valid"===e.status,w=e=>"undefined"!=typeof Promise&&e instanceof Promise;function O(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}function k(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r}var E,S,T;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(E||(E={}));class P{constructor(e,t,r,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=n}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const x=(e,t)=>{if(_(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new c(e.common.issues);return this._error=t,this._error}}};function j(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:a}=e;if(t&&(r||n))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{var i,s;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:a.defaultError}:void 0===a.data?{message:null!==(i=null!=o?o:n)&&void 0!==i?i:a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:null!==(s=null!=o?o:r)&&void 0!==s?s:a.defaultError}},description:a}}class C{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return s(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:s(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new f,ctx:{common:e.parent.common,data:e.data,parsedType:s(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(w(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const n={common:{issues:[],async:null!==(r=null==t?void 0:t.async)&&void 0!==r&&r,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:s(e)},a=this._parseSync({data:e,path:n.path,parent:n});return x(n,a)}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:s(e)},n=this._parse({data:e,path:r.path,parent:r}),a=await(w(n)?n:Promise.resolve(n));return x(r,a)}refine(e,t){const r=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,n)=>{const a=e(t),i=()=>n.addIssue({code:o.custom,...r(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then((e=>!!e||(i(),!1))):!!a||(i(),!1)}))}refinement(e,t){return this._refinement(((r,n)=>!!e(r)||(n.addIssue("function"==typeof t?t(r,n):t),!1)))}_refinement(e){return new Ee({schema:this,typeName:Le.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Se.create(this,this._def)}nullable(){return Te.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ie.create(this,this._def)}promise(){return ke.create(this,this._def)}or(e){return ce.create([this,e],this._def)}and(e){return he.create(this,e,this._def)}transform(e){return new Ee({...j(this._def),schema:this,typeName:Le.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Pe({...j(this._def),innerType:this,defaultValue:t,typeName:Le.ZodDefault})}brand(){return new Ie({typeName:Le.ZodBranded,type:this,...j(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new xe({...j(this._def),innerType:this,catchValue:t,typeName:Le.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Ae.create(this,e)}readonly(){return Re.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const I=/^c[^\s-]{8,}$/i,A=/^[0-9a-z]+$/,R=/^[0-9A-HJKMNP-TV-Z]{26}$/,N=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,$=/^[a-z0-9_-]{21}$/i,L=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,M=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let D;const F=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,U=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,B=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,z="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",V=new RegExp(`^${z}$`);function q(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function Z(e){let t=`${z}T${q(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}class G extends C{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==i.string){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.string,received:t.parsedType}),m}const t=new f;let r;for(const i of this._def.checks)if("min"===i.kind)e.data.length<i.value&&(r=this._getOrReturnCtx(e,r),p(r,{code:o.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if("max"===i.kind)e.data.length>i.value&&(r=this._getOrReturnCtx(e,r),p(r,{code:o.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if("length"===i.kind){const n=e.data.length>i.value,a=e.data.length<i.value;(n||a)&&(r=this._getOrReturnCtx(e,r),n?p(r,{code:o.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):a&&p(r,{code:o.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),t.dirty())}else if("email"===i.kind)M.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"email",code:o.invalid_string,message:i.message}),t.dirty());else if("emoji"===i.kind)D||(D=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),D.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"emoji",code:o.invalid_string,message:i.message}),t.dirty());else if("uuid"===i.kind)N.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"uuid",code:o.invalid_string,message:i.message}),t.dirty());else if("nanoid"===i.kind)$.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"nanoid",code:o.invalid_string,message:i.message}),t.dirty());else if("cuid"===i.kind)I.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"cuid",code:o.invalid_string,message:i.message}),t.dirty());else if("cuid2"===i.kind)A.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"cuid2",code:o.invalid_string,message:i.message}),t.dirty());else if("ulid"===i.kind)R.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"ulid",code:o.invalid_string,message:i.message}),t.dirty());else if("url"===i.kind)try{new URL(e.data)}catch(n){r=this._getOrReturnCtx(e,r),p(r,{validation:"url",code:o.invalid_string,message:i.message}),t.dirty()}else"regex"===i.kind?(i.regex.lastIndex=0,i.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"regex",code:o.invalid_string,message:i.message}),t.dirty())):"trim"===i.kind?e.data=e.data.trim():"includes"===i.kind?e.data.includes(i.value,i.position)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),t.dirty()):"toLowerCase"===i.kind?e.data=e.data.toLowerCase():"toUpperCase"===i.kind?e.data=e.data.toUpperCase():"startsWith"===i.kind?e.data.startsWith(i.value)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:{startsWith:i.value},message:i.message}),t.dirty()):"endsWith"===i.kind?e.data.endsWith(i.value)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:{endsWith:i.value},message:i.message}),t.dirty()):"datetime"===i.kind?Z(i).test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:"datetime",message:i.message}),t.dirty()):"date"===i.kind?V.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:"date",message:i.message}),t.dirty()):"time"===i.kind?new RegExp(`^${q(i)}$`).test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{code:o.invalid_string,validation:"time",message:i.message}),t.dirty()):"duration"===i.kind?L.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"duration",code:o.invalid_string,message:i.message}),t.dirty()):"ip"===i.kind?(a=e.data,("v4"!==(s=i.version)&&s||!F.test(a))&&("v6"!==s&&s||!U.test(a))&&(r=this._getOrReturnCtx(e,r),p(r,{validation:"ip",code:o.invalid_string,message:i.message}),t.dirty())):"base64"===i.kind?B.test(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{validation:"base64",code:o.invalid_string,message:i.message}),t.dirty()):n.assertNever(i);var a,s;return{status:t.value,value:e.data}}_regex(e,t,r){return this.refinement((t=>e.test(t)),{validation:t,code:o.invalid_string,...E.errToObj(r)})}_addCheck(e){return new G({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}datetime(e){var t,r;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(r=null==e?void 0:e.local)&&void 0!==r&&r,...E.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...E.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...E.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...E.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new G({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new G({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new G({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function H(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,a=r>n?r:n;return parseInt(e.toFixed(a).replace(".",""))%parseInt(t.toFixed(a).replace(".",""))/Math.pow(10,a)}G.create=e=>{var t;return new G({checks:[],typeName:Le.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...j(e)})};class W extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==i.number){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.number,received:t.parsedType}),m}let t;const r=new f;for(const a of this._def.checks)"int"===a.kind?n.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),p(t,{code:o.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==H(e.data,a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_finite,message:a.message}),r.dirty()):n.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,n){return new W({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(n)}]})}_addCheck(e){return new W({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&n.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}W.create=e=>new W({checks:[],typeName:Le.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...j(e)});class Y extends C{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==i.bigint){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.bigint,received:t.parsedType}),m}let t;const r=new f;for(const a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):n.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,n){return new Y({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(n)}]})}_addCheck(e){return new Y({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Y.create=e=>{var t;return new Y({checks:[],typeName:Le.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...j(e)})};class J extends C{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==i.boolean){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.boolean,received:t.parsedType}),m}return b(e.data)}}J.create=e=>new J({typeName:Le.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...j(e)});class K extends C{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==i.date){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.date,received:t.parsedType}),m}if(isNaN(e.data.getTime()))return p(this._getOrReturnCtx(e),{code:o.invalid_date}),m;const t=new f;let r;for(const a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),p(r,{code:o.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),t.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),p(r,{code:o.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),t.dirty()):n.assertNever(a);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new K({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}K.create=e=>new K({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Le.ZodDate,...j(e)});class X extends C{_parse(e){if(this._getType(e)!==i.symbol){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.symbol,received:t.parsedType}),m}return b(e.data)}}X.create=e=>new X({typeName:Le.ZodSymbol,...j(e)});class Q extends C{_parse(e){if(this._getType(e)!==i.undefined){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.undefined,received:t.parsedType}),m}return b(e.data)}}Q.create=e=>new Q({typeName:Le.ZodUndefined,...j(e)});class ee extends C{_parse(e){if(this._getType(e)!==i.null){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.null,received:t.parsedType}),m}return b(e.data)}}ee.create=e=>new ee({typeName:Le.ZodNull,...j(e)});class te extends C{constructor(){super(...arguments),this._any=!0}_parse(e){return b(e.data)}}te.create=e=>new te({typeName:Le.ZodAny,...j(e)});class re extends C{constructor(){super(...arguments),this._unknown=!0}_parse(e){return b(e.data)}}re.create=e=>new re({typeName:Le.ZodUnknown,...j(e)});class ne extends C{_parse(e){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.never,received:t.parsedType}),m}}ne.create=e=>new ne({typeName:Le.ZodNever,...j(e)});class ae extends C{_parse(e){if(this._getType(e)!==i.undefined){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.void,received:t.parsedType}),m}return b(e.data)}}ae.create=e=>new ae({typeName:Le.ZodVoid,...j(e)});class ie extends C{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),n=this._def;if(t.parsedType!==i.array)return p(t,{code:o.invalid_type,expected:i.array,received:t.parsedType}),m;if(null!==n.exactLength){const e=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(e||a)&&(p(t,{code:e?o.too_big:o.too_small,minimum:a?n.exactLength.value:void 0,maximum:e?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(null!==n.minLength&&t.data.length<n.minLength.value&&(p(t,{code:o.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),null!==n.maxLength&&t.data.length>n.maxLength.value&&(p(t,{code:o.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map(((e,r)=>n.type._parseAsync(new P(t,e,t.path,r))))).then((e=>f.mergeArray(r,e)));const a=[...t.data].map(((e,r)=>n.type._parseSync(new P(t,e,t.path,r))));return f.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new ie({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new ie({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new ie({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}}function se(e){if(e instanceof oe){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=Se.create(se(n))}return new oe({...e._def,shape:()=>t})}return e instanceof ie?new ie({...e._def,type:se(e.element)}):e instanceof Se?Se.create(se(e.unwrap())):e instanceof Te?Te.create(se(e.unwrap())):e instanceof pe?pe.create(e.items.map((e=>se(e)))):e}ie.create=(e,t)=>new ie({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Le.ZodArray,...j(t)});class oe extends C{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=n.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==i.object){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.object,received:t.parsedType}),m}const{status:t,ctx:r}=this._processInputParams(e),{shape:n,keys:a}=this._getCached(),s=[];if(!(this._def.catchall instanceof ne&&"strip"===this._def.unknownKeys))for(const e in r.data)a.includes(e)||s.push(e);const c=[];for(const e of a){const t=n[e],a=r.data[e];c.push({key:{status:"valid",value:e},value:t._parse(new P(r,a,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof ne){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)c.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)s.length>0&&(p(r,{code:o.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const n=r.data[t];c.push({key:{status:"valid",value:t},value:e._parse(new P(r,n,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of c){const r=await t.key,n=await t.value;e.push({key:r,value:n,alwaysSet:t.alwaysSet})}return e})).then((e=>f.mergeObjectSync(t,e))):f.mergeObjectSync(t,c)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new oe({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{var n,a,i,s;const o=null!==(i=null===(a=(n=this._def).errorMap)||void 0===a?void 0:a.call(n,t,r).message)&&void 0!==i?i:r.defaultError;return"unrecognized_keys"===t.code?{message:null!==(s=E.errToObj(e).message)&&void 0!==s?s:o}:{message:o}}}:{}})}strip(){return new oe({...this._def,unknownKeys:"strip"})}passthrough(){return new oe({...this._def,unknownKeys:"passthrough"})}extend(e){return new oe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new oe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Le.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new oe({...this._def,catchall:e})}pick(e){const t={};return n.objectKeys(e).forEach((r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])})),new oe({...this._def,shape:()=>t})}omit(e){const t={};return n.objectKeys(this.shape).forEach((r=>{e[r]||(t[r]=this.shape[r])})),new oe({...this._def,shape:()=>t})}deepPartial(){return se(this)}partial(e){const t={};return n.objectKeys(this.shape).forEach((r=>{const n=this.shape[r];e&&!e[r]?t[r]=n:t[r]=n.optional()})),new oe({...this._def,shape:()=>t})}required(e){const t={};return n.objectKeys(this.shape).forEach((r=>{if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof Se;)e=e._def.innerType;t[r]=e}})),new oe({...this._def,shape:()=>t})}keyof(){return _e(n.objectKeys(this.shape))}}oe.create=(e,t)=>new oe({shape:()=>e,unknownKeys:"strip",catchall:ne.create(),typeName:Le.ZodObject,...j(t)}),oe.strictCreate=(e,t)=>new oe({shape:()=>e,unknownKeys:"strict",catchall:ne.create(),typeName:Le.ZodObject,...j(t)}),oe.lazycreate=(e,t)=>new oe({shape:e,unknownKeys:"strip",catchall:ne.create(),typeName:Le.ZodObject,...j(t)});class ce extends C{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map((async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map((e=>new c(e.ctx.common.issues)));return p(t,{code:o.invalid_union,unionErrors:r}),m}));{let e;const n=[];for(const a of r){const r={...t,common:{...t.common,issues:[]},parent:null},i=a._parseSync({data:t.data,path:t.path,parent:r});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:r}),r.common.issues.length&&n.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=n.map((e=>new c(e)));return p(t,{code:o.invalid_union,unionErrors:a}),m}}get options(){return this._def.options}}ce.create=(e,t)=>new ce({options:e,typeName:Le.ZodUnion,...j(t)});const le=e=>e instanceof ye?le(e.schema):e instanceof Ee?le(e.innerType()):e instanceof ve?[e.value]:e instanceof we?e.options:e instanceof Oe?n.objectValues(e.enum):e instanceof Pe?le(e._def.innerType):e instanceof Q?[void 0]:e instanceof ee?[null]:e instanceof Se?[void 0,...le(e.unwrap())]:e instanceof Te?[null,...le(e.unwrap())]:e instanceof Ie||e instanceof Re?le(e.unwrap()):e instanceof xe?le(e._def.innerType):[];class ue extends C{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==i.object)return p(t,{code:o.invalid_type,expected:i.object,received:t.parsedType}),m;const r=this.discriminator,n=t.data[r],a=this.optionsMap.get(n);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(p(t,{code:o.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),m)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const n=new Map;for(const r of t){const t=le(r.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of t){if(n.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);n.set(a,r)}}return new ue({typeName:Le.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:n,...j(r)})}}function de(e,t){const r=s(e),a=s(t);if(e===t)return{valid:!0,data:e};if(r===i.object&&a===i.object){const r=n.objectKeys(t),a=n.objectKeys(e).filter((e=>-1!==r.indexOf(e))),i={...e,...t};for(const r of a){const n=de(e[r],t[r]);if(!n.valid)return{valid:!1};i[r]=n.data}return{valid:!0,data:i}}if(r===i.array&&a===i.array){if(e.length!==t.length)return{valid:!1};const r=[];for(let n=0;n<e.length;n++){const a=de(e[n],t[n]);if(!a.valid)return{valid:!1};r.push(a.data)}return{valid:!0,data:r}}return r===i.date&&a===i.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class he extends C{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),n=(e,n)=>{if(y(e)||y(n))return m;const a=de(e.value,n.value);return a.valid?((v(e)||v(n))&&t.dirty(),{status:t.value,value:a.data}):(p(r,{code:o.invalid_intersection_types}),m)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then((([e,t])=>n(e,t))):n(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}he.create=(e,t,r)=>new he({left:e,right:t,typeName:Le.ZodIntersection,...j(r)});class pe extends C{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.array)return p(r,{code:o.invalid_type,expected:i.array,received:r.parsedType}),m;if(r.data.length<this._def.items.length)return p(r,{code:o.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),m;!this._def.rest&&r.data.length>this._def.items.length&&(p(r,{code:o.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...r.data].map(((e,t)=>{const n=this._def.items[t]||this._def.rest;return n?n._parse(new P(r,e,r.path,t)):null})).filter((e=>!!e));return r.common.async?Promise.all(n).then((e=>f.mergeArray(t,e))):f.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new pe({...this._def,rest:e})}}pe.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new pe({items:e,typeName:Le.ZodTuple,rest:null,...j(t)})};class fe extends C{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.object)return p(r,{code:o.invalid_type,expected:i.object,received:r.parsedType}),m;const n=[],a=this._def.keyType,s=this._def.valueType;for(const e in r.data)n.push({key:a._parse(new P(r,e,r.path,e)),value:s._parse(new P(r,r.data[e],r.path,e)),alwaysSet:e in r.data});return r.common.async?f.mergeObjectAsync(t,n):f.mergeObjectSync(t,n)}get element(){return this._def.valueType}static create(e,t,r){return new fe(t instanceof C?{keyType:e,valueType:t,typeName:Le.ZodRecord,...j(r)}:{keyType:G.create(),valueType:e,typeName:Le.ZodRecord,...j(t)})}}class me extends C{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.map)return p(r,{code:o.invalid_type,expected:i.map,received:r.parsedType}),m;const n=this._def.keyType,a=this._def.valueType,s=[...r.data.entries()].map((([e,t],i)=>({key:n._parse(new P(r,e,r.path,[i,"key"])),value:a._parse(new P(r,t,r.path,[i,"value"]))})));if(r.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const r of s){const n=await r.key,a=await r.value;if("aborted"===n.status||"aborted"===a.status)return m;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const r of s){const n=r.key,a=r.value;if("aborted"===n.status||"aborted"===a.status)return m;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}}}}me.create=(e,t,r)=>new me({valueType:t,keyType:e,typeName:Le.ZodMap,...j(r)});class ge extends C{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.set)return p(r,{code:o.invalid_type,expected:i.set,received:r.parsedType}),m;const n=this._def;null!==n.minSize&&r.data.size<n.minSize.value&&(p(r,{code:o.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),null!==n.maxSize&&r.data.size>n.maxSize.value&&(p(r,{code:o.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const a=this._def.valueType;function s(e){const r=new Set;for(const n of e){if("aborted"===n.status)return m;"dirty"===n.status&&t.dirty(),r.add(n.value)}return{status:t.value,value:r}}const c=[...r.data.values()].map(((e,t)=>a._parse(new P(r,e,r.path,t))));return r.common.async?Promise.all(c).then((e=>s(e))):s(c)}min(e,t){return new ge({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new ge({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ge.create=(e,t)=>new ge({valueType:e,minSize:null,maxSize:null,typeName:Le.ZodSet,...j(t)});class be extends C{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==i.function)return p(t,{code:o.invalid_type,expected:i.function,received:t.parsedType}),m;function r(e,r){return h({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,d(),l].filter((e=>!!e)),issueData:{code:o.invalid_arguments,argumentsError:r}})}function n(e,r){return h({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,d(),l].filter((e=>!!e)),issueData:{code:o.invalid_return_type,returnTypeError:r}})}const a={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof ke){const e=this;return b((async function(...t){const i=new c([]),o=await e._def.args.parseAsync(t,a).catch((e=>{throw i.addIssue(r(t,e)),i})),l=await Reflect.apply(s,this,o);return await e._def.returns._def.type.parseAsync(l,a).catch((e=>{throw i.addIssue(n(l,e)),i}))}))}{const e=this;return b((function(...t){const i=e._def.args.safeParse(t,a);if(!i.success)throw new c([r(t,i.error)]);const o=Reflect.apply(s,this,i.data),l=e._def.returns.safeParse(o,a);if(!l.success)throw new c([n(o,l.error)]);return l.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new be({...this._def,args:pe.create(e).rest(re.create())})}returns(e){return new be({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new be({args:e||pe.create([]).rest(re.create()),returns:t||re.create(),typeName:Le.ZodFunction,...j(r)})}}class ye extends C{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ye.create=(e,t)=>new ye({getter:e,typeName:Le.ZodLazy,...j(t)});class ve extends C{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return p(t,{received:t.data,code:o.invalid_literal,expected:this._def.value}),m}return{status:"valid",value:e.data}}get value(){return this._def.value}}function _e(e,t){return new we({values:e,typeName:Le.ZodEnum,...j(t)})}ve.create=(e,t)=>new ve({value:e,typeName:Le.ZodLiteral,...j(t)});class we extends C{constructor(){super(...arguments),S.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),r=this._def.values;return p(t,{expected:n.joinValues(r),received:t.parsedType,code:o.invalid_type}),m}if(O(this,S,"f")||k(this,S,new Set(this._def.values),"f"),!O(this,S,"f").has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return p(t,{received:t.data,code:o.invalid_enum_value,options:r}),m}return b(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return we.create(e,{...this._def,...t})}exclude(e,t=this._def){return we.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}S=new WeakMap,we.create=_e;class Oe extends C{constructor(){super(...arguments),T.set(this,void 0)}_parse(e){const t=n.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==i.string&&r.parsedType!==i.number){const e=n.objectValues(t);return p(r,{expected:n.joinValues(e),received:r.parsedType,code:o.invalid_type}),m}if(O(this,T,"f")||k(this,T,new Set(n.getValidEnumValues(this._def.values)),"f"),!O(this,T,"f").has(e.data)){const e=n.objectValues(t);return p(r,{received:r.data,code:o.invalid_enum_value,options:e}),m}return b(e.data)}get enum(){return this._def.values}}T=new WeakMap,Oe.create=(e,t)=>new Oe({values:e,typeName:Le.ZodNativeEnum,...j(t)});class ke extends C{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==i.promise&&!1===t.common.async)return p(t,{code:o.invalid_type,expected:i.promise,received:t.parsedType}),m;const r=t.parsedType===i.promise?t.data:Promise.resolve(t.data);return b(r.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}ke.create=(e,t)=>new ke({type:e,typeName:Le.ZodPromise,...j(t)});class Ee extends C{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Le.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,i={addIssue:e=>{p(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===a.type){const e=a.transform(r.data,i);if(r.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return m;const n=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===n.status?m:"dirty"===n.status||"dirty"===t.value?g(n.value):n}));{if("aborted"===t.value)return m;const n=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===n.status?m:"dirty"===n.status||"dirty"===t.value?g(n.value):n}}if("refinement"===a.type){const e=e=>{const t=a.refinement(e,i);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===r.common.async){const n=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===n.status?m:("dirty"===n.status&&t.dirty(),e(n.value),{status:t.value,value:n.value})}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then((r=>"aborted"===r.status?m:("dirty"===r.status&&t.dirty(),e(r.value).then((()=>({status:t.value,value:r.value}))))))}if("transform"===a.type){if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!_(e))return e;const n=a.transform(e.value,i);if(n instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:n}}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then((e=>_(e)?Promise.resolve(a.transform(e.value,i)).then((e=>({status:t.value,value:e}))):e))}n.assertNever(a)}}Ee.create=(e,t,r)=>new Ee({schema:e,typeName:Le.ZodEffects,effect:t,...j(r)}),Ee.createWithPreprocess=(e,t,r)=>new Ee({schema:t,effect:{type:"preprocess",transform:e},typeName:Le.ZodEffects,...j(r)});class Se extends C{_parse(e){return this._getType(e)===i.undefined?b(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Se.create=(e,t)=>new Se({innerType:e,typeName:Le.ZodOptional,...j(t)});class Te extends C{_parse(e){return this._getType(e)===i.null?b(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Te.create=(e,t)=>new Te({innerType:e,typeName:Le.ZodNullable,...j(t)});class Pe extends C{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===i.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Pe.create=(e,t)=>new Pe({innerType:e,typeName:Le.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...j(t)});class xe extends C{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return w(n)?n.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new c(r.common.issues)},input:r.data})}))):{status:"valid",value:"valid"===n.status?n.value:this._def.catchValue({get error(){return new c(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}xe.create=(e,t)=>new xe({innerType:e,typeName:Le.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...j(t)});class je extends C{_parse(e){if(this._getType(e)!==i.nan){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:i.nan,received:t.parsedType}),m}return{status:"valid",value:e.data}}}je.create=e=>new je({typeName:Le.ZodNaN,...j(e)});const Ce=Symbol("zod_brand");class Ie extends C{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ae extends C{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),g(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new Ae({in:e,out:t,typeName:Le.ZodPipeline})}}class Re extends C{_parse(e){const t=this._def.innerType._parse(e),r=e=>(_(e)&&(e.value=Object.freeze(e.value)),e);return w(t)?t.then((e=>r(e))):r(t)}unwrap(){return this._def.innerType}}function Ne(e,t={},r){return e?te.create().superRefine(((n,a)=>{var i,s;if(!e(n)){const e="function"==typeof t?t(n):"string"==typeof t?{message:t}:t,o=null===(s=null!==(i=e.fatal)&&void 0!==i?i:r)||void 0===s||s,c="string"==typeof e?{message:e}:e;a.addIssue({code:"custom",...c,fatal:o})}})):te.create()}Re.create=(e,t)=>new Re({innerType:e,typeName:Le.ZodReadonly,...j(t)});const $e={object:oe.lazycreate};var Le;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Le||(Le={}));const Me=G.create,De=W.create,Fe=je.create,Ue=Y.create,Be=J.create,ze=K.create,Ve=X.create,qe=Q.create,Ze=ee.create,Ge=te.create,He=re.create,We=ne.create,Ye=ae.create,Je=ie.create,Ke=oe.create,Xe=oe.strictCreate,Qe=ce.create,et=ue.create,tt=he.create,rt=pe.create,nt=fe.create,at=me.create,it=ge.create,st=be.create,ot=ye.create,ct=ve.create,lt=we.create,ut=Oe.create,dt=ke.create,ht=Ee.create,pt=Se.create,ft=Te.create,mt=Ee.createWithPreprocess,gt=Ae.create,bt={string:e=>G.create({...e,coerce:!0}),number:e=>W.create({...e,coerce:!0}),boolean:e=>J.create({...e,coerce:!0}),bigint:e=>Y.create({...e,coerce:!0}),date:e=>K.create({...e,coerce:!0})},yt=m;var vt=Object.freeze({__proto__:null,defaultErrorMap:l,setErrorMap:function(e){u=e},getErrorMap:d,makeIssue:h,EMPTY_PATH:[],addIssueToContext:p,ParseStatus:f,INVALID:m,DIRTY:g,OK:b,isAborted:y,isDirty:v,isValid:_,isAsync:w,get util(){return n},get objectUtil(){return a},ZodParsedType:i,getParsedType:s,ZodType:C,datetimeRegex:Z,ZodString:G,ZodNumber:W,ZodBigInt:Y,ZodBoolean:J,ZodDate:K,ZodSymbol:X,ZodUndefined:Q,ZodNull:ee,ZodAny:te,ZodUnknown:re,ZodNever:ne,ZodVoid:ae,ZodArray:ie,ZodObject:oe,ZodUnion:ce,ZodDiscriminatedUnion:ue,ZodIntersection:he,ZodTuple:pe,ZodRecord:fe,ZodMap:me,ZodSet:ge,ZodFunction:be,ZodLazy:ye,ZodLiteral:ve,ZodEnum:we,ZodNativeEnum:Oe,ZodPromise:ke,ZodEffects:Ee,ZodTransformer:Ee,ZodOptional:Se,ZodNullable:Te,ZodDefault:Pe,ZodCatch:xe,ZodNaN:je,BRAND:Ce,ZodBranded:Ie,ZodPipeline:Ae,ZodReadonly:Re,custom:Ne,Schema:C,ZodSchema:C,late:$e,get ZodFirstPartyTypeKind(){return Le},coerce:bt,any:Ge,array:Je,bigint:Ue,boolean:Be,date:ze,discriminatedUnion:et,effect:ht,enum:lt,function:st,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Ne((t=>t instanceof e),t),intersection:tt,lazy:ot,literal:ct,map:at,nan:Fe,nativeEnum:ut,never:We,null:Ze,nullable:ft,number:De,object:Ke,oboolean:()=>Be().optional(),onumber:()=>De().optional(),optional:pt,ostring:()=>Me().optional(),pipeline:gt,preprocess:mt,promise:dt,record:nt,set:it,strictObject:Xe,string:Me,symbol:Ve,transformer:ht,tuple:rt,undefined:qe,union:Qe,unknown:He,void:Ye,NEVER:yt,ZodIssueCode:o,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:c})}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={id:n,loaded:!1,exports:{}};return e[n](i,i.exports,r),i.loaded=!0,i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var n={};r.d(n,{y:()=>is});var a={};r.r(a);var i={};r.r(i),r.d(i,{insecureHash:()=>me});var s={};r.r(s),r.d(s,{BaseCache:()=>_e,InMemoryCache:()=>Oe,deserializeStoredGeneration:()=>ye,getCacheKey:()=>be,serializeGeneration:()=>ve});var o={};r.r(o),r.d(o,{BaseChatMessageHistory:()=>Pe,BaseListChatMessageHistory:()=>xe,InMemoryChatMessageHistory:()=>je});var c={};r.r(c),r.d(c,{BaseDocumentTransformer:()=>Ae,Document:()=>Ce,MappingDocumentTransformer:()=>Re});var l={};r.r(l),r.d(l,{Embeddings:()=>$e});var u={};r.r(u),r.d(u,{BaseExampleSelector:()=>Le,BasePromptSelector:()=>Me,ConditionalPromptSelector:()=>De,LengthBasedExampleSelector:()=>ze,SemanticSimilarityExampleSelector:()=>qe,isChatModel:()=>Ue,isLLM:()=>Fe});var d={};r.r(d),r.d(d,{encodingForModel:()=>tt,getEncoding:()=>et});var h={};r.r(h),r.d(h,{BaseLangChain:()=>ot,BaseLanguageModel:()=>ct,calculateMaxTokens:()=>st,getEmbeddingContextSize:()=>nt,getModelContextSize:()=>at,getModelNameForTiktoken:()=>rt,isOpenAITool:()=>it});var p={};r.r(p),r.d(p,{BaseChatModel:()=>vt,SimpleChatModel:()=>_t,createChatMessageChunkEncoderStream:()=>yt});var f={};r.r(f),r.d(f,{BaseLLM:()=>wt,LLM:()=>Ot});var m={};r.r(m),r.d(m,{BaseMemory:()=>kt,getInputValue:()=>St,getOutputValue:()=>Tt,getPromptInputKey:()=>Pt});var g={};r.r(g),r.d(g,{RouterRunnable:()=>xt,Runnable:()=>Ie.YN,RunnableAssign:()=>Ie.B2,RunnableBinding:()=>Ie.fJ,RunnableBranch:()=>jt,RunnableEach:()=>Ie.Vi,RunnableLambda:()=>Ie.jY,RunnableMap:()=>Ie.ck,RunnableParallel:()=>Ie.Pq,RunnablePassthrough:()=>mt,RunnablePick:()=>Ie.Fm,RunnableRetry:()=>Ie.AO,RunnableSequence:()=>Ie.zZ,RunnableToolLike:()=>Ie.pG,RunnableWithFallbacks:()=>Ie.lH,RunnableWithMessageHistory:()=>Ct,_coerceToRunnable:()=>Ie.Bp,ensureConfig:()=>ft.ZI,getCallbackManagerForConfig:()=>ft.kJ,mergeConfigs:()=>ft.SV,patchConfig:()=>ft.tn});var b={};r.r(b),r.d(b,{applyPatch:()=>jr.X6,compare:()=>jr.UD});var y={};r.r(y),r.d(y,{AsymmetricStructuredOutputParser:()=>xr,BaseCumulativeTransformOutputParser:()=>br,BaseLLMOutputParser:()=>At,BaseOutputParser:()=>Rt,BaseTransformOutputParser:()=>gr,BytesOutputParser:()=>yr,CommaSeparatedListOutputParser:()=>_r,CustomListOutputParser:()=>wr,JsonMarkdownStructuredOutputParser:()=>Pr,JsonOutputParser:()=>Ir,ListOutputParser:()=>vr,MarkdownListOutputParser:()=>kr,NumberedListOutputParser:()=>Or,OutputParserException:()=>Nt,StringOutputParser:()=>Er,StructuredOutputParser:()=>Tr,XMLOutputParser:()=>Lr,XML_FORMAT_INSTRUCTIONS:()=>$r,parseJsonMarkdown:()=>Cr.D,parsePartialJson:()=>Cr.d,parseXMLMarkdown:()=>Fr});var v={};r.r(v),r.d(v,{AIMessagePromptTemplate:()=>Br.sS,BaseChatPromptTemplate:()=>Br.qF,BaseMessagePromptTemplate:()=>Br.pl,BaseMessageStringPromptTemplate:()=>Br.OT,BasePromptTemplate:()=>Ur.m,BaseStringPromptTemplate:()=>Zr.L,ChatMessagePromptTemplate:()=>Br.Wn,ChatPromptTemplate:()=>Br.RZ,DEFAULT_FORMATTER_MAPPING:()=>Gr.ez,DEFAULT_PARSER_MAPPING:()=>Gr.RG,FewShotChatMessagePromptTemplate:()=>zr.s,FewShotPromptTemplate:()=>zr.FewShotPromptTemplate,HumanMessagePromptTemplate:()=>Br.FS,ImagePromptTemplate:()=>Hr.C,MessagesPlaceholder:()=>Br.GL,PipelinePromptTemplate:()=>Vr,PromptTemplate:()=>qr.PromptTemplate,StructuredPrompt:()=>Yr,SystemMessagePromptTemplate:()=>Br.BJ,checkValidTemplate:()=>Gr.Ns,interpolateFString:()=>Gr.Vt,interpolateMustache:()=>Gr.Qs,parseFString:()=>Gr.D4,parseMustache:()=>Gr.g2,parseTemplate:()=>Gr.QC,renderTemplate:()=>Gr.Xm});var _={};r.r(_),r.d(_,{BaseRetriever:()=>Jr});var w={};r.r(w),r.d(w,{BaseStore:()=>Kr,InMemoryStore:()=>Xr});var O={};r.r(O),r.d(O,{BaseToolkit:()=>on,DynamicStructuredTool:()=>sn,DynamicTool:()=>an,StructuredTool:()=>rn,Tool:()=>nn,ToolInputParsingException:()=>tn.q,tool:()=>cn});var k={};r.r(k),r.d(k,{LangChainTracerV1:()=>fn});var E={};r.r(E),r.d(E,{getTracingCallbackHandler:()=>mn,getTracingV2CallbackHandler:()=>gn});var S={};r.r(S),r.d(S,{RunCollectorCallbackHandler:()=>bn});var T={};r.r(T),r.d(T,{chunkArray:()=>yn});var P={};r.r(P),r.d(P,{convertToOpenAIFunction:()=>vn,convertToOpenAITool:()=>_n,isLangChainTool:()=>En,isRunnableToolLike:()=>On,isStructuredTool:()=>wn,isStructuredToolParams:()=>kn});var x={};r.r(x),r.d(x,{Validator:()=>mr,deepCompareStrict:()=>Lt});var j={};r.r(j),r.d(j,{cosineSimilarity:()=>Cn,euclideanDistance:()=>An,innerProduct:()=>In,matrixFunc:()=>xn,maximalMarginalRelevance:()=>Rn,normalize:()=>jn});var C={};r.r(C),r.d(C,{SaveableVectorStore:()=>Mn,VectorStore:()=>Ln,VectorStoreRetriever:()=>$n});var I={};r.r(I),r.d(I,{FakeChatMessageHistory:()=>Gn,FakeChatModel:()=>zn,FakeEmbeddings:()=>Jn,FakeLLM:()=>Un,FakeListChatMessageHistory:()=>Hn,FakeListChatModel:()=>Zn,FakeRetriever:()=>qn,FakeRunnable:()=>Fn,FakeSplitIntoListParser:()=>Dn,FakeStreamingChatModel:()=>Vn,FakeStreamingLLM:()=>Bn,FakeTool:()=>Yn,FakeTracer:()=>Wn,FakeVectorStore:()=>Qn,SingleRunExtractor:()=>Xn,SyntheticEmbeddings:()=>Kn});var A={};r.r(A),r.d(A,{isZodSchema:()=>gt});var R={};r.r(R),r.d(R,{agents:()=>a,caches:()=>s,callbacks__base:()=>ke,callbacks__manager:()=>Ee,callbacks__promises:()=>Se,chat_history:()=>o,documents:()=>c,embeddings:()=>l,example_selectors:()=>u,language_models__base:()=>h,language_models__chat_models:()=>p,language_models__llms:()=>f,load__serializable:()=>ce,memory:()=>m,messages:()=>Te,output_parsers:()=>y,outputs:()=>ut,prompt_values:()=>Ze,prompts:()=>v,retrievers:()=>_,runnables:()=>g,stores:()=>w,tools:()=>O,tracers__base:()=>un,tracers__console:()=>dn,tracers__initialize:()=>E,tracers__log_stream:()=>ht,tracers__run_collector:()=>S,tracers__tracer_langchain:()=>hn,tracers__tracer_langchain_v1:()=>k,utils__async_caller:()=>Ne,utils__chunk_array:()=>T,utils__env:()=>pn,utils__function_calling:()=>P,utils__hash:()=>i,utils__json_patch:()=>b,utils__json_schema:()=>x,utils__math:()=>j,utils__stream:()=>pt,utils__testing:()=>I,utils__tiktoken:()=>d,utils__types:()=>A,vectorstores:()=>C});var N=r(7481);class $ extends Error{constructor(e,t){let r=e??"";t?.lc_error_code&&(r=`${r}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t.lc_error_code}/\n`),super(r),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}}class L extends ${constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}}class M extends ${constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}}class D extends ${constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}}class F extends D{constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}}function U(e){return void 0!==e&&[D.unminifiable_name,F.unminifiable_name].includes(e.name)}class B extends ${constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}}class z extends ${constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}}class V extends ${constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}}class q extends ${constructor(e,t){super(e,t),this.name="MultipleSubgraphError"}static get unminifiable_name(){return"MultipleSubgraphError"}}const Z=()=>(void 0===globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]&&(globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]=new Set),globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]);var G,H,W=r(8823),Y=r(3407),J=0,K=0;var X=r(8227);const Q=function(e){if(!(0,X.A)(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r};function ee(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function te(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ee(Object(r),!0).forEach((function(t){re(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ee(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function re(e,t,r){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ne(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:case 3:return t^r^n;case 2:return t&r^t&n^r&n}}function ae(e,t){return e<<t|e>>>32-t}const ie=function(){function e(e,t,r,n){var a;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof t&&(t=Q(t)),16!==(null===(a=t)||void 0===a?void 0:a.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(t),i.set(e,t.length),(i=function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var a=0;a<n.length;++a)e.push(n.charCodeAt(a))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,s=Math.ceil(i/16),o=new Array(s),c=0;c<s;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=e[64*c+4*u]<<24|e[64*c+4*u+1]<<16|e[64*c+4*u+2]<<8|e[64*c+4*u+3];o[c]=l}o[s-1][14]=8*(e.length-1)/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var f=16;f<80;++f)h[f]=ae(h[f-3]^h[f-8]^h[f-14]^h[f-16],1);for(var m=r[0],g=r[1],b=r[2],y=r[3],v=r[4],_=0;_<80;++_){var w=Math.floor(_/20),O=ae(m,5)+ne(w,g,b,y)+v+t[w]+h[_]>>>0;v=y,y=b,b=ae(g,30)>>>0,g=m,m=O}r[0]=r[0]+m>>>0,r[1]=r[1]+g>>>0,r[2]=r[2]+b>>>0,r[3]=r[3]+y>>>0,r[4]=r[4]+v>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]}(i))[6]=15&i[6]|80,i[8]=63&i[8]|128,r){n=n||0;for(var s=0;s<16;++s)r[n+s]=i[s];return r}return(0,W.k)(i)}try{e.name="v5"}catch(e){}return e.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",e.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",e}();function se(e){return function(e={},t,r=0){var n,a,i,s=function(e,t,r){var n=t&&r||0,a=t||new Array(16),i=(e=e||{}).node,s=e.clockseq;if(e._v6||(i||(i=G),null==s&&(s=H)),null==i||null==s){var o=e.random||(e.rng||Y.A)();null==i&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],G||e._v6||(i[0]|=1,G=i)),null==s&&(s=16383&(o[6]<<8|o[7]),void 0!==H||e._v6||(H=s))}var c=void 0!==e.msecs?e.msecs:Date.now(),l=void 0!==e.nsecs?e.nsecs:K+1,u=c-J+(l-K)/1e4;if(u<0&&void 0===e.clockseq&&(s=s+1&16383),(u<0||c>J)&&void 0===e.nsecs&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");J=c,K=l,H=s;var d=(1e4*(268435455&(c+=122192928e5))+l)%4294967296;a[n++]=d>>>24&255,a[n++]=d>>>16&255,a[n++]=d>>>8&255,a[n++]=255&d;var h=c/4294967296*1e4&268435455;a[n++]=h>>>8&255,a[n++]=255&h,a[n++]=h>>>24&15|16,a[n++]=h>>>16&255,a[n++]=s>>>8|128,a[n++]=255&s;for(var p=0;p<6;++p)a[n+p]=i[p];return t||(0,W.k)(a)}(te(te({},e),{},{_v6:!0}),new Uint8Array(16));if(a="string"==typeof(n=s)?Q(n):n,i=Uint8Array.of((15&a[6])<<4|a[7]>>4&15,(15&a[7])<<4|(240&a[4])>>4,(15&a[4])<<4|(240&a[5])>>4,(15&a[5])<<4|(240&a[0])>>4,(15&a[0])<<4|(240&a[1])>>4,(15&a[1])<<4|(240&a[2])>>4,96|15&a[2],a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]),s="string"==typeof n?(0,W.k)(i):i,t){for(var o=0;o<16;o++)t[r+o]=s[o];return t}return(0,W.k)(s)}({clockseq:e})}function oe(e,t){const r=t.replace(/-/g,"").match(/.{2}/g).map((e=>parseInt(e,16)));return ie(e,new Uint8Array(r))}var ce=r(7380),le="object"==typeof window?window:{},ue="0123456789abcdef".split(""),de=[-2147483648,8388608,32768,128],he=[24,16,8,0],pe=[];function fe(e){e?(pe[0]=pe[16]=pe[1]=pe[2]=pe[3]=pe[4]=pe[5]=pe[6]=pe[7]=pe[8]=pe[9]=pe[10]=pe[11]=pe[12]=pe[13]=pe[14]=pe[15]=0,this.blocks=pe):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}fe.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===le.ArrayBuffer&&(e=new Uint8Array(e));for(var r,n,a=0,i=e.length||0,s=this.blocks;a<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(n=this.start;a<i&&n<64;++a)s[n>>2]|=e[a]<<he[3&n++];else for(n=this.start;a<i&&n<64;++a)(r=e.charCodeAt(a))<128?s[n>>2]|=r<<he[3&n++]:r<2048?(s[n>>2]|=(192|r>>6)<<he[3&n++],s[n>>2]|=(128|63&r)<<he[3&n++]):r<55296||r>=57344?(s[n>>2]|=(224|r>>12)<<he[3&n++],s[n>>2]|=(128|r>>6&63)<<he[3&n++],s[n>>2]|=(128|63&r)<<he[3&n++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++a)),s[n>>2]|=(240|r>>18)<<he[3&n++],s[n>>2]|=(128|r>>12&63)<<he[3&n++],s[n>>2]|=(128|r>>6&63)<<he[3&n++],s[n>>2]|=(128|63&r)<<he[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=s[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},fe.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=de[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},fe.prototype.hash=function(){var e,t,r=this.h0,n=this.h1,a=this.h2,i=this.h3,s=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n&a|~n&i)+s+1518500249+o[e]|0)<<5|s>>>27)+(r&(n=n<<30|n>>>2)|~r&a)+i+1518500249+o[e+1]|0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|~s&n)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|~i&r)+n+1518500249+o[e+3]|0)<<5|n>>>27)+(a&(i=i<<30|i>>>2)|~a&s)+r+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n^a^i)+s+1859775393+o[e]|0)<<5|s>>>27)+(r^(n=n<<30|n>>>2)^a)+i+1859775393+o[e+1]|0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^n)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^r)+n+1859775393+o[e+3]|0)<<5|n>>>27)+(a^(i=i<<30|i>>>2)^s)+r+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n&a|n&i|a&i)+s-1894007588+o[e]|0)<<5|s>>>27)+(r&(n=n<<30|n>>>2)|r&a|n&a)+i-1894007588+o[e+1]|0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|s&n|r&n)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|i&r|s&r)+n-1894007588+o[e+3]|0)<<5|n>>>27)+(a&(i=i<<30|i>>>2)|a&s|i&s)+r-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n^a^i)+s-899497514+o[e]|0)<<5|s>>>27)+(r^(n=n<<30|n>>>2)^a)+i-899497514+o[e+1]|0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^n)+a-899497514+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^r)+n-899497514+o[e+3]|0)<<5|n>>>27)+(a^(i=i<<30|i>>>2)^s)+r-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+r|0,this.h1=this.h1+n|0,this.h2=this.h2+a|0,this.h3=this.h3+i|0,this.h4=this.h4+s|0},fe.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4;return ue[e>>28&15]+ue[e>>24&15]+ue[e>>20&15]+ue[e>>16&15]+ue[e>>12&15]+ue[e>>8&15]+ue[e>>4&15]+ue[15&e]+ue[t>>28&15]+ue[t>>24&15]+ue[t>>20&15]+ue[t>>16&15]+ue[t>>12&15]+ue[t>>8&15]+ue[t>>4&15]+ue[15&t]+ue[r>>28&15]+ue[r>>24&15]+ue[r>>20&15]+ue[r>>16&15]+ue[r>>12&15]+ue[r>>8&15]+ue[r>>4&15]+ue[15&r]+ue[n>>28&15]+ue[n>>24&15]+ue[n>>20&15]+ue[n>>16&15]+ue[n>>12&15]+ue[n>>8&15]+ue[n>>4&15]+ue[15&n]+ue[a>>28&15]+ue[a>>24&15]+ue[a>>20&15]+ue[a>>16&15]+ue[a>>12&15]+ue[a>>8&15]+ue[a>>4&15]+ue[15&a]},fe.prototype.toString=fe.prototype.hex,fe.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,a>>24&255,a>>16&255,a>>8&255,255&a]},fe.prototype.array=fe.prototype.digest,fe.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const me=e=>new fe(!0).update(e).hex();var ge=r(6362);const be=(...e)=>me(e.join("_"));function ye(e){return void 0!==e.message?{text:e.text,message:(0,ge.Pz)(e.message)}:{text:e.text}}function ve(e){const t={text:e.text};return void 0!==e.message&&(t.message=e.message.toDict()),t}class _e{}const we=new Map;class Oe extends _e{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(be(e,t))??null)}async update(e,t,r){this.cache.set(be(e,t),r)}static global(){return new Oe(we)}}var ke=r(5960),Ee=r(7715),Se=r(7243),Te=r(1673);class Pe extends ce.Serializable{async addMessages(e){for(const t of e)await this.addMessage(t)}}class xe extends ce.Serializable{addUserMessage(e){return this.addMessage(new Te.HumanMessage(e))}addAIChatMessage(e){return this.addMessage(new Te.AIMessage(e))}addAIMessage(e){return this.addMessage(new Te.AIMessage(e))}async addMessages(e){for(const t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}}class je extends xe{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}}class Ce{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=void 0!==e.pageContent?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}var Ie=r(7896);class Ae extends Ie.YN{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}}class Re extends Ae{async transformDocuments(e){const t=[];for(const r of e){const e=await this._transformDocument(r);t.push(e)}return t}}var Ne=r(9624);class $e{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new Ne.AsyncCaller(e??{})}}class Le extends ce.Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","example_selectors","base"]})}}class Me{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}}class De extends Me{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(const[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}function Fe(e){return"base_llm"===e._modelType()}function Ue(e){return"base_chat_model"===e._modelType()}function Be(e){return e.split(/\n| /).length}class ze extends Le{constructor(e){super(e),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getTextLength",{enumerable:!0,configurable:!0,writable:!0,value:Be}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"exampleTextLengths",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.examplePrompt=e.examplePrompt,this.maxLength=e.maxLength??2048,this.getTextLength=e.getTextLength??Be}async addExample(e){this.examples.push(e);const t=await this.examplePrompt.format(e);this.exampleTextLengths.push(this.getTextLength(t))}async calculateExampleTextLengths(e,t){if(e.length>0)return e;const{examples:r,examplePrompt:n}=t;return(await Promise.all(r.map((e=>n.format(e))))).map((e=>this.getTextLength(e)))}async selectExamples(e){const t=Object.values(e).join(" ");let r=this.maxLength-this.getTextLength(t),n=0;const a=[];for(;r>0&&n<this.examples.length;){const e=r-this.exampleTextLengths[n];if(e<0)break;a.push(this.examples[n]),r=e,n+=1}return a}static async fromExamples(e,t){const r=new ze(t);return await Promise.all(e.map((e=>r.addExample(e)))),r}}function Ve(e){return Object.keys(e).sort().map((t=>e[t]))}class qe extends Le{constructor(e){if(super(e),Object.defineProperty(this,"vectorStoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleKeys=e.exampleKeys,this.inputKeys=e.inputKeys,void 0!==e.vectorStore)this.vectorStoreRetriever=e.vectorStore.asRetriever({k:e.k??4,filter:e.filter});else{if(!e.vectorStoreRetriever)throw new Error('You must specify one of "vectorStore" and "vectorStoreRetriever".');this.vectorStoreRetriever=e.vectorStoreRetriever}}async addExample(e){const t=Ve((this.inputKeys??Object.keys(e)).reduce(((t,r)=>({...t,[r]:e[r]})),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new Ce({pageContent:t,metadata:e})])}async selectExamples(e){const t=Ve((this.inputKeys??Object.keys(e)).reduce(((t,r)=>({...t,[r]:e[r]})),{})).join(" "),r=(await this.vectorStoreRetriever.invoke(t)).map((e=>e.metadata));return this.exampleKeys?r.map((e=>this.exampleKeys.reduce(((t,r)=>({...t,[r]:e[r]})),{}))):r}static async fromExamples(e,t,r,n={}){const a=n.inputKeys??null,i=e.map((e=>Ve(a?a.reduce(((t,r)=>({...t,[r]:e[r]})),{}):e).join(" "))),s=await r.fromTexts(i,e,t,n);return new qe({vectorStore:s,k:n.k??4,exampleKeys:n.exampleKeys,inputKeys:n.inputKeys})}}var Ze=r(5311),Ge=r(7526),He=Object.defineProperty;function We(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let r=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;r.length>1;){let n=null;for(let a=0;a<r.length-1;a++){const i=e.slice(r[a].start,r[a+1].end),s=t.get(i.join(","));null!=s&&(null==n||s<n[0])&&(n=[s,a])}if(null==n)break;{const e=n[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}}return r}(e,t).map((r=>t.get(e.slice(r.start,r.end).join(",")))).filter((e=>null!=e))}var Ye,Je=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[r,n,...a]=t.split(" "),i=Number.parseInt(n,10);return a.forEach(((t,r)=>e[t]=i+r)),e}),{});for(const[e,t]of Object.entries(r)){const r=Ge.toByteArray(e);this.rankMap.set(r.join(","),t),this.textMap.set(t,r)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],r="all"){const n=new RegExp(this.patStr,"ug"),a=Je.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter((e=>!s.has(e))):r);if(o.size>0){const t=Je.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw new Error(`The text contains a special token that is not allowed: ${r[0]}`)}let c=0;for(;;){let t=null,r=c;for(;a.lastIndex=r,t=a.exec(e),null!=t&&!s.has(t[0]);)r=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(n)){const e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));null==r?i.push(...We(e,this.rankMap)):i.push(r)}if(null==t)break;let l=this.specialTokens[t[0]];i.push(l),c=t.index+t[0].length}return i}decode(e){const t=[];let r=0;for(let n=0;n<e.length;++n){const a=e[n],i=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=i&&(t.push(i),r+=i.length)}const n=new Uint8Array(r);let a=0;for(const e of t)n.set(e,a),a+=e.length;return this.textDecoder.decode(n)}},Ke=Je;((e,t,r)=>{t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(Ke,"symbol"!=typeof(Ye="specialTokenRegex")?Ye+"":Ye,(e=>new RegExp(e.map((e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&"))).join("|"),"g")));const Xe={},Qe=new Ne.AsyncCaller({});async function et(e){return e in Xe||(Xe[e]=Qe.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new Ke(e))).catch((t=>{throw delete Xe[e],t}))),await Xe[e]}async function tt(e){return et(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}(e))}const rt=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e,nt=e=>"text-embedding-ada-002"===e?8191:2046,at=e=>{switch(rt(e)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}};function it(e){return!("object"!=typeof e||!e||!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function))}const st=async({prompt:e,modelName:t})=>{let r;try{r=(await tt(rt(t))).encode(e).length}catch(t){console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(e.length/4)}return at(t)-r};class ot extends Ie.YN{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class ct extends ot{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:n,...a}=r;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache="object"==typeof n?n:n?Oe.global():void 0,this.caller=new Ne.AsyncCaller(r??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await tt("modelName"in this?rt(this.modelName):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new Ze.StringPromptValue(e):Array.isArray(e)?new Ze.ChatPromptValue(e.map(ge.K0)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},n=Object.entries(r).filter((([e,t])=>void 0!==t)).map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return n}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}var lt=r(2522),ut=r(8028),dt=r(4102),ht=r(1060),pt=r(58),ft=r(765);class mt extends Ie.YN{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=(0,ft.ZI)(t);return this.func&&await this.func(e,r),this._callWithConfig((e=>Promise.resolve(e)),e,r)}async*transform(e,t){const r=(0,ft.ZI)(t);let n,a=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),r))if(yield t,a)if(void 0===n)n=t;else try{n=(0,pt.concat)(n,t)}catch{n=void 0,a=!1}this.func&&void 0!==n&&await this.func(n,r)}static assign(e){return new Ie.B2(new Ie.ck({steps:e}))}}function gt(e){return"function"==typeof e?.parse}var bt=r(7481).Rv;function yt(){const e=new TextEncoder;return new bt({transform(t,r){r.enqueue(e.encode("string"==typeof t.content?t.content:JSON.stringify(t.content)))}})}class vt extends ct{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){const r=vt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===vt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=vt._convertInputToPromptValue(e).toChatMessages(),[n,a]=this._separateRunnableConfigFromCallOptionsCompat(t),i={...n.metadata,...this.getLsParams(a)},s=await Ee.CallbackManager.configure(n.callbacks,this.callbacks,n.tags,this.tags,i,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},c=await(s?.handleChatModelStart(this.toJSON(),[r],n.runId,void 0,o,void 0,void 0,n.runName));let l,u;try{for await(const e of this._streamResponseChunks(r,a,c?.[0])){if(null==e.message.id){const t=c?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,l=l?l.concat(e):e,(0,Te.isAIMessageChunk)(e.message)&&void 0!==e.message.usage_metadata&&(u={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((c??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((c??[]).map((e=>e?.handleLLMEnd({generations:[[l]],llmOutput:u}))))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r){const n=e.map((e=>e.map(Te.coerceMessageLikeToMessage))),a={...r.metadata,...this.getLsParams(t)},i=await Ee.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,a,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1},o=await(i?.handleChatModelStart(this.toJSON(),n,r.runId,void 0,s,void 0,void 0,r.runName)),c=[],l=[];if(o?.[0].handlers.find((e=>(0,dt.K)(e)||(0,ht.isLogStreamHandler)(e)))&&1===n.length&&this._streamResponseChunks!==vt.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(n[0],t,o?.[0]);let r,a;for await(const t of e){if(null==t.message.id){const e=o?.at(0)?.runId;null!=e&&t.message._updateId(`run-${e}`)}r=void 0===r?t:(0,pt.concat)(r,t),(0,Te.isAIMessageChunk)(t.message)&&void 0!==t.message.usage_metadata&&(a={tokenUsage:{promptTokens:t.message.usage_metadata.input_tokens,completionTokens:t.message.usage_metadata.output_tokens,totalTokens:t.message.usage_metadata.total_tokens}})}if(void 0===r)throw new Error("Received empty response from chat model call.");c.push([r]),await(o?.[0].handleLLMEnd({generations:c,llmOutput:a}))}catch(e){throw await(o?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(n.map(((e,r)=>this._generate(e,{...t,promptIndex:r},o?.[r]))));await Promise.all(e.map((async(e,t)=>{if("fulfilled"===e.status){const r=e.value;for(const e of r.generations){if(null==e.message.id){const t=o?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),c[t]=r.generations,l[t]=r.llmOutput,o?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}return await(o?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})))}const u={generations:c,llmOutput:l.length?this._combineLLMOutput?.(...l):void 0};return Object.defineProperty(u,ut.RUN_KEY,{value:o?{runIds:o?.map((e=>e.runId))}:void 0,configurable:!0}),u}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:a}){const i=e.map((e=>e.map(Te.coerceMessageLikeToMessage))),s={...a.metadata,...this.getLsParams(n)},o=await Ee.CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,s,this.metadata,{verbose:this.verbose}),c={options:n,invocation_params:this?.invocationParams(n),batch_size:1,cached:!0},l=await(o?.handleChatModelStart(this.toJSON(),i,a.runId,void 0,c,void 0,void 0,a.runName)),u=[],d=(await Promise.allSettled(i.map((async(e,n)=>{const a=vt._convertInputToPromptValue(e).toString(),i=await t.lookup(a,r);return null==i&&u.push(n),i})))).map(((e,t)=>({result:e,runManager:l?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),h=[];await Promise.all(d.map((async({result:e,runManager:t},r)=>{if("fulfilled"===e.status){const n=e.value;return h[r]=n,n.length&&await(t?.handleLLMNewToken(n[0].text)),t?.handleLLMEnd({generations:[n]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const p={generations:h,missingPromptIndices:u};return Object.defineProperty(p,ut.RUN_KEY,{value:l?{runIds:l?.map((e=>e.runId))}:void 0,configurable:!0}),p}async generate(e,t,r){let n;n=Array.isArray(t)?{stop:t}:t;const a=e.map((e=>e.map(Te.coerceMessageLikeToMessage))),[i,s]=this._separateRunnableConfigFromCallOptionsCompat(n);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(a,s,i);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(s),{generations:l,missingPromptIndices:u}=await this._generateCached({messages:a,cache:o,llmStringKey:c,parsedOptions:s,handledOptions:i});let d={};if(u.length>0){const e=await this._generateUncached(u.map((e=>a[e])),s,i);await Promise.all(e.generations.map((async(e,t)=>{const r=u[t];l[r]=e;const n=vt._convertInputToPromptValue(a[r]).toString();return o.update(n,c,e)}))),d=e.llmOutput??{}}return{generations:l,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const n=e.map((e=>e.toChatMessages()));return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e.map(Te.coerceMessageLikeToMessage)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const n=e.toChatMessages();return this.call(n,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const n=new Te.HumanMessage(e),a=await this.call([n],t,r);if("string"!=typeof a.content)throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');const r=e,n=t?.name,a=r.description??"A function available to call.",i=t?.method,s=t?.includeRaw;if("jsonMode"===i)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,c=n??"extract";gt(r)?o=[{type:"function",function:{name:c,description:a,parameters:(0,lt.Ik)(r)}}]:("name"in r&&(c=r.name),o=[{type:"function",function:{name:c,description:a,parameters:r}}]);const l=this.bindTools(o),u=Ie.jY.from((e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find((e=>e.name===c));if(!t)throw new Error(`No tool call found with name ${c}.`);return t.args}));if(!s)return l.pipe(u).withConfig({runName:"StructuredOutput"});const d=mt.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=mt.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return Ie.zZ.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class _t extends vt{async _generate(e,t,r){const n=await this._call(e,t,r),a=new Te.AIMessage(n);if("string"!=typeof a.content)throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:a.content,message:a}]}}}class wt extends ct{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const r=wt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async*_streamIterator(e,t){if(this._streamResponseChunks===wt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=wt._convertInputToPromptValue(e),[n,a]=this._separateRunnableConfigFromCallOptionsCompat(t),i=await Ee.CallbackManager.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s={options:a,invocation_params:this?.invocationParams(a),batch_size:1},o=await(i?.handleLLMStart(this.toJSON(),[r.toString()],n.runId,void 0,s,void 0,void 0,n.runName));let c=new ut.GenerationChunk({text:""});try{for await(const e of this._streamResponseChunks(r.toString(),a,o?.[0]))c=c?c.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}async generatePrompt(e,t,r){const n=e.map((e=>e.toString()));return this.generate(n,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let r=0;r<e.generations.length;r+=1){const n=e.generations[r];if(0===r)t.push({generations:[n],llmOutput:e.llmOutput});else{const r=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[n],llmOutput:r})}}return t}async _generateUncached(e,t,r){const n=await Ee.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length},i=await(n?.handleLLMStart(this.toJSON(),e,r.runId,void 0,a,void 0,void 0,r?.runName));let s;if(i?.[0].handlers.find((e=>(0,dt.K)(e)||(0,ht.isLogStreamHandler)(e)))&&1===e.length&&this._streamResponseChunks!==wt.prototype._streamResponseChunks)try{const r=await this._streamResponseChunks(e[0],t,i?.[0]);let n;for await(const e of r)n=void 0===n?e:(0,pt.concat)(n,e);if(void 0===n)throw new Error("Received empty response from chat model call.");s={generations:[[n]],llmOutput:{}},await(i?.[0].handleLLMEnd(s))}catch(e){throw await(i?.[0].handleLLMError(e)),e}else{try{s=await this._generate(e,t,i?.[0])}catch(e){throw await Promise.all((i??[]).map((t=>t?.handleLLMError(e)))),e}const r=this._flattenLLMResult(s);await Promise.all((i??[]).map(((e,t)=>e?.handleLLMEnd(r[t]))))}const o=i?.map((e=>e.runId))||void 0;return Object.defineProperty(s,ut.RUN_KEY,{value:o?{runIds:o}:void 0,configurable:!0}),s}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:a,runId:i}){const s=await Ee.CallbackManager.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:n,invocation_params:this?.invocationParams(n),batch_size:e.length,cached:!0},c=await(s?.handleLLMStart(this.toJSON(),e,i,void 0,o,void 0,void 0,a?.runName)),l=[],u=(await Promise.allSettled(e.map((async(e,n)=>{const a=await t.lookup(e,r);return null==a&&l.push(n),a})))).map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),d=[];await Promise.all(u.map((async({result:e,runManager:t},r)=>{if("fulfilled"===e.status){const n=e.value;return d[r]=n,n.length&&await(t?.handleLLMNewToken(n[0].text)),t?.handleLLMEnd({generations:[n]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const h={generations:d,missingPromptIndices:l};return Object.defineProperty(h,ut.RUN_KEY,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),h}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let n;n=Array.isArray(t)?{stop:t}:t;const[a,i]=this._separateRunnableConfigFromCallOptionsCompat(n);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(e,i,a);const{cache:s}=this,o=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:l}=await this._generateCached({prompts:e,cache:s,llmStringKey:o,parsedOptions:i,handledOptions:a,runId:a.runId});let u={};if(l.length>0){const t=await this._generateUncached(l.map((t=>e[t])),i,a);await Promise.all(t.generations.map((async(t,r)=>{const n=l[r];return c[n]=t,s.update(e[n],o,t)}))),u=t.llmOutput??{}}return{generations:c,llmOutput:u}}async call(e,t,r){const{generations:n}=await this.generate([e],t,r);return n[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){const n=(0,Te.getBufferString)(e),a=await this.call(n,t,r);return new Te.AIMessage(a)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class Ot extends wt{async _generate(e,t,r){return{generations:await Promise.all(e.map(((e,n)=>this._call(e,{...t,promptIndex:n},r).then((e=>[{text:e}])))))}}}class kt{}const Et=(e,t)=>{if(void 0!==t)return e[t];const r=Object.keys(e);return 1===r.length?e[r[0]]:void 0},St=(e,t)=>{const r=Et(e,t);if(!r){const t=Object.keys(e);throw new Error(`input values have ${t.length} keys, you must specify an input key or pass only 1 key as input`)}return r},Tt=(e,t)=>{const r=Et(e,t);if(!r&&""!==r){const t=Object.keys(e);throw new Error(`output values have ${t.length} keys, you must specify an output key or pass only 1 key as output`)}return r};function Pt(e,t){const r=Object.keys(e).filter((e=>!t.includes(e)&&"stop"!==e));if(1!==r.length)throw new Error(`One input key expected, but got ${r.length}`);return r[0]}class xt extends Ie.YN{static lc_name(){return"RouterRunnable"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnables=e.runnables}async invoke(e,t){const{key:r,input:n}=e,a=this.runnables[r];if(void 0===a)throw new Error(`No runnable associated with key "${r}".`);return a.invoke(n,(0,ft.ZI)(t))}async batch(e,t,r){const n=e.map((e=>e.key)),a=e.map((e=>e.input)),i=n.find((e=>void 0===this.runnables[e]));if(void 0!==i)throw new Error("One or more keys do not have a corresponding runnable.");const s=n.map((e=>this.runnables[e])),o=this._getOptionsList(t??{},e.length),c=o[0]?.maxConcurrency??r?.maxConcurrency,l=c&&c>0?c:e.length,u=[];for(let e=0;e<a.length;e+=l){const t=a.slice(e,e+l).map(((e,t)=>s[t].invoke(e,o[t]))),r=await Promise.all(t);u.push(r)}return u.flat()}async stream(e,t){const{key:r,input:n}=e,a=this.runnables[r];if(void 0===a)throw new Error(`No runnable associated with key "${r}".`);return a.stream(n,t)}}class jt extends Ie.YN{static lc_name(){return"RunnableBranch"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"default",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.branches=e.branches,this.default=e.default}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");return new this({branches:e.slice(0,-1).map((([e,t])=>[(0,Ie.Bp)(e),(0,Ie.Bp)(t)])),default:(0,Ie.Bp)(e[e.length-1])})}async _invoke(e,t,r){let n;for(let a=0;a<this.branches.length;a+=1){const[i,s]=this.branches[a];if(await i.invoke(e,(0,ft.tn)(t,{callbacks:r?.getChild(`condition:${a+1}`)}))){n=await s.invoke(e,(0,ft.tn)(t,{callbacks:r?.getChild(`branch:${a+1}`)}));break}}return n||(n=await this.default.invoke(e,(0,ft.tn)(t,{callbacks:r?.getChild("branch:default")}))),n}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async*_streamIterator(e,t){const r=await(0,ft.kJ)(t),n=await(r?.handleChainStart(this.toJSON(),(0,Ie.GH)(e,"input"),t?.runId,void 0,void 0,void 0,t?.runName));let a,i,s=!0;try{for(let r=0;r<this.branches.length;r+=1){const[o,c]=this.branches[r];if(await o.invoke(e,(0,ft.tn)(t,{callbacks:n?.getChild(`condition:${r+1}`)}))){i=await c.stream(e,(0,ft.tn)(t,{callbacks:n?.getChild(`branch:${r+1}`)}));for await(const e of i)if(yield e,s)if(void 0===a)a=e;else try{a=(0,pt.concat)(a,e)}catch(e){a=void 0,s=!1}break}}if(void 0===i){i=await this.default.stream(e,(0,ft.tn)(t,{callbacks:n?.getChild("branch:default")}));for await(const e of i)if(yield e,s)if(void 0===a)a=e;else try{a=(0,pt.concat)(a,e)}catch(e){a=void 0,s=!1}}}catch(e){throw await(n?.handleChainError(e)),e}await(n?.handleChainEnd(a??{}))}}class Ct extends Ie.fJ{constructor(e){let t=Ie.jY.from(((e,t)=>this._enterHistory(e,t??{}))).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=mt.assign({[r]:t}).withConfig({runName:"insertHistory"}));const n=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),a=e.config??{};super({...e,config:a,bound:n}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||(0,Te.isBaseMessage)(e))t=e;else{let r;r=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[r])&&Array.isArray(e[r][0])?e[r][0]:e[r]}if("string"==typeof t)return[new Te.HumanMessage(t)];if(Array.isArray(t))return t;if((0,Te.isBaseMessage)(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.\nGot ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||(0,Te.isBaseMessage)(e)||"string"==typeof e)t=e;else{let r;r=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[r]}if("string"==typeof t)return[new Te.AIMessage(t)];if(Array.isArray(t))return t;if((0,Te.isBaseMessage)(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){const r=t?.configurable?.messageHistory,n=await r.getMessages();return void 0===this.historyMessagesKey?n.concat(this._getInputMessages(e)):n}async _exitHistory(e,t){const r=t.configurable?.messageHistory;let n;n=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let a=this._getInputMessages(n);if(void 0===this.historyMessagesKey){const e=await r.getMessages();a=a.slice(e.length)}const i=e.outputs;if(!i)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const s=this._getOutputMessages(i);await r.addMessages([...a,...s])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const e={[this.inputMessagesKey??"input"]:"foo"},t={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()\neg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify(t)})`)}const{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}}var It=r(1368);class At extends Ie.YN{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class Rt extends At{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class Nt extends Error{constructor(e,t,r,n=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=n,n&&(void 0===r||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,It.Y)(this,"OUTPUT_PARSING_FAILURE")}}var $t=r(3490);function Lt(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const r=e.length;if(r!==t.length)return!1;for(let n=0;n<r;n++)if(!Lt(e[n],t[n]))return!1;return!0}if("object"===r){if(!e||!t)return e===t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const n of r)if(!Lt(e[n],t[n]))return!1;return!0}return e===t}function Mt(e){return encodeURI(function(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}(e))}const Dt={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Ft={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Ut={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let Bt="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function zt(e,t=Object.create(null),r=Bt,n=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const a=e.$id||e.id;if(a){const i=new URL(a,r.href);i.hash.length>1?t[i.href]=e:(i.hash="",""===n?r=i:zt(e,t,r))}}else if(!0!==e&&!1!==e)return t;const a=r.href+(n?"#"+n:"");if(void 0!==t[a])throw new Error(`Duplicate schema URI "${a}".`);if(t[a]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:a}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,r.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,r.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}e.$anchor&&(t[new URL("#"+e.$anchor,r.href).href]=e);for(let a in e){if(Ut[a])continue;const i=`${n}/${Mt(a)}`,s=e[a];if(Array.isArray(s)){if(Dt[a]){const e=s.length;for(let n=0;n<e;n++)zt(s[n],t,r,`${i}/${n}`)}}else if(Ft[a])for(let e in s)zt(s[e],t,r,`${i}/${Mt(e)}`);else zt(s,t,r,i)}return t}const Vt=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,qt=[0,31,28,31,30,31,30,31,31,30,31,30,31],Zt=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Gt=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Ht=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Wt=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,Yt=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,Jt=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,Kt=/^(?:\/(?:[^~/]|~0|~1)*)*$/,Xt=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,Qt=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,er=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,tr=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,rr=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,nr=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,ar=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,ir=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i;function sr(e){return e.test.bind(e)}const or={date:cr,time:lr.bind(void 0,!1),"date-time":function(e){const t=e.split(ur);return 2==t.length&&cr(t[0])&&lr(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return dr.test(e)&&hr.test(e)},"uri-reference":sr(Ht),"uri-template":sr(Wt),url:sr(Yt),email:e=>{if('"'===e[0])return!1;const[t,r,...n]=e.split("@");return!(!t||!r||0!==n.length||t.length>64||r.length>253)&&"."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&!(!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&r.split(".").every((e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e)))},hostname:sr(Gt),ipv4:sr(ar),ipv6:sr(ir),regex:function(e){if(pr.test(e))return!1;try{return new RegExp(e),!0}catch(e){return!1}},uuid:sr(Jt),"json-pointer":sr(Kt),"json-pointer-uri-fragment":sr(Xt),"relative-json-pointer":sr(Qt),date:sr(er),time:sr(tr),"date-time":sr(rr),"uri-reference":sr(nr)};function cr(e){const t=e.match(Vt);if(!t)return!1;const r=+t[1],n=+t[2],a=+t[3];return n>=1&&n<=12&&a>=1&&a<=(2==n&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(r)?29:qt[n])}function lr(e,t){const r=t.match(Zt);if(!r)return!1;const n=+r[1],a=+r[2],i=+r[3],s=!!r[5];return(n<=23&&a<=59&&i<=59||23==n&&59==a&&60==i)&&(!e||s)}const ur=/t|\s/i,dr=/\/|:/,hr=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,pr=/[^\\]\\Z/;function fr(e,t,r="2019-09",n=zt(t),a=!0,i=null,s="#",o="#",c=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};const l=typeof e;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":u=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:f,const:m,enum:g,required:b,not:y,anyOf:v,allOf:_,oneOf:w,if:O,then:k,else:E,format:S,properties:T,patternProperties:P,additionalProperties:x,unevaluatedProperties:j,minProperties:C,maxProperties:I,propertyNames:A,dependentRequired:R,dependentSchemas:N,dependencies:$,prefixItems:L,items:M,additionalItems:D,unevaluatedItems:F,contains:U,minContains:B,maxContains:z,minItems:V,maxItems:q,uniqueItems:Z,minimum:G,maximum:H,exclusiveMinimum:W,exclusiveMaximum:Y,multipleOf:J,minLength:K,maxLength:X,pattern:Q,__absolute_ref__:ee,__absolute_recursive_ref__:te}=t,re=[];if(!0===p&&null===i&&(i=t),"#"===h){const l=null===i?n[te]:i,u=`${o}/$recursiveRef`,d=fr(e,null===i?t:i,r,n,a,l,s,u,c);d.valid||re.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:u,error:"A subschema had errors."},...d.errors)}if(void 0!==d){const t=n[ee||d];if(void 0===t){let e=`Unresolved $ref "${d}".`;throw ee&&ee!==d&&(e+=`  Absolute URI "${ee}".`),e+=`\nKnown schemas:\n- ${Object.keys(n).join("\n- ")}`,new Error(e)}const l=`${o}/$ref`,u=fr(e,t,r,n,a,i,s,l,c);if(u.valid||re.push({instanceLocation:s,keyword:"$ref",keywordLocation:l,error:"A subschema had errors."},...u.errors),"4"===r||"7"===r)return{valid:0===re.length,errors:re}}if(Array.isArray(f)){let t=f.length,r=!1;for(let n=0;n<t;n++)if(u===f[n]||"integer"===f[n]&&"number"===u&&e%1==0&&e==e){r=!0;break}r||re.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f.join('", "')}".`})}else"integer"===f?("number"!==u||e%1||e!=e)&&re.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`}):void 0!==f&&u!==f&&re.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`});if(void 0!==m&&("object"===u||"array"===u?Lt(e,m)||re.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):e!==m&&re.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),void 0!==g&&("object"===u||"array"===u?g.some((t=>Lt(e,t)))||re.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some((t=>e===t))||re.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),void 0!==y){const t=`${o}/not`;fr(e,y,r,n,a,i,s,t).valid&&re.push({instanceLocation:s,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let ne=[];if(void 0!==v){const t=`${o}/anyOf`,l=re.length;let u=!1;for(let o=0;o<v.length;o++){const l=v[o],d=Object.create(c),h=fr(e,l,r,n,a,!0===p?i:null,s,`${t}/${o}`,d);re.push(...h.errors),u=u||h.valid,h.valid&&ne.push(d)}u?re.length=l:re.splice(l,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==_){const t=`${o}/allOf`,l=re.length;let u=!0;for(let o=0;o<_.length;o++){const l=_[o],d=Object.create(c),h=fr(e,l,r,n,a,!0===p?i:null,s,`${t}/${o}`,d);re.push(...h.errors),u=u&&h.valid,h.valid&&ne.push(d)}u?re.length=l:re.splice(l,0,{instanceLocation:s,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==w){const t=`${o}/oneOf`,l=re.length,u=w.filter(((o,l)=>{const u=Object.create(c),d=fr(e,o,r,n,a,!0===p?i:null,s,`${t}/${l}`,u);return re.push(...d.errors),d.valid&&ne.push(u),d.valid})).length;1===u?re.length=l:re.splice(l,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${u} matches).`})}if("object"!==u&&"array"!==u||Object.assign(c,...ne),void 0!==O){const t=`${o}/if`;if(fr(e,O,r,n,a,i,s,t,c).valid){if(void 0!==k){const l=fr(e,k,r,n,a,i,s,`${o}/then`,c);l.valid||re.push({instanceLocation:s,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...l.errors)}}else if(void 0!==E){const l=fr(e,E,r,n,a,i,s,`${o}/else`,c);l.valid||re.push({instanceLocation:s,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...l.errors)}}if("object"===u){if(void 0!==b)for(const t of b)t in e||re.push({instanceLocation:s,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==C&&t.length<C&&re.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${C} properties.`}),void 0!==I&&t.length>I&&re.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${I} properties.`}),void 0!==A){const t=`${o}/propertyNames`;for(const o in e){const e=`${s}/${Mt(o)}`,c=fr(o,A,r,n,a,i,e,t);c.valid||re.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:t,error:`Property name "${o}" does not match schema.`},...c.errors)}}if(void 0!==R){const t=`${o}/dependantRequired`;for(const r in R)if(r in e){const n=R[r];for(const a of n)a in e||re.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${r}" but does not have "${a}".`})}}if(void 0!==N)for(const t in N){const l=`${o}/dependentSchemas`;if(t in e){const o=fr(e,N[t],r,n,a,i,s,`${l}/${Mt(t)}`,c);o.valid||re.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:l,error:`Instance has "${t}" but does not match dependant schema.`},...o.errors)}}if(void 0!==$){const t=`${o}/dependencies`;for(const o in $)if(o in e){const c=$[o];if(Array.isArray(c))for(const r of c)r in e||re.push({instanceLocation:s,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not have "${r}".`});else{const l=fr(e,c,r,n,a,i,s,`${t}/${Mt(o)}`);l.valid||re.push({instanceLocation:s,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not match dependant schema.`},...l.errors)}}}const l=Object.create(null);let u=!1;if(void 0!==T){const t=`${o}/properties`;for(const o in T){if(!(o in e))continue;const d=`${s}/${Mt(o)}`,h=fr(e[o],T[o],r,n,a,i,d,`${t}/${Mt(o)}`);if(h.valid)c[o]=l[o]=!0;else if(u=a,re.push({instanceLocation:s,keyword:"properties",keywordLocation:t,error:`Property "${o}" does not match schema.`},...h.errors),u)break}}if(!u&&void 0!==P){const t=`${o}/patternProperties`;for(const o in P){const d=new RegExp(o),h=P[o];for(const p in e){if(!d.test(p))continue;const f=`${s}/${Mt(p)}`,m=fr(e[p],h,r,n,a,i,f,`${t}/${Mt(o)}`);m.valid?c[p]=l[p]=!0:(u=a,re.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:t,error:`Property "${p}" matches pattern "${o}" but does not match associated schema.`},...m.errors))}}}if(u||void 0===x){if(!u&&void 0!==j){const t=`${o}/unevaluatedProperties`;for(const o in e)if(!c[o]){const l=`${s}/${Mt(o)}`,u=fr(e[o],j,r,n,a,i,l,t);u.valid?c[o]=!0:re.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${o}" does not match unevaluated properties schema.`},...u.errors)}}}else{const t=`${o}/additionalProperties`;for(const o in e){if(l[o])continue;const d=`${s}/${Mt(o)}`,h=fr(e[o],x,r,n,a,i,d,t);h.valid?c[o]=!0:(u=a,re.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:t,error:`Property "${o}" does not match additional properties schema.`},...h.errors))}}}else if("array"===u){void 0!==q&&e.length>q&&re.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${q}).`}),void 0!==V&&e.length<V&&re.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${V}).`});const t=e.length;let l=0,u=!1;if(void 0!==L){const d=`${o}/prefixItems`,h=Math.min(L.length,t);for(;l<h;l++){const t=fr(e[l],L[l],r,n,a,i,`${s}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}if(void 0!==M){const d=`${o}/items`;if(Array.isArray(M)){const o=Math.min(M.length,t);for(;l<o;l++){const t=fr(e[l],M[l],r,n,a,i,`${s}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:s,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}else for(;l<t;l++){const t=fr(e[l],M,r,n,a,i,`${s}/${l}`,d);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:s,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}if(!u&&void 0!==D){const d=`${o}/additionalItems`;for(;l<t;l++){const t=fr(e[l],D,r,n,a,i,`${s}/${l}`,d);c[l]=!0,t.valid||(u=a,re.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:d,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==U)if(0===t&&void 0===B)re.push({instanceLocation:s,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==B&&t<B)re.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${t}) than minContains (${B}).`});else{const l=`${o}/contains`,u=re.length;let d=0;for(let o=0;o<t;o++){const t=fr(e[o],U,r,n,a,i,`${s}/${o}`,l);t.valid?(c[o]=!0,d++):re.push(...t.errors)}d>=(B||0)&&(re.length=u),void 0===B&&void 0===z&&0===d?re.splice(u,0,{instanceLocation:s,keyword:"contains",keywordLocation:l,error:"Array does not contain item matching schema."}):void 0!==B&&d<B?re.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${B} items matching schema. Only ${d} items were found.`}):void 0!==z&&d>z&&re.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${z} items matching schema. ${d} items were found.`})}if(!u&&void 0!==F){const u=`${o}/unevaluatedItems`;for(;l<t;l++){if(c[l])continue;const t=fr(e[l],F,r,n,a,i,`${s}/${l}`,u);c[l]=!0,t.valid||re.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:u,error:"Items did not match unevaluated items schema."},...t.errors)}}if(Z)for(let r=0;r<t;r++){const n=e[r],a="object"==typeof n&&null!==n;for(let i=0;i<t;i++){if(r===i)continue;const t=e[i];(n===t||a&&"object"==typeof t&&null!==t&&Lt(n,t))&&(re.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${r} and ${i}.`}),r=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER)}}}else if("number"===u){if("4"===r?(void 0!==G&&(!0===W&&e<=G||e<G)&&re.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${W?"or equal to ":""} ${G}.`}),void 0!==H&&(!0===Y&&e>=H||e>H)&&re.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${Y?"or equal to ":""} ${H}.`})):(void 0!==G&&e<G&&re.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${G}.`}),void 0!==H&&e>H&&re.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${H}.`}),void 0!==W&&e<=W&&re.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${W}.`}),void 0!==Y&&e>=Y&&re.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${Y}.`})),void 0!==J){const t=e%J;Math.abs(0-t)>=1.1920929e-7&&Math.abs(J-t)>=1.1920929e-7&&re.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${J}.`})}}else if("string"===u){const t=void 0===K&&void 0===X?0:function(e){let t,r=0,n=e.length,a=0;for(;a<n;)r++,t=e.charCodeAt(a++),t>=55296&&t<=56319&&a<n&&(t=e.charCodeAt(a),56320==(64512&t)&&a++);return r}(e);void 0!==K&&t<K&&re.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${t} < ${K}).`}),void 0!==X&&t>X&&re.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${t} > ${X}).`}),void 0===Q||new RegExp(Q).test(e)||re.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),void 0!==S&&or[S]&&!or[S](e)&&re.push({instanceLocation:s,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${S}".`})}return{valid:0===re.length,errors:re}}class mr{constructor(e,t="2019-09",r=!0){Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"draft",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"shortCircuit",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"lookup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lookup=zt(e)}validate(e){return fr(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,t){t&&(e={...e,$id:t}),zt(e,this.lookup)}}class gr extends Rt{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class br extends gr{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(const n of e){if("string"!=typeof n&&"string"!=typeof n.content)throw new Error("Cannot handle non-string output.");let e;if((0,$t.AJ)(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new ut.ChatGenerationChunk({message:n,text:n.content})}else if((0,$t.ny)(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new ut.ChatGenerationChunk({message:(0,ge.ih)(n),text:n.content})}else e=new ut.GenerationChunk({text:n});r=void 0===r?e:r.concat(e);const a=await this.parsePartialResult([r]);null==a||Lt(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}class yr extends gr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","bytes"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"textEncoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextEncoder})}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}}class vr extends gr{constructor(){super(...arguments),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async*_transform(e){let t="";for await(const r of e)if(t+="string"==typeof r?r:r.content,this.re){const e=[...t.matchAll(this.re)];if(e.length>1){let r=0;for(const t of e.slice(0,-1))yield[t[1]],r+=(t.index??0)+t[0].length;t=t.slice(r)}}else{const e=await this.parse(t);if(e.length>1){for(const t of e.slice(0,-1))yield[t];t=e[e.length-1]}}for(const e of await this.parse(t))yield[e]}}class _r extends vr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map((e=>e.trim()))}catch(t){throw new Nt(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}}class wr extends vr{constructor({length:e,separator:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{const t=e.trim().split(this.separator).map((e=>e.trim()));if(void 0!==this.length&&t.length!==this.length)throw new Nt(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){if(Object.getPrototypeOf(t)===Nt.prototype)throw t;throw new Nt(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${void 0===this.length?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}}class Or extends vr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/\d+\.\s([^\n]+)/g})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return"Your response should be a numbered list with each item on a new line. For example: \n\n1. foo\n\n2. bar\n\n3. baz"}async parse(e){return[...e.matchAll(this.re)??[]].map((e=>e[1]))}}class kr extends vr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/^\s*[-*]\s([^\n]+)$/gm})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return"Your response should be a numbered list with each item on a new line. For example: \n\n1. foo\n\n2. bar\n\n3. baz"}async parse(e){return[...e.matchAll(this.re)??[]].map((e=>e[1]))}}class Er extends gr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce(((e,t)=>e+this._messageContentComplexToString(t)),"")}}var Sr=r(4476);class Tr extends Rt{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Sr.z.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Sr.z.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify((0,lt.Ik)(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Nt(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class Pr extends Tr{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){const t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:\n\`\`\`json\n${this._schemaToInstruction((0,lt.Ik)(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}\n\`\`\``}_schemaToInstruction(e,t=2){const r=e;if("type"in r){let e,n=!1;if(Array.isArray(r.type)){const t=r.type.findIndex((e=>"null"===e));-1!==t&&(n=!0,r.type.splice(t,1)),e=r.type.join(" | ")}else e=r.type;if("object"===r.type&&r.properties){const e=r.description?` // ${r.description}`:"",n=Object.entries(r.properties).map((([e,n])=>{const a=r.required?.includes(e)?"":" (optional)";return`${" ".repeat(t)}"${e}": ${this._schemaToInstruction(n,t+2)}${a}`})).join("\n");return`{\n${n}\n${" ".repeat(t-2)}}${e}`}if("array"===r.type&&r.items){const e=r.description?` // ${r.description}`:"";return`array[\n${" ".repeat(t)}${this._schemaToInstruction(r.items,t+2)}\n${" ".repeat(t-2)}] ${e}`}const a=n?" (nullable)":"";return`${e}${r.description?` // ${r.description}`:""}${a}`}if("anyOf"in r)return r.anyOf.map((e=>this._schemaToInstruction(e,t))).join(`\n${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Sr.z.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Sr.z.string().describe(t)])))))}}class xr extends Rt{constructor({inputSchema:e}){super(...arguments),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new Pr(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(t){throw new Nt(`Failed to parse. Text: "${e}". Error: ${t}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}}var jr=r(6150),Cr=r(780);class Ir extends br{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?(0,jr.UD)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,Cr.D)(e[0].text)}async parse(e){return(0,Cr.D)(e,JSON.parse)}getFormatInstructions(){return""}}var Ar=r(7481).ZY;const Rr=function(){const e={parser:function(e,t){return new r(e,t)}};e.SAXParser=r,e.SAXStream=i,e.createStream=function(e,t){return new i(e,t)},e.MAX_BUFFER_LENGTH=65536;const t=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function r(n,a){if(!(this instanceof r))return new r(n,a);var i=this;!function(e){for(var r=0,n=t.length;r<n;r++)e[t[r]]=""}(i),i.q=i.c="",i.bufferCheckPosition=e.MAX_BUFFER_LENGTH,i.opt=a||{},i.opt.lowercase=i.opt.lowercase||i.opt.lowercasetags,i.looseCase=i.opt.lowercase?"toLowerCase":"toUpperCase",i.tags=[],i.closed=i.closedRoot=i.sawRoot=!1,i.tag=i.error=null,i.strict=!!n,i.noscript=!(!n&&!i.opt.noscript),i.state=k.BEGIN,i.strictEntities=i.opt.strictEntities,i.ENTITIES=i.strictEntities?Object.create(e.XML_ENTITIES):Object.create(e.ENTITIES),i.attribList=[],i.opt.xmlns&&(i.ns=Object.create(u)),i.trackPosition=!1!==i.opt.position,i.trackPosition&&(i.position=i.line=i.column=0),S(i,"onready")}e.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(e){function t(){}return t.prototype=e,new t}),Object.keys||(Object.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t}),r.prototype={end:function(){C(this)},write:function(r){var n=this;if(this.error)throw this.error;if(n.closed)return j(n,"Cannot write after close. Assign an onready handler.");if(null===r)return C(n);"object"==typeof r&&(r=r.toString());for(var a=0,i="";i=F(r,a++),n.c=i,i;)switch(n.trackPosition&&(n.position++,"\n"===i?(n.line++,n.column=0):n.column++),n.state){case k.BEGIN:if(n.state=k.BEGIN_WHITESPACE,"\ufeff"===i)continue;D(n,i);continue;case k.BEGIN_WHITESPACE:D(n,i);continue;case k.TEXT:if(n.sawRoot&&!n.closedRoot){for(var c=a-1;i&&"<"!==i&&"&"!==i;)(i=F(r,a++))&&n.trackPosition&&(n.position++,"\n"===i?(n.line++,n.column=0):n.column++);n.textNode+=r.substring(c,a-1)}"<"!==i||n.sawRoot&&n.closedRoot&&!n.strict?(m(i)||n.sawRoot&&!n.closedRoot||I(n,"Text data outside of root node."),"&"===i?n.state=k.TEXT_ENTITY:n.textNode+=i):(n.state=k.OPEN_WAKA,n.startTagPosition=n.position);continue;case k.SCRIPT:"<"===i?n.state=k.SCRIPT_ENDING:n.script+=i;continue;case k.SCRIPT_ENDING:"/"===i?n.state=k.CLOSE_TAG:(n.script+="<"+i,n.state=k.SCRIPT);continue;case k.OPEN_WAKA:if("!"===i)n.state=k.SGML_DECL,n.sgmlDecl="";else if(m(i));else if(y(d,i))n.state=k.OPEN_TAG,n.tagName=i;else if("/"===i)n.state=k.CLOSE_TAG,n.tagName="";else if("?"===i)n.state=k.PROC_INST,n.procInstName=n.procInstBody="";else{if(I(n,"Unencoded <"),n.startTagPosition+1<n.position){var l=n.position-n.startTagPosition;i=new Array(l).join(" ")+i}n.textNode+="<"+i,n.state=k.TEXT}continue;case k.SGML_DECL:(n.sgmlDecl+i).toUpperCase()===s?(T(n,"onopencdata"),n.state=k.CDATA,n.sgmlDecl="",n.cdata=""):n.sgmlDecl+i==="--"?(n.state=k.COMMENT,n.comment="",n.sgmlDecl=""):(n.sgmlDecl+i).toUpperCase()===o?(n.state=k.DOCTYPE,(n.doctype||n.sawRoot)&&I(n,"Inappropriately located doctype declaration"),n.doctype="",n.sgmlDecl=""):">"===i?(T(n,"onsgmldeclaration",n.sgmlDecl),n.sgmlDecl="",n.state=k.TEXT):g(i)?(n.state=k.SGML_DECL_QUOTED,n.sgmlDecl+=i):n.sgmlDecl+=i;continue;case k.SGML_DECL_QUOTED:i===n.q&&(n.state=k.SGML_DECL,n.q=""),n.sgmlDecl+=i;continue;case k.DOCTYPE:">"===i?(n.state=k.TEXT,T(n,"ondoctype",n.doctype),n.doctype=!0):(n.doctype+=i,"["===i?n.state=k.DOCTYPE_DTD:g(i)&&(n.state=k.DOCTYPE_QUOTED,n.q=i));continue;case k.DOCTYPE_QUOTED:n.doctype+=i,i===n.q&&(n.q="",n.state=k.DOCTYPE);continue;case k.DOCTYPE_DTD:n.doctype+=i,"]"===i?n.state=k.DOCTYPE:g(i)&&(n.state=k.DOCTYPE_DTD_QUOTED,n.q=i);continue;case k.DOCTYPE_DTD_QUOTED:n.doctype+=i,i===n.q&&(n.state=k.DOCTYPE_DTD,n.q="");continue;case k.COMMENT:"-"===i?n.state=k.COMMENT_ENDING:n.comment+=i;continue;case k.COMMENT_ENDING:"-"===i?(n.state=k.COMMENT_ENDED,n.comment=x(n.opt,n.comment),n.comment&&T(n,"oncomment",n.comment),n.comment=""):(n.comment+="-"+i,n.state=k.COMMENT);continue;case k.COMMENT_ENDED:">"!==i?(I(n,"Malformed comment"),n.comment+="--"+i,n.state=k.COMMENT):n.state=k.TEXT;continue;case k.CDATA:"]"===i?n.state=k.CDATA_ENDING:n.cdata+=i;continue;case k.CDATA_ENDING:"]"===i?n.state=k.CDATA_ENDING_2:(n.cdata+="]"+i,n.state=k.CDATA);continue;case k.CDATA_ENDING_2:">"===i?(n.cdata&&T(n,"oncdata",n.cdata),T(n,"onclosecdata"),n.cdata="",n.state=k.TEXT):"]"===i?n.cdata+="]":(n.cdata+="]]"+i,n.state=k.CDATA);continue;case k.PROC_INST:"?"===i?n.state=k.PROC_INST_ENDING:m(i)?n.state=k.PROC_INST_BODY:n.procInstName+=i;continue;case k.PROC_INST_BODY:if(!n.procInstBody&&m(i))continue;"?"===i?n.state=k.PROC_INST_ENDING:n.procInstBody+=i;continue;case k.PROC_INST_ENDING:">"===i?(T(n,"onprocessinginstruction",{name:n.procInstName,body:n.procInstBody}),n.procInstName=n.procInstBody="",n.state=k.TEXT):(n.procInstBody+="?"+i,n.state=k.PROC_INST_BODY);continue;case k.OPEN_TAG:y(h,i)?n.tagName+=i:(A(n),">"===i?$(n):"/"===i?n.state=k.OPEN_TAG_SLASH:(m(i)||I(n,"Invalid character in tag name"),n.state=k.ATTRIB));continue;case k.OPEN_TAG_SLASH:">"===i?($(n,!0),L(n)):(I(n,"Forward-slash in opening tag not followed by >"),n.state=k.ATTRIB);continue;case k.ATTRIB:if(m(i))continue;">"===i?$(n):"/"===i?n.state=k.OPEN_TAG_SLASH:y(d,i)?(n.attribName=i,n.attribValue="",n.state=k.ATTRIB_NAME):I(n,"Invalid attribute name");continue;case k.ATTRIB_NAME:"="===i?n.state=k.ATTRIB_VALUE:">"===i?(I(n,"Attribute without value"),n.attribValue=n.attribName,N(n),$(n)):m(i)?n.state=k.ATTRIB_NAME_SAW_WHITE:y(h,i)?n.attribName+=i:I(n,"Invalid attribute name");continue;case k.ATTRIB_NAME_SAW_WHITE:if("="===i)n.state=k.ATTRIB_VALUE;else{if(m(i))continue;I(n,"Attribute without value"),n.tag.attributes[n.attribName]="",n.attribValue="",T(n,"onattribute",{name:n.attribName,value:""}),n.attribName="",">"===i?$(n):y(d,i)?(n.attribName=i,n.state=k.ATTRIB_NAME):(I(n,"Invalid attribute name"),n.state=k.ATTRIB)}continue;case k.ATTRIB_VALUE:if(m(i))continue;g(i)?(n.q=i,n.state=k.ATTRIB_VALUE_QUOTED):(I(n,"Unquoted attribute value"),n.state=k.ATTRIB_VALUE_UNQUOTED,n.attribValue=i);continue;case k.ATTRIB_VALUE_QUOTED:if(i!==n.q){"&"===i?n.state=k.ATTRIB_VALUE_ENTITY_Q:n.attribValue+=i;continue}N(n),n.q="",n.state=k.ATTRIB_VALUE_CLOSED;continue;case k.ATTRIB_VALUE_CLOSED:m(i)?n.state=k.ATTRIB:">"===i?$(n):"/"===i?n.state=k.OPEN_TAG_SLASH:y(d,i)?(I(n,"No whitespace between attributes"),n.attribName=i,n.attribValue="",n.state=k.ATTRIB_NAME):I(n,"Invalid attribute name");continue;case k.ATTRIB_VALUE_UNQUOTED:if(!b(i)){"&"===i?n.state=k.ATTRIB_VALUE_ENTITY_U:n.attribValue+=i;continue}N(n),">"===i?$(n):n.state=k.ATTRIB;continue;case k.CLOSE_TAG:if(n.tagName)">"===i?L(n):y(h,i)?n.tagName+=i:n.script?(n.script+="</"+n.tagName,n.tagName="",n.state=k.SCRIPT):(m(i)||I(n,"Invalid tagname in closing tag"),n.state=k.CLOSE_TAG_SAW_WHITE);else{if(m(i))continue;v(d,i)?n.script?(n.script+="</"+i,n.state=k.SCRIPT):I(n,"Invalid tagname in closing tag."):n.tagName=i}continue;case k.CLOSE_TAG_SAW_WHITE:if(m(i))continue;">"===i?L(n):I(n,"Invalid characters in closing tag");continue;case k.TEXT_ENTITY:case k.ATTRIB_VALUE_ENTITY_Q:case k.ATTRIB_VALUE_ENTITY_U:var u,_;switch(n.state){case k.TEXT_ENTITY:u=k.TEXT,_="textNode";break;case k.ATTRIB_VALUE_ENTITY_Q:u=k.ATTRIB_VALUE_QUOTED,_="attribValue";break;case k.ATTRIB_VALUE_ENTITY_U:u=k.ATTRIB_VALUE_UNQUOTED,_="attribValue"}if(";"===i)if(n.opt.unparsedEntities){var w=M(n);n.entity="",n.state=u,n.write(w)}else n[_]+=M(n),n.entity="",n.state=u;else y(n.entity.length?f:p,i)?n.entity+=i:(I(n,"Invalid character in entity name"),n[_]+="&"+n.entity+i,n.entity="",n.state=u);continue;default:throw new Error(n,"Unknown state: "+n.state)}return n.position>=n.bufferCheckPosition&&function(r){for(var n=Math.max(e.MAX_BUFFER_LENGTH,10),a=0,i=0,s=t.length;i<s;i++){var o=r[t[i]].length;if(o>n)switch(t[i]){case"textNode":P(r);break;case"cdata":T(r,"oncdata",r.cdata),r.cdata="";break;case"script":T(r,"onscript",r.script),r.script="";break;default:j(r,"Max buffer length exceeded: "+t[i])}a=Math.max(a,o)}var c=e.MAX_BUFFER_LENGTH-a;r.bufferCheckPosition=c+r.position}(n),n},resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){var e;P(e=this),""!==e.cdata&&(T(e,"oncdata",e.cdata),e.cdata=""),""!==e.script&&(T(e,"onscript",e.script),e.script="")}};var n=Ar;n||(n=function(){});var a=e.EVENTS.filter((function(e){return"error"!==e&&"end"!==e}));function i(e,t){if(!(this instanceof i))return new i(e,t);n.apply(this),this._parser=new r(e,t),this.writable=!0,this.readable=!0;var s=this;this._parser.onend=function(){s.emit("end")},this._parser.onerror=function(e){s.emit("error",e),s._parser.error=null},this._decoder=null,a.forEach((function(e){Object.defineProperty(s,"on"+e,{get:function(){return s._parser["on"+e]},set:function(t){if(!t)return s.removeAllListeners(e),s._parser["on"+e]=t,t;s.on(e,t)},enumerable:!0,configurable:!1})}))}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.write=function(e){return this._parser.write(e.toString()),this.emit("data",e),!0},i.prototype.end=function(e){return e&&e.length&&this.write(e),this._parser.end(),!0},i.prototype.on=function(e,t){var r=this;return r._parser["on"+e]||-1===a.indexOf(e)||(r._parser["on"+e]=function(){var t=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.splice(0,0,e),r.emit.apply(r,t)}),n.prototype.on.call(r,e,t)};var s="[CDATA[",o="DOCTYPE",c="http://www.w3.org/XML/1998/namespace",l="http://www.w3.org/2000/xmlns/",u={xml:c,xmlns:l},d=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,h=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,p=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,f=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function m(e){return" "===e||"\n"===e||"\r"===e||"\t"===e}function g(e){return'"'===e||"'"===e}function b(e){return">"===e||m(e)}function y(e,t){return e.test(t)}function v(e,t){return!y(e,t)}var _,w,O,k=0;for(var E in e.STATE={BEGIN:k++,BEGIN_WHITESPACE:k++,TEXT:k++,TEXT_ENTITY:k++,OPEN_WAKA:k++,SGML_DECL:k++,SGML_DECL_QUOTED:k++,DOCTYPE:k++,DOCTYPE_QUOTED:k++,DOCTYPE_DTD:k++,DOCTYPE_DTD_QUOTED:k++,COMMENT_STARTING:k++,COMMENT:k++,COMMENT_ENDING:k++,COMMENT_ENDED:k++,CDATA:k++,CDATA_ENDING:k++,CDATA_ENDING_2:k++,PROC_INST:k++,PROC_INST_BODY:k++,PROC_INST_ENDING:k++,OPEN_TAG:k++,OPEN_TAG_SLASH:k++,ATTRIB:k++,ATTRIB_NAME:k++,ATTRIB_NAME_SAW_WHITE:k++,ATTRIB_VALUE:k++,ATTRIB_VALUE_QUOTED:k++,ATTRIB_VALUE_CLOSED:k++,ATTRIB_VALUE_UNQUOTED:k++,ATTRIB_VALUE_ENTITY_Q:k++,ATTRIB_VALUE_ENTITY_U:k++,CLOSE_TAG:k++,CLOSE_TAG_SAW_WHITE:k++,SCRIPT:k++,SCRIPT_ENDING:k++},e.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},e.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(e.ENTITIES).forEach((function(t){var r=e.ENTITIES[t],n="number"==typeof r?String.fromCharCode(r):r;e.ENTITIES[t]=n})),e.STATE)e.STATE[e.STATE[E]]=E;function S(e,t,r){e[t]&&e[t](r)}function T(e,t,r){e.textNode&&P(e),S(e,t,r)}function P(e){e.textNode=x(e.opt,e.textNode),e.textNode&&S(e,"ontext",e.textNode),e.textNode=""}function x(e,t){return e.trim&&(t=t.trim()),e.normalize&&(t=t.replace(/\s+/g," ")),t}function j(e,t){return P(e),e.trackPosition&&(t+="\nLine: "+e.line+"\nColumn: "+e.column+"\nChar: "+e.c),t=new Error(t),e.error=t,S(e,"onerror",t),e}function C(e){return e.sawRoot&&!e.closedRoot&&I(e,"Unclosed root tag"),e.state!==k.BEGIN&&e.state!==k.BEGIN_WHITESPACE&&e.state!==k.TEXT&&j(e,"Unexpected end"),P(e),e.c="",e.closed=!0,S(e,"onend"),r.call(e,e.strict,e.opt),e}function I(e,t){if("object"!=typeof e||!(e instanceof r))throw new Error("bad call to strictFail");e.strict&&j(e,t)}function A(e){e.strict||(e.tagName=e.tagName[e.looseCase]());var t=e.tags[e.tags.length-1]||e,r=e.tag={name:e.tagName,attributes:{}};e.opt.xmlns&&(r.ns=t.ns),e.attribList.length=0,T(e,"onopentagstart",r)}function R(e,t){var r=e.indexOf(":")<0?["",e]:e.split(":"),n=r[0],a=r[1];return t&&"xmlns"===e&&(n="xmlns",a=""),{prefix:n,local:a}}function N(e){if(e.strict||(e.attribName=e.attribName[e.looseCase]()),-1!==e.attribList.indexOf(e.attribName)||e.tag.attributes.hasOwnProperty(e.attribName))e.attribName=e.attribValue="";else{if(e.opt.xmlns){var t=R(e.attribName,!0),r=t.prefix,n=t.local;if("xmlns"===r)if("xml"===n&&e.attribValue!==c)I(e,"xml: prefix must be bound to "+c+"\nActual: "+e.attribValue);else if("xmlns"===n&&e.attribValue!==l)I(e,"xmlns: prefix must be bound to "+l+"\nActual: "+e.attribValue);else{var a=e.tag,i=e.tags[e.tags.length-1]||e;a.ns===i.ns&&(a.ns=Object.create(i.ns)),a.ns[n]=e.attribValue}e.attribList.push([e.attribName,e.attribValue])}else e.tag.attributes[e.attribName]=e.attribValue,T(e,"onattribute",{name:e.attribName,value:e.attribValue});e.attribName=e.attribValue=""}}function $(e,t){if(e.opt.xmlns){var r=e.tag,n=R(e.tagName);r.prefix=n.prefix,r.local=n.local,r.uri=r.ns[n.prefix]||"",r.prefix&&!r.uri&&(I(e,"Unbound namespace prefix: "+JSON.stringify(e.tagName)),r.uri=n.prefix);var a=e.tags[e.tags.length-1]||e;r.ns&&a.ns!==r.ns&&Object.keys(r.ns).forEach((function(t){T(e,"onopennamespace",{prefix:t,uri:r.ns[t]})}));for(var i=0,s=e.attribList.length;i<s;i++){var o=e.attribList[i],c=o[0],l=o[1],u=R(c,!0),d=u.prefix,h=u.local,p=""===d?"":r.ns[d]||"",f={name:c,value:l,prefix:d,local:h,uri:p};d&&"xmlns"!==d&&!p&&(I(e,"Unbound namespace prefix: "+JSON.stringify(d)),f.uri=d),e.tag.attributes[c]=f,T(e,"onattribute",f)}e.attribList.length=0}e.tag.isSelfClosing=!!t,e.sawRoot=!0,e.tags.push(e.tag),T(e,"onopentag",e.tag),t||(e.noscript||"script"!==e.tagName.toLowerCase()?e.state=k.TEXT:e.state=k.SCRIPT,e.tag=null,e.tagName=""),e.attribName=e.attribValue="",e.attribList.length=0}function L(e){if(!e.tagName)return I(e,"Weird empty close tag."),e.textNode+="</>",void(e.state=k.TEXT);if(e.script){if("script"!==e.tagName)return e.script+="</"+e.tagName+">",e.tagName="",void(e.state=k.SCRIPT);T(e,"onscript",e.script),e.script=""}var t=e.tags.length,r=e.tagName;e.strict||(r=r[e.looseCase]());for(var n=r;t--&&e.tags[t].name!==n;)I(e,"Unexpected close tag");if(t<0)return I(e,"Unmatched closing tag: "+e.tagName),e.textNode+="</"+e.tagName+">",void(e.state=k.TEXT);e.tagName=r;for(var a=e.tags.length;a-- >t;){var i=e.tag=e.tags.pop();e.tagName=e.tag.name,T(e,"onclosetag",e.tagName);var s={};for(var o in i.ns)s[o]=i.ns[o];var c=e.tags[e.tags.length-1]||e;e.opt.xmlns&&i.ns!==c.ns&&Object.keys(i.ns).forEach((function(t){var r=i.ns[t];T(e,"onclosenamespace",{prefix:t,uri:r})}))}0===t&&(e.closedRoot=!0),e.tagName=e.attribValue=e.attribName="",e.attribList.length=0,e.state=k.TEXT}function M(e){var t,r=e.entity,n=r.toLowerCase(),a="";return e.ENTITIES[r]?e.ENTITIES[r]:e.ENTITIES[n]?e.ENTITIES[n]:("#"===(r=n).charAt(0)&&("x"===r.charAt(1)?(r=r.slice(2),a=(t=parseInt(r,16)).toString(16)):(r=r.slice(1),a=(t=parseInt(r,10)).toString(10))),r=r.replace(/^0+/,""),isNaN(t)||a.toLowerCase()!==r?(I(e,"Invalid character entity"),"&"+e.entity+";"):String.fromCodePoint(t))}function D(e,t){"<"===t?(e.state=k.OPEN_WAKA,e.startTagPosition=e.position):m(t)||(I(e,"Non-whitespace before first tag."),e.textNode=t,e.state=k.TEXT)}function F(e,t){var r="";return t<e.length&&(r=e.charAt(t)),r}return k=e.STATE,String.fromCodePoint||(_=String.fromCharCode,w=Math.floor,O=function(){var e,t,r=[],n=-1,a=arguments.length;if(!a)return"";for(var i="";++n<a;){var s=Number(arguments[n]);if(!isFinite(s)||s<0||s>1114111||w(s)!==s)throw RangeError("Invalid code point: "+s);s<=65535?r.push(s):(e=55296+((s-=65536)>>10),t=s%1024+56320,r.push(e,t)),(n+1===a||r.length>16384)&&(i+=_.apply(null,r),r.length=0)}return i},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:O,configurable:!0,writable:!0}):String.fromCodePoint=O),e},Nr=Rr(),$r='The output should be formatted as a XML file.\n1. Output should conform to the tags below. \n2. If tags are not given, make them on your own.\n3. Remember to always open and close all the tags.\n\nAs an example, for the tags ["foo", "bar", "baz"]:\n1. String "<foo>\n   <bar>\n      <baz></baz>\n   </bar>\n</foo>" is a well-formatted instance of the schema. \n2. String "<foo>\n   <bar>\n   </foo>" is a badly-formatted instance.\n3. String "<foo>\n   <tag>\n   </tag>\n</foo>" is a badly-formatted instance.\n\nHere are the output tags:\n```\n{tags}\n```';class Lr extends br{constructor(e){super(e),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}_diff(e,t){if(t)return e?(0,jr.UD)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Fr(e[0].text)}async parse(e){return Fr(e)}getFormatInstructions(){return this.tags&&this.tags.length>0?$r.replace("{tags}",this.tags?.join(", ")??""):$r}}const Mr=e=>e.split("\n").map((e=>e.replace(/^\s+/,""))).join("\n").trim(),Dr=e=>{if(0===Object.keys(e).length)return{};const t={};return e.children.length>0?(t[e.name]=e.children.map(Dr),t):(t[e.name]=e.text??void 0,t)};function Fr(e){const t=Mr(e),r=Nr.parser(!0);let n={};const a=[];r.onopentag=e=>{const t={name:e.name,attributes:e.attributes,children:[],text:"",isSelfClosing:e.isSelfClosing};a.length>0?a[a.length-1].children.push(t):n=t,e.isSelfClosing||a.push(t)},r.onclosetag=()=>{if(a.length>0){const e=a.pop();0===a.length&&e&&(n=e)}},r.ontext=e=>{a.length>0&&(a[a.length-1].text+=e)},r.onattribute=e=>{a.length>0&&(a[a.length-1].attributes[e.name]=e.value)};const i=/```(xml)?(.*)```/s.exec(t),s=i?i[2]:t;return r.write(s).close(),n&&"?xml"===n.name&&(n=n.children[0]),Dr(n)}var Ur=r(6993),Br=r(3766),zr=r(2771);class Vr extends Ur.m{static lc_name(){return"PipelinePromptTemplate"}constructor(e){super({...e,inputVariables:[]}),Object.defineProperty(this,"pipelinePrompts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"finalPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){const e=this.pipelinePrompts.map((e=>e.name)),t=this.pipelinePrompts.map((t=>t.prompt.inputVariables.filter((t=>!e.includes(t))))).flat();return[...new Set(t)]}static extractRequiredInputValues(e,t){return t.reduce(((t,r)=>(t[r]=e[r],t)),{})}async formatPipelinePrompts(e){const t=await this.mergePartialAndUserVariables(e);for(const{name:e,prompt:r}of this.pipelinePrompts){const n=Vr.extractRequiredInputValues(t,r.inputVariables);r instanceof Br.RZ?t[e]=await r.formatMessages(n):t[e]=await r.format(n)}return Vr.extractRequiredInputValues(t,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(e){const t={...this};return t.inputVariables=this.inputVariables.filter((t=>!(t in e))),t.partialVariables={...this.partialVariables??{},...e},new Vr(t)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}}var qr=r(3650),Zr=r(329),Gr=r(9849),Hr=r(6279);function Wr(e){return"object"==typeof e&&null!=e&&"withStructuredOutput"in e&&"function"==typeof e.withStructuredOutput}class Yr extends Br.RZ{get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","structured"]}),this.schema=e.schema}pipe(e){if(Wr(e))return super.pipe(e.withStructuredOutput(this.schema));if("object"==typeof(t=e)&&null!=t&&"lc_id"in t&&Array.isArray(t.lc_id)&&"langchain_core/runnables/RunnableBinding"===t.lc_id.join("/")&&Wr(e.bound))return super.pipe(e.bound.withStructuredOutput(this.schema).bind(e.kwargs??{}).withConfig(e.config));var t;throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(e,t){return Yr.fromMessages(e,{schema:t})}}class Jr extends Ie.YN{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,(0,ft.ZI)(t))}async getRelevantDocuments(e,t){const r=(0,ft.ZI)((0,Ee.parseCallbackConfigArg)(t)),n=await Ee.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a=await(n?.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName));try{const t=await this._getRelevantDocuments(e,a);return await(a?.handleRetrieverEnd(t)),t}catch(e){throw await(a?.handleRetrieverError(e)),e}}}class Kr extends ce.Serializable{}class Xr extends Kr{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","storage"]}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:{}})}async mget(e){return e.map((e=>this.store[e]))}async mset(e){for(const[t,r]of e)this.store[t]=r}async mdelete(e){for(const t of e)delete this.store[t]}async*yieldKeys(e){const t=Object.keys(this.store);for(const r of t)(void 0===e||r.startsWith(e))&&(yield r)}}var Qr=r(8009),en=r(8521),tn=r(199);class rn extends ot{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let r,n;(0,tn.K)(e)?(r=e.id,n=e.args):n=e;const a=(0,ft.ZI)(t);return this.call(n,{...a,configurable:{...a.configurable,tool_call_id:r}})}async call(e,t,r){let n;try{n=await this.schema.parseAsync(e)}catch(t){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}\nDetails: ${t.message}`),new tn.q(r,JSON.stringify(e))}const a=(0,Ee.parseCallbackConfigArg)(t),i=await Ee.CallbackManager.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),s=await(i?.handleToolStart(this.toJSON(),"string"==typeof n?n:JSON.stringify(n),a.runId,void 0,void 0,void 0,a.runName));let o,c,l,u;delete a.runId;try{o=await this._call(n,s,a)}catch(e){throw await(s?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(o)||2!==o.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(o)}`);[c,l]=o}else c=o;a&&"configurable"in a&&(u=a.configurable.tool_call_id);const d=function(e){const{content:t,artifact:r,toolCallId:n}=e;return n?"string"==typeof t||Array.isArray(t)&&t.every((e=>"object"==typeof e))?new Qr.uf({content:t,artifact:r,tool_call_id:n,name:e.name}):new Qr.uf({content:ln(t),artifact:r,tool_call_id:n,name:e.name}):t}({content:c,artifact:l,toolCallId:u,name:this.name});return await(s?.handleToolEnd(d)),d}}class nn extends rn{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Sr.z.object({input:Sr.z.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}class an extends nn{static lc_name(){return"DynamicTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}async call(e,t){const r=(0,Ee.parseCallbackConfigArg)(t);return void 0===r.runName&&(r.runName=this.name),super.call(e,r)}async _call(e,t,r){return this.func(e,t,r)}}class sn extends rn{static lc_name(){return"DynamicStructuredTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=gt(e.schema)?e.schema:Sr.z.object({}).passthrough()}async call(e,t,r){const n=(0,Ee.parseCallbackConfigArg)(t);return void 0===n.runName&&(n.runName=this.name),super.call(e,n,r)}_call(e,t,r){return this.func(e,t,r)}}class on{getTools(){return this.tools}}function cn(e,t){if(!t.schema||gt(t.schema)&&(!("shape"in t.schema)||!t.schema.shape))return new an({...t,description:t.description??t.schema?.description??`${t.name} tool`,func:async(t,r,n)=>new Promise(((a,i)=>{const s=(0,ft.tn)(n,{callbacks:r?.getChild()});en.Nx.runWithConfig(s,(async()=>{try{a(e(t,s))}catch(e){i(e)}}))}))});const r=t.description??t.schema.description??`${t.name} tool`;return new sn({...t,description:r,schema:t.schema,func:async(t,r,n)=>new Promise(((a,i)=>{const s=(0,ft.tn)(n,{callbacks:r?.getChild()});en.Nx.runWithConfig(s,(async()=>{try{a(e(t,s))}catch(e){i(e)}}))}))})}function ln(e){try{return JSON.stringify(e,null,2)}catch(t){return`${e}`}}var un=r(1590),dn=r(6906),hn=r(1201),pn=r(9583);class fn extends un.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(0,pn.getEnvironmentVariable)("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const e=(0,pn.getEnvironmentVariable)("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){const t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){const t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){const e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){const t=this.session??await this.loadDefaultSession(),r=e.serialized;let n;if("llm"===e.run_type){const a=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map((e=>(0,ge.Sw)(e)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:a,response:e.outputs}}else if("chain"===e.run_type){const a=await Promise.all(e.child_runs.map((e=>this.convertV2RunToRun(e))));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:a.filter((e=>"llm"===e.type)),child_chain_runs:a.filter((e=>"chain"===e.type)),child_tool_runs:a.filter((e=>"tool"===e.type))}}else{if("tool"!==e.run_type)throw new Error(`Unknown run type: ${e.run_type}`);{const a=await Promise.all(e.child_runs.map((e=>this.convertV2RunToRun(e))));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:a.filter((e=>"llm"===e.type)),child_chain_runs:a.filter((e=>"chain"===e.type)),child_tool_runs:a.filter((e=>"tool"===e.type))}}}return n}async persistRun(e){let t,r;r=void 0!==e.run_type?await this.convertV2RunToRun(e):e,t="llm"===r.type?`${this.endpoint}/llm-runs`:"chain"===r.type?`${this.endpoint}/chain-runs`:`${this.endpoint}/tool-runs`;const n=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){const t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){const t=await fetch(e,{method:"GET",headers:this.headers});let r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;const n=await t.json();return 0===n.length?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}}async function mn(e){const t=new fn;return e?await t.loadSession(e):await t.loadDefaultSession(),t}async function gn(){return new hn.LangChainTracer}class bn extends un.BaseTracer{constructor({exampleId:e}={}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"run_collector"}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracedRuns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleId=e,this.tracedRuns=[]}async persistRun(e){const t={...e};t.reference_example_id=this.exampleId,this.tracedRuns.push(t)}}const yn=(e,t)=>e.reduce(((e,r,n)=>{const a=Math.floor(n/t),i=e[a]||[];return e[a]=i.concat([r]),e}),[]);function vn(e,t){const r="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(0,lt.Ik)(e.schema),...void 0!==r?.strict?{strict:r.strict}:{}}}function _n(e,t){const r="number"==typeof t?void 0:t;let n;return n=En(e)?{type:"function",function:vn(e)}:e,void 0!==r?.strict&&(n.function.strict=r.strict),n}function wn(e){return void 0!==e&&Array.isArray(e.lc_namespace)}function On(e){return void 0!==e&&Ie.YN.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}function kn(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&gt(e.schema)}function En(e){return kn(e)||On(e)||wn(e)}function Sn(e,t){let r=0,n=0,a=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],n+=e[i]*e[i],a+=t[i]*t[i];return r/(Math.sqrt(n)*Math.sqrt(a))}function Tn(e,t){let r=0;for(let n=0;n<e.length;n++)r+=e[n]*t[n];return r}function Pn(e,t){return Math.sqrt(function(e,t){let r=0;for(let n=0;n<e.length;n++)r+=(e[n]-t[n])*(e[n]-t[n]);return r}(e,t))}function xn(e,t,r){if(0===e.length||0===e[0].length||0===t.length||0===t[0].length)return[[]];if(e[0].length!==t[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[e.length,e[0].length]} and Y has shape ${[t.length,t[0].length]}.`);return e.map((e=>t.map((t=>r(e,t))).map((e=>Number.isNaN(e)?0:e))))}function jn(e,t=!1){const r=e.reduce(((e,t)=>Math.max(e,Nn(t).maxValue)),0);return e.map((e=>e.map((e=>t?1-e/r:e/r))))}function Cn(e,t){return xn(e,t,Sn)}function In(e,t){return xn(e,t,Tn)}function An(e,t){return xn(e,t,Pn)}function Rn(e,t,r=.5,n=4){if(Math.min(n,t.length)<=0)return[];const a=Cn(Array.isArray(e[0])?e:[e],t)[0],i=Nn(a).maxIndex,s=[t[i]],o=[i];for(;o.length<Math.min(n,t.length);){let e=-1/0,n=-1;const i=Cn(t,s);a.forEach(((t,a)=>{if(o.includes(a))return;const s=Math.max(...i[a]),c=r*t-(1-r)*s;c>e&&(e=c,n=a)})),s.push(t[n]),o.push(n)}return o}function Nn(e){if(0===e.length)return{maxIndex:-1,maxValue:NaN};let t=e[0],r=0;for(let n=1;n<e.length;n+=1)e[n]>t&&(r=n,t=e[n]);return{maxIndex:r,maxValue:t}}class $n extends Jr{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,"mmr"===e.searchType&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if("mmr"===this.searchType){if("function"!=typeof this.vectorStore.maxMarginalRelevanceSearch)throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class Ln extends ce.Serializable{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,n=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map((e=>e[0]))}async similaritySearchWithScore(e,t=4,r=void 0,n=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,n){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,n,a,i){if("number"==typeof e)return new $n({vectorStore:this,k:e,filter:t,tags:[...n??[],this._vectorstoreType()],metadata:a,verbose:i,callbacks:r});{const t={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return new $n("mmr"===e?.searchType?{...t,searchKwargs:e.searchKwargs}:{...t})}}}class Mn extends Ln{static load(e,t){throw new Error("Not implemented")}}class Dn extends Rt{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]})}getFormatInstructions(){return""}async parse(e){return e.split(",").map((e=>e.trim()))}}class Fn extends Ie.YN{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]}),Object.defineProperty(this,"returnOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.returnOptions=e.returnOptions}async invoke(e,t){return this.returnOptions?t??{}:{input:e}}}class Un extends Ot{constructor(e){super(e),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,t,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=this.response??e;return await(r?.handleLLMNewToken(n)),n}}class Bn extends Ot{constructor(e){super(e),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const t=this.responses?.[0];return this.responses=this.responses?.slice(1),t??e}async*_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=this.responses?.[0];this.responses=this.responses?.slice(1);for(const t of n??e)await new Promise((e=>setTimeout(e,this.sleep))),yield{text:t,generationInfo:{}},await(r?.handleLLMNewToken(t))}}class zn extends vt{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(e,t,r){if(t?.stop?.length)return{generations:[{message:new Te.AIMessage(t.stop[0]),text:t.stop[0]}]};const n=e.map((e=>"string"==typeof e.content?e.content:JSON.stringify(e.content,null,2))).join("\n");return await(r?.handleLLMNewToken(n)),{generations:[{message:new Te.AIMessage(n),text:n}],llmOutput:{}}}}class Vn extends vt{constructor(e){super(e),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _generate(e,t,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=this.responses?.[0].content??e[0].content;return{generations:[{text:"",message:new Te.AIMessage({content:n})}]}}async*_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw new Error(this.thrownErrorString);const n=this.responses?.[0].content??e[0].content;if("string"!=typeof n)for(const t of this.responses??e)yield new ut.ChatGenerationChunk({text:"",message:new Te.AIMessageChunk({content:n})});else for(const t of this.responses??e)yield new ut.ChatGenerationChunk({text:n,message:new Te.AIMessageChunk({content:n})})}}class qn extends Jr{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["test","fake"]}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:[new Ce({pageContent:"foo"}),new Ce({pageContent:"bar"})]}),this.output=e?.output??this.output}async _getRelevantDocuments(e){return this.output}}class Zn extends vt{static lc_name(){return"FakeListChatModel"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"i",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emitCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1});const{responses:t,sleep:r,emitCustomEvent:n}=e;this.responses=t,this.sleep=r,this.emitCustomEvent=n??this.emitCustomEvent}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,t,r){if(await this._sleepIfRequested(),t?.thrownErrorString)throw new Error(t.thrownErrorString);if(this.emitCustomEvent&&await(r?.handleCustomEvent("some_test_event",{someval:!0})),t?.stop?.length)return{generations:[this._formatGeneration(t.stop[0])]};{const e=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(e)],llmOutput:{}}}}_formatGeneration(e){return{message:new Te.AIMessage(e),text:e}}async*_streamResponseChunks(e,t,r){const n=this._currentResponse();this._incrementResponse(),this.emitCustomEvent&&await(r?.handleCustomEvent("some_test_event",{someval:!0}));for await(const e of n){if(await this._sleepIfRequested(),t?.thrownErrorString)throw new Error(t.thrownErrorString);const n=this._createResponseChunk(e);yield n,r?.handleLLMNewToken(e)}}async _sleepIfRequested(){void 0!==this.sleep&&await this._sleep()}async _sleep(){return new Promise((e=>{setTimeout((()=>e()),this.sleep)}))}_createResponseChunk(e){return new ut.ChatGenerationChunk({message:new Te.AIMessageChunk({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,t){return Ie.jY.from((async e=>{const t=await this.invoke(e);return JSON.parse(t.content)}))}}class Gn extends Pe{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new Te.HumanMessage(e))}async addAIChatMessage(e){this.messages.push(new Te.AIMessage(e))}async clear(){this.messages=[]}}class Hn extends xe{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}}class Wn extends un.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"fake_tracer"}),Object.defineProperty(this,"runs",{enumerable:!0,configurable:!0,writable:!0,value:[]})}persistRun(e){return this.runs.push(e),Promise.resolve()}}class Yn extends rn{constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,t){return JSON.stringify(e)}}class Jn extends $e{constructor(e){super(e??{})}embedDocuments(e){return Promise.resolve(e.map((()=>[.1,.2,.3,.4])))}embedQuery(e){return Promise.resolve([.1,.2,.3,.4])}}class Kn extends $e{constructor(e){super(e??{}),Object.defineProperty(this,"vectorSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorSize=e?.vectorSize??4}async embedDocuments(e){return Promise.all(e.map((e=>this.embedQuery(e))))}async embedQuery(e){let t=e;t=t.toLowerCase().replaceAll(/[^a-z ]/g,"");const r=t.length%this.vectorSize,n=0===r?0:this.vectorSize-r,a=t.length+n;t=t.padEnd(a," ");const i=t.length/this.vectorSize,s=[];for(let e=0;e<t.length;e+=i)s.push(t.slice(e,e+i));return s.map((e=>{let t=0;for(let r=0;r<e.length;r+=1)t+=" "===e?0:e.charCodeAt(r);return t%26/26}))}}class Xn extends un.BaseTracer{constructor(){super(),Object.defineProperty(this,"runPromiseResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"single_run_extractor"}),this.runPromise=new Promise((e=>{this.runPromiseResolver=e}))}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}}class Qn extends Ln{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??Sn}async addDocuments(e){const t=e.map((({pageContent:e})=>e));return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){const r=e.map(((e,r)=>({content:t[r].pageContent,embedding:e,metadata:t[r].metadata})));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(e,t,r){const n=this.memoryVectors.filter((e=>{if(!r)return!0;const t=new Ce({metadata:e.metadata,pageContent:e.content});return r(t)}));return n.map(((t,r)=>({similarity:this.similarity(e,t.embedding),index:r}))).sort(((e,t)=>e.similarity>t.similarity?-1:0)).slice(0,t).map((e=>[new Ce({metadata:n[e.index].metadata,pageContent:n[e.index].content}),e.similarity]))}static async fromTexts(e,t,r,n){const a=[];for(let r=0;r<e.length;r+=1){const n=Array.isArray(t)?t[r]:t,i=new Ce({pageContent:e[r],metadata:n});a.push(i)}return Qn.fromDocuments(a,r,n)}static async fromDocuments(e,t,r){const n=new this(t,r);return await n.addDocuments(e),n}static async fromExistingIndex(e,t){return new this(e,t)}}function ea(e){if("object"!=typeof e||null===e)return e;const t=Array.isArray(e)?[]:{};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=ea(e[r]));return t}function ta(){return{v:1,id:se(-2),ts:(new Date).toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function ra(e){return{v:e.v,id:e.id,ts:e.ts,channel_values:{...e.channel_values},channel_versions:{...e.channel_versions},versions_seen:ea(e.versions_seen),pending_sends:[...e.pending_sends]}}function na(e,t){return"number"==typeof e&&"number"==typeof t?Math.sign(e-t):String(e).localeCompare(String(t))}function aa(...e){return e.reduce(((e,t,r)=>0===r?t:na(e,t)>=0?e:t))}r(7492);class ia extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}}class sa{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t){const r={limit:10,offset:0,...t||{}};return(await this.batch([{namespacePrefix:e,...r}]))[0]}async put(e,t,r){!function(e){if(0===e.length)throw new ia("Namespace cannot be empty.");for(const t of e){if("string"!=typeof t)throw new ia(`Invalid namespace label '${t}' found in ${e}. Namespace labels must be strings, but got ${typeof t}.`);if(t.includes("."))throw new ia(`Invalid namespace label '${t}' found in ${e}. Namespace labels cannot contain periods ('.').`);if(""===t)throw new ia(`Namespace labels cannot be empty strings. Got ${t} in ${e}`)}if("langgraph"===e[0])throw new ia(`Root label for namespace cannot be "langgraph". Got: ${e}`)}(e),await this.batch([{namespace:e,key:t,value:r}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e){const{prefix:t,suffix:r,maxDepth:n,limit:a=100,offset:i=0}=e,s=[];t&&s.push({matchType:"prefix",path:t}),r&&s.push({matchType:"suffix",path:r});const o={matchConditions:s.length>0?s:void 0,maxDepth:n,limit:a,offset:i};return(await this.batch([o]))[0]}stop(){}start(){}}class oa extends sa{constructor(e){super(),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=e}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){const{filter:r,limit:n=10,offset:a=0}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:r,limit:n,offset:a})}async put(e,t,r){return this.enqueueOperation({namespace:e,key:t,value:r})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise(((t,r)=>{const n=this.nextKey;this.nextKey+=1,this.queue.set(n,{operation:e,resolve:t,reject:r})}))}async processBatchQueue(){for(;this.running;){if(await new Promise((e=>{setTimeout(e,0)})),0===this.queue.size)continue;const e=new Map(this.queue);this.queue.clear();try{const t=Array.from(e.values()).map((({operation:e})=>e)),r=await this.store.batch(t);e.forEach((({resolve:t},n)=>{const a=Array.from(e.keys()).indexOf(n);t(r[a])}))}catch(t){e.forEach((({reject:e})=>{e(t)}))}}}}function ca(e){return null!=e&&!0===e.lg_is_channel}class la{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}}function ua(e,t){const r=Object.fromEntries(Object.entries(e).filter((([,e])=>ca(e)))),n={};for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e)){const a=t.channel_values[e];n[e]=r[e].fromCheckpoint(a)}return n}function da(e,t,r){let n;if(void 0===t)n=e.channel_values;else{n={};for(const e of Object.keys(t))try{n[e]=t[e].checkpoint()}catch(e){if(e.name!==z.unminifiable_name)throw e}}return{v:1,id:se(r),ts:(new Date).toISOString(),channel_values:n,channel_versions:{...e.channel_versions},versions_seen:ea(e.versions_seen),pending_sends:e.pending_sends??[]}}class ha extends la{constructor(e,t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=e,this.initialValueFactory=t,this.value=t?.()}fromCheckpoint(e){const t=new ha(this.operator,this.initialValueFactory);return e&&(t.value=e),t}update(e){let t=e;if(!t.length)return!1;void 0===this.value&&([this.value]=t,t=t.slice(1));for(const e of t)void 0!==this.value&&(this.value=this.operator(this.value,e));return!0}get(){if(void 0===this.value)throw new z;return this.value}checkpoint(){if(void 0===this.value)throw new z;return this.value}}class pa extends la{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}fromCheckpoint(e){const t=new pa;return e&&(t.value=e),t}update(e){if(0===e.length)return!1;if(1!==e.length)throw new V("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=e[e.length-1],!0}get(){if(void 0===this.value)throw new z;return this.value}checkpoint(){if(void 0===this.value)throw new z;return this.value}}const fa="__input__",ma="__error__",ga="__pregel_send",ba="__pregel_read",ya="__pregel_checkpointer",va="__pregel_resuming",_a="__pregel_task_id",wa="__pregel_stream",Oa="checkpoint_map",ka="__interrupt__",Ea="__pregel_runtime_placeholder__",Sa="langsmith:hidden",Ta="__pregel_tasks",Pa="__pregel_push",xa="__pregel_pull",ja=[ka,ma,Ta,ga,ba,ya,va,_a,wa,Oa,fa],Ca="|",Ia=":";function Aa(e){return"Send"===e.lg_name}class Ra{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw new Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}}class Na extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every((e=>!e.runtime)))if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(const r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{const n=t[r];for(const[a,i]of this.entries())i.runtime&&i.call(e)===n&&(t[r]={[Ea]:a})}catch(e){if(e.name!==TypeError.name)throw e}}else for(const[r,n]of Object.entries(t))for(const[a,i]of this.entries())i.runtime&&i.call(e)===n&&(t[r]={[Ea]:a})}replaceRuntimePlaceholders(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every((e=>!e.runtime)))if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(const r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{const n=t[r];if("object"==typeof n&&null!==n&&Ea in n){const a=this.get(n[Ea]);a&&(t[r]=a.call(e))}}catch(e){if(e.name!==TypeError.name)throw e}}else for(const[r,n]of Object.entries(t))if("object"==typeof n&&null!==n&&Ea in n){const a=n[Ea];"string"==typeof a&&(t[r]=this.get(a)?.call(e))}}}function $a(e){return!!("object"==typeof e&&e&&"cls"in e&&"params"in e)}class La extends Ra{call(){}static async initialize(e,t){return Promise.resolve(new La(e))}}class Ma{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}}const Da=function(e){return $a(e)?e:e?Fa(e):new pa};function Fa(e){return"object"==typeof e&&e&&"reducer"in e&&e.reducer?new ha(e.reducer,e.default):"object"==typeof e&&e&&"value"in e&&e.value?new ha(e.value,e.default):new pa}Da.Root=e=>new Ma(e);var Ua=r(9475);const Ba=["tags","metadata","callbacks","configurable"],za=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer"];function Va(...e){const t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,configurable:{}},r=en.Nx.getRunnableConfig();if(void 0!==r)for(const[e,n]of Object.entries(r))if(void 0!==n)if(Ba.includes(e)){let r;r=Array.isArray(n)?[...n]:"object"==typeof n?"callbacks"===e&&"copy"in n&&"function"==typeof n.copy?n.copy():{...n}:n,t[e]=r}else t[e]=n;for(const r of e)if(void 0!==r)for(const[e,n]of Object.entries(r))void 0!==n&&za.includes(e)&&(t[e]=n);for(const[e,r]of Object.entries(t.configurable))t.metadata=t.metadata??{},e.startsWith("__")||"string"!=typeof r&&"number"!=typeof r&&"boolean"!=typeof r||e in t.metadata||(t.metadata[e]=r);return t}class qa extends Ie.YN{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,r){return new Promise(((n,a)=>{const i=(0,ft.tn)(t,{callbacks:r?.getChild()});en.Nx.runWithConfig(i,(async()=>{try{const t=await this.func(e,i);n(t)}catch(e){a(e)}}))}))}async invoke(e,t){let r;const n=Va(t),a=(0,ft.SV)(this.config,n);return r=this.trace?await this._callWithConfig(this._tracedInvoke,e,a):await en.Nx.runWithConfig(a,(async()=>this.func(e,a))),Ie.YN.isRunnable(r)&&this.recurse?await en.Nx.runWithConfig(a,(async()=>r.invoke(e,a))):r}}function*Za(e,t){if(void 0===t)yield*e;else for(const r of e)yield[t,r]}async function Ga(e){const t=[];for await(const r of await e)t.push(r);return t}function Ha(e){const t=[];for(const r of e)t.push(r);return t}function Wa(e,t){return e?"configurable"in e?{...e,configurable:{...e.configurable,...t}}:{...e,configurable:t}:{configurable:t}}const Ya={[Symbol.for("LG_SKIP_WRITE")]:!0},Ja={[Symbol.for("LG_PASSTHROUGH")]:!0},Ka=Symbol("IS_WRITER");class Xa extends qa{constructor(e,t){const r=`ChannelWrite<${e.map((e=>Aa(e)?e.node:e.channel)).join(",")}>`;super({writes:e,name:r,tags:t,func:async(e,t)=>this._write(e,t??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=e}async _getWriteValues(e,t){const r=this.writes.filter(Aa).map((e=>[Ta,e])),n=this.writes.filter((e=>!Aa(e)));if(n.find((e=>e.channel===Ta)))throw new V(`Cannot write to the reserved channel ${Ta}`);const a=await Promise.all(n.map((async r=>{let n;var a;n="object"==typeof(a=r.value)&&void 0!==a?.[Symbol.for("LG_PASSTHROUGH")]?e:r.value;const i=r.mapper?await r.mapper.invoke(n,t):n;return{...r,value:i}}))).then((e=>e.filter((e=>!e.skipNone||null!==e.value)).map((e=>[e.channel,e.value]))));return[...r,...a]}async _write(e,t){const r=await this._getWriteValues(e,t);return Xa.doWrite(t,r),e}static doWrite(e,t){const r=e.configurable?.[ga];r(t.filter((([e,t])=>{return!("object"==typeof(r=t)&&void 0!==r?.[Symbol.for("LG_SKIP_WRITE")]);var r})))}static isWriter(e){return e instanceof Xa||Ka in e&&!!e[Ka]}static registerWriter(e){return Object.defineProperty(e,Ka,{value:!0})}}class Qa extends qa{constructor(e,t,r=!1){super({func:(e,t)=>Qa.doRead(t,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=r,this.mapper=t,this.channel=e,this.name=Array.isArray(e)?`ChannelRead<${e.join(",")}>`:`ChannelRead<${e}>`}static doRead(e,t,r,n){const a=e.configurable?.[ba];if(!a)throw new Error(`Runnable ${this} is not configured with a read function. Make sure to call in the context of a Pregel process`);return n?n(a(t,r)):a(t,r)}}const ei=new mt;class ti extends Ie.fJ{constructor(e){const{channels:t,triggers:r,mapper:n,writers:a,bound:i,kwargs:s,metadata:o,retryPolicy:c,tags:l,subgraphs:u}=e,d=[...e.config?.tags?e.config.tags:[],...l??[]];super({...e,bound:e.bound??ei,config:{...e.config?e.config:{},tags:d}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:ei}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=t,this.triggers=r,this.mapper=n,this.writers=a??this.writers,this.bound=i??this.bound,this.kwargs=s??this.kwargs,this.metadata=o??this.metadata,this.tags=d,this.retryPolicy=c,this.subgraphs=u}getWriters(){const e=[...this.writers];for(;e.length>1&&e[e.length-1]instanceof Xa&&e[e.length-2]instanceof Xa;){const t=e.slice(-2),r=t[0].writes.concat(t[1].writes);e[e.length-2]=new Xa(r,t[0].config?.tags),e.pop()}return e}getNode(){const e=this.getWriters();return this.bound===ei&&0===e.length?void 0:this.bound===ei&&1===e.length?e[0]:this.bound===ei?new Ie.zZ({first:e[0],middle:e.slice(1,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):e.length>0?new Ie.zZ({first:this.bound,middle:e.slice(0,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):this.bound}join(e){if(!Array.isArray(e))throw new Error("channels must be a list");if("object"!=typeof this.channels)throw new Error("all channels must be named when using .join()");return new ti({channels:{...this.channels,...Object.fromEntries(e.map((e=>[e,e])))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(e){return Xa.isWriter(e)?new ti({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,e],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):this.bound===ei?new ti({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:(0,Ie.Bp)(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):new ti({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}}class ri extends Error{constructor(e){super(e),this.name="GraphValidationError"}}function ni(e,t){if(Array.isArray(e)){for(const r of e)if(!(r in t))throw new Error(`Key ${String(r)} not found in channels`)}else if(!(e in t))throw new Error(`Key ${String(e)} not found in channels`)}function ai(e,t,r=!0,n=!1){try{return e[t].get()}catch(e){if(e.name===z.unminifiable_name){if(n)return e;if(r)return null}throw e}}function ii(e,t,r=!0){if(Array.isArray(t)){const n={};for(const a of t)try{n[a]=ai(e,a,!r)}catch(e){if(e.name===z.unminifiable_name)continue}return n}return ai(e,t)}function*si(e,t,r){Array.isArray(e)?(!0===t||t.find((([t,r])=>e.includes(t))))&&(yield ii(r,e)):(!0===t||t.some((([t,r])=>t===e)))&&(yield ai(r,e))}function*oi(e,t,r){const n=t.filter((([e])=>void 0===e.config||!e.config.tags?.includes(Sa)));if(!n.length)return;let a;a=Array.isArray(e)?n.filter((([t])=>t.writes.some((([t])=>e.includes(t))))).map((([t])=>[t.name,Object.fromEntries(t.writes.filter((([t])=>e.includes(t))))])):n.flatMap((([t])=>t.writes.filter((([t,r])=>t===e)).map((([e,r])=>[t.name,r]))));const i=Object.fromEntries(n.map((([e])=>[e.name,[]])));for(const[e,t]of a)i[e].push(t);for(const[e,t]of Object.entries(i))0===t.length?delete i[e]:1===t.length&&(i[e]=t[0]);r&&(i.__metadata__={cached:r}),yield i}function ci(e){return"lg_is_pregel"in e&&!0===e.lg_is_pregel}function li(e){const t=[e];for(const e of t){if(ci(e))return e;"steps"in(r=e)&&Array.isArray(r.steps)&&t.push(...e.steps)}var r}const ui={start:"[34m",end:"[0m"},di={start:"[32m",end:"[0m"},hi={start:"[33;1m",end:"[0m"},pi=(e,t)=>`${e.start}${t}${e.end}`;function fi(e,t,r){return e.map((e=>{const n=t.find((([t,r])=>t===e.id&&r===ma))?.[2],a=t.filter((([t,r])=>t===e.id&&r===ka)).map((([,,e])=>e));return n?{id:e.id,name:e.name,path:e.path,error:n,interrupts:a}:{id:e.id,name:e.name,path:e.path,interrupts:a,state:r?.[e.id]}}))}function mi(e,t){const r=t.length;console.log([`${pi(ui,`[${e}:tasks]`)}`,`[1m Starting step ${e} with ${r} task${1===r?"":"s"}:[0m\n`,t.map((e=>`- ${pi(di,String(e.name))} -> ${JSON.stringify(e.input,null,2)}`)).join("\n")].join(""))}function gi(e,t,r){const n={};for(const[e,a]of t)r.includes(e)&&(n[e]||(n[e]=[]),n[e].push(a));console.log([`${pi(ui,`[${e}:writes]`)}`,`[1m Finished step ${e} with writes to ${Object.keys(n).length} channel${1!==Object.keys(n).length?"s":""}:[0m\n`,Object.entries(n).map((([e,t])=>`- ${pi(hi,e)} -> ${t.map((e=>JSON.stringify(e))).join(", ")}`)).join("\n")].join(""))}function bi(e){const t=Object.values(e),r=t.length>0?typeof t[0]:void 0;let n;return"number"===r?n=0:"string"===r&&(n=""),n}function yi(e,t){if(Object.keys(e).length>0){const r=bi(t);return Object.fromEntries(Object.entries(t).filter((([t,n])=>n>(e[t]??r))))}return t}function vi(e,t){return null===e?{configurable:t}:void 0===e?.configurable?{...e,configurable:t}:{...e,configurable:{...e.configurable,...t}}}function _i(e,t){const r=t?.parents??{};return Object.keys(r).length>0?vi(e,{[Oa]:{...r,[e.configurable?.checkpoint_ns??""]:e.configurable?.checkpoint_id}}):e}const wi=e=>void 0!==e?e+1:1;function Oi(e,t,r){const n=Object.values(e.channel_versions),a=n.length>0?typeof n[0]:void 0;let i;"number"===a?i=0:"string"===a&&(i="");const s=e.versions_seen[ka]??{},o=Object.entries(e.channel_versions).some((([e,t])=>t>(s[e]??i))),c=r.some((e=>"*"===t?!e.config?.tags?.includes(Sa):t.includes(e.name)));return o&&c}function ki(e,t,r,n,a,i,s=!1){let o,c=[],l=new Set;if(Array.isArray(i))c=i.filter((e=>n.get(e))),i=i.filter((e=>!n.get(e))),l=new Set(i.filter((e=>a.writes.some((([t,r])=>t===e)))));else{for(const[e]of a.writes)if(e===i){l=new Set([e]);break}l=l||new Set}if(s&&l.size>0){const e=Object.fromEntries(Object.entries(r).filter((([e,t])=>l.has(e)))),n=da(t,e,-1),s=ua(e,n);Si(ra(n),s,[a]),o=ii({...r,...s},i)}else o=ii(r,i);if(c.length>0)for(const t of c){const r=n.get(t);if(r){const n=r.call(e);o[t]=n}}return o}function Ei(e,t,r,n,a,i){for(const[t,s]of i)if(t===Ta){if(!Aa(s))throw new V(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in r))throw new V(`Invalid node name "${s.node}" in Send packet`);a.replaceRuntimeValues(e,s.args)}else t in n||a.get(t)||console.warn(`Skipping write for channel '${t}' which has no readers`);t(i)}function Si(e,t,r,n){const a=Object.fromEntries(Object.entries(t).filter((([e,t])=>ca(t))));for(const t of r){void 0===e.versions_seen[t.name]&&(e.versions_seen[t.name]={});for(const r of t.triggers)r in e.channel_versions&&(e.versions_seen[t.name][r]=e.channel_versions[r])}let i;Object.keys(e.channel_versions).length>0&&(i=aa(...Object.values(e.channel_versions)));const s=new Set(r.flatMap((e=>e.triggers)).filter((e=>!ja.includes(e))));for(const t of s)t in a&&a[t].consume()&&void 0!==n&&(e.channel_versions[t]=n(i,a[t]));e.pending_sends&&(e.pending_sends=[]);const o={},c={};for(const t of r)for(const[r,n]of t.writes)r===Ta?e.pending_sends.push({node:n.node,args:n.args}):r in a?r in o?o[r].push(n):o[r]=[n]:r in c?c[r].push(n):c[r]=[n];i=void 0,Object.keys(e.channel_versions).length>0&&(i=aa(...Object.values(e.channel_versions)));const l=new Set;for(const[t,r]of Object.entries(o))if(t in a){let s;try{s=a[t].update(r)}catch(e){if(e.name===V.unminifiable_name){const n=new V(`Invalid update for channel "${t}" with values ${JSON.stringify(r)}: ${e.message}`);throw n.lc_error_code=e.lc_error_code,n}throw e}s&&void 0!==n&&(e.channel_versions[t]=n(i,a[t])),l.add(t)}for(const t of Object.keys(a))l.has(t)||a[t].update([])&&void 0!==n&&(e.channel_versions[t]=n(i,a[t]));return c}function Ti(e,t,r,n,a,i,s){const o={};for(let c=0;c<e.pending_sends.length;c+=1){const l=Pi([Pa,c],e,t,r,n,a,i,s);void 0!==l&&(o[l.id]=l)}for(const c of Object.keys(t)){const l=Pi([xa,c],e,t,r,n,a,i,s);void 0!==l&&(o[l.id]=l)}return o}function Pi(e,t,r,n,a,i,s,o){const{step:c,checkpointer:l,manager:u}=o,d=i.configurable??{},h=d.checkpoint_ns??"";if(e[0]===Pa){const p="number"==typeof e[1]?e[1]:parseInt(e[1],10);if(p>=t.pending_sends.length)return;const f=t.pending_sends[p];if(!function(e){const t=e;return"string"==typeof t.node&&void 0!==t.args}(f))return void console.warn(`Ignoring invalid packet ${JSON.stringify(f)} in pending sends.`);if(!(f.node in r))return void console.warn(`Ignoring unknown node name ${f.node} in pending sends.`);const m=[Pa],g=""===h?f.node:`${h}${Ca}${f.node}`,b=oe(JSON.stringify([g,c.toString(),f.node,Pa,p.toString()]),t.id),y=`${g}${Ia}${b}`;let v={langgraph_step:c,langgraph_node:f.node,langgraph_triggers:m,langgraph_path:e,langgraph_checkpoint_ns:y};if(!s)return{id:b,name:f.node,interrupts:[],path:e};{const s=r[f.node],p=s.getNode();if(void 0!==p){a.replaceRuntimePlaceholders(c,f.args),void 0!==s.metadata&&(v={...v,...s.metadata});const g=[];return{name:f.node,input:f.args,proc:p,subgraphs:s.subgraphs,writes:g,config:(0,ft.tn)((0,ft.SV)(i,{metadata:v,tags:s.tags,store:o.store??i.store}),{runName:f.node,callbacks:u?.getChild(`graph:step:${c}`),configurable:{[_a]:b,[ga]:e=>Ei(c,(e=>g.push(...e)),r,n,a,e),[ba]:(e,r=!1)=>ki(c,t,n,a,{name:f.node,writes:g,triggers:m},e,r),[ya]:l??d[ya],[Oa]:{...d[Oa],[h]:t.id},checkpoint_id:void 0,checkpoint_ns:y}}),triggers:m,retry_policy:s.retryPolicy,id:b,path:e}}}}else if(e[0]===xa){const p=e[1].toString(),f=r[p];if(void 0===f)return;const m=bi(t.channel_versions);if(void 0===m)return;const g=t.versions_seen[p]??{},b=f.triggers.filter((e=>{const r=ai(n,e,!1,!0);return!(r instanceof Error&&r.name===z.unminifiable_name)&&(t.channel_versions[e]??m)>(g[e]??m)})).sort();if(b.length>0){const m=function(e,t,r,n,a){let i;if("object"!=typeof t.channels||Array.isArray(t.channels)){if(!Array.isArray(t.channels))throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);{let e=!1;for(const r of t.channels)try{i=ai(n,r,!1),e=!0;break}catch(e){if(e.name===z.unminifiable_name)continue;throw e}if(!e)return}}else{i={};for(const[a,s]of Object.entries(t.channels))if(t.triggers.includes(s))try{i[a]=ai(n,s,!1)}catch(e){if(e.name===z.unminifiable_name)return;throw e}else if(s in n)try{i[a]=ai(n,s,!0)}catch(e){if(e.name===z.unminifiable_name)continue;throw e}else i[a]=r.get(a)?.call(e)}return a&&void 0!==t.mapper&&(i=t.mapper(i)),i}(c,f,a,n,s);if(void 0===m)return;const g=""===h?p:`${h}${Ca}${p}`,y=oe(JSON.stringify([g,c.toString(),p,xa,b]),t.id);let v={langgraph_step:c,langgraph_node:p,langgraph_triggers:b,langgraph_path:e,langgraph_checkpoint_ns:`${g}${Ia}${y}`};if(!s)return{id:y,name:p,interrupts:[],path:e};{const s=f.getNode();if(void 0!==s){void 0!==f.metadata&&(v={...v,...f.metadata});const _=[],w=`${g}${Ia}${y}`;return{name:p,input:m,proc:s,subgraphs:f.subgraphs,writes:_,config:(0,ft.tn)((0,ft.SV)(i,{metadata:v,tags:f.tags,store:o.store??i.store}),{runName:p,callbacks:u?.getChild(`graph:step:${c}`),configurable:{[_a]:y,[ga]:e=>Ei(c,(e=>{_.push(...e)}),r,n,a,e),[ba]:(e,r=!1)=>ki(c,t,n,a,{name:p,writes:_,triggers:b},e,r),[ya]:l??d[ya],[Oa]:{...d[Oa],[h]:t.id},checkpoint_id:void 0,checkpoint_ns:w}}),triggers:b,retry_policy:f.retryPolicy,id:y,path:e}}}}}}const xi=Symbol.for("INPUT_DONE"),ji=Symbol.for("INPUT_RESUMING"),Ci=[ma,ka];class Ii extends pt.IterableReadableStream{constructor(e){let t;const r=new Promise((e=>{t=e}));super({start:e=>{t(e)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),r.then((e=>{this.controller=e})),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch(e){}}error(e){this.controller.error(e)}}class Ai{constructor(e){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"taskWritesLeft",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.input=e.input,this.checkpointer=e.checkpointer,void 0!==this.checkpointer?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=wi,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.managed=e.managed,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig}static async initialize(e){let{config:t,stream:r}=e;const{checkSubgraphs:n=!0}=e;void 0!==r&&void 0!==t.configurable?.[wa]&&(r=function(...e){return new Ii({passthroughFn:t=>{for(const r of e)r.modes.has(t[1])&&r.push(t)},modes:new Set(e.flatMap((e=>Array.from(e.modes))))})}(r,t.configurable[wa]));const a=void 0===t.configurable?.checkpoint_id,i=ba in(t.configurable??{});i||void 0===t.configurable?.checkpoint_ns||""===t.configurable?.checkpoint_ns||(t=vi(t,{checkpoint_ns:"",checkpoint_id:void 0}));let s=t;void 0!==t.configurable?.[Oa]&&t.configurable?.[Oa]?.[t.configurable?.checkpoint_ns]&&(s=vi(t,{checkpoint_id:t.configurable[Oa][t.configurable?.checkpoint_ns]}));const o=t.configurable?.checkpoint_ns?.split(Ca)??[],c=await(e.checkpointer?.getTuple(s))??{config:t,checkpoint:ta(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};s={...t,...c.config,configurable:{checkpoint_ns:"",...t.configurable,...c.config.configurable}};const l=c.parentConfig,u=ra(c.checkpoint),d={...c.metadata},h=c.pendingWrites??[],p=ua(e.channelSpecs,u),f=(d.step??0)+1,m=f+(t.recursionLimit??25)+1,g={...u.channel_versions},b=e.store?new oa(e.store):void 0;if(b&&b.start(),n&&i&&void 0!==e.checkpointer){if(Z().has(t.configurable?.checkpoint_ns))throw new q(["Detected the same subgraph called multiple times by the same node.","This is not allowed if checkpointing is enabled.","",'You can disable checkpointing for a subgraph by compiling it with ".compile({ checkpointer: false });"'].join("\n"),{lc_error_code:"MULTIPLE_SUBGRAPHS"});Z().add(t.configurable?.checkpoint_ns)}return new Ai({input:e.input,config:t,checkpointer:e.checkpointer,checkpoint:u,checkpointMetadata:d,checkpointConfig:s,prevCheckpointConfig:l,checkpointNamespace:o,channels:p,managed:e.managed,isNested:i,skipDoneTasks:a,step:f,stop:m,checkpointPreviousVersions:g,checkpointPendingWrites:h,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:r,store:b})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then((()=>this.checkpointer?.put(e.config,e.checkpoint,e.metadata,e.newVersions))),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(e,t){const r=this.managed.get(e);r&&"update"in r&&"function"==typeof r.update&&await r.update(t)}putWrites(e,t){if(0===t.length)return;const r=t[0][0];if(!t.find((([e])=>e===Ta))&&!Ci.includes(r)&&!this.taskWritesLeft)return this._outputWrites(e,t);r!==ka&&(this.taskWritesLeft-=1);const n=t.map((([t,r])=>[e,t,r]));this.checkpointPendingWrites.push(...n);const a=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},t,e);void 0!==a&&this.checkpointerPromises.push(a),this._outputWrites(e,t)}_outputWrites(e,t,r=!1){const n=this.tasks[e];if(void 0!==n){if(void 0!==n.config&&(n.config.tags??[]).includes(Sa))return;t.length>0&&t[0][0]!==ma&&t[0][0]!==ka&&this._emit(Ha(Za(oi(this.outputKeys,[[n,t]],r),"updates"))),r||this._emit(Ha(Za(function*(e,t,r){const n=(new Date).toISOString();for(const[{id:a,name:i,config:s},o]of t)s?.tags?.includes(Sa)||(yield{type:"task_result",timestamp:n,step:e,payload:{id:a,name:i,result:o.filter((([e])=>Array.isArray(r)?r.includes(e):e===r)),interrupts:o.filter((([e])=>e===ka))}})}(this.step,[[n,t]],this.streamKeys),"debug")))}}async tick(e){let t;try{this.store&&!this.store.isRunning&&this.store?.start();const{inputKeys:t=[],interruptAfter:r=[],interruptBefore:n=[],manager:a}=e;if("pending"!==this.status)throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if([xi,ji].includes(this.input)){if(!Object.values(this.tasks).every((e=>e.writes.length>0)))return!1;{const e=Object.values(this.tasks).flatMap((e=>e.writes)),t=Si(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(const[e,r]of Object.entries(t))await this.updateManagedValues(e,r);const n=await Ga(Za(si(this.outputKeys,e,this.channels),"values"));if(this._emit(n),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:oi(this.outputKeys,Object.values(this.tasks).map((e=>[e,e.writes]))).next().value??null}),Oi(this.checkpoint,r,Object.values(this.tasks))){if(this.status="interrupt_after",this.isNested)throw new D;return!1}}}else await this._first(t);if(this.step>this.stop)return this.status="out_of_steps",!1;const i=Ti(this.checkpoint,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.input===ji,manager:a,store:this.store});if(this.tasks=i,this.taskWritesLeft=Object.values(this.tasks).length-1,this.checkpointer&&this._emit(await Ga(Za(function*(e,t,r,n,a,i,s,o){function c(e){const t={};return null!=e.callbacks&&(t.callbacks=e.callbacks),null!=e.configurable&&(t.configurable=e.configurable),null!=e.maxConcurrency&&(t.max_concurrency=e.maxConcurrency),null!=e.metadata&&(t.metadata=e.metadata),null!=e.recursionLimit&&(t.recursion_limit=e.recursionLimit),null!=e.runId&&(t.run_id=e.runId),null!=e.runName&&(t.run_name=e.runName),null!=e.tags&&(t.tags=e.tags),t}const l=t.configurable?.checkpoint_ns,u={};for(const e of i){if(!(e.subgraphs?.length?e.subgraphs:[e.proc]).find(li))continue;let r=`${e.name}:${e.id}`;l&&(r=`${l}|${r}`),u[e.id]={configurable:{thread_id:t.configurable?.thread_id,checkpoint_ns:r}}}const d=(new Date).toISOString();yield{type:"checkpoint",timestamp:d,step:e,payload:{config:c(t),values:ii(r,n),metadata:a,next:i.map((e=>e.name)),tasks:fi(i,s,u),parentConfig:o?c(o):void 0}}}(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),0===Object.values(this.tasks).length)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(const[e,t,r]of this.checkpointPendingWrites){if(t===ma||t===ka)continue;const n=Object.values(this.tasks).find((t=>t.id===e));n&&n.writes.push([t,r])}for(const e of Object.values(this.tasks))e.writes.length>0&&this._outputWrites(e.id,e.writes,!0)}if(Object.values(this.tasks).every((e=>e.writes.length>0)))return this.tick({inputKeys:t,interruptAfter:r,interruptBefore:n,manager:a});if(Oi(this.checkpoint,n,Object.values(this.tasks))){if(this.status="interrupt_before",this.isNested)throw new D;return!1}const s=await Ga(Za(function*(e,t){const r=(new Date).toISOString();for(const{id:n,name:a,input:i,config:s,triggers:o,writes:c}of t){if(s?.tags?.includes(Sa))continue;const t=c.filter((([e,t])=>e===n&&t===ka)).map((([,e])=>e));yield{type:"task",timestamp:r,step:e,payload:{id:n,name:a,input:i,triggers:o,interrupts:t}}}}(this.step,Object.values(this.tasks)),"debug"));return this._emit(s),!0}catch(e){if(t=e,!this._suppressInterrupt(t))throw t;return this.output=ii(this.channels,this.outputKeys),!1}finally{void 0===t&&(this.output=ii(this.channels,this.outputKeys))}}_suppressInterrupt(e){return U(e)&&!this.isNested}async _first(e){const t=0!==Object.keys(this.checkpoint.channel_versions).length&&(void 0!==this.config.configurable?.[va]||null===this.input);if(t){for(const e of Object.keys(this.channels))if(void 0!==this.checkpoint.channel_versions[e]){const t=this.checkpoint.channel_versions[e];this.checkpoint.versions_seen[ka]={...this.checkpoint.versions_seen[ka],[e]:t}}const e=await Ga(Za(si(this.outputKeys,!0,this.channels),"values"));this._emit(e)}else{const t=await Ga(function*(e,t){if(null!=t)if(Array.isArray(e)&&"object"==typeof t&&!Array.isArray(t))for(const r in t)e.includes(r)&&(yield[r,t[r]]);else{if(Array.isArray(e))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[e,t]}}(e,this.input));if(0===t.length)throw new B(`Received no input writes for ${JSON.stringify(e,null,2)}`);const r=Ti(this.checkpoint,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});Si(this.checkpoint,this.channels,Object.values(r).concat([{name:fa,writes:t,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(t)})}this.input=t?ji:xi,this.isNested||(this.config=vi(this.config,{[va]:t}))}_emit(e){for(const t of e)this.stream.modes.has(t[0])&&this.stream.push([this.checkpointNamespace,...t])}async _putCheckpoint(e){const t={...e,step:this.step,parents:this.config.configurable?.[Oa]??{}};if(void 0!==this.checkpointer){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=t,this.checkpoint=da(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};const e={...this.checkpoint.channel_versions},r=yi(this.checkpointPreviousVersions,e);this.checkpointPreviousVersions=e,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:ra(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:r}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}}const Ri=[400,401,402,403,404,405,406,407,409],Ni=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)return!1;if("ECONNABORTED"===e?.code)return!1;const t=e?.response?.status??e?.status;return!(t&&Ri.includes(+t)||"insufficient_quota"===e?.error?.code)};async function*$i(e,t){const{stepTimeout:r,retryPolicy:n}=t??{};let a=t?.signal;const i=Object.fromEntries(e.map((e=>[e.id,Li(e,n)])));let s;r&&a?"any"in AbortSignal&&(a=AbortSignal.any([a,AbortSignal.timeout(r)])):r&&(a=AbortSignal.timeout(r)),a?.throwIfAborted();const o=new Promise(((e,t)=>{s=()=>t(new Error("Abort")),a?.addEventListener("abort",s)})).finally((()=>a?.removeEventListener("abort",s)));for(;Object.keys(i).length>0;){const e=await Promise.race([...Object.values(i),o]);yield e,delete i[e.task.id]}}async function Li(e,t){const r=e.retry_policy??t;let n,a,i=void 0!==r?r.initialInterval??500:0,s=0;for(;;){for(;e.writes.length>0;)e.writes.pop();n=void 0;try{a=await e.proc.invoke(e.input,e.config);break}catch(t){if(n=t,n.pregelTaskId=e.id,U(n))break;if(void 0===r)break;if(s+=1,s>=(r.maxAttempts??3))break;if(!(r.retryOn??Ni)(n))break;i=Math.min(r.maxInterval??128e3,i*(r.backoffFactor??2));const a=r.jitter?Math.floor(i+1e3*Math.random()):i;await new Promise((e=>setTimeout(e,a)));const o=n.name??n.constructor.unminifiable_name??n.constructor.name;console.log(`Retrying task "${e.name}" after ${i.toFixed(2)}ms (attempt ${s}) after ${o}: ${n}`)}finally{const t=e.config?.configurable?.checkpoint_ns;t&&Z().delete(t)}}return{task:e,result:a,error:n}}var Mi=r(477);class Di extends ke.BaseCallbackHandler{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this.streamFn=e}_emit(e,t,r=!1){if(!r||void 0===t.id||void 0===this.seen[t.id]){if(void 0===t.id){const e=(0,Mi.A)();t.id=e,t.lc_kwargs.id=e}this.seen[t.id]=t,this.streamFn([e[0],"messages",[t,e[1]]])}}handleChatModelStart(e,t,r,n,a,i,s,o){!s||i&&i.includes("langsmith:nostream")&&i.includes("nostream")||(this.metadatas[r]=[s.langgraph_checkpoint_ns.split("NS_SEP"),{tags:i,name:o,...s}])}handleLLMNewToken(e,t,r,n,a,i){const s=i?.chunk;var o;this.emittedChatModelRunIds[r]=!0,o=s,(0,Te.isBaseMessage)(o?.message)&&void 0!==this.metadatas[r]?this._emit(this.metadatas[r],s.message):this._emit(this.metadatas[r],new Te.AIMessageChunk({content:e}))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){const r=e.generations?.[0]?.[0];(0,Te.isBaseMessage)(r?.message)&&this._emit(this.metadatas[t],r?.message,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,r,n,a,i,s,o){void 0===i||o!==i.langgraph_node||void 0!==a&&a.includes(Sa)||(this.metadatas[r]=[i.langgraph_checkpoint_ns.split("NS_SEP"),{tags:a,name:o,...i}])}handleChainEnd(e,t){const r=this.metadatas[t];if(delete this.metadatas[t],void 0!==r)if((0,Te.isBaseMessage)(e))this._emit(r,e,!0);else if(Array.isArray(e))for(const t of e)(0,Te.isBaseMessage)(t)&&this._emit(r,t,!0);else if(null!=e&&"object"==typeof e)for(const t of Object.values(e))if((0,Te.isBaseMessage)(t))this._emit(r,t,!0);else if(Array.isArray(t))for(const e of t)(0,Te.isBaseMessage)(e)&&this._emit(r,e,!0)}handleChainError(e,t){delete this.metadatas[t]}}class Fi{static subscribeTo(e,t){const{key:r,tags:n}=t??{};if(Array.isArray(e)&&void 0!==r)throw new Error("Can't specify a key when subscribing to multiple channels");let a;a="string"==typeof e?r?{[r]:e}:[e]:Object.fromEntries(e.map((e=>[e,e])));const i=Array.isArray(e)?e:[e];return new ti({channels:a,triggers:i,tags:n})}static writeTo(e,t){const r=[];for(const t of e)r.push({channel:t,value:Ja,skipNone:!1});for(const[e,n]of Object.entries(t??{}))Ie.YN.isRunnable(n)||"function"==typeof n?r.push({channel:e,value:Ja,skipNone:!0,mapper:(0,Ie.Bp)(n)}):r.push({channel:e,value:n,skipNone:!1});return new Xa(r)}}class Ui extends Ie.YN{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;null==t||Array.isArray(t)||(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.autoValidate&&this.validate()}withConfig(e){const t=(0,ft.SV)(this.config,e);return new this.constructor({...this,config:t})}validate(){return function({nodes:e,channels:t,inputChannels:r,outputChannels:n,streamChannels:a,interruptAfterNodes:i,interruptBeforeNodes:s}){if(!t)throw new ri("Channels not provided");const o=new Set,c=new Set;for(const[t,r]of Object.entries(e)){if(t===ka)throw new ri(`"Node name ${ka} is reserved"`);if(r.constructor!==ti)throw new ri(`Invalid node type ${typeof r}, expected PregelNode`);r.triggers.forEach((e=>o.add(e)))}for(const e of o)if(!(e in t))throw new ri(`Subcribed channel '${String(e)}' not in channels`);if(Array.isArray(r)){if(r.every((e=>!o.has(e))))throw new ri(`None of the input channels ${r} are subscribed to by any node`)}else if(!o.has(r))throw new ri(`Input channel ${String(r)} is not subscribed to by any node`);Array.isArray(n)?n.forEach((e=>c.add(e))):c.add(n),a&&!Array.isArray(a)?c.add(a):Array.isArray(a)&&a.forEach((e=>c.add(e)));for(const e of c)if(!(e in t))throw new ri(`Output channel '${String(e)}' not in channels`);if(i&&"*"!==i)for(const t of i)if(!(t in e))throw new ri(`Node ${String(t)} not in nodes`);if(s&&"*"!==s)for(const t of s)if(!(t in e))throw new ri(`Node ${String(t)} not in nodes`)}({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(const[r,n]of Object.entries(this.nodes)){if(void 0!==e&&!e.startsWith(r))continue;const a=n.subgraphs?.length?n.subgraphs:[n.bound];for(const n of a){const a=li(n);if(void 0!==a){if(r===e)return void(yield[r,a]);if(void 0===e&&(yield[r,a]),t){let n=e;void 0!==e&&(n=e.slice(r.length+1));for(const[e,i]of a.getSubgraphs(n,t))yield[`${r}${Ca}${e}`,i]}}}}}async*getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:r}){if(void 0===t)return{values:{},next:[],config:e,tasks:[]};const{managed:n}=await this.prepareSpecs(e,{skipManaged:!0}),a=ua(this.channels,t.checkpoint),i=Object.values(Ti(t.checkpoint,this.nodes,a,n,t.config,!1,{step:(t.metadata?.step??-1)+1})),s=await Ga(this.getSubgraphsAsync()),o=t.config.configurable?.checkpoint_ns??"",c={};for(const e of i){const n=s.find((([t])=>t===e.name));if(!n)continue;let a=`${e.name}${Ia}${e.id}`;if(o&&(a=`${o}${Ca}${a}`),void 0===r){const r={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:a}};c[e.id]=r}else{const i={configurable:{[ya]:r,thread_id:t.config.configurable?.thread_id,checkpoint_ns:a}};c[e.id]=await n[1].getState(i,{subgraphs:!0})}}return{values:ii(a,this.streamChannelsAsIs),next:i.map((e=>e.name)),tasks:fi(i,t?.pendingWrites??[],c),metadata:t.metadata,config:_i(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){const r=e.configurable?.[ya]??this.checkpointer;if(!r)throw new M("No checkpointer set");const n=e.configurable?.checkpoint_ns??"";if(""!==n&&void 0===e.configurable?.[ya]){const a=n.split(Ca).map((e=>e.split(Ia)[0])).join(Ca);for await(const[n,i]of this.getSubgraphsAsync(a,!0))if(n===a)return await i.getState(Wa(e,{[ya]:r}),{subgraphs:t?.subgraphs});throw new Error(`Subgraph with namespace "${a}" not found.`)}const a=(0,ft.SV)(this.config,e),i=await r.getTuple(e);return await this._prepareStateSnapshot({config:a,saved:i,subgraphCheckpointer:t?.subgraphs?r:void 0})}async*getStateHistory(e,t){const r=e.configurable?.[ya]??this.checkpointer;if(!r)throw new Error("No checkpointer set");const n=e.configurable?.checkpoint_ns??"";if(""!==n&&void 0===e.configurable?.[ya]){const a=n.split(Ca).map((e=>e.split(Ia)[0])).join(Ca);for await(const[n,i]of this.getSubgraphsAsync(a,!0))if(n===a)return void(yield*i.getStateHistory(Wa(e,{[ya]:r}),t));throw new Error(`Subgraph with namespace "${a}" not found.`)}const a=(0,ft.SV)(this.config,e,{configurable:{checkpoint_ns:n}});for await(const e of r.list(a,t))yield this._prepareStateSnapshot({config:e.config,saved:e})}async updateState(e,t,r){const n=e.configurable?.[ya]??this.checkpointer;if(!n)throw new M("No checkpointer set");const a=e.configurable?.checkpoint_ns??"";if(""!==a&&void 0===e.configurable?.[ya]){const i=a.split(Ca).map((e=>e.split(Ia)[0])).join(Ca);for await(const[,a]of this.getSubgraphsAsync(i,!0))return await a.updateState(Wa(e,{[ya]:n}),t,r);throw new Error(`Subgraph "${i}" not found`)}const i=this.config?(0,ft.SV)(this.config,e):e,s=await n.getTuple(i),o=void 0!==s?ra(s.checkpoint):ta(),c={...s?.checkpoint.channel_versions},l=s?.metadata?.step??-1;let u=Wa(i,{checkpoint_ns:i.configurable?.checkpoint_ns??""});if(s&&(u=Wa(i,s.config.configurable)),null==t&&void 0===r)return _i(await n.put(u,da(o,void 0,l),{source:"update",step:l,writes:{},parents:s?.metadata?.parents??{}},{}),s?s.metadata:void 0);const d=Object.values(o.versions_seen).map((e=>Object.values(e))).flat().find((e=>!!e));if(void 0===r&&void 0===d)"string"==typeof this.inputChannels&&void 0!==this.nodes[this.inputChannels]&&(r=this.inputChannels);else if(void 0===r){const e=Object.entries(o.versions_seen).map((([e,t])=>Object.values(t).map((t=>[t,e])))).flat().sort((([e],[t])=>na(e,t)));e&&(1===e.length?r=e[0][1]:e[e.length-1][0]!==e[e.length-2][0]&&(r=e[e.length-1][1]))}if(void 0===r)throw new V('Ambiguous update, specify "asNode"');if(void 0===this.nodes[r])throw new V(`Node "${r.toString()}" does not exist`);const h=ua(this.channels,o),{managed:p}=await this.prepareSpecs(i,{skipManaged:!0}),f=this.nodes[r].getWriters();if(!f.length)throw new V(`No writers found for node "${r.toString()}"`);const m={name:r,input:t,proc:f.length>1?Ie.zZ.from(f,{omitSequenceTags:!0}):f[0],writes:[],triggers:[ka],id:oe(ka,o.id)};await m.proc.invoke(m.input,(0,ft.tn)({...i,store:i?.store??this.store},{runName:i.runName??`${this.getName()}UpdateState`,configurable:{[ga]:e=>m.writes.push(...e),[ba]:(e,t=!1)=>ki(l,o,h,p,m,e,t)}})),void 0!==s&&await n.putWrites(u,m.writes,m.id),Si(o,h,[m],n.getNextVersion.bind(this.checkpointer));const g=yi(c,o.channel_versions);return _i(await n.put(u,da(o,h,l+1),{source:"update",step:l+1,writes:{[r]:t},parents:s?.metadata?.parents??{}},g),s?s.metadata:void 0)}_defaults(e){const{debug:t,streamMode:r,inputKeys:n,outputKeys:a,interruptAfter:i,interruptBefore:s,...o}=e;let c=!0;const l=void 0!==t?t:this.debug;let u=a;void 0===u?u=this.streamChannelsAsIs:ni(u,this.channels);let d=n;void 0===d?d=this.inputChannels:ni(d,this.channels);const h=s??this.interruptBefore??[],p=i??this.interruptAfter??[];let f,m;return void 0!==r?(f=Array.isArray(r)?r:[r],c="string"==typeof r):(f=this.streamMode,c=!0),void 0!==e.configurable?.[_a]&&(f=["values"]),m=!1===this.checkpointer?void 0:void 0!==e&&void 0!==e.configurable?.[ya]?e.configurable[ya]:this.checkpointer,[l,f,d,u,o,h,p,m,e.store??this.store,c]}async stream(e,t){return super.stream(e,t)}async prepareSpecs(e,t){const r={...e,store:this.store},n={},a={};for(const[e,r]of Object.entries(this.channels))ca(r)?n[e]=r:a[e]=t?.skipManaged?{cls:La,params:{config:{}}}:r;const i=new Na(await Object.entries(a).reduce((async(e,[t,n])=>{const a=await e;let i;return $a(n)?("key"in n.params&&"__channel_key_placeholder__"===n.params.key&&(n.params.key=t),i=await n.cls.initialize(r,n.params)):i=await n.initialize(r),void 0!==i&&a.push([t,i]),a}),Promise.resolve([])));return{channelSpecs:n,managed:i}}async*_streamIterator(e,t){const r=t?.subgraphs,n=Va(this.config,t);if(void 0===n.recursionLimit||n.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(void 0!==this.checkpointer&&!1!==this.checkpointer&&void 0===n.configurable)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');const{runId:a,...i}=n,[s,o,,c,l,u,d,h,p,f]=this._defaults(i),m=new Ii({modes:new Set(o)});if(o.includes("messages")){const e=new Di((e=>m.push(e))),{callbacks:t}=l;if(void 0===t)l.callbacks=[e];else if(Array.isArray(t))l.callbacks=t.concat(e);else{const r=t.copy();r.addHandler(e,!0),l.callbacks=r}}o.includes("custom")&&(l.writer=e=>m.push([[],"custom",e]));const g=await(0,ft.kJ)(l),b=await(g?.handleChainStart(this.toJSON(),(_=e,w="input",!_||Array.isArray(_)||_ instanceof Date||"object"!=typeof _?{[w]:_}:_),a,void 0,void 0,void 0,l?.runName??this.getName())),{channelSpecs:y,managed:v}=await this.prepareSpecs(l);var _,w;let O,k;const E=(async()=>{try{for(O=await Ai.initialize({input:e,config:l,checkpointer:h,nodes:this.nodes,channelSpecs:y,managed:v,outputKeys:c,streamKeys:this.streamChannelsAsIs,store:p,stream:m}),t?.subgraphs&&(O.config.configurable={...O.config.configurable,[wa]:O.stream});await O.tick({inputKeys:this.inputChannels,interruptAfter:d,interruptBefore:u,manager:b});){s&&(r=O.checkpointMetadata.step,n=O.channels,a=this.streamChannelsList,console.log([`${pi(ui,`[${r}:checkpoint]`)}`,`[1m State at the end of step ${r}:[0m\n`,JSON.stringify(ii(n,a),null,2)].join(""))),s&&mi(O.step,Object.values(O.tasks));const e=$i(Object.values(O.tasks).filter((e=>0===e.writes.length)),{stepTimeout:this.stepTimeout,signal:l.signal,retryPolicy:this.retryPolicy});for await(const{task:t,error:r}of e){if(void 0!==r)if(U(r)){if(O.isNested)throw r;r.interrupts.length&&O.putWrites(t.id,r.interrupts.map((e=>[ka,e])))}else O.putWrites(t.id,[[ma,{message:r.message,name:r.name}]]);else O.putWrites(t.id,t.writes);if(void 0!==r&&!U(r))throw r}s&&gi(O.step,Object.values(O.tasks).map((e=>e.writes)).flat(),this.streamChannelsList)}if("out_of_steps"===O.status)throw new L([`Recursion limit of ${l.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(e){k=e}finally{try{O&&await(O.store?.stop()),await Promise.all([...O?.checkpointerPromises??[],...Array.from(v.values()).map((e=>e.promises()))])}catch(e){k=k??e}k?m.error(k):m.close()}var r,n,a})();try{for await(const e of m){if(void 0===e)throw new Error("Data structure error.");const[t,n,a]=e;o.includes(n)&&(r&&!f?yield[t,n,a]:f?r?yield[t,a]:yield a:yield[n,a])}}catch(e){throw await(b?.handleChainError(k)),e}finally{await E}await(b?.handleChainEnd(O?.output??{}))}async invoke(e,t){const r=t?.streamMode??"values",n={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:r},a=[],i=await this.stream(e,n);for await(const e of i)a.push(e);return"values"===r?a[a.length-1]:a}}class Bi extends la{constructor(e=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.guard=e}fromCheckpoint(e){const t=new Bi(this.guard);return e&&(t.value=e),t}update(e){if(0===e.length){const e=void 0!==this.value;return this.value=void 0,e}if(1!==e.length&&this.guard)throw new V("EphemeralValue can only receive one value per step.");return this.value=e[e.length-1],!0}get(){if(void 0===this.value)throw new z;return this.value}checkpoint(){if(void 0===this.value)throw new z;return this.value}}const zi="__start__",Vi="__end__";class qi{constructor(e){Object.defineProperty(this,"condition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.condition=e.path,this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce(((e,t)=>(e[t]=t,e)),{}):e.pathMap}compile(e,t){return Xa.registerWriter(new qa({trace:!1,func:async(r,n)=>{try{return await this._route(r,n,e,t)}catch(e){throw e.name===F.unminifiable_name&&console.warn("[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.\nNodeInterrupt should only be thrown inside a node, not in edge conditions."),e}}}))}async _route(e,t,r,n){let a,i=await this.condition(n?n(t):e,t);if(Array.isArray(i)||(i=[i]),a=this.ends?i.map((e=>Aa(e)?e:this.ends[e])):i,a.some((e=>!e)))throw new Error("Branch condition returned unknown or null destination");if(a.filter(Aa).some((e=>e.node===Vi)))throw new V("Cannot send a packet to the END node");return r(a)}}class Zi{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(e,t,r){for(const t of[Ca,Ia])if(e.includes(t))throw new Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw new Error(`Node \`${e}\` already present.`);if(e===Vi)throw new Error(`Node \`${e}\` is reserved.`);const n=(0,Ie.Bp)(t);return this.nodes[e]={runnable:n,metadata:r?.metadata,subgraphs:ci(n)?[n]:r?.subgraphs},this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===Vi)throw new Error("END cannot be a start node");if(t===zi)throw new Error("START cannot be an end node");if(Array.from(this.edges).some((([t])=>t===e))&&!("channels"in this))throw new Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,r){const n="object"==typeof e?e:{source:e,path:t,pathMap:r};this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");const a=n.path.name||"condition";if(this.branches[n.source]&&this.branches[n.source][a])throw new Error(`Condition \`${a}\` already present for node \`${e}\``);return this.branches[n.source]||(this.branches[n.source]={}),this.branches[n.source][a]=new qi(n),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(zi,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,Vi)}compile({checkpointer:e,interruptBefore:t,interruptAfter:r}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(r)?r:[]]);const n=new Gi({builder:this,checkpointer:e,interruptAfter:r,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[zi]:new Bi,[Vi]:new Bi},inputChannels:zi,outputChannels:Vi,streamChannels:[],streamMode:"values"});for(const[e,t]of Object.entries(this.nodes))n.attachNode(e,t);for(const[e,t]of this.edges)n.attachEdge(e,t);for(const[e,t]of Object.entries(this.branches))for(const[r,a]of Object.entries(t))n.attachBranch(e,r,a);return n.validate()}validate(e){const t=new Set([...this.allEdges].map((([e,t])=>e)));for(const[e]of Object.entries(this.branches))t.add(e);for(const e of t)if(e!==zi&&!(e in this.nodes))throw new Error(`Found edge starting at unknown node \`${e}\``);const r=new Set([...this.allEdges].map((([e,t])=>t)));for(const[e,t]of Object.entries(this.branches))for(const n of Object.values(t))if(n.ends)for(const e of Object.values(n.ends))r.add(e);else{r.add(Vi);for(const t of Object.keys(this.nodes))t!==e&&r.add(t)}for(const e of Object.keys(this.nodes))if(!r.has(e))throw new Error(`Node \`${e}\` is not reachable`);for(const e of r)if(e!==Vi&&!(e in this.nodes))throw new Error(`Found edge ending at unknown node \`${e}\``);if(e)for(const t of e)if(!(t in this.nodes))throw new Error(`Interrupt node \`${t}\` is not present`);this.compiled=!0}}class Gi extends Ui{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new Bi,this.nodes[e]=new ti({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs}).pipe(t.runnable).pipe(new Xa([{channel:e,value:Ja}],[Sa])),this.streamChannels.push(e)}attachEdge(e,t){if(t===Vi){if(e===zi)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new Xa([{channel:Vi,value:Ja}],[Sa]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,r){e===zi&&this.nodes[zi]&&(this.nodes[zi]=Fi.subscribeTo(zi,{tags:[Sa]})),this.nodes[e].pipe(r.compile((r=>{const n=r.map((r=>Aa(r)?r:{channel:r===Vi?Vi:`branch:${e}:${t}:${r}`,value:Ja}));return new Xa(n,[Sa])})));const n=r.ends?Object.values(r.ends):Object.keys(this.nodes);for(const r of n)if(r!==Vi){const n=`branch:${e}:${t}:${r}`;this.channels[n]=new Bi,this.nodes[r].triggers.push(n),this.nodes[r].channels.push(n)}}async getGraphAsync(e){const t=e?.xray,r=new Ua.T,n={[zi]:r.addNode({schema:Sr.z.any()},zi)},a={};let i={};function s(e,t,i,s=!1){return t===Vi&&void 0===a[Vi]&&(a[Vi]=r.addNode({schema:Sr.z.any()},Vi)),r.addEdge(n[e],a[t],i!==t?i:void 0,s)}t&&(i=Object.fromEntries((await Ga(this.getSubgraphsAsync())).filter((e=>Hi(e[1])))));for(const[c,l]of Object.entries(this.builder.nodes)){const u=Wi(c),d=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?h.__interrupt="before,after":this.interruptBefore?.includes(c)?h.__interrupt="before":this.interruptAfter?.includes(c)&&(h.__interrupt="after"),t){const p="number"==typeof t?t-1:t,f=void 0!==i[c]?await i[c].getGraphAsync({...e,xray:p}):d.getGraph(e);if(f.trimFirstNode(),f.trimLastNode(),Object.keys(f.nodes).length>1){const[m,g]=r.extend(f,u);if(void 0===m)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);function b(e,t){if(void 0!==e&&!(0,X.A)(e))return e;if(!(r=t)||!r.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}var r}void 0!==g&&(n[u]={name:b(g.id,g.data),...g}),a[u]={name:b(m.id,m.data),...m}}else{const y=r.addNode(d,u,h);n[u]=y,a[u]=y}}else{const v=r.addNode(d,u,h);n[u]=v,a[u]=v}}const o=[...this.builder.allEdges].sort((([e],[t])=>e<t?-1:t>e?1:0));for(const[_,w]of o)s(Wi(_),Wi(w));for(const[O,k]of Object.entries(this.builder.branches)){const E={...Object.fromEntries(Object.keys(this.builder.nodes).filter((e=>e!==O)).map((e=>[Wi(e),Wi(e)]))),[Vi]:Vi};for(const S of Object.values(k)){let T;T=void 0!==S.ends?S.ends:E;for(const[P,x]of Object.entries(T))s(Wi(O),Wi(x),P,!0)}}return r}getGraph(e){const t=e?.xray,r=new Ua.T,n={[zi]:r.addNode({schema:Sr.z.any()},zi)},a={};let i={};function s(e,t,i,s=!1){return t===Vi&&void 0===a[Vi]&&(a[Vi]=r.addNode({schema:Sr.z.any()},Vi)),r.addEdge(n[e],a[t],i!==t?i:void 0,s)}t&&(i=Object.fromEntries(Ha(this.getSubgraphs()).filter((e=>Hi(e[1])))));for(const[c,l]of Object.entries(this.builder.nodes)){const u=Wi(c),d=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?h.__interrupt="before,after":this.interruptBefore?.includes(c)?h.__interrupt="before":this.interruptAfter?.includes(c)&&(h.__interrupt="after"),t){const p="number"==typeof t?t-1:t,f=void 0!==i[c]?i[c].getGraph({...e,xray:p}):d.getGraph(e);if(f.trimFirstNode(),f.trimLastNode(),Object.keys(f.nodes).length>1){const[m,g]=r.extend(f,u);if(void 0===m)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);function b(e,t){if(void 0!==e&&!(0,X.A)(e))return e;if(!(r=t)||!r.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}var r}void 0!==g&&(n[u]={name:b(g.id,g.data),...g}),a[u]={name:b(m.id,m.data),...m}}else{const y=r.addNode(d,u,h);n[u]=y,a[u]=y}}else{const v=r.addNode(d,u,h);n[u]=v,a[u]=v}}const o=[...this.builder.allEdges].sort((([e],[t])=>e<t?-1:t>e?1:0));for(const[_,w]of o)s(Wi(_),Wi(w));for(const[O,k]of Object.entries(this.builder.branches)){const E={...Object.fromEntries(Object.keys(this.builder.nodes).filter((e=>e!==O)).map((e=>[Wi(e),Wi(e)]))),[Vi]:Vi};for(const S of Object.values(k)){let T;T=void 0!==S.ends?S.ends:E;for(const[P,x]of Object.entries(T))s(Wi(O),Wi(x),P,!0)}}return r}}function Hi(e){return"function"==typeof e.attachNode&&"function"==typeof e.attachEdge}function Wi(e){return"subgraph"===e?`"${e}"`:e}const Yi=(e,t)=>e.size===t.size&&[...e].every((e=>t.has(e)));class Ji extends la{constructor(e){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=e,this.seen=new Set}fromCheckpoint(e){const t=new Ji(this.names);return e&&(t.seen=new Set(e)),t}update(e){let t=!1;for(const r of e){if(!this.names.has(r))throw new V(`Value ${JSON.stringify(r)} not in names ${JSON.stringify(this.names)}`);this.seen.has(r)||(this.seen.add(r),t=!0)}return t}get(){if(!Yi(this.names,this.seen))throw new z}checkpoint(){return[...this.seen]}consume(){return!!(this.seen&&this.names&&Yi(this.seen,this.names))&&(this.seen=new Set,!0)}}const Ki="__root__";class Xi extends Gi{attachNode(e,t){function r(e,t){if(t){if("object"!=typeof t||Array.isArray(t)){const r=Array.isArray(t)?"array":typeof t;throw new V(`Expected node "${e.toString()}" to return an object, received ${r}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}return e in t?t[e]:Ya}return Ya}const n=Object.keys(this.builder.channels).map((e=>e===Ki?{channel:e,value:Ja,skipNone:!0}:{channel:e,value:Ja,mapper:new qa({func:r.bind(null,e),trace:!1,recurse:!1})}));if(e===zi)this.nodes[e]=new ti({tags:[Sa],triggers:[zi],channels:[zi],writers:[new Xa(n,[Sa])]});else{const r=t?.input??this.builder._schemaDefinition,a=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(r)).map((e=>[e,e]))),i=1===Object.keys(a).length&&Ki in a;this.channels[e]=new Bi(!1),this.nodes[e]=new ti({triggers:[],channels:i?Object.keys(a):a,writers:[new Xa(n.concat({channel:e,value:e}),[Sa])],mapper:i?void 0:e=>Object.fromEntries(Object.entries(e).filter((([e])=>e in a))),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs})}}attachEdge(e,t){if(t!==Vi)if(Array.isArray(e)){const r=`join:${e.join("+")}:${t}`;this.channels[r]=new Ji(new Set(e)),this.nodes[t].triggers.push(r);for(const t of e)this.nodes[t].writers.push(new Xa([{channel:r,value:t}],[Sa]))}else if(e===zi){const e=`${zi}:${t}`;this.channels[e]=new Bi,this.nodes[t].triggers.push(e),this.nodes[zi].writers.push(new Xa([{channel:e,value:zi}],[Sa]))}else this.nodes[t].triggers.push(e)}attachBranch(e,t,r){this.nodes[e].writers.push(r.compile((r=>{const n=r.filter((e=>e!==Vi));if(!n.length)return;const a=n.map((r=>Aa(r)?r:{channel:`branch:${e}:${t}:${r}`,value:e}));return new Xa(a,[Sa])}),(e=>Qa.doRead(e,this.streamChannels??this.outputChannels,!0))));const n=r.ends?Object.values(r.ends):Object.keys(this.builder.nodes);for(const r of n){if(r===Vi)continue;const n=`branch:${e}:${t}:${r}`;this.channels[n]=new Bi(!1),this.nodes[r].triggers.push(n)}}}function Qi(e){return"object"==typeof e&&null!==e&&"lc_graph_name"in e&&"AnnotationRoot"===e.lc_graph_name}function es(e){return es="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},es(e)}function ts(){ts=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,a=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",o=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var i=t&&t.prototype instanceof b?t:b,s=Object.create(i.prototype),o=new C(n||[]);return a(s,"_invoke",{value:T(e,r,o)}),s}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function b(){}function y(){}function v(){}var _={};l(_,s,(function(){return this}));var w=Object.getPrototypeOf,O=w&&w(w(I([])));O&&O!==r&&n.call(O,s)&&(_=O);var k=v.prototype=b.prototype=Object.create(_);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(a,i,s,o){var c=d(e[a],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==es(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,s,o)}),(function(e){r("throw",e,s,o)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return r("throw",e,s,o)}))}o(c.arg)}var i;a(this,"_invoke",{value:function(e,n){function a(){return new t((function(t,a){r(e,n,t,a)}))}return i=i?i.then(a,a):a()}})}function T(t,r,n){var a=h;return function(i,s){if(a===f)throw Error("Generator is already running");if(a===m){if("throw"===i)throw s;return{value:e,done:!0}}for(n.method=i,n.arg=s;;){var o=n.delegate;if(o){var c=P(o,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(a===h)throw a=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=f;var l=d(t,r,n);if("normal"===l.type){if(a=n.done?m:p,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(a=m,n.method="throw",n.arg=l.arg)}}}function P(t,r){var n=r.method,a=t.iterator[n];if(a===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,P(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var i=d(a,t.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,g;var s=i.arg;return s?s.done?(r[t.resultName]=s.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function I(t){if(t||""===t){var r=t[s];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,i=function r(){for(;++a<t.length;)if(n.call(t,a))return r.value=t[a],r.done=!1,r;return r.value=e,r.done=!0,r};return i.next=i}}throw new TypeError(es(t)+" is not iterable")}return y.prototype=v,a(k,"constructor",{value:v,configurable:!0}),a(v,"constructor",{value:y,configurable:!0}),y.displayName=l(v,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,c,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},E(S.prototype),l(S.prototype,o,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,a,i){void 0===i&&(i=Promise);var s=new S(u(e,r,n,a),i);return t.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},E(k),l(k,c,"Generator"),l(k,s,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=I,C.prototype={constructor:C,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function a(n,a){return o.type="throw",o.arg=t,r.next=n,a&&(r.method="next",r.arg=e),!!a}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],o=s.completion;if("root"===s.tryLoc)return a("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),l=n.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return a(s.catchLoc,!0);if(this.prev<s.finallyLoc)return a(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return a(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return a(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),j(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;j(r)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:I(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function rs(e,t,r,n,a,i,s){try{var o=e[i](s),c=o.value}catch(e){return void r(e)}o.done?t(c):Promise.resolve(c).then(n,a)}Da.Root({messages:Da({reducer:function(e,t){const r=Array.isArray(e)?e:[e],n=Array.isArray(t)?t:[t],a=r.map(Te.coerceMessageLikeToMessage),i=n.map(Te.coerceMessageLikeToMessage);for(const e of a)null!==e.id&&void 0!==e.id||(e.id=(0,Mi.A)(),e.lc_kwargs.id=e.id);for(const e of i)null!==e.id&&void 0!==e.id||(e.id=(0,Mi.A)(),e.lc_kwargs.id=e.id);const s=new Map(a.map(((e,t)=>[e.id,t]))),o=[...a],c=new Set;for(const e of i){const t=s.get(e.id);if(void 0!==t)"remove"===e._getType()?c.add(e.id):o[t]=e;else{if("remove"===e._getType())throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${e.id}')`);o.push(e)}}return o.filter((e=>!c.has(e.id)))},default:()=>[]})}),void 0===globalThis.crypto?globalThis.crypto={getRandomValues:function(e){for(var t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e}}:void 0===globalThis.crypto.getRandomValues&&(globalThis.crypto.getRandomValues=function(e){for(var t=0;t<e.length;t++)e[t]=Math.floor(256*Math.random());return e}),globalThis.ReadableStream=N.ZY,globalThis.WritableStream=N.ho,globalThis.TransformStream=N.Rv,globalThis.ByteLengthQueuingStrategy=N.i0,globalThis.CountQueuingStrategy=N.ty;var ns=Da.Root({messages:Da({reducer:function(e,t){return e.concat(t)}})}),as=function(){var e,t=(e=ts().mark((function e(t){return ts().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{messages:[new Te.HumanMessage("Hello from Unity!")]});case 1:case"end":return e.stop()}}),e)})),function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function s(e){rs(i,n,a,s,o,"next",e)}function o(e){rs(i,n,a,s,o,"throw",e)}s(void 0)}))});return function(e){return t.apply(this,arguments)}}(),is=new class extends Zi{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof(r=e)&&null!==r&&void 0===r.stateSchema&&void 0!==r.input&&void 0!==r.output)this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(function(e){return"object"==typeof e&&null!==e&&void 0!==e.stateSchema}(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&Object.keys(e).length>0&&Object.values(e).every((e=>"function"==typeof e||ca(e)))}(e)||Qi(e)){const t=Qi(e)?e.spec:e;this._schemaDefinition=t}else{if(!function(e){return"object"==typeof e&&null!==e&&void 0!==e.channels}(e))throw new Error("Invalid StateGraph input.");{const t=function(e){const t={};for(const[r,n]of Object.entries(e))t[r]=Fa(n);return t}(e.channels);this._schemaDefinition=t}}var r;this._inputDefinition=this._inputDefinition??this._schemaDefinition,this._outputDefinition=this._outputDefinition??this._schemaDefinition,this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),this._configSchema=t?.spec}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap((([e,t])=>e.map((e=>[e,t]))))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(const[t,r]of Object.entries(e)){let e;if(e="function"==typeof r?r():r,void 0!==this.channels[t]){if(this.channels[t]!==e&&!$a(e)&&"LastValue"!==e.lc_graph_name)throw new Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=e}}}addNode(e,t,r){if(e in this.channels)throw new Error(`${e} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(const t of[Ca,Ia])if(e.includes(t))throw new Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw new Error(`Node \`${e}\` already present.`);if(e===Vi||e===zi)throw new Error(`Node \`${e}\` is reserved.`);let n;void 0!==r?.input&&this._addSchema(r.input.spec),n=Ie.YN.isRunnable(t)?t:"function"==typeof t?new qa({func:t,name:e,trace:!1}):(0,Ie.Bp)(t);const a={runnable:n,retryPolicy:r?.retryPolicy,metadata:r?.metadata,input:r?.input?.spec??this._schemaDefinition,subgraphs:ci(n)?[n]:r?.subgraphs};return this.nodes[e]=a,this}addEdge(e,t){if("string"==typeof e)return super.addEdge(e,t);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(const t of e){if(t===Vi)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some((e=>e===t)))throw new Error(`Need to add a node named "${t}" first`)}if(t===Vi)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some((e=>e===t)))throw new Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}compile({checkpointer:e,store:t,interruptBefore:r,interruptAfter:n}={}){this.validate([...Array.isArray(r)?r:[],...Array.isArray(n)?n:[]]);const a=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),i=1===a.length&&a[0]===Ki?Ki:a,s=Object.keys(this.channels),o=1===s.length&&s[0]===Ki?Ki:s,c=new Xi({builder:this,checkpointer:e,interruptAfter:n,interruptBefore:r,autoValidate:!1,nodes:{},channels:{...this.channels,[zi]:new Bi},inputChannels:zi,outputChannels:i,streamChannels:o,streamMode:"updates",store:t});c.attachNode(zi);for(const[e,t]of Object.entries(this.nodes))c.attachNode(e,t);for(const[e,t]of this.edges)c.attachEdge(e,t);for(const[e,t]of this.waitingEdges)c.attachEdge(e,t);for(const[e,t]of Object.entries(this.branches))for(const[r,n]of Object.entries(t))c.attachBranch(e,r,n);return c.validate()}}(ns).addNode("node",as).addEdge(zi,"node").addEdge("node",Vi).compile({}),ss=n.y;export{ss as app};